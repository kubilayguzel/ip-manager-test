<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Belge Ä°ndeksleme</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* BODY VE YENÄ° LAYOUT */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            display: flex;
        }
        
        .page-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

.main-container {
    width: 100%; /* GeniÅŸliÄŸi tamamen doldurmasÄ±nÄ± saÄŸlar */
    padding: 30px; /* Ä°Ã§eriÄŸin kenarlara yapÄ±ÅŸmamasÄ± iÃ§in boÅŸluk bÄ±rakÄ±r */
    margin: 0; /* Otomatik ortalamayÄ± kaldÄ±rÄ±r */
}

        /* ESKÄ° HEADER'I GÄ°ZLE */
        body > .header { display: none; }

        /* === YENÄ° SOL MENÃœ VE ÃœST BAR STÄ°LLERÄ° === */
        .sidebar { width: 260px; background: #1e3c72; color: white; display: flex; flex-direction: column; transition: width 0.3s ease; height: 100vh; position: sticky; top: 0; z-index: 1001; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .sidebar-logo { font-size: 1.8em; font-weight: bold; color: white; text-decoration: none; }
        .sidebar-nav { flex-grow: 1; overflow-y: auto; padding: 20px 0; }
        .nav-category-title { padding: 10px 20px; font-size: 0.8em; font-weight: bold; color: rgba(255, 255, 255, 0.5); text-transform: uppercase; }
        .sidebar-nav-item, .accordion-header { display: flex; align-items: center; gap: 15px; padding: 15px 20px; color: rgba(255, 255, 255, 0.8); text-decoration: none; transition: background 0.3s ease; cursor: pointer; }
        .sidebar-nav-item:hover, .accordion-header:hover { background: rgba(255, 255, 255, 0.1); }
        .sidebar-nav-item.active { background: #2a5298; color: white; font-weight: bold; border-left: 4px solid #4ecdc4; padding-left: 16px; }
        .nav-icon { font-size: 1.2em; width: 20px; text-align: center; }
        .accordion-header::after { content: 'â–¶'; margin-left: auto; font-size: 0.8em; transition: transform 0.3s ease; }
        .accordion-header.active::after { transform: rotate(90deg); }
        .accordion-content { background: rgba(0, 0, 0, 0.2); max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-content a { display: block; padding: 12px 20px 12px 55px; color: rgba(255, 255, 255, 0.7); text-decoration: none; transition: background 0.2s ease; }
        .accordion-content a:hover { background: rgba(255, 255, 255, 0.1); color: white; }
        .accordion-content a.active { color: white; font-weight: 500; }
        .top-header { background: rgba(255, 255, 255, 0.95); padding: 15px 30px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 99; backdrop-filter: blur(10px); }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: linear-gradient(45deg, #1e3c72, #2a5298); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-weight: 600; color: #333; }
        .user-role { font-size: 0.8em; color: #666; }
        .logout-btn { background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.9em; transition: all 0.3s ease; }
        .logout-btn:hover { background: #ff5252; }
        .breadcrumb { display: flex; align-items: center; gap: 10px; color: #666; font-size: 1.1em; }
        .breadcrumb a { color: #1e3c72; text-decoration: none; }
        .back-btn { background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .back-btn:hover { background: #5a6268; transform: translateY(-1px); }

        /* === INDEXING SAYFASINA AÄ°T ORÄ°JÄ°NAL STÄ°LLER === */
        .page-header-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; margin-bottom: 30px; }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .form-container { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .notification-message { padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .notification-message.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .notification-message.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .notification-message.info { background: #cce5ff; color: #004085; border-left: 4px solid #007bff; }
        .form-group { margin-bottom: 25px; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        /* Font dÃ¼zenlemesi iÃ§in form-input, form-select'e ekleme */
        .form-input, .form-select, .form-textarea { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #e1e8ed; 
            border-radius: 10px; 
            font-size: 1em; 
            transition: all 0.3s ease; 
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Eklenen stil */
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #1e3c72; box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1); }
        .form-input.error-field { border-color: #ff6b6b; }
        .error-message { color: #ff6b6b; font-size: 0.85em; margin-top: 5px; display: none; }
        .file-upload-area { border: 2px dashed #e1e8ed; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: all 0.3s ease; }
        .file-upload-area:hover { border-color: #1e3c72; background: #f0f4f8; }
        .file-list { margin-top: 15px; }
        .file-item { display: flex; flex-direction: column; justify-content: space-between; align-items: flex-start; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .file-item > span { font-weight: 500; color: #333; margin-bottom: 5px; }
        /* Dosya kontrol alanÄ±ndaki input ve select'i yan yana yapmak iÃ§in flex kullanÄ±ldÄ± */
        .file-item-controls { display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%; }
        /* file-item-select iÃ§in font dÃ¼zenlemesi */
        .file-item-select { flex-grow: 1; min-width: 150px; width: 100%; padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.85em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .remove-file { background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.3s ease; flex-shrink: 0; margin-top: 5px; align-self: flex-end; }
        .remove-file:hover { background: #c82333; }
        .form-actions { display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #e1e8ed; justify-content: flex-end; }
        .btn { padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        .btn-primary { background: linear-gradient(45deg, #1e3c72, #2a5298); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(30, 60, 114, 0.3); }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; transform: none; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid #ffffff; border-radius: 50%; border-top-color: transparent; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .record-search-section { padding-bottom: 20px; margin-bottom: 30px; border-bottom: 1px solid #e1e8ed; }
        .search-results-container { max-height: 250px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; margin-top: 15px; }
        .record-search-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px dashed #e1e8ed; cursor: pointer; transition: background-color 0.2s ease; }
        .record-search-item:last-child { border-bottom: none; }
        .record-search-item:hover { background-color: #f0f4f8; }
        .record-search-item.selected { background-color: #e6f2ff; border-color: #a3d2ff; }
        .record-info { flex-grow: 1; }
        .record-title { font-weight: 600; color: #1e3c72; margin-bottom: 3px; }
        .record-meta { font-size: 0.8em; color: #666; }
        .no-results-message { text-align: center; color: #999; padding: 20px; }
        .indexing-transaction-history { margin-top: 20px; padding: 10px; border-top: 1px solid #e1e8ed; max-height: 250px; overflow-y: auto; }
        .transaction-node { position: relative; padding: 8px 0 8px 25px; border-bottom: 1px dashed #eee; }
        .transaction-node:last-child { border-bottom: none; }
        .transaction-node-content { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .transaction-info { flex-grow: 1; }
        .transaction-description { font-size: 0.9em; color: #333; font-weight: 600;}
        .transaction-meta { font-size: 0.8em; color: #666; white-space: nowrap; margin-top: 4px;}
        .transaction-document-link { font-size: 0.8em; color: #007bff; text-decoration: none; }
        .transaction-document-link:hover { text-decoration: underline; }
        .transaction-toggle-btn { position: absolute; left: 0; top: 10px; background: #e9ecef; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 1em; font-weight: bold; line-height: 20px; text-align: center; cursor: pointer; transition: background 0.2s ease, transform 0.2s ease; }
        .transaction-toggle-btn:hover { background: #d0d0d0; }
        .transaction-toggle-btn.expanded { transform: rotate(45deg); }
        .child-transactions { margin-left: 20px; padding: 15px; border-left: 2px solid #1e3c72; display: none; }
        .child-transactions.show { display: block; }
        .transaction-actions { display: flex; gap: 5px; }
        .transaction-action-btn { padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.75em; transition: all 0.3s ease; }
        .btn-edit-transaction { background: #ffc107; color: #212529; }
        .btn-edit-transaction:hover { background: #e0a800; }
        .btn-delete-transaction { background: #dc3545; color: white; }
        .btn-delete-transaction:hover { background: #c82333; }
        @media (max-width: 768px) { .form-actions { flex-direction: column; } .btn { width: 100%; } .file-item-controls { flex-direction: column; align-items: stretch; } .file-item-select, .remove-file { width: 100%; } }
    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">ğŸ”¥ IP Manager</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-category-title">Ana MenÃ¼</div>
            <a href="dashboard.html" class="sidebar-nav-item"><span class="nav-icon">ğŸ“Š</span><span>Dashboard</span></a>
            <a href="portfolio.html" class="sidebar-nav-item"><span class="nav-icon">ğŸ“‹</span><span>PortfÃ¶y</span></a>
            <div class="nav-category-title">Veri GiriÅŸi</div>
            <a href="data-entry.html" class="sidebar-nav-item"><span class="nav-icon">â•</span><span>Yeni KayÄ±t</span></a>
            <a href="excel-upload.html" class="sidebar-nav-item"><span class="nav-icon">ğŸ“„</span><span>Excel ile YÃ¼kle</span></a>
            <div class="nav-category-title">YÃ¶netim</div>
          <div class="accordion">
    <div class="accordion-header"><span class="nav-icon">âš™ï¸</span><span>YÃ¶netim</span></div>
    <div class="accordion-content">
        <a href="create-task.html" class="new-task-link">Yeni Ä°ÅŸ OluÅŸtur</a>
        
        <a href="task-management.html">Ä°ÅŸ YÃ¶netimi</a>
        <a href="my-tasks.html">Ä°ÅŸlerim</a>
        <a href="persons.html">KiÅŸiler YÃ¶netimi</a>
        <a href="user-management.html">KullanÄ±cÄ± YÃ¶netimi</a>
    </div>
</div>
            <div class="nav-category-title">AraÃ§lar</div>
            <a href="indexing.html" class="sidebar-nav-item"><span class="nav-icon">ğŸ“</span><span>Belge Ä°ndeksleme</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">ğŸ“ˆ</span><span>Raporlar</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">ğŸ”§</span><span>Ayarlar</span></a>
        </nav>
    </aside>

    <div class="page-wrapper">
        <header class="top-header">
            <div class="breadcrumb">
                <a href="portfolio.html">PortfÃ¶y</a>
                <span>&gt;</span>
                <span>Belge Ä°ndeksleme</span>
            </div>
             <div class="user-section">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="userName">YÃ¼kleniyor...</div>
                    <div class="user-role" id="userRole">KullanÄ±cÄ±</div>
                </div>
                <button class="logout-btn" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </header>

        <main class="main-container">
            <div class="page-header-section">
                <h1 class="page-title">Belge Ä°ndeksleme</h1>
                <p class="page-subtitle">Mevcut fikri mÃ¼lkiyet kayÄ±tlarÄ±na belge ekleyin ve indeksleyin.</p>
            </div>
    
            <div class="form-container">
                <div class="notification-message success" id="formSuccessMessage" style="display: none;"><span>âœ…</span><span id="formSuccessText">Belgeler baÅŸarÄ±yla indekslendi!</span></div>
                <div class="notification-message error" id="formErrorMessage" style="display: none;"><span>âŒ</span><span id="formErrorText">Bir hata oluÅŸtu. LÃ¼tfen tekrar deneyin.</span></div>
                <div class="notification-message info" id="formInfoMessage" style="display: none;"><span>â„¹ï¸</span><span id="formInfoText"></span></div>
    
                <form id="indexingForm" onsubmit="return false;">
                    <div class="form-section record-search-section">
                        <h2 class="section-title"><span class="section-icon">ğŸ”</span>1. KayÄ±t SeÃ§in</h2>
                        <div class="form-group"><label class="form-label" for="recordSearchInput">BaÅŸvuru NumarasÄ± veya BaÅŸlÄ±k ile Ara</label><input type="text" id="recordSearchInput" class="form-input" placeholder="Ã–rn: TR2024/123, Proje X..."></div>
                        <div class="search-results-container" id="searchResultsContainer"><p class="no-results-message">Arama yapmak iÃ§in yukarÄ±ya yazÄ±n.</p></div>
                        <div class="form-group" style="margin-top: 20px;"><label class="form-label">SeÃ§ili KayÄ±t:</label><input type="text" id="selectedRecordDisplay" class="form-input" readonly placeholder="HenÃ¼z kayÄ±t seÃ§ilmedi."><div class="error-message" id="recordSelectError">LÃ¼tfen indeksleme yapacaÄŸÄ±nÄ±z kaydÄ± seÃ§in.</div></div>
                    </div>
    
                    <div class="form-section document-upload-section" id="documentUploadSection" style="display: none;">
                        <h2 class="section-title"><span class="section-icon">ğŸ“</span>2. Belgeleri YÃ¼kleyin ve Ä°ndeksleyin</h2>
                        <div class="form-group">
                            <label class="form-label" for="parentTransactionSelect">Ä°lgili Ãœst Ä°ÅŸlem SeÃ§in (Opsiyonel)</label>
                            <select id="parentTransactionSelect" class="form-select">
                                <option value="">Yok (Ana Belge)</option>
                            </select>
                            <p class="help-text">YÃ¼klediÄŸiniz belgeler, seÃ§tiÄŸiniz Ã¼st iÅŸlem altÄ±nda alt iÅŸlem olarak iliÅŸkilendirilecektir.</p>
                        </div>
                        <div class="form-group"><div class="file-upload-area" id="fileUploadArea"><div class="upload-icon">ğŸ“„</div><div>DosyalarÄ± buraya sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n</div><div class="help-text">PDF, DOC, JPG, PNG formatlarÄ± (Maks. 10MB)</div><input type="file" id="fileInput" multiple hidden accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"></div><div class="file-list" id="fileList"></div></div>
                    </div>
    
                    <div class="form-section record-update-section" id="recordUpdateSection" style="display: none;">
                        <h2 class="section-title"><span class="section-icon">âœï¸</span>3. KayÄ±t Bilgilerini GÃ¼ncelle (Ä°steÄŸe BaÄŸlÄ±)</h2>
                        <div class="form-group"><label class="form-label" for="updateRecordStatus">Durum</label><select id="updateRecordStatus" class="form-select"><option value="">DeÄŸiÅŸtirmeyin</option></select></div>
                        </div>
    
                    <div class="form-section transaction-history-indexing-section" id="indexingTransactionHistorySection" style="display: none;">
                        <h2 class="section-title"><span class="section-icon">ğŸ“œ</span>4. KayÄ±t GeÃ§miÅŸi</h2>
                        <div class="indexing-transaction-history" id="indexingTransactionHistory">
                            <p style="text-align: center; color: #666;">Ä°ÅŸlem geÃ§miÅŸi yÃ¼kleniyor...</p>
                        </div>
                    </div>
    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="resetIndexingFormBtn">Temizle</button>
                        <button type="submit" class="btn btn-primary" id="indexDocumentsBtn" disabled><span id="indexBtnText">Belgeleri Ä°ndeksle ve Kaydet</span><span class="loading-spinner" id="indexBtnLoading" style="display: none;"></span></button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { authService, ipRecordsService, auth, generateUUID, subDesignationTranslations, documentDesignationTranslations } from './firebase-config.js';

        class IndexingModule {
            constructor() {
                this.currentUser = null;
                this.allRecords = []; 
                this.selectedRecord = null; 
                this.uploadedFiles = [];
                this.originalRecordData = null; 
                this.allDocumentDesignations = [ 
                    'BaÅŸvuru Ek DokÃ¼manÄ±',
                    'Resmi YazÄ±ÅŸma',
                    'Vekaletname',
                    'Teknik Ã‡izim',
                    'Karar',
                    'Finansal Belge',
                    'YayÄ±n KararÄ±',
                    'Ret KararÄ±',
                    'Tescil Belgesi',
                    'AraÅŸtÄ±rma Raporu',
                    'Ä°nceleme Raporu',
                    'DiÄŸer Belge',
                    'Genel Not'
                ];
                this.currentDocumentDesignations = []; // Dynamically populated
                this.existingDocumentIndexedTransactions = []; // Unused in provided snippet
                this.init();
            }

            init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        this.updateUserInfo();
                        this.initializeEventListeners();
                        await this.loadRecords(); // allRecords'u yÃ¼kler
                        this.populateStatusOptions();
                        // this.renderSearchResults(this.allRecords); // Ä°lk baÅŸta tÃ¼m kayÄ±tlarÄ± gÃ¶sterme kaldÄ±rÄ±ldÄ±
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0] || 'KullanÄ±cÄ±';
                    const userRole = this.currentUser.role === 'admin' ? 'YÃ¶netici' : this.currentUser.role === 'superadmin' ? 'SÃ¼per YÃ¶netici' : 'KullanÄ±cÄ±';
                    
                    document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userRole').textContent = userRole;
                }
            }

            initializeEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => authService.signOut());
                document.getElementById('recordSearchInput').addEventListener('input', (e) => this.searchRecords(e.target.value));
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFiles(e.target.files));
                document.getElementById('fileUploadArea').addEventListener('click', () => document.getElementById('fileInput').click());
                
                document.getElementById('fileUploadArea').addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.currentTarget.style.borderColor = '#1e3c72';
                    e.currentTarget.style.background = '#f0f4f8';
                });
                document.getElementById('fileUploadArea').addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    e.currentTarget.style.borderColor = '#e1e8ed';
                    e.currentTarget.style.background = 'transparent';
                });
                document.getElementById('fileUploadArea').addEventListener('drop', (e) => {
                    e.preventDefault();
                    e.currentTarget.style.borderColor = '#e1e8ed';
                    e.currentTarget.style.background = 'transparent';
                    this.handleFiles(e.dataTransfer.files);
                });

                document.getElementById('resetIndexingFormBtn').addEventListener('click', () => this.resetForm());
                document.getElementById('indexDocumentsBtn').addEventListener('click', () => this.handleSubmit());
                
                // KayÄ±t geÃ§miÅŸi akordiyonu iÃ§in olay dinleyicisi ekle
                document.getElementById('indexingTransactionHistory').addEventListener('click', (e) => {
                    if (e.target.classList.contains('transaction-toggle-btn')) {
                        const btn = e.target;
                        const targetId = btn.dataset.targetId;
                        const childContainer = document.getElementById(`children-of-${targetId}`);
                        if (childContainer) {
                            childContainer.classList.toggle('show');
                            btn.classList.toggle('expanded');
                            btn.textContent = childContainer.classList.contains('show') ? 'âˆ’' : '+';
                        }
                    }
                });
            }

            populateStatusOptions() {
                const statusSelect = document.getElementById('updateRecordStatus');
                statusSelect.innerHTML = '<option value="">DeÄŸiÅŸtirmeyin</option>';
                const statusTranslations = { 
                    'application': 'BaÅŸvuru',
                    'pending': 'Beklemede',
                    'approved': 'OnaylandÄ±',
                    'rejected': 'Reddedildi',
                    'expired': 'SÃ¼resi Doldu',
                    'published': 'YayÄ±nlandÄ±',
                    'partial_refusal': 'KÄ±smi Ret',
                    'refused': 'Ret',
                    'opposition_received': 'Ä°tiraz Geldi',
                    'opposition_filed': 'Ä°tiraz Edildi',
                    'registered': 'Tescilli',
                    'not_renewed': 'Yenilenmedi',
                    'invalid_void': 'GeÃ§ersiz/HÃ¼kÃ¼msÃ¼z'
                };
                const allStatuses = [ 
                    'application', 'pending', 'approved', 'rejected', 'expired',
                    'published', 'partial_refusal', 'refused', 'opposition_received',
                    'opposition_filed', 'registered', 'not_renewed', 'invalid_void'
                ];

                allStatuses.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status;
                    option.textContent = statusTranslations[status] || status.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    statusSelect.appendChild(option);
                });
            }

            async loadRecords() {
                const result = await ipRecordsService.getRecords();
                if (result.success) {
                    this.allRecords = result.data;
                    // this.renderSearchResults(this.allRecords); // Ä°lk baÅŸta tÃ¼m kayÄ±tlarÄ± gÃ¶sterme kaldÄ±rÄ±ldÄ±
                } else {
                    this.showNotification('KayÄ±tlar yÃ¼klenemedi: ' + result.error, 'error');
                }
            }

            searchRecords(query) {
                const searchResultsContainer = document.getElementById('searchResultsContainer');
                searchResultsContainer.innerHTML = '';
                if (query.length < 3) {
                    searchResultsContainer.innerHTML = '<p class="no-results-message">Arama yapmak iÃ§in yukarÄ±ya yazÄ±n.</p>';
                    this.toggleIndexButton();
                    return;
                }

                const searchLower = query.toLowerCase();
                const filtered = this.allRecords.filter(record => 
                    (record.title && record.title.toLowerCase().includes(searchLower)) ||
                    (record.applicationNumber && record.applicationNumber.toLowerCase().includes(searchLower))
                );
                
                this.renderSearchResults(filtered);
            }

            renderSearchResults(records) {
                const searchResultsContainer = document.getElementById('searchResultsContainer');
                searchResultsContainer.innerHTML = '';
                if (records.length === 0) {
                    searchResultsContainer.innerHTML = '<p class="no-results-message">KayÄ±t bulunamadÄ±.</p>';
                    return;
                }

                records.forEach(record => {
                    const item = document.createElement('div');
                    item.className = 'record-search-item';
                    item.dataset.id = record.id;
                    item.innerHTML = `
                        <div class="record-info">
                            <div class="record-title">${record.title}</div>
                            <div class="record-meta">${record.applicationNumber || 'Numara Yok'} | ${record.type}</div>
                        </div>
                    `;
                    item.addEventListener('click', () => this.selectRecord(record.id));
                    searchResultsContainer.appendChild(item);
                });
            }

            selectRecord(recordId) {
                this.selectedRecord = this.allRecords.find(r => r.id === recordId);
                if (!this.selectedRecord) return;

                document.getElementById('selectedRecordDisplay').value = `${this.selectedRecord.title} (${this.selectedRecord.applicationNumber || 'Numara Yok'})`;
                
                document.getElementById('documentUploadSection').style.display = 'block';
                document.getElementById('recordUpdateSection').style.display = 'block';
                document.getElementById('indexingTransactionHistorySection').style.display = 'block';
                
                document.getElementById('recordSelectError').style.display = 'none';

                this.uploadedFiles = [];
                this.updateFileList();
                
                // Parent transaction seÃ§eneklerini doldur
                this.populateParentTransactionSelect(this.selectedRecord.transactions);
                this.renderTransactionHistory(this.selectedRecord.id, this.selectedRecord.transactions, this.selectedRecord.files);

                this.toggleIndexButton();
            }
            
            showNotification(message, type = 'info') {
                const successMessage = document.getElementById('formSuccessMessage');
                const errorMessage = document.getElementById('formErrorMessage');
                const infoMessage = document.getElementById('formInfoMessage');

                successMessage.style.display = 'none';
                errorMessage.style.display = 'none';
                infoMessage.style.display = 'none';

                let targetMessage;
                let targetText;

                switch (type) {
                    case 'success':
                        targetMessage = successMessage;
                        targetText = document.getElementById('formSuccessText');
                        break;
                    case 'error':
                        targetMessage = errorMessage;
                        targetText = document.getElementById('formErrorText');
                        break;
                    case 'info':
                        targetMessage = infoMessage;
                        targetText = document.getElementById('formInfoText');
                        break;
                    default:
                        targetMessage = infoMessage;
                        targetText = document.getElementById('infoText');
                }

                if (targetMessage && targetText) {
                    targetText.textContent = message;
                    targetMessage.style.display = 'flex';
                    setTimeout(() => {
                        targetMessage.style.display = 'none';
                    }, 5000); // 5 saniye sonra bildirimi kapat
                }
            }

            toggleLoading(isLoading) {
                const btn = document.getElementById('indexDocumentsBtn');
                const text = document.getElementById('indexBtnText');
                const spinner = document.getElementById('indexBtnLoading');
                
                if (btn) btn.disabled = isLoading;
                if (text) text.style.display = isLoading ? 'none' : 'inline';
                if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
            }

            toggleIndexButton() {
                // Sadece kayÄ±t seÃ§iliyse ve yÃ¼klenecek dosya varsa butonu etkinleÅŸtir
                document.getElementById('indexDocumentsBtn').disabled = !(this.selectedRecord && this.uploadedFiles.length > 0);
            }

            handleFiles(files) {
                for (const file of files) {
                    if (file.size > 10 * 1024 * 1024) { // 10MB limit
                        this.showNotification(`"${file.name}" dosyasÄ± 10MB'tan bÃ¼yÃ¼k ve yÃ¼klenemedi.`, 'error');
                        continue;
                    }
                    if (this.uploadedFiles.some(f => f.name === file.name && f.size === file.size)) {
                        this.showNotification(`"${file.name}" dosyasÄ± zaten eklenmiÅŸ.`, 'info');
                        continue;
                    }

                    this.readFileAsDataURL(file).then(dataUrl => {
                        this.uploadedFiles.push({
                            id: generateUUID(),
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            content: dataUrl,
                            uploadedAt: new Date().toISOString(),
                            documentDesignation: this.allDocumentDesignations[0] || 'DiÄŸer Belge', // VarsayÄ±lan deÄŸer
                            subDesignation: '',
                            indexingType: 'Kabul KararÄ±', // VarsayÄ±lan indeksleme tipi
                            indexingName: 'Kabul KararÄ±' // VarsayÄ±lan indeksleme adÄ± (artÄ±k tip ile aynÄ±)
                        });
                        this.updateFileList();
                        this.toggleIndexButton();
                    }).catch(error => {
                        console.error("Dosya okuma hatasÄ±:", error);
                        this.showNotification(`"${file.name}" dosyasÄ± okunamadÄ±.`, 'error');
                    });
                }
            }

            updateFileList() {
                const fileList = document.getElementById('fileList');
                fileList.innerHTML = '';
                if (this.uploadedFiles.length === 0) {
                    return;
                }

                const indexingTypes = ['Kabul KararÄ±', 'Ret KararÄ±', 'Eksiklik Bildirimi']; // Ä°ndeksleme tipleri

                this.uploadedFiles.forEach(file => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.dataset.id = file.id;

                    fileItem.innerHTML = `
                        <div style="flex-grow: 1;">
                            <span>**Dosya AdÄ±:** ${file.name} (${this.formatFileSize(file.size)})</span>
                            <div style="display: flex; gap: 10px; margin-top: 5px; flex-wrap: wrap;">
                                <div class="form-group" style="margin-bottom: 0; flex-basis: 98%;"> <label class="form-label" style="font-size: 0.8em; margin-bottom: 2px;">Ä°ndeksleme Tipi</label>
                                    <select class="form-select file-indexing-type" data-id="${file.id}">
                                        ${indexingTypes.map(type => `<option value="${type}" ${file.indexingType === type ? 'selected' : ''}>${type}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="remove-file" data-id="${file.id}">&times;</button>
                    `;
                    
                    // Ä°ndeksleme AdÄ± input'u kaldÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in ilgili event listener da kaldÄ±rÄ±ldÄ±.
                    fileItem.querySelector('.file-indexing-type').addEventListener('change', (e) => {
                        const updatedFile = this.uploadedFiles.find(f => f.id === file.id);
                        if (updatedFile) {
                            updatedFile.indexingType = e.target.value;
                            updatedFile.indexingName = e.target.value; // Ä°ndeksleme adÄ± artÄ±k tip ile aynÄ±
                        }
                    });
                    fileItem.querySelector('.remove-file').addEventListener('click', () => this.removeFile(file.id));

                    fileList.appendChild(fileItem);
                });
            }


            removeFile(id) {
                this.uploadedFiles = this.uploadedFiles.filter(file => file.id !== id);
                this.updateFileList();
                this.toggleIndexButton();
            }

            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            async handleSubmit() {
                if (!this.selectedRecord) {
                    document.getElementById('recordSelectError').style.display = 'block';
                    return;
                }
                if (this.uploadedFiles.length === 0) {
                    this.showNotification('LÃ¼tfen en az bir belge yÃ¼kleyin.', 'error');
                    return;
                }
                document.getElementById('recordSelectError').style.display = 'none';

                this.toggleLoading(true);

                const selectedParentTransactionId = document.getElementById('parentTransactionSelect').value || null;

                // DosyalarÄ±, parentTransactionId, indexingType ve indexingName bilgileriyle birlikte updates objesine ekle
                const filesToUpdate = this.uploadedFiles.map(file => ({
                    id: file.id,
                    name: file.name,
                    type: file.type,
                    content: file.content,
                    uploadedAt: file.uploadedAt,
                    documentDesignation: file.documentDesignation,
                    subDesignation: file.subDesignation || null,
                    parentTransactionId: selectedParentTransactionId, // SeÃ§ilen parent ID'yi ata
                    indexingType: file.indexingType, // Yeni eklenen indeksleme tipi
                    indexingName: file.indexingName // Yeni eklenen indeksleme adÄ± (artÄ±k tip ile aynÄ±)
                }));

                const updates = {
                    files: filesToUpdate, // GÃ¼ncellenmiÅŸ files dizisini ata
                    status: document.getElementById('updateRecordStatus').value || this.selectedRecord.status,
                    notes: null // Notlar alanÄ± kaldÄ±rÄ±ldÄ±ÄŸÄ± iÃ§in null olarak ayarlandÄ±
                };

                try {
                    const result = await ipRecordsService.updateRecord(this.selectedRecord.id, updates);
                    if (result.success) {
                        this.showNotification('Belgeler baÅŸarÄ±yla indekslendi ve kayÄ±t gÃ¼ncellendi!', 'success');
                        this.resetForm(); // Formu temizle
                        await this.loadRecords(); // KayÄ±tlarÄ± yeniden yÃ¼kle (gÃ¼ncel transaction'larla birlikte)
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Belge indeksleme hatasÄ±:', error);
                    this.showNotification('Belge indeksleme sÄ±rasÄ±nda bir hata oluÅŸtu: ' + error.message, 'error');
                } finally {
                    this.toggleLoading(false);
                }
            }

            resetForm() {
                this.selectedRecord = null;
                this.uploadedFiles = [];
                document.getElementById('recordSearchInput').value = '';
                document.getElementById('selectedRecordDisplay').value = '';
                document.getElementById('documentUploadSection').style.display = 'none';
                document.getElementById('recordUpdateSection').style.display = 'none';
                document.getElementById('indexingTransactionHistorySection').style.display = 'none';
                document.getElementById('fileList').innerHTML = '';
                document.getElementById('updateRecordStatus').value = '';
                // document.getElementById('updateRecordNotes').value = ''; // Notlar alanÄ± kaldÄ±rÄ±ldÄ±
                document.getElementById('recordSelectError').style.display = 'none';
                // Parent transaction select'i sÄ±fÄ±rla
                const parentTxSelect = document.getElementById('parentTransactionSelect');
                if (parentTxSelect) {
                    parentTxSelect.innerHTML = '<option value="">Yok (Ana Belge)</option>';
                }
                this.toggleIndexButton();
                this.showNotification('Form temizlendi.', 'info');
            }
            
            // Bu metot IndexingModule sÄ±nÄ±fÄ±nÄ±n iÃ§inde doÄŸru yerde olmalÄ±
            populateParentTransactionSelect(transactions) {
                const selectElement = document.getElementById('parentTransactionSelect');
                if (!selectElement) { 
                    console.warn("parentTransactionSelect elementi bulunamadÄ±. Bu form tipi iÃ§in gerekli deÄŸil mi?");
                    return;
                }

                selectElement.innerHTML = '<option value="">Yok (Ana Belge)</option>'; // VarsayÄ±lan seÃ§enek
                
                if (!transactions || transactions.length === 0) {
                    return;
                }

                // Sadece parent transaction'larÄ± (parentId null olanlarÄ±) filtrele
                const parentTransactions = transactions.filter(tx => tx.parentId === null);

                if (parentTransactions.length > 0) {
                    parentTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) // En yeni Ã¼ste
                                    .forEach(tx => {
                        const option = document.createElement('option');
                        option.value = tx.transactionId;
                        option.textContent = `${new Date(tx.timestamp).toLocaleDateString('tr-TR')} - ${tx.description || tx.type}`; // description veya type gÃ¶ster
                        selectElement.appendChild(option);
                    });
                }
            }

            renderTransactionHistory(recordId, transactions, recordFiles) {
                const historyContainer = document.getElementById('indexingTransactionHistory');
                historyContainer.innerHTML = '';

                if (!transactions || transactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Ä°ÅŸlem geÃ§miÅŸi bulunmuyor.</p>';
                    return;
                }

                // Sadece belge indeksleme sonucu oluÅŸan transaction'lar ve iÅŸ oluÅŸturma sonucu kaydedilen transaction'lar
                const displayableTransactionTypes = [
                    "Document Indexed",
                    "Document Sub-Indexed",
                    // create-task.html'den gelen iÅŸ tipleri (portfolio.html'deki ile aynÄ± liste)
                    'BaÅŸvuru', 'Ä°tiraza KarÅŸÄ± GÃ¶rÃ¼ÅŸ (YIDD)', 'Yenileme', 'Eksiklik Giderme', 'YayÄ±na Ä°tiraz',
                    'Karara Ä°tiraz', 'YayÄ±ma Ä°tirazÄ±n Yeniden Ä°ncelenmesi', 'Ä°tiraza KarÅŸÄ± GÃ¶rÃ¼ÅŸ (Markalar)',
                    'Devir', 'Lisans', 'BirleÅŸme', 'Veraset ile Ä°ntikal', 'Tescil Belgesi Sureti',
                    'Sicil Sureti', 'MenÅŸe Memleket Belgesi', 'Rehin/Teminat', 'BÃ¶lÃ¼nme', 'VazgeÃ§me',
                    'TanÄ±nmÄ±ÅŸlÄ±k Tespiti', '3.KiÅŸi GÃ¶rÃ¼ÅŸÃ¼', 'YayÄ±na Ä°tirazÄ± Geri Ã‡ekme',
                    'Madrid BaÅŸvurusu Ãœcret Ã–deme', 'Muvaffakat Sunumu', 'KullanÄ±m Ä°spatÄ± Sunma',
                    'Ä°tiraza Ek Belge', 'EÅŸya SÄ±nÄ±rlandÄ±rma',
                    // Ä°ndeksleme Tipleri (Belge Ä°ndeksleme modÃ¼lÃ¼ne Ã¶zel)
                    'Kabul KararÄ±', 'Ret KararÄ±', 'Eksiklik Bildirimi'
                ];

                const relevantTransactions = transactions.filter(tx => 
                    displayableTransactionTypes.includes(tx.type) || // Ana iÅŸ tipi olarak gelenler (create-task'ten)
                    displayableTransactionTypes.includes(tx.description) // Ä°ndeksleme tipleri (indexing.html'den)
                ).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Tarihe gÃ¶re sÄ±rala


                if (relevantTransactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">GÃ¶sterilebilir iÅŸlem bulunmuyor.</p>';
                    return;
                }

                const transactionsMap = new Map(relevantTransactions.map(tx => [tx.transactionId, tx]));
                const childrenMap = new Map();
                
                relevantTransactions.forEach(tx => {
                    if (tx.parentId && transactionsMap.has(tx.parentId)) { // Sadece parent'Ä± da listede olanlarÄ± child yap
                        if (!childrenMap.has(tx.parentId)) childrenMap.set(tx.parentId, []);
                        childrenMap.get(tx.parentId).push(tx);
                    }
                });

                const buildTreeHtml = (transactionsToBuild) => {
                    let html = '';
                    transactionsToBuild.forEach(tx => {
                        const children = childrenMap.get(tx.transactionId) || [];
                        const hasChildren = children.length > 0;
                        let documentLinkHtml = '';
                        if (tx.documentId && recordFiles) {
                            const relatedFile = recordFiles.find(file => file.id === tx.documentId);
                            if (relatedFile) documentLinkHtml = ` | <a href="${relatedFile.content}" download="${relatedFile.name}" class="transaction-document-link">ğŸ“„ Belge</a>`;
                        }
                        html += `
                            <div class="transaction-node" data-id="${tx.transactionId}">
                                ${hasChildren ? `<button class="transaction-toggle-btn" data-target-id="${tx.transactionId}">+</button>` : ''}
                                <div class="transaction-node-content">
                                    <div class="transaction-info">
                                        <div class="transaction-description">${tx.description || tx.type}</div> 
                                        <div class="transaction-meta">${new Date(tx.timestamp).toLocaleDateString('tr-TR')} by ${tx.userEmail}${documentLinkHtml}</div>
                                    </div>
                                    <div class="transaction-actions">
                                        </div>
                                </div>
                            </div>
                            ${hasChildren ? `<div class="child-transactions" id="children-of-${tx.transactionId}">${buildTreeHtml(children)}</div>` : ''}`;
                    });
                    return html;
                };

                const rootTransactions = relevantTransactions.filter(tx => !tx.parentId || !transactionsMap.has(tx.parentId));
                historyContainer.innerHTML = buildTreeHtml(rootTransactions);

                if (rootTransactions.length === 0) {
                    historyContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">GÃ¶sterilebilir iÅŸlem bulunmuyor.</p>';
                }
            }
        }

        window.indexingModule = new IndexingModule();

        // YENÄ° AKORDÄ°YON MENÃœ Ä°Ã‡Ä°N JAVASCRIPT
        document.addEventListener('DOMContentLoaded', function() {
    // --- Akordiyon MenÃ¼ TÄ±klama Fonksiyonu ---
    const accordions = document.querySelectorAll('.accordion-header');
    accordions.forEach(accordion => {
        accordion.addEventListener('click', function(event) {
            // Akordiyonu aÃ§/kapat
            this.classList.toggle('active');
            const content = this.nextElementSibling;
            if (content.style.maxHeight) {
                content.style.maxHeight = null;
            } else {
                content.style.maxHeight = content.scrollHeight + "px";
            }
        });
    });

    // --- Sayfa YÃ¼klendiÄŸinde Aktif MenÃ¼yÃ¼ Ayarlama Fonksiyonu ---
    function setActiveMenu() {
        const currentPage = window.location.pathname.split("/").pop() || 'dashboard.html';
        
        // Ã–nce tÃ¼m aktif iÅŸaretlerini temizle
        document.querySelectorAll('.sidebar-nav-item.active, .accordion-content a.active').forEach(el => el.classList.remove('active'));
        
        // Mevcut sayfanÄ±n linkini bul ve aktif yap
        const activeLink = document.querySelector(`.sidebar-nav a[href="${currentPage}"]`);
        if (!activeLink) return;

        activeLink.classList.add('active');
        
        // EÄŸer link bir akordiyon iÃ§indeyse, akordiyonu aÃ§ ve baÅŸlÄ±ÄŸÄ±nÄ± aktif et
        const parentAccordionContent = activeLink.closest('.accordion-content');
        if (parentAccordionContent) {
            const parentAccordionHeader = parentAccordionContent.previousElementSibling;
            if (parentAccordionHeader && parentAccordionHeader.classList.contains('accordion-header')) {
                parentAccordionHeader.classList.add('active');
                parentAccordionContent.style.maxHeight = parentAccordionContent.scrollHeight + "px";
            }
        }
    }

    // Sayfa ilk yÃ¼klendiÄŸinde aktif menÃ¼yÃ¼ ayarla
    setActiveMenu();
});
    </script>
</body>
</html>