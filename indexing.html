<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Belge İndeksleme</title>
    <link rel="stylesheet" href="css/shared-styles.css"> 
    <style>
        /* Genel CSS stilleri */
        .main-container { width: 100%; padding: 30px; margin: 0; }
        .page-header-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; margin-bottom: 30px; }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .form-container { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .form-section { border-bottom: 1px solid #e1e8ed; padding-bottom: 25px; margin-bottom: 25px; }
        .form-section:last-child { border-bottom: none; }
        .section-title { font-size: 1.3em; color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .form-actions { display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #e1e8ed; justify-content: flex-end; }
        .btn { padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; }
        
        .search-wrapper { position: relative; }
        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: white;
            z-index: 100;
            display: none;
        }
        
        .record-search-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px dashed #e1e8ed; cursor: pointer; }
        .record-search-item:hover { background-color: #f0f4f8; }
        .record-search-item:last-child { border-bottom: none; }
        .record-search-item.selected { background-color: #e6f2ff; }

        .file-list { margin-top: 15px; }
        .file-item { display: flex; flex-direction: column; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .file-item-controls { display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .file-item-select { flex-grow: 1; min-width: 150px; padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.85em; }
        .remove-file { background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; flex-shrink: 0; align-self: center; }

        .tabs-container { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 1rem; }
        .tab-btn { padding: 0.75rem 1.25rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: #6c757d; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #1e3c72; border-color: #1e3c72; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; } 
        .transaction-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 5px; }
        .transaction-list-item { padding: 10px; cursor: pointer; border-radius: 6px; }
        .transaction-list-item:hover { background-color: #f0f4f8; }
        .transaction-list-item.selected { background-color: #e6f2ff; color: #1e3c72; font-weight: bold; }

        .child-transaction-inputs {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e1e8ed;
            /* display: none; */ /* Bu kısım JS tarafından yönetileceği için kaldırıldı */
        }
        
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%; 
            cursor: pointer;
        }

        .file-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .file-upload-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8; 
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-button:hover {
            background-color: #e6f2ff;
            border-color: #a3d4ff;
        }

        .file-upload-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
            padding-left: 5px;
        }
    </style>
</head>
<body>
    <div id="notification-container" class="notification-container"></div>

    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <div class="page-header-section">
                <h1 class="page-title">Belge İndeksleme</h1>
                <p class="page-subtitle">Mevcut fikri mülkiyet kayıtlarına belge ekleyin ve indeksleyin.</p>
            </div>
    
            <div class="form-container">
                <form id="indexingForm" onsubmit="return false;">
        
                    <div class="form-section document-upload-section" id="documentUploadSection">
                        <h2 class="section-title"><span>1.</span>Belgeleri Yükleyin ve İndeksleyin</h2> 
                        
                        <div class="tabs-container">
                            <button type="button" class="tab-btn active" data-tab="existing-transaction-pane">İşleme Dosya Ekle</button>
                            <button type="button" class="tab-btn" data-tab="manual-indexing-pane">Manuel İşlem Oluştur</button>
                            <a href="bulk-indexing-page.html" class="tab-btn" data-tab="bulk-indexing-pane">Toplu İndeksleme</a>
                        </div>
                        
                        <div class="tab-content-container">
                            <div id="existing-transaction-pane" class="tab-pane active">
                                <div class="form-section record-search-section">
                                    <h2 class="section-title"><span>1.1</span>Kayıt Seçin</h2>
                                    <div class="form-group search-wrapper">
                                        <label class="form-label" for="recordSearchInputExisting">Başvuru Numarası veya Başlık ile Ara</label>
                                        <input type="text" id="recordSearchInputExisting" class="form-input" placeholder="Örn: TR2024/123, Proje X..." autocomplete="off">
                                        <div class="search-results-container" id="searchResultsContainerExisting">
                                            <p class="no-results-message p-2">Arama yapmak için yukarıya yazın.</p>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 20px;">
                                        <label class="form-label">Seçili Kayıt:</label>
                                        <input type="text" id="selectedRecordDisplayExisting" class="form-input" readonly placeholder="Henüz kayıt seçilmedi.">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">A- Ana İşlem Seçin <span style="color: red;">*</span></label>
                                    <div id="transactions-list-for-selection" class="transaction-list-container">
                                        <p class="text-muted p-2">Lütfen bir kayıt seçin.</p>
                                    </div>
                                </div>

                                <div id="childTransactionInputs" class="child-transaction-inputs" style="display: block;">
                                    <h4 class="section-title" style="font-size: 1.1em;">B- Alt İşlem Seçin <span style="color: red;">*</span></h4> <div class="form-group">
                                        <label class="form-label" for="specificChildTransactionType">Alt İşlem Türü</label>
                                        <select id="specificChildTransactionType" class="form-select" name="specificChildTransactionType">
                                            <option value="" disabled selected>Alt işlem türü seçin...</option> </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="existingChildTransactionDeliveryDate">Tebliğ Tarihi</label>
                                        <input type="date" id="existingChildTransactionDeliveryDate" class="form-input" name="existingChildTransactionDeliveryDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="filesExisting">C- Dosya Yükleyin <span style="color: red;">*</span></label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="filesExisting" multiple name="filesExisting">
                                        <div class="file-upload-button" id="filesExistingButton">Dosya Seç</div>
                                    </div>
                                    <div class="file-upload-info" id="filesExistingInfo">Henüz dosya seçilmedi.</div>
                                </div>
                                <div class="file-list" id="fileListExisting"></div>
                            </div>

                            <div id="manual-indexing-pane" class="tab-pane">
                                <div class="form-section record-search-section">
                                    <h2 class="section-title"><span>1.1</span>Kayıt Seçin</h2>
                                    <div class="form-group search-wrapper">
                                        <label class="form-label" for="recordSearchInputManual">Başvuru Numarası veya Başlık ile Ara</label>
                                        <input type="text" id="recordSearchInputManual" class="form-input" placeholder="Örn: TR2024/123, Proje X..." autocomplete="off">
                                        <div class="search-results-container" id="searchResultsContainerManual">
                                            <p class="no-results-message p-2">Arama yapmak için yukarıya yazın.</p>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 20px;">
                                        <label class="form-label">Seçili Kayıt:</label>
                                        <input type="text" id="selectedRecordDisplayManual" class="form-input" readonly placeholder="Henüz kayıt seçilmedi.">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="specificManualTransactionType">A- Ana İşlem Seçin <span style="color: red;">*</span></label> <select id="specificManualTransactionType" class="form-select" name="specificManualTransactionType">
                                        <option value="" disabled selected>İşlem türü seçin...</option>
                                        </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="specificManualChildTransactionType">B- Alt İşlem Seçin (İsteğe Bağlı)</label>
                                    <select id="specificManualChildTransactionType" class="form-select" name="specificManualChildTransactionType">
                                        <option value="" selected>Alt işlem türü seçin...</option>
                                        </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="manualChildTransactionDeliveryDate">Tebliğ Tarihi (Alt İşlem için)</label>
                                    <input type="date" id="manualChildTransactionDeliveryDate" class="form-input" name="manualChildTransactionDeliveryDate">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="filesManual">C- Dosya Yükleyin (İsteğe Bağlı)</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="filesManual" multiple name="filesManual">
                                        <div class="file-upload-button" id="filesManualButton">Dosya Seç</div>
                                    </div>
                                    <div class="file-upload-info" id="filesManualInfo">Henüz dosya seçilmedi.</div>
                                </div>
                                <div class="file-list" id="fileListManual"></div>
                            </div>
                            <div id="bulk-indexing-pane" class="tab-pane">
                                <p class="text-muted p-4">Toplu İndeksleme için lütfen "Toplu İndeksleme" sekmesine tıklayınız.</p>
                            </div>
                        </div>
                    </div>
        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" id="resetIndexingFormBtn">Temizle</button>
                            <button type="submit" class="btn btn-primary" id="indexDocumentsBtn" disabled>Değişiklikleri Kaydet</button>
                        </div>
                    </form>
                </div>
            </main>
        </div>
        
        <script type="module">
            import { authService, ipRecordsService, auth, generateUUID, transactionTypeService, taskService } from './firebase-config.js'; 
            import { getFirestore, writeBatch, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

            import { showNotification, formatFileSize, readFileAsDataURL, addMonthsToDate, isWeekend, isHoliday, findNextWorkingDay, TURKEY_HOLIDAYS } from './utils.js'; // Utils'ten yeni fonksiyonlar import edildi
            import { loadSharedLayout } from './js/layout-loader.js';
            // documentDesignationTranslations artık firebase-config.js'ten geliyor

            // Selcan'ın bilgilerini buraya tanımlıyoruz
            const SELCAN_UID = '5GD0KCpyeVUneDJq4pP0yxZEP6r1'; 
            const SELCAN_EMAIL = 'selcan@gmail.com'; 

            class IndexingModule {
                constructor() {
                    this.currentUser = null;
                    this.allRecords = []; 
                    this.selectedRecordExisting = null; 
                    this.selectedRecordManual = null; 
                    this.uploadedFiles = new Map(); // Key: tabId, Value: [{id, fileObject, designation}]
                    this.selectedTransactionId = null; 
                    this.activeTab = 'existing-transaction-pane';
                    this.allTransactionTypes = []; // Tüm işlem tiplerini tutacak
                    
                    this.init();
                }

                async init() {
                    this.currentUser = authService.getCurrentUser();
                    if(!this.currentUser) {
                        window.location.href = 'index.html';
                        return; 
                    }

                    await this.loadRecordsAndTransactionTypes(); 
                    this.setupEventListeners();
                    this.populateManualTransactionTypeSelect(); 
                    this.populateManualChildTransactionTypeSelect(); 
                    this.activateTab(this.activeTab); 
                }

                async loadRecordsAndTransactionTypes() {
                    try {
                        const [recordsResult, transactionTypesResult] = await Promise.all([
                            ipRecordsService.getRecords(),
                            transactionTypeService.getTransactionTypes() 
                        ]);

                        if (recordsResult.success) {
                            this.allRecords = recordsResult.data;
                            console.log('Tüm Kayıtlar yüklendi:', this.allRecords); 
                        }
                        else showNotification('Kayıtlar yüklenemedi: ' + recordsResult.error, 'error');

                        if (transactionTypesResult.success) {
                            this.allTransactionTypes = transactionTypesResult.data;
                            console.log('Tüm İşlem Tipleri yüklendi:', this.allTransactionTypes); 
                            const childHierarchyTypes = this.allTransactionTypes.filter(type => type.hierarchy === 'child');
                            console.log('Tüm İşlem Tipleri (Çocuk Hiyerarşisi):', childHierarchyTypes);
                        }
                        else showNotification('İşlem tipleri yüklenemedi: ' + transactionTypesResult.error, 'error');

                    } catch (error) {
                        showNotification('Veriler yüklenirken hata oluştu: ' + error.message, 'error');
                    }
                }

                activateTab = (tabName) => {
                    document.querySelectorAll('.tabs-container .tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                    
                    const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
                    if (activeBtn) {
                        activeBtn.classList.add('active');
                    }
                    const activePane = document.getElementById(tabName);
                    if (activePane) {
                        activePane.classList.add('active');
                    }

                    this.activeTab = tabName;
                    this.setRequiredFieldsForActiveTab(); 
                    this.checkFormCompleteness(); 
                }

                populateChildTransactionTypeSelect = (allowedChildTypeIds = []) => {
                    console.log('populateChildTransactionTypeSelect çağrıldı. İzin verilen Alt İşlem Türü ID\'leri:', allowedChildTypeIds); 
                    const selectEl = document.getElementById('specificChildTransactionType');
                    if (!selectEl) return;
                    selectEl.innerHTML = '<option value="" disabled selected>Alt işlem türü seçin...</option>'; 
                    
                    const filteredChildTypes = this.allTransactionTypes.filter(type => 
                        type.hierarchy === 'child' &&
                        allowedChildTypeIds.includes(type.id)
                    ).sort((a,b) => (a.order || 999) - (b.order || 999)); 

                    console.log('Filtrelenmiş Alt İşlem Türleri:', filteredChildTypes); 

                    filteredChildTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.alias || type.name;
                        selectEl.appendChild(option);
                    });
                }

                populateManualTransactionTypeSelect = (recordIpType = null) => { 
                    const selectEl = document.getElementById('specificManualTransactionType');
                    if (!selectEl) return;
                    selectEl.innerHTML = '<option value="" disabled selected>İşlem türü seçin...</option>';
                    
                    let parentTypes = this.allTransactionTypes.filter(type => 
                        type.hierarchy === 'parent' 
                    );

                    if (recordIpType) { 
                        parentTypes = parentTypes.filter(type => 
                            type.ipType === recordIpType || 
                            (type.applicableToMainType && type.applicableToMainType.includes(recordIpType)) 
                        );
                    }

                    parentTypes.sort((a,b) => (a.order || 999) - (b.order || 999));
                    console.log(`DEBUG: Manuel Ana İşlem Tipleri (parentTypes - IP Type: ${recordIpType || 'Tümü'}):`, parentTypes); 

                    parentTypes.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.alias || type.name;
                        selectEl.appendChild(option);
                    });
                }

                populateManualChildTransactionTypeSelect = (allowedChildTypeIds = null) => { 
                    const selectEl = document.getElementById('specificManualChildTransactionType');
                    if (!selectEl) return;
                    selectEl.innerHTML = '<option value="" selected>Alt işlem türü seçin...</option>'; 
                    
                    let typesToDisplay;
                    if (allowedChildTypeIds && allowedChildTypeIds.length > 0) {
                        typesToDisplay = this.allTransactionTypes.filter(type => 
                            type.hierarchy === 'child' &&
                            allowedChildTypeIds.includes(type.id)
                        );
                    } else {
                        typesToDisplay = this.allTransactionTypes.filter(type => 
                            type.hierarchy === 'child' && type.isTopLevelSelectable
                        );
                    }

                    typesToDisplay.sort((a,b) => (a.order || 999) - (b.order || 999));
                    console.log('DEBUG: Manuel Alt İşlem Tipleri (typesToDisplay):', typesToDisplay); 

                    typesToDisplay.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type.id;
                        option.textContent = type.alias || type.name;
                        selectEl.appendChild(option);
                    });
                }

                setRequiredFieldsForActiveTab = () => {
                    const recordSearchInputExisting = document.getElementById('recordSearchInputExisting');
                    const selectedRecordDisplayExisting = document.getElementById('selectedRecordDisplayExisting'); 
                    const recordSearchInputManual = document.getElementById('recordSearchInputManual');
                    const selectedRecordDisplayManual = document.getElementById('selectedRecordDisplayManual'); 

                    const specificChildTransactionType = document.getElementById('specificChildTransactionType');
                    const filesExisting = document.getElementById('filesExisting');
                    
                    const specificManualTransactionType = document.getElementById('specificManualTransactionType');
                    const specificManualChildTransactionType = document.getElementById('specificManualChildTransactionType'); 
                    const filesManual = document.getElementById('filesManual');

                    [
                        recordSearchInputExisting, selectedRecordDisplayExisting,
                        recordSearchInputManual, selectedRecordDisplayManual,
                        specificChildTransactionType, filesExisting, 
                        specificManualTransactionType, specificManualChildTransactionType, filesManual
                    ].forEach(el => {
                        if (el) {
                            el.removeAttribute('required');
                        }
                    });

                    if (this.activeTab === 'existing-transaction-pane') {
                        if (recordSearchInputExisting) recordSearchInputExisting.setAttribute('required', 'required');
                        if (specificChildTransactionType) specificChildTransactionType.setAttribute('required', 'required'); 
                        if (filesExisting) filesExisting.setAttribute('required', 'required'); 
                    } else if (this.activeTab === 'manual-indexing-pane') {
                        if (recordSearchInputManual) recordSearchInputManual.setAttribute('required', 'required');
                        if (specificManualTransactionType) specificManualTransactionType.setAttribute('required', 'required'); 
                    }
                }

                setupEventListeners = () => { 
                    document.getElementById('recordSearchInputExisting').addEventListener('input', (e) => this.searchRecords(e.target.value, 'existing'));
                    document.getElementById('recordSearchInputExisting').addEventListener('blur', () => {
                        setTimeout(() => { document.getElementById('searchResultsContainerExisting').style.display = 'none'; }, 200);
                    });
                    document.getElementById('recordSearchInputManual').addEventListener('input', (e) => this.searchRecords(e.target.value, 'manual'));
                    document.getElementById('recordSearchInputManual').addEventListener('blur', () => {
                        setTimeout(() => { document.getElementById('searchResultsContainerManual').style.display = 'none'; }, 200);
                    });
                    
                    document.getElementById('filesExisting').addEventListener('change', (e) => {
                        this.handleFileChange(e, 'existing-transaction-pane');
                        document.getElementById('filesExistingInfo').textContent = e.target.files.length > 0 ? `${e.target.files.length} dosya seçildi.` : 'Henüz dosya seçilmedi.';
                    });
                    document.getElementById('filesManual').addEventListener('change', (e) => {
                        this.handleFileChange(e, 'manual-indexing-pane');
                        document.getElementById('filesManualInfo').textContent = e.target.files.length > 0 ? `${e.target.files.length} dosya seçildi.` : 'Henüz dosya seçilmedi.';
                    });

                    document.getElementById('filesExistingButton').addEventListener('click', () => document.getElementById('filesExisting').click());
                    document.getElementById('filesManualButton').addEventListener('click', () => document.getElementById('filesManual').click());
                    
                    document.getElementById('indexDocumentsBtn').addEventListener('click', this.handleSubmit);
                    document.getElementById('resetIndexingFormBtn').addEventListener('click', this.resetForm);
                    
                    document.querySelectorAll('.tabs-container .tab-btn').forEach(btn => { 
                        btn.addEventListener('click', (e) => {
                            const targetTab = e.currentTarget.dataset.tab;
                            if (targetTab === 'bulk-indexing-pane') { 
                                e.preventDefault(); 
                                window.location.href = 'bulk-indexing-page.html'; 
                            } else {
                                this.activateTab(targetTab);
                            }
                        });
                    }); 

                    document.addEventListener('click', (e) => {
                        if (e.target.classList.contains('remove-uploaded-file')) {
                            const fileId = e.target.dataset.fileId;
                            const tabKey = e.target.dataset.tabKey;
                            let files = this.uploadedFiles.get(tabKey) || [];
                            this.uploadedFiles.set(tabKey, files.filter(f => f.id !== fileId));
                            this.renderUploadedFilesList(tabKey);
                            this.checkFormCompleteness(); 
                        }
                    });
                    
                    document.getElementById('specificChildTransactionType').addEventListener('change', this.checkFormCompleteness);
                    document.getElementById('existingChildTransactionDeliveryDate').addEventListener('change', this.checkFormCompleteness); 

                    document.getElementById('specificManualTransactionType').addEventListener('change', (e) => {
                        const selectedParentId = e.target.value;
                        const selectedParentType = this.allTransactionTypes.find(type => type.id === selectedParentId);
                        if (selectedParentType && selectedParentType.indexManuel) { 
                            this.populateManualChildTransactionTypeSelect(selectedParentType.indexManuel);
                        } else {
                            this.populateManualChildTransactionTypeSelect(null); 
                        }
                        this.checkFormCompleteness();
                    });

                    document.getElementById('specificManualChildTransactionType').addEventListener('change', this.checkFormCompleteness); 
                    document.getElementById('manualChildTransactionDeliveryDate').addEventListener('change', this.checkFormCompleteness); 
                }

                searchRecords = (query, tabContext) => { 
                    const searchResultsContainerId = tabContext === 'existing' ? 'searchResultsContainerExisting' : 'searchResultsContainerManual';
                    const container = document.getElementById(searchResultsContainerId);

                    if (query.length < 3) {
                        container.innerHTML = '<p class="no-results-message p-2">Arama yapmak için en az 3 karakter girin.</p>';
                        container.style.display = 'block';
                        return;
                    }
                    container.innerHTML = '';
                    const filtered = this.allRecords.filter(r => 
                        (r.title && r.title.toLowerCase().includes(query.toLowerCase())) ||
                        (r.applicationNumber && r.applicationNumber.toLowerCase().includes(query.toLowerCase()))
                    );
                    
                    if(filtered.length === 0) {
                        container.innerHTML = '<p class="no-results-message p-2">Kayıt bulunamadı.</p>';
                        return; 
                    } else {
                        filtered.forEach(record => {
                            const item = document.createElement('div');
                            item.className = 'record-search-item';
                            item.dataset.id = record.id; 
                            item.innerHTML = `<div class="record-info"><div>${record.title}</div><small>${record.applicationNumber}</small></div>`;
                            item.addEventListener('click', (e) => {
                                e.preventDefault(); 
                                this.selectRecordBasedOnTab(record.id, tabContext);
                            });
                            container.appendChild(item);
                        });
                    }
                    container.style.display = 'block';
                }

                selectRecordBasedOnTab = async (recordId, tabContext) => { 
                    const record = this.allRecords.find(r => r.id === recordId);
                    if (!record) return;

                    const selectedRecordDisplayId = tabContext === 'existing' ? 'selectedRecordDisplayExisting' : 'selectedRecordDisplayManual';
                    const recordSearchInputId = tabContext === 'existing' ? 'recordSearchInputExisting' : 'recordSearchInputManual';
                    const searchResultsContainerId = tabContext === 'existing' ? 'searchResultsContainerExisting' : 'searchResultsContainerManual';

                    document.getElementById(selectedRecordDisplayId).value = `${record.title} (${record.applicationNumber})`;
                    document.getElementById(recordSearchInputId).value = '';
                    document.getElementById(searchResultsContainerId).style.display = 'none';

                    if (tabContext === 'existing') {
                        this.selectedRecordExisting = record;
                        console.log('Seçilen Mevcut Kayıt:', this.selectedRecordExisting);
                        const transactionsResult = await ipRecordsService.getTransactionsForRecord(record.id); 
                        
                        console.log('ipRecordsService.getTransactionsForRecord çağrı sonucu:', transactionsResult);
                        
                        if (transactionsResult.success) {
                            console.log('İşlemler başarıyla çekildi. Data:', transactionsResult.transactions); 
                            this.renderTransactionsForSelection(transactionsResult.transactions); 
                        } else {
                            console.error('Kayıt işlemleri yüklenirken hata oluştu:', transactionsResult.error);
                            showNotification('Kayıt işlemleri yüklenemedi: ' + transactionsResult.error, 'error');
                            this.renderTransactionsForSelection([]); 
                        }
                    } else if (tabContext === 'manual') {
                        this.selectedRecordManual = record;
                        console.log('Seçilen Manuel Kayıt:', this.selectedRecordManual);
                        this.populateManualTransactionTypeSelect(record.type); 
                    }
                    this.checkFormCompleteness();
                }

                renderTransactionsForSelection = (transactions) => {
                    const container = document.getElementById('transactions-list-for-selection');
                    container.innerHTML = '';
                    this.selectedTransactionId = null; 
                    
                    document.getElementById('specificChildTransactionType').value = ''; 
                    document.getElementById('existingChildTransactionDeliveryDate').value = ''; 
                    
                    console.log('Seçilen kaydın işlemleri (transactions):', transactions); 

                    if (!transactions || transactions.length === 0) {
                        container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut işlem yok. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                        return;
                    }
                    
                    const parentTransactions = transactions
                        .filter(tx => tx.transactionHierarchy === 'parent' || !tx.transactionHierarchy) 
                        .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                    console.log('Filtrelenmiş Ana İşlemler (parentTransactions):', parentTransactions); 

                    if (parentTransactions.length === 0) {
                        container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut ana işlem bulunamadı. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                        return;
                    }

                    parentTransactions.forEach(tx => {
                        const item = document.createElement('div');
                        item.className = 'transaction-list-item';
                        item.dataset.id = tx.id; 
                        const transactionType = this.allTransactionTypes.find(t => t.id === tx.type);
                        console.log(`İşlem ID: ${tx.id}, İşlem Tipi ID (tx.type): ${tx.type}, Bulunan transactionType objesi:`, transactionType); 
                        const transactionDisplayName = transactionType ? (transactionType.alias || transactionType.name) : (tx.designation || tx.type || 'Tanımsız İşlem'); 

                        item.textContent = `${transactionDisplayName} - ${new Date(tx.timestamp).toLocaleDateString('tr-TR')}`;
                        item.addEventListener('click', (e) => {
                            this.selectedTransactionId = e.currentTarget.dataset.id;
                            console.log('Seçilen işlem ID:', this.selectedTransactionId); 
                            document.querySelectorAll('#transactions-list-for-selection .transaction-list-item').forEach(el => el.classList.remove('selected'));
                            e.currentTarget.classList.add('selected');
                            
                            document.getElementById('specificChildTransactionType').value = ''; 
                            document.getElementById('existingChildTransactionDeliveryDate').value = ''; 
                            
                            const selectedParentTransactionDefinition = this.allTransactionTypes.find(t => t.id === tx.type); 
                            console.log('Seçilen Ana İşlem İçin transactionType objesi (alt tipler için):', selectedParentTransactionDefinition); 
                            if (selectedParentTransactionDefinition && selectedParentTransactionDefinition.indexFile) { 
                                this.populateChildTransactionTypeSelect(selectedParentTransactionDefinition.indexFile);
                            } else {
                                console.log('Seçilen ana işlem için indexFile bulunamadı veya boş.'); 
                                this.populateChildTransactionTypeSelect([]); 
                            }
                            this.checkFormCompleteness();
                        });
                        container.appendChild(item);
                    });
                }
                
                handleFileChange = (event, tabKey) => {
                    const fileInput = event.target;
                    const files = Array.from(fileInput.files);
                    
                    this.uploadedFiles.set(tabKey, []); 
                    
                    files.forEach(file => {
                        this.uploadedFiles.get(tabKey).push({ 
                            id: `temp_${Date.now()}_${generateUUID()}`, 
                            fileObject: file,
                            documentDesignation: '' 
                        });
                    });
                    this.renderUploadedFilesList(tabKey);
                    this.checkFormCompleteness();
                }

                renderUploadedFilesList = (tabKey) => {
                    const containerId = tabKey === 'existing-transaction-pane' ? 'fileListExisting' : 'fileListManual';
                    const container = document.getElementById(containerId);
                    container.innerHTML = ''; 
                    const files = this.uploadedFiles.get(tabKey) || [];
                    if (files.length === 0) return;

                    files.forEach(fileData => {
                        const fileItem = document.createElement('div');
                        fileItem.className = 'file-item';
                        fileItem.innerHTML = `
                            <div class="d-flex justify-content-between w-100">
                                <strong>${fileData.fileObject.name}</strong>
                                <button type="button" class="remove-file remove-uploaded-file" data-file-id="${fileData.id}" data-tab-key="${tabKey}">&times;</button>
                            </div>
                        `;
                        container.appendChild(fileItem);
                    });
                }

                checkFormCompleteness = () => {
                    let canSubmit = false;
                    const filesExist = (this.uploadedFiles.get(this.activeTab) || []).length > 0;

                    if (this.activeTab === 'existing-transaction-pane') {
                        const specificChildTransactionTypeSelected = document.getElementById('specificChildTransactionType').value !== '';
                        
                        // İşleme Dosya Ekle menüsünde: Kayıt, Ana İşlem, Alt İşlem Türü ve Dosya Yükle HEPSİ zorunlu
                        canSubmit = this.selectedRecordExisting !== null && 
                                    this.selectedTransactionId !== null && 
                                    specificChildTransactionTypeSelected && 
                                    filesExist;

                    } else if (this.activeTab === 'manual-indexing-pane') {
                        const specificManualTransactionTypeSelected = document.getElementById('specificManualTransactionType').value !== '';
                        // Alt işlem ve dosya opsiyonel olduğu için, bu kontrol sadece manuel ana işlemin seçili olup olmadığını denetler.
                        // Alt işlem veya dosya varsa bile, ana işlem zorunlu olduğu sürece bu ifade yeterlidir.
                        canSubmit = this.selectedRecordManual !== null && specificManualTransactionTypeSelected;


                    } else if (this.activeTab === 'bulk-indexing-pane') { 
                        canSubmit = false; 
                    }
                    document.getElementById('indexDocumentsBtn').disabled = !canSubmit;
                }

                handleSubmit = async () => { 
                    const btn = document.getElementById('indexDocumentsBtn');
                    btn.disabled = true;
                    showNotification('İşlem kaydediliyor...', 'info');

                    let currentSelectedRecord = null; 
                    let transactionIdToAssociateFiles = null; 
                    let transactionDesignationForFiles = 'Genel Belge'; 
                    const filesToProcess = this.uploadedFiles.get(this.activeTab) || []; 


                    if (this.activeTab === 'existing-transaction-pane') {
                        currentSelectedRecord = this.selectedRecordExisting;
                        const childTypeId = document.getElementById('specificChildTransactionType').value;
                        const childTransactionType = this.allTransactionTypes.find(type => type.id === childTypeId);
                        const deliveryDateStr = document.getElementById('existingChildTransactionDeliveryDate').value; 
                        const deliveryDate = deliveryDateStr ? new Date(deliveryDateStr) : null;
                        if (deliveryDate) deliveryDate.setHours(0,0,0,0); // Saati sıfırla

                        let officialDueDate = null;
                        let officialDueDateDetails = null;
                        let taskDueDate = null; 

                        if (deliveryDate && childTransactionType.duePeriod !== undefined && childTransactionType.duePeriod !== null) {
                            const originalCalculatedDate = addMonthsToDate(deliveryDate, childTransactionType.duePeriod);
                            const finalOfficialDate = findNextWorkingDay(originalCalculatedDate, TURKEY_HOLIDAYS);
                            officialDueDate = finalOfficialDate;

                            officialDueDateDetails = {
                                initialDeliveryDate: deliveryDateStr,
                                periodMonths: childTransactionType.duePeriod,
                                originalCalculatedDate: originalCalculatedDate.toISOString().slice(0, 10),
                                finalOfficialDueDate: finalOfficialDate.toISOString().slice(0, 10),
                                adjustments: [] 
                            };

                            if (!taskDueDate) { 
                                const threeDaysBeforeOfficial = new Date(officialDueDate);
                                threeDaysBeforeOfficial.setDate(officialDueDate.getDate() - 3);
                                
                                let tempDueDate = new Date(threeDaysBeforeOfficial);
                                while (isWeekend(tempDueDate) || isHoliday(tempDueDate, TURKEY_HOLIDAYS)) {
                                    tempDueDate.setDate(tempDueDate.getDate() - 1); 
                                }
                                taskDueDate = tempDueDate.toISOString().slice(0, 10);
                            }
                        }

                        const newChildData = {
                            designation: childTransactionType.alias || childTransactionType.name,
                            type: childTransactionType.id, 
                            transactionHierarchy: 'child',
                            parentId: this.selectedTransactionId,
                            deliveryDate: deliveryDateStr ? new Date(deliveryDateStr).toISOString() : null
                        };
                        const childResult = await ipRecordsService.addTransactionToRecord(currentSelectedRecord.id, newChildData);

                        if(!childResult.success) {
                            showNotification(childResult.error || 'Alt işlem oluşturulurken hata oluştu.', 'error');
                            btn.disabled = false; 
                            return; 
                        }
                        
                        if (childResult.id) { 
                            transactionIdToAssociateFiles = childResult.id; 
                        } else if (childResult.data && childResult.data.id) { 
                            transactionIdToAssociateFiles = childResult.data.id;
                        } else {
                            console.error('HATA: Alt işlem ID\'si alınamadı, ancak işlem başarılı olarak bildirildi. childResult:', childResult);
                            showNotification('Alt işlem oluşturuldu ancak ID alınamadı. Lütfen yöneticinize başvurun.', 'error');
                            btn.disabled = false;
                            return;
                        }

                        transactionDesignationForFiles = childTransactionType.documentDesignationDefault || 'Diğer Belge'; 

                        const triggeredTaskType = this.mapTransactionToTask(childTransactionType, currentSelectedRecord.recordType); 

                        if (triggeredTaskType) {
                            let defaultAssignedToUid = SELCAN_UID; 
                            let defaultAssignedToEmail = SELCAN_EMAIL;

                            const targetTaskDefinition = this.allTransactionTypes.find(t => t.id === triggeredTaskType);
                            
                            const newTaskData = {
                                taskType: triggeredTaskType,
                                title: `[OTOMATİK GÖREV] ${targetTaskDefinition ? (targetTaskDefinition.taskDisplayName || targetTaskDefinition.alias || targetTaskDefinition.name) : 'Bilinmeyen İşlem'} - ${currentSelectedRecord.title} (${currentSelectedRecord.applicationNumber})`,
                                description: `${currentSelectedRecord.title} (${currentSelectedRecord.applicationNumber}) kaydının ${childTransactionType.alias || childTransactionType.name} işlemi sonrasında otomatik oluşturulan görev.`,
                                priority: 'medium', 
                                assignedTo_uid: defaultAssignedToUid,
                                assignedTo_email: defaultAssignedToEmail,
                                dueDate: taskDueDate, 
                                status: 'awaiting_client_approval', 
                                relatedIpRecordId: currentSelectedRecord.id,
                                relatedIpRecordTitle: currentSelectedRecord.title,
                                details: {
                                    relatedParty: currentSelectedRecord.details?.relatedParty || null
                                }
                            };
                            
                            if (officialDueDate) {
                                newTaskData.officialDueDate = officialDueDate;
                                newTaskData.officialDueDateDetails = officialDueDateDetails;
                            }
                            // Tebliğ tarihini de göreve ekle
                            if (deliveryDateStr) {
                                newTaskData.deliveryDate = deliveryDateStr;
                            }


                            const taskCreationResult = await taskService.createTask(newTaskData);
                            if (taskCreationResult.success) {
                                showNotification(`Yeni görev otomatik olarak oluşturuldu: "${newTaskData.title}".`, 'success', 5000);
                            } else {
                                showNotification(`Otomatik görev oluşturulurken hata oluştu: ${taskCreationResult.error}`, 'error', 8000);
                            }
                        }

                    } else if (this.activeTab === 'manual-indexing-pane') {
                        currentSelectedRecord = this.selectedRecordManual;
                        const parentTypeId = document.getElementById('specificManualTransactionType').value;
                        const childTypeId = document.getElementById('specificManualChildTransactionType').value;
                        const deliveryDateStr = document.getElementById('manualChildTransactionDeliveryDate').value;
                        const deliveryDate = deliveryDateStr ? new Date(deliveryDateStr) : null;
                        if (deliveryDate) deliveryDate.setHours(0,0,0,0); // Saati sıfırla


                        let newParentTransactionId = null;
                        let selectedParentTransaction = null;
                        let selectedChildTransaction = null;

                        selectedParentTransaction = this.allTransactionTypes.find(type => type.id === parentTypeId);
                        const parentTransactionData = {
                            designation: selectedParentTransaction.alias || selectedParentTransaction.name,
                            type: selectedParentTransaction.id,
                            transactionHierarchy: 'parent',
                            timestamp: new Date().toISOString()
                        };
                        const parentResult = await ipRecordsService.addTransactionToRecord(currentSelectedRecord.id, parentTransactionData);
                        if (!parentResult.success) {
                            showNotification(parentResult.error || 'Manuel ana işlem oluşturulurken hata oluştu.', 'error');
                            btn.disabled = false; 
                            return; 
                        }
                        
                        if (parentResult.id) {
                            newParentTransactionId = parentResult.id; 
                        } else if (parentResult.data && parentResult.data.id) {
                            newParentTransactionId = parentResult.data.id;
                        } else {
                            console.error('HATA: Ana işlem ID\'si alınamadı, ancak işlem başarılı olarak bildirildi. parentResult:', parentResult);
                            showNotification('Ana işlem oluşturuldu ancak ID alınamadı. Lütfen yöneticinize başvurun.', 'error');
                            btn.disabled = false;
                            return;
                        }
                        transactionIdToAssociateFiles = newParentTransactionId; 
                        transactionDesignationForFiles = selectedParentTransaction.documentDesignationDefault || 'Diğer Belge';
                        

                        if (childTypeId !== '') { 
                            selectedChildTransaction = this.allTransactionTypes.find(type => type.id === childTypeId);
                            
                            const childTransactionData = {
                                designation: selectedChildTransaction.alias || selectedChildTransaction.name,
                                type: selectedChildTransaction.id,
                                transactionHierarchy: 'child',
                                parentId: newParentTransactionId, 
                                deliveryDate: deliveryDateStr ? new Date(deliveryDateStr).toISOString() : null,
                                timestamp: new Date().toISOString()
                            };
                            const childResult = await ipRecordsService.addTransactionToRecord(currentSelectedRecord.id, childTransactionData);
                            if (!childResult.success) {
                                showNotification(childResult.error || 'Manuel alt işlem oluşturulurken hata oluştu.', 'error');
                                btn.disabled = false; 
                                return; 
                            }
                            if (childResult.id) {
                                transactionIdToAssociateFiles = childResult.id; 
                            } else if (childResult.data && childResult.data.id) {
                                transactionIdToAssociateFiles = childResult.data.id;
                            } else {
                                console.error('HATA: Manuel alt işlem ID\'si alınamadı, ancak işlem başarılı olarak bildirildi. childResult:', childResult);
                                showNotification('Manuel alt işlem oluşturuldu ancak ID alınamadı. Lütfen yöneticinize başvurun.', 'error');
                                btn.disabled = false;
                                return;
                            }
                            transactionDesignationForFiles = selectedChildTransaction.documentDesignationDefault || 'Diğer Belge';

                            let officialDueDate = null;
                            let officialDueDateDetails = null;
                            let taskDueDate = null; 
                            
                            if (deliveryDate && selectedChildTransaction.duePeriod !== undefined && selectedChildTransaction.duePeriod !== null) {
                                const originalCalculatedDate = addMonthsToDate(deliveryDate, selectedChildTransaction.duePeriod);
                                
                                const finalOfficialDate = findNextWorkingDay(originalCalculatedDate, TURKEY_HOLIDAYS);
                                officialDueDate = finalOfficialDate;

                                officialDueDateDetails = {
                                    initialDeliveryDate: deliveryDateStr,
                                    periodMonths: selectedChildTransaction.duePeriod,
                                    originalCalculatedDate: originalCalculatedDate.toISOString().slice(0, 10),
                                    finalOfficialDueDate: finalOfficialDate.toISOString().slice(0, 10),
                                    adjustments: [] 
                                };

                                if (!taskDueDate) { 
                                    const threeDaysBeforeOfficial = new Date(officialDueDate);
                                    threeDaysBeforeOfficial.setDate(officialDueDate.getDate() - 3);
                                    
                                    let tempDueDate = new Date(threeDaysBeforeOfficial);
                                    while (isWeekend(tempDueDate) || isHoliday(tempDueDate, TURKEY_HOLIDAYS)) {
                                        tempDueDate.setDate(tempDueDate.getDate() - 1); 
                                    }
                                    taskDueDate = tempDueDate.toISOString().slice(0, 10);
                                }
                            }

                            const triggeredTaskType = this.mapTransactionToTask(selectedChildTransaction, currentSelectedRecord.recordType); 

                            if (triggeredTaskType) {
                                let defaultAssignedToUid = SELCAN_UID; 
                                let defaultAssignedToEmail = SELCAN_EMAIL;
                                
                                const targetTaskDefinition = this.allTransactionTypes.find(t => t.id === triggeredTaskType);
                                
                                const newTaskData = {
                                    taskType: triggeredTaskType,
                                    title: `[OTOMATİK GÖREV] ${targetTaskDefinition ? (targetTaskDefinition.taskDisplayName || targetTaskDefinition.alias || targetTaskDefinition.name) : 'Bilinmeyen İşlem'} - ${currentSelectedRecord.title} (${currentSelectedRecord.applicationNumber})`,
                                    description: `${currentSelectedRecord.title} (${currentSelectedRecord.applicationNumber}) kaydının ${selectedChildTransaction.alias || selectedChildTransaction.name} işlemi sonrasında otomatik oluşturulan görev.`,
                                    priority: 'medium',
                                    assignedTo_uid: defaultAssignedToUid,
                                    assignedTo_email: defaultAssignedToEmail,
                                    dueDate: taskDueDate, 
                                    status: 'awaiting_client_approval',
                                    relatedIpRecordId: currentSelectedRecord.id,
                                    relatedIpRecordTitle: currentSelectedRecord.title,
                                    details: {
                                        relatedParty: currentSelectedRecord.details?.relatedParty || null 
                                    }
                                };
                                
                                if (officialDueDate) {
                                    newTaskData.officialDueDate = officialDueDate;
                                    newTaskData.officialDueDateDetails = officialDueDateDetails;
                                }
                                // Tebliğ tarihini de göreve ekle
                                if (deliveryDateStr) {
                                    newTaskData.deliveryDate = deliveryDateStr;
                                }

                                const taskCreationResult = await taskService.createTask(newTaskData);
                                if (taskCreationResult.success) {
                                    showNotification(`Yeni görev otomatik olarak oluşturuldu: "${newTaskData.title}".`, 'success', 5000);
                                } else {
                                    showNotification(`Otomatik görev oluşturulurken hata oluştu: ${taskCreationResult.error}`, 'error', 8000);
                                }
                            }
                        }

                    } 
                    
                    if (filesToProcess.length > 0) {
                        for (const fileData of filesToProcess) {
                            try {
                                const fileContent = await readFileAsDataURL(fileData.fileObject); 
                                const fileToUpload = {
                                    fileName: fileData.fileObject.name,
                                    fileType: fileData.fileObject.type,
                                    fileSize: fileData.fileObject.size,
                                    fileUrl: fileContent, 
                                    relatedTransactionId: transactionIdToAssociateFiles, 
                                    documentDesignation: transactionDesignationForFiles 
                                };
                                const fileAddResult = await ipRecordsService.addFileToRecord(currentSelectedRecord.id, fileToUpload); 
                                if (!fileAddResult.success) {
                                    console.error(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`);
                                    showNotification(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`, 'error');
                                }
                            } catch (fileError) {
                                console.error(`Dosya işlenirken hata (${fileData.fileObject.name}):`, fileError);
                                showNotification(`Dosya işlenirken hata (${fileData.fileObject.name}): ${fileError.message}`, 'error');
                            }
                        }
                        showNotification('Tüm işlemler ve belgeler başarıyla kaydedildi!', 'success'); 
                    } else if (transactionIdToAssociateFiles !== null) { 
                         showNotification('İşlem başarıyla kaydedildi (belge yüklenmedi).', 'success');
                    } else { 
                         showNotification('Hiçbir işlem yapılmadı.', 'info');
                    }
                   
                    this.resetForm();
                    await this.loadRecordsAndTransactionTypes(); 
                }

                resetForm = () => { 
                    document.getElementById('indexingForm').reset(); 
                    
                    document.getElementById('fileListExisting').innerHTML = '';
                    document.getElementById('fileListManual').innerHTML = '';
                    document.getElementById('filesExistingInfo').textContent = 'Henüz dosya seçilmedi.';
                    document.getElementById('filesManualInfo').textContent = 'Henüz dosya seçilmedi.';
                    
                    document.getElementById('selectedRecordDisplayExisting').value = '';
                    document.getElementById('selectedRecordDisplayManual').value = '';
                    
                    document.getElementById('transactions-list-for-selection').innerHTML = '<p class="text-muted p-2">Lütfen bir kayıt seçin.</p>';
                    
                    const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                    if(childTransactionInputsEl) childTransactionInputsEl.style.display = 'none';

                    this.resetSelections();
                    this.uploadedFiles.clear(); 

                    this.activateTab('existing-transaction-pane');
                    this.checkFormCompleteness();
                }

                resetSelections = () => {
                    this.selectedRecordExisting = null;
                    this.selectedRecordManual = null;
                    this.selectedTransactionId = null;
                }

                // YENİ FONKSİYON: Alt işlem türü ile tetiklenecek görev türünü eşleştirir
                // Bu fonksiyon artık transactionType objesini alıyor
                mapTransactionToTask = (selectedChildTransactionType, recordType) => { 
                    return selectedChildTransactionType.taskTriggered || null; 
                }
            }
            
            document.addEventListener('DOMContentLoaded', async () => {
                await loadSharedLayout({ activeMenuLink: 'indexing.html' });
                const indexingModule = new IndexingModule();
            });
        </script>
</body>
</html>