<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bana Atanan İşler - IP Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .sidebar { width: 250px; background: #1e3c72; color: white; position: fixed; left: 0; top: 0; height: 100%; overflow-y: auto; z-index: 1000; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #2a4f8b; }
        .sidebar-logo { color: white; text-decoration: none; font-size: 1.3em; font-weight: bold; }
        .sidebar-nav { padding: 15px 0; }
        .sidebar-nav-item { display: flex; align-items: center; padding: 12px 20px; color: #b3c6ff; text-decoration: none; transition: all 0.3s; }
        .sidebar-nav-item:hover, .sidebar-nav-item.active { background: #2a4f8b; color: white; }
        .nav-icon { margin-right: 10px; font-size: 1.1em; }
        .nav-category-title { padding: 15px 20px 8px; font-size: 0.9em; color: #7a92d1; font-weight: 600; text-transform: uppercase; }
        .dropdown-nav { position: relative; }
        .dropdown-toggle { cursor: pointer; justify-content: space-between; }
        .dropdown-content { display: none; background: #2a4f8b; }
        .dropdown-content a { padding-left: 50px; font-size: 0.9em; }
        .dropdown-nav.open .dropdown-content { display: block; }
        .page-wrapper { margin-left: 250px; min-height: 100vh; }
        .top-header { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-info { }
        .user-name { font-weight: 600; color: #333; }
        .user-role { font-size: 0.85em; color: #666; }
        .logout-btn { background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .main-container { padding: 30px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .page-title { color: white; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .page-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1em; }
        .tasks-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .tasks-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f4; padding-bottom: 15px; }
        .filter-group { display: flex; align-items: center; gap: 15px; }
        .filter-label { font-weight: 600; color: #1e3c72; }
        .filter-select { padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 10px; background: white; font-weight: 500; }
        .filter-select:focus { outline: none; border-color: #667eea; }
        .action-btn { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .action-btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .action-btn.complete { background: #28a745; }
        .action-btn.complete:hover { background: #218838; }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .tasks-table { width: 100%; border-collapse: collapse; }
        .tasks-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 18px 15px; text-align: left; font-weight: 600; font-size: 0.95em; }
        .tasks-table td { padding: 15px; border-bottom: 1px solid #f1f3f4; }
        .tasks-table tr:hover { background: #f8f9fa; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .status-open { background: #ffc107; color: #856404; }
        .status-in-progress { background: #17a2b8; color: white; }
        .status-completed { background: #28a745; color: white; }
        .status-blocked { background: #dc3545; color: white; }
        .priority-high { color: #dc3545; font-weight: bold; }
        .priority-medium { color: #ffc107; font-weight: bold; }
        .priority-low { color: #28a745; font-weight: bold; }
        .task-actions { display: flex; gap: 8px; }
        .task-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .btn-view { background: #17a2b8; color: white; }
        .btn-edit { background: #ffc107; color: #856404; }
        .btn-complete { background: #28a745; color: white; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-accrual { background: #6f42c1; color: white; }
        .task-actions button:hover { transform: translateY(-1px); opacity: 0.9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1003; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content, .modal-content-lg { background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content-lg { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px 15px; border-bottom: 2px solid #f1f3f4; }
        .modal-title { font-size: 1.4em; color: #1e3c72; font-weight: 700; }
        .close-modal-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #666; }
        .modal-body-content { padding: 25px 30px; }
        .modal-footer { padding: 15px 30px 25px; border-top: 2px solid #f1f3f4; display: flex; gap: 15px; justify-content: flex-end; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #667eea; }
        .form-textarea { resize: vertical; min-height: 100px; }
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .modal-detail-item { }
        .modal-detail-item.full-width { grid-column: 1 / -1; }
        .modal-detail-label { font-weight: 600; color: #1e3c72; margin-bottom: 5px; }
        .modal-detail-value { color: #333; }
        .modal-detail-value.long-text { background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
        .modal-detail-section-title { grid-column: 1 / -1; font-size: 1.2em; color: #1e3c72; margin: 25px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #e1e8ed; }
        .task-history { }
        .task-history-item { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea; }
        .task-history-item-content { }
        .task-history-info { }
        .task-history-description { font-weight: 600; color: #333; margin-bottom: 5px; }
        .task-history-meta { font-size: 0.9em; color: #666; }
        .file-upload-area { border: 2px dashed #e1e8ed; border-radius: 10px; padding: 30px; text-align: center; cursor: pointer; transition: background 0.2s; margin-top: 15px; }
        .file-upload-area:hover { background: #f0f4f8; }
        .file-list { margin-top: 15px; }
        .file-list-task-detail { margin-top: 10px; }
        .file-item-task-detail { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: #f8f9fa; border-radius: 6px; margin-bottom: 5px; }
        .remove-file-task-detail { background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        .related-accrual-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            border-left: 3px solid #1e3c72;
        }
        .status-badge.status-paid { background-color: #28a745; }
        .status-badge.status-unpaid { background-color: #dc3545; }
        .input-with-currency { display: flex; gap: 10px; }
        .input-with-currency .form-input { flex-grow: 1; }
        .currency-select {
            padding: 12px 8px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .checkbox-label input {
            width: 18px;
            height: 18px;
        }
        .total-amount-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #1e3c72;
            text-align: right;
            margin-top: 10px;
            padding: 12px 15px;
            background-color: #f0f4f8;
            border-radius: 10px;
        }
        .search-results-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background-color: #f0f4f8; }
        .search-result-display { background: #e9f5ff; border: 1px solid #bde0fe; padding: 10px; border-radius: 8px; margin-top: 10px; }
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; text-align: center; }
        .no-records-message { text-align: center; padding: 50px; color: #666; font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="loadingIndicator">
        <div style="font-size: 1.2em; color: #1e3c72; margin-bottom: 15px;">📋 Veriler Yükleniyor...</div>
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">🔥 IP Manager</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-category-title">Ana Sayfa</div>
            <a href="dashboard.html" class="sidebar-nav-item"><span class="nav-icon">🏠</span><span>Dashboard</span></a>
            <div class="nav-category-title">Portföy Yönetimi</div>
            <a href="portfolio.html" class="sidebar-nav-item"><span class="nav-icon">💼</span><span>Portföy</span></a>
            <a href="data-entry.html" class="sidebar-nav-item"><span class="nav-icon">📝</span><span>Yeni Kayıt</span></a>
            <div class="nav-category-title">İş Yönetimi</div>
            <a href="task-management.html" class="sidebar-nav-item"><span class="nav-icon">📋</span><span>İş Yönetimi</span></a>
            <a href="my-tasks.html" class="sidebar-nav-item active"><span class="nav-icon">✅</span><span>Bana Atanan İşler</span></a>
            <a href="create-task.html" class="sidebar-nav-item"><span class="nav-icon">➕</span><span>Yeni İş Oluştur</span></a>
            <div class="nav-category-title">Kişiler</div>
            <div class="dropdown-nav" id="personsDropdown">
                <a href="#" class="sidebar-nav-item dropdown-toggle">
                    <div><span class="nav-icon">👥</span><span>Kişiler</span></div>
                    <span>▼</span>
                </a>
                <div class="dropdown-content">
                    <a href="persons.html">Kişiler Yönetimi</a>
                    <a href="user-management.html">Kullanıcı Yönetimi</a>
                </div>
            </div>
            <div class="nav-category-title">Finans</div>
            <a href="accruals.html" class="sidebar-nav-item"><span class="nav-icon">💰</span><span>Tahakkuklarım</span></a>
            <div class="nav-category-title">Araçlar</div>
            <a href="indexing.html" class="sidebar-nav-item"><span class="nav-icon">📁</span><span>Belge İndeksleme</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">📈</span><span>Raporlar</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">🔧</span><span>Ayarlar</span></a>
        </nav>
    </aside>

    <div class="page-wrapper">
        <header class="top-header">
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Yükleniyor...</div>
                    <div class="user-role" id="userRole">Kullanıcı</div>
                </div>
                <button class="logout-btn" id="logoutBtn">Çıkış</button>
            </div>
        </header>

        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Bana Atanan İşler</h1>
                <p class="page-subtitle">Size atanan tüm işleri buradan görüntüleyebilir ve yönetebilirsiniz.</p>
            </section>

            <div class="tasks-container">
                <div class="tasks-header">
                    <div class="filter-group">
                        <label class="filter-label" for="statusFilter">Duruma Göre Filtrele:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">Tümü</option>
                            <option value="open">Açık</option>
                            <option value="in-progress">Devam Ediyor</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="blocked">Engellendi</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label" for="priorityFilter">Önceliğe Göre:</label>
                        <select id="priorityFilter" class="filter-select">
                            <option value="all">Tümü</option>
                            <option value="high">Yüksek</option>
                            <option value="medium">Orta</option>
                            <option value="low">Düşük</option>
                        </select>
                    </div>
                </div>

                <div class="table-container">
                    <table class="tasks-table">
                        <thead>
                            <tr>
                                <th>İş Başlığı</th>
                                <th>Durum</th>
                                <th>Öncelik</th>
                                <th>Bitiş Tarihi</th>
                                <th>İş Türü</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="noRecordsMessage" class="no-records-message" style="display: none;">
                    📋 Henüz size atanmış iş bulunmuyor.
                </div>
            </div>
        </main>
    </div>

    <!-- İş Detayları Modal -->
    <div id="viewTaskDetailModal" class="modal">
        <div class="modal-content-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="modalViewTaskTitle">İş Detayı</h3>
                <button class="close-modal-btn" id="closeViewTaskDetailModal">&times;</button>
            </div>
            <div class="modal-body-content">
                <div class="modal-detail-grid">
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">Başlık</div><div class="modal-detail-value" id="modalViewTaskTitleValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">Açıklama</div><div class="modal-detail-value long-text" id="modalViewTaskDescriptionValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">İş Türü</div><div class="modal-detail-value" id="modalViewTaskTypeValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Öncelik</div><div class="modal-detail-value" id="modalViewTaskPriorityValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Atanan Kişi</div><div class="modal-detail-value" id="modalViewAssignedToValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Bitiş Tarihi</div><div class="modal-detail-value" id="modalViewTaskDueDateValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">İlgili Fikri Mülkiyet Kaydı</div><div class="modal-detail-value" id="modalViewRelatedIpRecordValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedPartyGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedPartyLabel"></div><div class="modal-detail-value" id="modalViewRelatedPartyValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedTransactionGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedTransactionLabel"></div><div class="modal-detail-value" id="modalViewRelatedTransactionValue"></div></div>
                    
                    <h4 class="modal-detail-section-title">İlişkili Tahakkuklar</h4>
                    <div class="modal-detail-item full-width" id="modalViewRelatedAccruals">
                        <p style="text-align: center; color: #666;">Tahakkuk bilgisi bulunmuyor.</p>
                    </div>

                    <h4 class="modal-detail-section-title">İşlem Geçmişi</h4>
                    <div class="modal-detail-item full-width task-history" id="modalViewTaskHistory">
                        <p style="text-align: center; color: #666;">İşlem geçmişi bulunmuyor.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- İş Tamamlama Modal -->
    <div id="completeTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">İşi Tamamla</h3>
                <button class="close-modal-btn" id="closeCompleteTaskModal">&times;</button>
            </div>
            <div class="modal-body-content">
                <input type="hidden" id="completeTaskId">
                <input type="hidden" id="completeTaskRelatedIpRecordId">
                
                <div class="form-group">
                    <label for="completionNotes" class="form-label">Tamamlama Notları</label>
                    <textarea id="completionNotes" class="form-textarea" placeholder="Bu işi nasıl tamamladığınızı açıklayın..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Belge Yükleme</label>
                    <div class="file-upload-area" id="completionFileUploadArea">
                        <p>📁 Dosya seçmek için tıklayın veya sürükleyip bırakın</p>
                        <input type="file" id="completionFileInput" style="display: none;" multiple>
                    </div>
                    <div id="completeTaskFileList" class="file-list-task-detail"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelCompleteTaskBtn">İptal</button>
                <button type="button" class="btn btn-success" onclick="myTasksModule.completeTask('completed_with_doc')">Tamamla</button>
            </div>
        </div>
    </div>

    <!-- Ek Tahakkuk Modal -->
    <div class="modal" id="addAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeAddAccrualModal">&times;</span>
            <h3 class="modal-title">İşe Yeni Tahakkuk Ekle</h3>
            <form id="addAccrualForm" onsubmit="return false;">
                <input type="hidden" id="accrualTaskId">
                <div class="modal-body-content">
                    <div class="form-group">
                        <label for="accrualTaskTitleDisplay" class="form-label">İlgili İş</label>
                        <input type="text" id="accrualTaskTitleDisplay" class="form-input" readonly>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="officialFee" class="form-label">Resmi Ücret</label>
                            <div class="input-with-currency">
                                <input type="number" id="officialFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="officialFeeCurrency" class="currency-select">
                                    <option value="TRY" selected>TRY</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="serviceFee" class="form-label">Hizmet Bedeli</label>
                            <div class="input-with-currency">
                                <input type="number" id="serviceFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="serviceFeeCurrency" class="currency-select">
                                    <option value="TRY" selected>TRY</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vatRate" class="form-label">KDV Oranı (%)</label>
                        <input type="number" id="vatRate" class="form-input" value="20">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="applyVatToOfficialFee" checked>
                            Resmi Ücrete KDV Uygula
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Toplam Tutar</label>
                        <div id="totalAmountDisplay" class="total-amount-display">0.00 TL</div>
                    </div>
                    <div class="form-group">
                        <label for="tpInvoicePartySearch" class="form-label">Türk Patent Faturası Tarafı</label>
                        <input type="text" id="tpInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="tpInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedTpInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="serviceInvoicePartySearch" class="form-label">Hizmet Faturası Tarafı</label>
                        <input type="text" id="serviceInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="serviceInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedServiceInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="myTasksModule.closeModal('addAccrualModal')">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveAccrualBtn">Tahakkuk Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/services/taskService.js"></script>
    <script src="js/services/ipRecordsService.js"></script>
    <script src="js/services/personsService.js"></script>
    <script src="js/services/accrualService.js"></script>
    <script>
        class MyTasksModule {
            constructor() {
                this.tasks = [];
                this.allAccruals = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.uploadedCompletionFiles = [];
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                this.isSavingAccrual = false; // Duplikasyon koruması
            }

            // Para birimi kodunu standart hale getiren fonksiyon
            normalizeCurrencyCode(currency) {
                const currencyMap = {
                    'TL': 'TRY',
                    'tl': 'TRY',
                    'try': 'TRY'
                };
                return currencyMap[currency] || currency;
            }

            // Güvenli para birimi formatı fonksiyonu
            formatCurrencyAmount(amount, currency) {
                try {
                    const normalizedCurrency = this.normalizeCurrencyCode(currency || 'TL');
                    return new Intl.NumberFormat('tr-TR', { 
                        style: 'currency', 
                        currency: normalizedCurrency 
                    }).format(amount || 0);
                } catch (error) {
                    console.warn('Currency formatting error:', error);
                    // Fallback: Sadece sayı + para birimi simgesi
                    return `${(amount || 0).toFixed(2)} ${currency || 'TL'}`;
                }
            }

            async init() {
                await this.loadInitialData();
                this.setupEventListeners();
                this.setupDropdowns();
            }

            setupDropdowns() {
                const dropdown = document.getElementById('personsDropdown');
                if (dropdown) {
                    dropdown.addEventListener('click', (e) => {
                        e.preventDefault();
                        dropdown.classList.toggle('open');
                    });
                }
            }

            setupEventListeners() {
                // Mevcut event listener'ları temizle ve ekle
                const saveAccrualBtn = document.getElementById('saveAccrualBtn');
                if (saveAccrualBtn) {
                    saveAccrualBtn.removeEventListener('click', this.handleSaveAccrual);
                    saveAccrualBtn.addEventListener('click', this.handleSaveAccrual.bind(this));
                }

                // Form submit olayını önle
                const addAccrualForm = document.getElementById('addAccrualForm');
                if (addAccrualForm) {
                    addAccrualForm.removeEventListener('submit', this.preventFormSubmit);
                    addAccrualForm.addEventListener('submit', this.preventFormSubmit);
                }

                // Filtreler
                document.getElementById('statusFilter').addEventListener('change', () => this.renderTable());
                document.getElementById('priorityFilter').addEventListener('change', () => this.renderTable());

                // Modal kapatma
                document.getElementById('closeViewTaskDetailModal').addEventListener('click', () => this.closeModal('viewTaskDetailModal'));
                document.getElementById('closeCompleteTaskModal').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('closeAddAccrualModal').addEventListener('click', () => this.closeModal('addAccrualModal'));
                document.getElementById('cancelCompleteTaskBtn').addEventListener('click', () => this.closeModal('completeTaskModal'));

                // Dosya yükleme
                const completionFileInput = document.getElementById('completionFileInput');
                const completionFileUploadArea = document.getElementById('completionFileUploadArea');
                
                if (completionFileUploadArea && completionFileInput) {
                    completionFileUploadArea.addEventListener('click', () => completionFileInput.click());
                    completionFileInput.addEventListener('change', (e) => this.handleCompletionFileUpload(e));
                }

                // KDV hesaplama
                ['officialFee', 'serviceFee', 'vatRate', 'applyVatToOfficialFee'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.calculateTotalAmount());
                        element.addEventListener('change', () => this.calculateTotalAmount());
                    }
                });

                // Kişi arama
                document.getElementById('tpInvoicePartySearch')?.addEventListener('input', (e) => {
                    this.searchPersons(e.target.value, 'tpInvoiceParty');
                });
                document.getElementById('serviceInvoicePartySearch')?.addEventListener('input', (e) => {
                    this.searchPersons(e.target.value, 'serviceInvoiceParty');
                });

                // Logout
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    authService.signOut();
                    window.location.href = 'index.html';
                });
            }

            preventFormSubmit(event) {
                event.preventDefault();
                return false;
            }

            async loadInitialData() {
                try {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    const currentUser = authService.getCurrentUser();
                    if (currentUser) {
                        document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                        document.getElementById('userAvatar').textContent = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                    }

                    const [tasksResult, accrualsResult, ipRecordsResult, personsResult] = await Promise.all([
                        taskService.getUserTasks(),
                        accrualService.getAllAccruals(),
                        ipRecordsService.getAllRecords(),
                        personsService.getAllPersons()
                    ]);

                    this.tasks = tasksResult.success ? tasksResult.data : [];
                    this.allAccruals = accrualsResult.success ? accrualsResult.data : [];
                    this.allIpRecords = ipRecordsResult.success ? ipRecordsResult.data : [];
                    this.allPersons = personsResult.success ? personsResult.data : [];

                    this.renderTable();
                } catch (error) {
                    console.error('Veri yükleme hatası:', error);
                    alert('Veriler yüklenirken bir hata oluştu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            renderTable() {
                const tableBody = document.getElementById('tasksTableBody');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                const statusFilter = document.getElementById('statusFilter').value;
                const priorityFilter = document.getElementById('priorityFilter').value;

                tableBody.innerHTML = '';

                let filteredTasks = this.tasks.filter(task => {
                    const statusMatch = statusFilter === 'all' || task.status === statusFilter;
                    const priorityMatch = priorityFilter === 'all' || task.priority === priorityFilter;
                    return statusMatch && priorityMatch;
                });

                if (filteredTasks.length === 0) {
                    noRecordsMessage.style.display = 'block';
                    return;
                }
                noRecordsMessage.style.display = 'none';

                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    
                    const statusClass = `status-${task.status}`;
                    const priorityClass = `priority-${task.priority}`;
                    
                    const priorityText = {
                        'high': 'Yüksek',
                        'medium': 'Orta', 
                        'low': 'Düşük'
                    }[task.priority] || task.priority;

                    const statusText = {
                        'open': 'Açık',
                        'in-progress': 'Devam Ediyor',
                        'completed': 'Tamamlandı',
                        'blocked': 'Engellendi'
                    }[task.status] || task.status;

                    const dueDateText = task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-';
                    const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                    const mainType = taskTypeParts[0] || '';
                    const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                    const taskTypeText = `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}`;

                    row.innerHTML = `
                        <td>${task.title || '-'}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td><span class="${priorityClass}">${priorityText}</span></td>
                        <td>${dueDateText}</td>
                        <td>${taskTypeText}</td>
                        <td>
                            <div class="task-actions">
                                <button class="btn-view" onclick="myTasksModule.viewTaskDetailsModal('${task.id}')" title="Görüntüle">👁️</button>
                                ${task.status !== 'completed' ? `<button class="btn-complete" onclick="myTasksModule.showCompleteTaskModal('${task.id}', '${task.relatedIpRecordId || ''}')" title="Tamamla">✅</button>` : ''}
                                <button class="btn-accrual" onclick="myTasksModule.showAddAccrualModal('${task.id}')" title="Ek Tahakkuk">💰</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            async viewTaskDetailsModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) { 
                    alert('Görev bulunamadı.'); 
                    return; 
                }
                this.populateModalTaskDetails(task, this.allIpRecords, this.allPersons);
                document.getElementById('viewTaskDetailModal').classList.add('show');
            }

            populateModalTaskDetails(task, ipRecords, persons) {
                const modal = document.getElementById('viewTaskDetailModal');
                if (!modal) return;
                
                document.getElementById('modalViewTaskTitle').textContent = `İş Detayı: ${task.title || '-'}`;
                document.getElementById('modalViewTaskTitleValue').textContent = task.title || '-';
                document.getElementById('modalViewTaskDescriptionValue').textContent = task.description || '-';
                
                const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                const mainType = taskTypeParts[0] || '';
                const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('modalViewTaskTypeValue').textContent = `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}` || '-';
                
                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                document.getElementById('modalViewTaskPriorityValue').textContent = priorityMap[task.priority] || task.priority || '-';
                document.getElementById('modalViewAssignedToValue').textContent = task.assignedTo_email || '-';
                document.getElementById('modalViewTaskDueDateValue').textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-';
                
                let relatedIpRecordText = '-';
                if (task.relatedIpRecordId) {
                    const ipRecord = ipRecords.find(r => r.id === task.relatedIpRecordId);
                    relatedIpRecordText = ipRecord ? `${ipRecord.title} (${ipRecord.applicationNumber || 'No: Yok'})` : 'Bulunamadı';
                }
                document.getElementById('modalViewRelatedIpRecordValue').textContent = relatedIpRecordText;

                // İlgili taraf bilgisi
                const relatedPartyGroup = document.getElementById('modalViewRelatedPartyGroup');
                const relatedPartyLabel = document.getElementById('modalViewRelatedPartyLabel');
                const relatedPartyValue = document.getElementById('modalViewRelatedPartyValue');
                
                if (task.relatedPartyId && persons.length > 0) {
                    const relatedParty = persons.find(p => p.id === task.relatedPartyId);
                    if (relatedParty) {
                        relatedPartyGroup.style.display = 'block';
                        relatedPartyLabel.textContent = 'İlgili Taraf';
                        relatedPartyValue.textContent = relatedParty.name;
                    } else {
                        relatedPartyGroup.style.display = 'none';
                    }
                } else {
                    relatedPartyGroup.style.display = 'none';
                }

                // İlişkili tahakkuklar - DÜZELTİLMİŞ VERSİYON
                const modalViewRelatedAccruals = document.getElementById('modalViewRelatedAccruals');
                const relatedAccruals = this.allAccruals.filter(acc => acc.taskId === task.id);
                
                if (relatedAccruals.length > 0) {
                    modalViewRelatedAccruals.innerHTML = relatedAccruals.map(acc => {
                        const statusText = acc.status === 'paid' ? 'Ödendi' : 'Ödenmedi';
                        const statusBadgeClass = acc.status === 'paid' ? 'status-badge status-paid' : 'status-badge status-unpaid';
                        
                        // HATA DÜZELTİLDİ: formatCurrencyAmount kullanılıyor
                        const totalAmountText = this.formatCurrencyAmount(acc.totalAmount, acc.totalAmountCurrency);
                        
                        return `<div class="related-accrual-item">
                            <b>ID:</b> ${acc.id.substring(0,8)}... | 
                            <b>Durum:</b> <span class="${statusBadgeClass}">${statusText}</span> | 
                            <b>Tutar:</b> ${totalAmountText}
                        </div>`;
                    }).join('');
                } else {
                    modalViewRelatedAccruals.innerHTML = '<p>Bu işe ait tahakkuk bulunmuyor.</p>';
                }

                // İşlem geçmişi
                const modalViewTaskHistory = document.getElementById('modalViewTaskHistory');
                modalViewTaskHistory.innerHTML = '';
                if (!task.history || task.history.length === 0) {
                    modalViewTaskHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">İşlem geçmişi bulunmuyor.</p>';
                } else {
                    const sortedHistory = [...task.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedHistory.forEach(entry => {
                        const item = document.createElement('div');
                        item.className = 'task-history-item';
                        item.innerHTML = `<div class="task-history-item-content"><div class="task-history-info"><div class="task-history-description">${entry.action}</div><div class="task-history-meta">${new Date(entry.timestamp).toLocaleString('tr-TR')} by ${entry.userEmail}</div></div></div>`;
                        modalViewTaskHistory.appendChild(item);
                    });
                }
            }

            showCompleteTaskModal(taskId, relatedIpRecordId) {
                const modal = document.getElementById('completeTaskModal');
                if (!modal) return;
                document.getElementById('completeTaskId').value = taskId;
                document.getElementById('completeTaskRelatedIpRecordId').value = relatedIpRecordId;
                this.uploadedCompletionFiles = [];
                document.getElementById('completeTaskFileList').innerHTML = '';
                modal.classList.add('show');
            }

            async completeTask(actionType) {
                const taskId = document.getElementById('completeTaskId').value;
                const relatedIpRecordId = document.getElementById('completeTaskRelatedIpRecordId').value;
                if (!taskId) { 
                    alert('İş ID\'si bulunamadı.'); 
                    return; 
                }
                
                const actionMessages = {
                    completed_with_doc: { 
                        confirm: 'Bu işi "Tamamlandı" olarak işaretlemek istediğinizden emin misiniz?',
                        success: 'İş başarıyla tamamlandı olarak işaretlendi.'
                    }
                };

                if (!confirm(actionMessages[actionType].confirm)) return;

                try {
                    const completionNotes = document.getElementById('completionNotes').value;
                    const taskData = {
                        status: 'completed',
                        completionNotes,
                        completionFiles: this.uploadedCompletionFiles
                    };

                    const result = await taskService.updateTask(taskId, taskData);
                    if (result.success) {
                        if (relatedIpRecordId) {
                            const transactionData = {
                                type: 'task_completed',
                                description: `İş tamamlandı: ${completionNotes || 'Açıklama yok'}`,
                                documentFiles: this.uploadedCompletionFiles
                            };
                            await ipRecordsService.addTransactionToRecord(relatedIpRecordId, transactionData);
                        }

                        alert(actionMessages[actionType].success);
                        this.closeModal('completeTaskModal');
                        await this.loadInitialData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('İş tamamlama hatası:', error);
                    alert('İş tamamlanırken bir hata oluştu: ' + error.message);
                }
            }

            showAddAccrualModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) {
                    alert('Tahakkuk eklenecek iş bulunamadı.');
                    return;
                }
                
                document.getElementById('addAccrualForm').reset();
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                document.getElementById('selectedTpInvoicePartyDisplay').style.display = 'none';
                document.getElementById('selectedServiceInvoicePartyDisplay').style.display = 'none';
                document.getElementById('tpInvoicePartySearch').value = '';
                document.getElementById('serviceInvoicePartySearch').value = '';
                
                document.getElementById('accrualTaskId').value = taskId;
                document.getElementById('accrualTaskTitleDisplay').value = task.title;
                
                this.calculateTotalAmount();
                document.getElementById('addAccrualModal').classList.add('show');
            }

            // DÜZELTİLMİŞ handleSaveAccrual - Duplikasyon koruması ile
            async handleSaveAccrual() {
                // Çoklu tıklama koruması
                if (this.isSavingAccrual) {
                    console.log('Tahakkuk kaydediliyor, lütfen bekleyin...');
                    return;
                }
                
                this.isSavingAccrual = true;
                
                try {
                    const taskId = document.getElementById('accrualTaskId').value;
                    const task = this.tasks.find(t => t.id === taskId);

                    const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                    const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                    
                    if (officialFee <= 0 && serviceFee <= 0) {
                        alert("Lütfen en az bir ücret girin.");
                        return;
                    }

                    // Buton deaktif et
                    const saveButton = document.getElementById('saveAccrualBtn');
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.textContent = 'Kaydediliyor...';
                    }

                    const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                    const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;
                    
                    let totalAmount;
                    if (applyVatToOfficial) {
                        totalAmount = (officialFee + serviceFee) * (1 + vatRate / 100);
                    } else {
                        totalAmount = officialFee + (serviceFee * (1 + vatRate / 100));
                    }

                    const accrualData = {
                        taskId: taskId,
                        taskTitle: task.title,
                        officialFee: {
                            amount: officialFee,
                            currency: this.normalizeCurrencyCode(document.getElementById('officialFeeCurrency').value)
                        },
                        serviceFee: {
                            amount: serviceFee,
                            currency: this.normalizeCurrencyCode(document.getElementById('serviceFeeCurrency').value)
                        },
                        vatRate,
                        applyVatToOfficialFee: applyVatToOfficial,
                        totalAmount,
                        totalAmountCurrency: 'TRY', // TL yerine TRY
                        tpInvoiceParty: this.selectedTpInvoiceParty ? 
                            {id: this.selectedTpInvoiceParty.id, name: this.selectedTpInvoiceParty.name} : null,
                        serviceInvoiceParty: this.selectedServiceInvoiceParty ? 
                            {id: this.selectedServiceInvoiceParty.id, name: this.selectedServiceInvoiceParty.name} : null,
                    };
                    
                    const result = await accrualService.addAccrual(accrualData);
                    if (result.success) {
                        alert('Yeni tahakkuk başarıyla eklendi!');
                        
                        // Sadece başarılı olursa listeye ekle (duplikasyonu önler)
                        if (!this.allAccruals.find(acc => acc.id === result.data.id)) {
                            this.allAccruals.push(result.data);
                        }
                        
                        this.closeModal('addAccrualModal');
                        
                        // Sayfayı yenile (en güncel veri için)
                        await this.loadInitialData();
                    } else {
                        alert('Tahakkuk eklenirken hata oluştu: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Tahakkuk kaydetme hatası:', error);
                    alert('Beklenmeyen bir hata oluştu: ' + error.message);
                } finally {
                    // Her durumda kilidi aç
                    this.isSavingAccrual = false;
                    
                    // Butonu tekrar aktif et
                    const saveButton = document.getElementById('saveAccrualBtn');
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Tahakkuk Ekle';
                    }
                }
            }

            calculateTotalAmount() {
                const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;

                let total;
                if(applyVatToOfficial) {
                    total = (officialFee + serviceFee) * (1 + vatRate / 100);
                } else {
                    total = officialFee + (serviceFee * (1 + vatRate / 100));
                }
                
                // TL yerine TRY göster ama kullanıcı için TL yazsın
                const displayElement = document.getElementById('totalAmountDisplay');
                if (displayElement) {
                    displayElement.textContent = `${total.toFixed(2)} TL`;
                }
            }

            searchPersons(query, target) {
                const resultsContainerId = {
                    'tpInvoiceParty': 'tpInvoicePartyResults',
                    'serviceInvoiceParty': 'serviceInvoicePartyResults'
                }[target];
                const container = document.getElementById(resultsContainerId);
                if (!container) return;
                
                container.innerHTML = '';
                if (query.length < 2) { 
                    container.innerHTML = ''; 
                    return; 
                }
                
                const filtered = this.allPersons.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
                if (filtered.length === 0) { 
                    container.innerHTML = '<p class="no-results-message">Kişi bulunamadı.</p>'; 
                    return; 
                }

                filtered.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = p.name;
                    item.addEventListener('click', () => this.selectPerson(p, target));
                    container.appendChild(item);
                });
            }

            selectPerson(person, target) {
                if (target === 'tpInvoiceParty') {
                    this.selectedTpInvoiceParty = person;
                    document.getElementById('selectedTpInvoicePartyDisplay').innerHTML = `<strong>Seçilen:</strong> ${person.name}`;
                    document.getElementById('selectedTpInvoicePartyDisplay').style.display = 'block';
                    document.getElementById('tpInvoicePartyResults').innerHTML = '';
                } else if (target === 'serviceInvoiceParty') {
                    this.selectedServiceInvoiceParty = person;
                    document.getElementById('selectedServiceInvoicePartyDisplay').innerHTML = `<strong>Seçilen:</strong> ${person.name}`;
                    document.getElementById('selectedServiceInvoicePartyDisplay').style.display = 'block';
                    document.getElementById('serviceInvoicePartyResults').innerHTML = '';
                }
            }

            handleCompletionFileUpload(event) {
                const files = Array.from(event.target.files);
                files.forEach(file => this.addCompletionFile(file));
            }

            async addCompletionFile(file) {
                try {
                    const dataUrl = await this.readFileAsDataURL(file);
                    const fileData = {
                        id: Date.now() + Math.random(),
                        name: file.name,
                        size: file.size,
                        content: dataUrl
                    };
                    
                    this.uploadedCompletionFiles.push(fileData);
                    this.renderCompletionFileList();
                } catch (error) {
                    console.error('Dosya yükleme hatası:', error);
                    alert('Dosya yüklenirken hata oluştu: ' + error.message);
                }
            }

            renderCompletionFileList() {
                const container = document.getElementById('completeTaskFileList');
                container.innerHTML = '';
                
                this.uploadedCompletionFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'file-item-task-detail';
                    item.innerHTML = `
                        <span>📄 ${file.name} (${this.formatFileSize(file.size)})</span>
                        <button class="remove-file-task-detail" onclick="myTasksModule.removeCompletionFile('${file.id}')">×</button>
                    `;
                    container.appendChild(item);
                });
            }

            removeCompletionFile(fileId) {
                this.uploadedCompletionFiles = this.uploadedCompletionFiles.filter(f => f.id !== fileId);
                this.renderCompletionFileList();
            }

            readFileAsDataURL(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                if (modalId === 'completeTaskModal') {
                    this.uploadedCompletionFiles = [];
                    document.getElementById('completeTaskFileList').innerHTML = '';
                }
                if (modalId === 'addAccrualModal') {
                    document.getElementById('addAccrualForm').reset();
                    this.selectedTpInvoiceParty = null;
                    this.selectedServiceInvoiceParty = null;
                }
            }
        }

        // Global instance
        const myTasksModule = new MyTasksModule();

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user || authService.getCurrentUser()) {
                myTasksModule.init();
                window.myTasksModule = myTasksModule;
            } else {
                window.location.href = 'index.html';
            }
        });

        // Modal click outside to close
        window.addEventListener('click', (event) => {
            const modals = ['viewTaskDetailModal', 'completeTaskModal', 'addAccrualModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    myTasksModule.closeModal(modalId);
                }
            });
        });
    </script>
</body>
</html>