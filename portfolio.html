<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Portföy</title>
    <style>
        /* Bu sayfaya özel stiller */
        /* Genel body, page-wrapper, main-container stilleri shared-styles.css'ten gelecektir. */
        /* Sadece bu sayfaya özgü ve çakışmayan stilleri burada tutun */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; display: flex; }
        .page-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .main-container { width: 100%; padding: 30px; margin: 0; }
        
        /* Portfolio specific styles */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }

        .portfolio-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group { display: flex; gap: 10px; align-items: center; }
        .filter-label { font-weight: 500; }
        .filter-select, .search-input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .search-input { flex-grow: 1; min-width: 150px;}

        .btn-add-record {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-add-record:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.2);
        }

        /* Yeni Tablo Stil Tanımlamaları */
        .portfolio-table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden; /* Kenarları yuvarlak tutar */
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .portfolio-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .portfolio-table tr:hover {
            background-color: #f6f8fa;
        }

        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-right: 5px; /* Butonlar arasına boşluk */
        }
        .action-btn:last-child { margin-right: 0; } /* Son butonda boşluk olmasın */
        .action-btn:hover { opacity: 0.9; }
        .action-btn.edit-btn { background-color: #ffc107; color: #212529; }
        .action-btn.edit-btn:hover { background-color: #e0a800; }
        .action-btn.delete-btn { background-color: #dc3545; }
        .action-btn.delete-btn:hover { background-color: #c82333; }
        .action-btn.view-btn { background-color: #17a2b8; }
        .action-btn.view-btn:hover { background-color: #138496; }

        .no-records, .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            /* Tablonun içinde yer alacaksa, kapsayıcının tam genişliğini kaplamalıdır. */
            width: 100%;
            display: block; /* İçerik olmasa bile görünmesi için */
        }
        .loading { display: none; } /* Başlangıçta gizli */

        /* Modal Styles (for record detail) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px; /* Daha geniş modal */
            border-radius: 20px;
            animation-name: animatetop;
            animation-duration: 0.4s;
            max-height: 90vh;
            overflow-y: auto;
        }
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .close-modal-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-title { font-size: 1.5em; color: #1e3c72; margin-bottom: 20px;}
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; }
        .modal-detail-item { margin-bottom: 10px; }
        .modal-detail-label { font-weight: 600; color: #333; margin-bottom: 5px; font-size: 0.9em; }
        .modal-detail-value { color: #555; word-break: break-word; font-size: 0.95em; }
        .modal-detail-value.long-text { white-space: pre-wrap; background-color: #f8f9fa; padding: 8px; border-radius: 6px; }
        .modal-detail-section-title { grid-column: 1 / -1; font-size: 1.1em; color: #1e3c72; margin-top: 20px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #e1e8ed; }
        .document-list { list-style: none; padding: 0; }
        .document-list li { margin-bottom: 8px; font-size: 0.95em;}
        .document-list li a { text-decoration: none; color: #1e3c72; display: flex; align-items: center; gap: 8px;}
        .document-list li a:hover { text-decoration: underline; }
        .document-list li .doc-icon { font-size: 1.2em; }
        .record-image-display { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }
        .transaction-history { max-height: 300px; overflow-y: auto; }
        .transaction-item { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item div { margin-bottom: 3px; }
        .transaction-type { font-weight: 600; color: #333; }
        .transaction-meta { color: #666; }

    </style>
</head>
<body>
    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Portföy Yönetimi</h1>
                <p class="page-subtitle">Tüm fikri mülkiyet kayıtlarınızı burada görüntüleyin ve yönetin.</p>
            </section>
            
            <div class="portfolio-controls">
                <div class="filter-group">
                    <label class="filter-label" for="typeFilter">Kayıt Tipi:</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="all">Tümü</option>
                        <option value="patent">Patent</option>
                        <option value="trademark">Marka</option>
                        <option value="copyright">Telif Hakkı</option>
                        <option value="design">Tasarım</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label" for="ownerFilter">Hak Sahibi:</label>
                    <select id="ownerFilter" class="filter-select">
                        <option value="all">Tümü</option>
                        </select>
                </div>
                <input type="text" id="searchBar" class="search-input" placeholder="Başlık, numara, durum ara...">
                <button class="btn-add-record" onclick="window.location.href='data-entry.html'">
                    <span>&#x2795;</span> Yeni Kayıt Ekle
                </button>
            </div>
    
            <div class="portfolio-table-container">
                <table class="portfolio-table">
                    <thead>
                        <tr>
                            <th>Kayıt Tipi</th>
                            <th>Başlık</th>
                            <th>Başvuru Numarası</th>
                            <th>Başvuru Tarihi</th>
                            <th>Durum</th>
                            <th>Hak Sahipleri</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="portfolioTableBody">
                        </tbody>
                </table>
                <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                <div id="noRecordsMessage" class="no-records">Henüz kayıt bulunmamaktadır.</div>
            </div>
        </main>
    </div>

    <div id="recordDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeRecordDetailModal">&times;</span>
            <h3 class="modal-title" id="modalRecordTitle">Kayıt Detayı</h3>
            <div id="modalBody" class="modal-body-content">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { authService, ipRecordsService, personService, auth } from './firebase-config.js';
        import { showNotification, formatFileSize } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // Ortak layout'u yükle ve bu sayfanın aktif linkini belirt
            await loadSharedLayout({ activeMenuLink: 'portfolio.html' });

            class PortfolioModule {
                constructor() {
                    this.currentUser = null;
                    this.allRecords = [];
                    this.allPersons = [];
                }

                async init() {
                    this.currentUser = authService.getCurrentUser();
                    if (!this.currentUser) {
                        window.location.href = 'index.html';
                        return;
                    }
                    await this.loadAllData();
                    this.setupEventListeners();
                }

                async loadAllData() {
                    // Hatanın çözülmesi için loadingIndicator'ın varlığını kontrol edin.
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) {
                        loadingIndicator.style.display = 'block';
                    }
                    
                    try {
                        const [recordsResult, personsResult] = await Promise.all([
                            ipRecordsService.getRecords(),
                            personService.getPersons()
                        ]);

                        this.allRecords = recordsResult.success ? recordsResult.data : [];
                        this.allPersons = personsResult.success ? personsResult.data : [];
                        
                        this.populateOwnerFilter();
                        this.renderRecords(); // Initial render
                    } catch (error) {
                        showNotification('Veriler yüklenirken bir hata oluştu: ' + error.message, 'error');
                    } finally {
                        if (loadingIndicator) {
                            loadingIndicator.style.display = 'none';
                        }
                    }
                }

                setupEventListeners() {
                    document.getElementById('typeFilter').addEventListener('change', () => this.renderRecords());
                    document.getElementById('ownerFilter').addEventListener('change', () => this.renderRecords());
                    document.getElementById('searchBar').addEventListener('input', () => this.renderRecords());

                    document.getElementById('portfolioTableBody').addEventListener('click', (e) => { // grid yerine tableBody
                        if (e.target.classList.contains('action-btn')) {
                            e.preventDefault();
                            const recordId = e.target.dataset.id;
                            if (e.target.classList.contains('edit-btn')) {
                                window.location.href = `data-entry.html?id=${recordId}`;
                            } else if (e.target.classList.contains('delete-btn')) {
                                this.deleteRecord(recordId);
                            } else if (e.target.classList.contains('view-btn')) {
                                this.showRecordDetailModal(recordId);
                            }
                        }
                    });

                    document.getElementById('closeRecordDetailModal').addEventListener('click', () => this.closeModal('recordDetailModal'));
                }

                populateOwnerFilter() {
                    const ownerFilterSelect = document.getElementById('ownerFilter');
                    ownerFilterSelect.innerHTML = '<option value="all">Tümü</option>'; // Reset
                    const ownersMap = new Map(); // Use Map to ensure unique owners based on ID
                
                    this.allRecords.forEach(record => {
                        if (record.owners && Array.isArray(record.owners)) {
                            record.owners.forEach(owner => {
                                const person = this.allPersons.find(p => p.id === owner.id);
                                if (person && !ownersMap.has(person.id)) {
                                    ownersMap.set(person.id, person);
                                }
                            });
                        }
                    });
                
                    const sortedOwners = Array.from(ownersMap.values()).sort((a, b) => a.name.localeCompare(b.name));
                
                    sortedOwners.forEach(person => {
                        const option = document.createElement('option');
                        option.value = person.id;
                        option.textContent = person.name;
                        ownerFilterSelect.appendChild(option);
                    });
                }
                

                renderRecords() {
                    const tableBody = document.getElementById('portfolioTableBody'); // Tablo body'sine referans
                    const noRecordsMessage = document.getElementById('noRecordsMessage');
                    tableBody.innerHTML = ''; // İçeriği temizle

                    const typeFilter = document.getElementById('typeFilter').value;
                    const ownerFilter = document.getElementById('ownerFilter').value;
                    const searchTerm = document.getElementById('searchBar').value.toLowerCase();

                    const filteredRecords = this.allRecords.filter(record => {
                        const matchesType = typeFilter === 'all' || record.type === typeFilter;
                        const matchesOwner = ownerFilter === 'all' || (record.owners && record.owners.some(owner => owner.id === ownerFilter));
                        const matchesSearch = 
                            record.title.toLowerCase().includes(searchTerm) ||
                            (record.applicationNumber && record.applicationNumber.toLowerCase().includes(searchTerm)) ||
                            (record.status && record.status.toLowerCase().includes(searchTerm));
                        
                        return matchesType && matchesOwner && matchesSearch;
                    });

                    if (filteredRecords.length === 0) {
                        noRecordsMessage.style.display = 'block';
                        // Tabloya veri girmediğimizde "veri yok" mesajı görünür kalsın
                        tableBody.style.display = 'none'; // Tabloyu gizle
                        return;
                    }
                    noRecordsMessage.style.display = 'none';
                    tableBody.style.display = 'table-row-group'; // Tablo body'sini göster

                    filteredRecords.forEach(record => {
                        const row = document.createElement('tr'); // Her kayıt için bir tablo satırı
                        
                        const ownerNames = record.owners ? record.owners.map(owner => {
                            const person = this.allPersons.find(p => p.id === owner.id);
                            return person ? person.name : 'Bilinmeyen Kişi';
                        }).join(', ') : 'Belirtilmemiş';

                        row.innerHTML = `
                            <td>${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</td>
                            <td>${record.title || 'Başlıksız Kayıt'}</td>
                            <td>${record.applicationNumber || '-'}</td>
                            <td>${record.applicationDate || '-'}</td>
                            <td>${record.status || '-'}</td>
                            <td>${ownerNames || '-'}</td>
                            <td>
                                <button class="action-btn view-btn" data-id="${record.id}">Görüntüle</button>
                                <button class="action-btn edit-btn" data-id="${record.id}">Düzenle</button>
                                <button class="action-btn delete-btn" data-id="${record.id}">Sil</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }

                getRecordIcon(type) { // Bu fonksiyon artık kullanılmıyor, kaldırılabilir veya gelecekteki kart görünümü için tutulabilir.
                    switch (type) {
                        case 'patent': return '📋';
                        case 'trademark': return '🏷️';
                        case 'copyright': return '©️';
                        case 'design': return '🎨';
                        default: return '📄';
                    }
                }

                async deleteRecord(recordId) {
                    if (confirm('Bu kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                        const result = await ipRecordsService.deleteRecord(recordId);
                        if (result.success) {
                            showNotification('Kayıt başarıyla silindi.', 'success');
                            await this.loadAllData(); // Reload all data to refresh
                        } else {
                            showNotification('Kayıt silinirken hata oluştu: ' + result.error, 'error');
                        }
                    }
                }

                async showRecordDetailModal(recordId) {
                    const record = this.allRecords.find(r => r.id === recordId);
                    if (!record) {
                        showNotification('Kayıt bulunamadı.', 'error');
                        return;
                    }

                    const modal = document.getElementById('recordDetailModal');
                    const modalBody = document.getElementById('modalBody');
                    
                    document.getElementById('modalRecordTitle').textContent = `Kayıt Detayı: ${record.title || 'N/A'}`;

                    const getOwnerNames = (owners) => {
                        if (!owners || owners.length === 0) return '-';
                        return owners.map(owner => {
                            const person = this.allPersons.find(p => p.id === owner.id);
                            return person ? person.name : 'Bilinmeyen Kişi';
                        }).join(', ');
                    };
                    
                    let imageHtml = '';
                    if (record.type === 'trademark' && record.trademarkImage && record.trademarkImage.content) {
                        imageHtml = `<h4 class="modal-detail-section-title">Marka Görseli</h4><img src="${record.trademarkImage.content}" alt="Marka Görseli" class="record-image-display">`;
                    }

                    let documentsHtml = '<ul class="document-list"><li>Henüz belge yok.</li></ul>';
                    if (record.documents && record.documents.length > 0) {
                        documentsHtml = '<ul class="document-list">';
                        record.documents.forEach(doc => {
                            documentsHtml += `<li><a href="${doc.content}" download="${doc.name}"><span class="doc-icon">📄</span>${doc.name} (${formatFileSize(doc.size)}) - ${doc.documentDesignation || 'Belge'}</a></li>`;
                        });
                        documentsHtml += '</ul>';
                    }

                    let transactionsHtml = '<div class="transaction-history"><p>Henüz işlem geçmişi yok.</p></div>';
                    if (record.transactions && record.transactions.length > 0) {
                        transactionsHtml = '<div class="transaction-history">';
                        [...record.transactions].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(transaction => {
                            transactionsHtml += `
                                <div class="transaction-item">
                                    <div class="transaction-type">İşlem: ${transaction.type || 'Bilinmiyor'}</div>
                                    <div class="transaction-meta">Açıklama: ${transaction.description || '-'}</div>
                                    <div class="transaction-meta">Tarih: ${transaction.timestamp ? new Date(transaction.timestamp).toLocaleString('tr-TR') : '-'}</div>
                                </div>
                            `;
                        });
                        transactionsHtml += '</div>';
                    }

                    modalBody.innerHTML = `
                        <div class="modal-detail-grid">
                            <div class="modal-detail-item"><div class="modal-detail-label">Kayıt Tipi</div><div class="modal-detail-value">${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Durum</div><div class="modal-detail-value">${record.status}</div></div>
                            <div class="modal-detail-item full-width"><div class="modal-detail-label">Başlık</div><div class="modal-detail-value">${record.title}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Başvuru Numarası</div><div class="modal-detail-value">${record.applicationNumber || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Başvuru Tarihi</div><div class="modal-detail-value">${record.applicationDate || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Tescil Numarası</div><div class="modal-detail-value">${record.registrationNumber || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Tescil Tarihi</div><div class="modal-detail-value">${record.registrationDate || '-'}</div></div>
                            <div class="modal-detail-item full-width"><div class="modal-detail-label">Hak Sahipleri</div><div class="modal-detail-value">${getOwnerNames(record.owners)}</div></div>
                            
                            ${record.patentClass ? `<div class="modal-detail-item"><div class="modal-detail-label">Patent Sınıfı</div><div class="modal-detail-value">${record.patentClass}</div></div>` : ''}
                            ${record.renewalDatePatent ? `<div class="modal-detail-item"><div class="modal-detail-label">Patent Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDatePatent}</div></div>` : ''}

                            ${record.niceClass ? `<div class="modal-detail-item"><div class="modal-detail-label">Nice Sınıfı</div><div class="modal-detail-value">${record.niceClass}</div></div>` : ''}
                            ${record.renewalDateTrademark ? `<div class="modal-detail-item"><div class="modal-detail-label">Marka Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDateTrademark}</div></div>` : ''}

                            ${record.copyrightType ? `<div class="modal-detail-item"><div class="modal-detail-label">Telif Hakkı Tipi</div><div class="modal-detail-value">${record.copyrightType}</div></div>` : ''}
                            
                            ${record.designClass ? `<div class="modal-detail-item"><div class="modal-detail-label">Tasarım Sınıfı</div><div class="modal-detail-value">${record.designClass}</div></div>` : ''}
                            ${record.renewalDateDesign ? `<div class="modal-detail-item"><div class="modal-detail-label">Tasarım Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDateDesign}</div></div>` : ''}

                            <div class="modal-detail-item full-width"><div class="modal-detail-label">Açıklama</div><div class="modal-detail-value long-text">${record.description || '-'}</div></div>
                        </div>
                        ${imageHtml}
                        <h4 class="modal-detail-section-title">Ekli Belgeler</h4>
                        <div class="modal-detail-item full-width">${documentsHtml}</div>
                        <h4 class="modal-detail-section-title">İşlem Geçmişi</h4>
                        <div class="modal-detail-item full-width">${transactionsHtml}</div>
                    `;
                    modal.classList.add('show');
                }

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('show');
                }
            }

            const portfolioModule = new PortfolioModule();
            portfolioModule.init();
        });
    </script>
</body>
</html>