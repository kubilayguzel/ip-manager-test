<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Belge İndeksleme</title>
    <link rel="stylesheet" href="css/shared-styles.css"> 
    <style>
        .main-container { width: 100%; padding: 30px; margin: 0; }
        .page-header-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; margin-bottom: 30px; }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .form-container { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .form-section { border-bottom: 1px solid #e1e8ed; padding-bottom: 25px; margin-bottom: 25px; }
        .form-section:last-child { border-bottom: none; }
        .section-title { font-size: 1.3em; color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .form-actions { display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #e1e8ed; justify-content: flex-end; }
        .btn { padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; }
        
        .search-wrapper { position: relative; }
        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: white;
            z-index: 100;
            display: none;
        }
        
        .record-search-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px dashed #e1e8ed; cursor: pointer; }
        .record-search-item:hover { background-color: #f0f4f8; }
        .record-search-item:last-child { border-bottom: none; }
        .record-search-item.selected { background-color: #e6f2ff; }

        .file-list { margin-top: 15px; }
        .file-item { display: flex; flex-direction: column; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .file-item-controls { display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .file-item-select { flex-grow: 1; min-width: 150px; padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.85em; }
        .remove-file { background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; flex-shrink: 0; align-self: center; }

        .tabs-container { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 1rem; }
        .tab-btn { padding: 0.75rem 1.25rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: #6c757d; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #1e3c72; border-color: #1e3c72; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .transaction-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 5px; }
        .transaction-list-item { padding: 10px; cursor: pointer; border-radius: 6px; }
        .transaction-list-item:hover { background-color: #f0f4f8; }
        .transaction-list-item.selected { background-color: #e6f2ff; color: #1e3c72; font-weight: bold; }

        /* Yeni eklenecek child işlem tanımı alanı için stil */
        .child-transaction-inputs {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e1e8ed;
            display: none; /* Varsayılan olarak gizli */
        }
    </style>
</head>
<body>
    <div id="layout-placeholder"></div>

    <div class="page-wrapper">
        <main class="main-container">
            <div class="page-header-section">
                <h1 class="page-title">Belge İndeksleme</h1>
                <p class="page-subtitle">Mevcut fikri mülkiyet kayıtlarına belge ekleyin ve indeksleyin.</p>
            </div>
    
            <div class="form-container">
                <form id="indexingForm" onsubmit="return false;">
                    <div class="form-section record-search-section">
                        <h2 class="section-title"><span>1.</span>Kayıt Seçin</h2>
                        <div class="form-group search-wrapper">
                            <label class="form-label" for="recordSearchInput">Başvuru Numarası veya Başlık ile Ara</label>
                            <input type="text" id="recordSearchInput" class="form-input" placeholder="Örn: TR2024/123, Proje X..." autocomplete="off">
                            <div class="search-results-container" id="searchResultsContainer">
                                <p class="no-results-message p-2">Arama yapmak için yukarıya yazın.</p>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Seçili Kayıt:</label>
                            <input type="text" id="selectedRecordDisplay" class="form-input" readonly placeholder="Henüz kayıt seçilmedi.">
                        </div>
                    </div>
    
                    <div class="form-section document-upload-section" id="documentUploadSection" style="display: none;">
                        <h2 class="section-title"><span>2.</span>Belgeleri Yükleyin ve İndeksleyin</h2>
                        
                        <div class="tabs-container">
                            <button type="button" class="tab-btn active" data-tab="existing-transaction-pane">İşleme Dosya Ekle</button>
                            <button type="button" class="tab-btn" data-tab="manual-indexing-pane">Manuel İşlem Oluştur</button>
                        </div>
                        
                        <div class="tab-content-container">
                            <div id="existing-transaction-pane" class="tab-pane active">
                                <div class="form-group">
                                    <label class="form-label">A) Dosyanın Ekleneceği PARENT İşlemi Seçin</label>
                                    <div id="transactions-list-for-selection" class="transaction-list-container">
                                        <p class="text-muted p-2">Lütfen bir kayıt seçin.</p>
                                    </div>
                                </div>

                                <div id="childTransactionInputs" class="child-transaction-inputs">
                                    <h4 class="section-title" style="font-size: 1.1em;"><span>A-1.</span> Yeni Çocuk İşlem Oluştur (Opsiyonel)</h4>
                                    <div class="form-group">
                                        <label class="form-label" for="specificChildTransactionDesignation">Çocuk İşlem Başlığı (Örn: Ret Kararı)</label>
                                        <input type="text" id="specificChildTransactionDesignation" class="form-input" placeholder="Çocuk işlem başlığını girin...">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="specificChildTransactionType">Çocuk İşlem Türünü Seçin</label>
                                        <select id="specificChildTransactionType" class="form-select">
                                            <option value="" disabled selected>İşlem türü seçin...</option>
                                            <option value="Karara İtiraz">Karara İtiraz</option>
                                            <option value="Yayına İtiraz">Yayına İtiraz</option>
                                            <option value="İtiraza Cevap">İtiraza Cevap</option>
                                            <option value="Ret Kararı">Ret Kararı</option>
                                            <option value="Kabul Kararı">Kabul Kararı</option>
                                            <option value="Eksiklik Bildirimi">Eksiklik Bildirimi</option>
                                            <option value="Genel">Genel</option>
                                            <option value="Diğer">Diğer</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="specificChildTransactionNotes">Notlar (İsteğe Bağlı)</label>
                                        <textarea id="specificChildTransactionNotes" class="form-input" rows="2" placeholder="Çocuk işlemle ilgili notlar..."></textarea>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="filesExisting">B) Dosyaları Yükle</label>
                                    <input type="file" id="filesExisting" class="form-control" multiple>
                                </div>
                                <div class="file-list" id="fileListExisting"></div>
                            </div>

                            <div id="manual-indexing-pane" class="tab-pane">
                                <div class="form-group">
                                    <label class="form-label" for="specificTransactionDesignation">A) Yeni İşlem Başlığı (Örn: Ret Kararı, Yenileme)</label>
                                    <input type="text" id="specificTransactionDesignation" class="form-input" placeholder="İşlem başlığını girin...">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="specificTransactionType">Yeni İşlem Türünü Seçin</label>
                                    <select id="specificTransactionType" class="form-select">
                                        <option value="" disabled selected>İşlem türü seçin...</option>
                                        <option value="Başvuru">Başvuru</option>
                                        <option value="Yenileme">Yenileme</option>
                                        <option value="Devir">Devir</option>
                                        <option value="Lisans">Lisans</option>
                                        <option value="Karara İtiraz">Karara İtiraz</option>
                                        <option value="Yayına İtiraz">Yayına İtiraz</option>
                                        <option value="İtiraza Cevap">İtiraza Cevap</option>
                                        <option value="Ödeme">Ödeme</option>
                                        <option value="Genel">Genel</option>
                                        <option value="Diğer">Diğer</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="specificTransactionNotes">Notlar (İsteğe Bağlı)</label>
                                    <textarea id="specificTransactionNotes" class="form-input" rows="3" placeholder="İşlemle ilgili notlar..."></textarea>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="specificTransactionParentId">Parent İşlem Seç (Bu bir çocuk işlemse)</label>
                                    <select id="specificTransactionParentId" class="form-select">
                                        <option value="">Yok (Ana İşlem)</option>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="filesManual">B) Dosyaları Yükle</label>
                                    <input type="file" id="filesManual" class="form-control" multiple>
                                </div>
                                <div class="file-list" id="fileListManual"></div>
                            </div>
                        </div>
                    </div>
    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="resetIndexingFormBtn">Temizle</button>
                        <button type="submit" class="btn btn-primary" id="indexDocumentsBtn" disabled>Değişiklikleri Kaydet</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { authService, ipRecordsService, auth, generateUUID } from './firebase-config.js';
        import { showNotification, formatFileSize, readFileAsDataURL } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';
        import { documentDesignationTranslations } from './firebase-config.js'; 

        // documentDesignationTranslations objesini bir diziye çevirelim
        const DOCUMENT_DESIGNATION_TYPES = Object.values(documentDesignationTranslations);

        class IndexingModule {
            constructor() {
                this.currentUser = null;
                this.allRecords = []; 
                this.selectedRecord = null; 
                this.uploadedFiles = new Map(); // Key: tabKey (existing/manual), Value: Array of { id, fileObject, documentDesignation }
                this.selectedTransactionId = null; // 'existing-transaction-pane' için seçilen parent transaction ID'si
                this.activeTab = 'existing-transaction-pane';
                
                this.init();
            }

            async init() {
                this.currentUser = authService.getCurrentUser();
                if(!this.currentUser) {
                    window.location.href = 'index.html';
                    return; 
                }

                await this.loadRecords();
                this.setupEventListeners();
                this.activateTab(this.activeTab); 
            }

            async loadRecords() {
                const result = await ipRecordsService.getRecords();
                if (result.success) this.allRecords = result.data;
                else showNotification('Kayıtlar yüklenemedi: ' + result.error, 'error');
            }

            setupEventListeners() {
                const searchInput = document.getElementById('recordSearchInput');
                searchInput.addEventListener('input', (e) => this.searchRecords(e.target.value));
                searchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('searchResultsContainer').style.display = 'none';
                    }, 200);
                });
                
                document.getElementById('filesExisting').addEventListener('change', (e) => this.handleFileChange(e, 'existing-transaction-pane'));
                document.getElementById('filesManual').addEventListener('change', (e) => this.handleFileChange(e, 'manual-indexing-pane'));
                document.getElementById('indexDocumentsBtn').addEventListener('click', () => this.handleSubmit());
                document.getElementById('resetIndexingFormBtn').addEventListener('click', () => this.resetForm());
                
                document.querySelectorAll('.tabs-container .tab-btn').forEach(btn => { 
                    btn.addEventListener('click', (e) => {
                        const targetTab = e.currentTarget.dataset.tab;
                        this.activateTab(targetTab); 
                    });
                });
                
                document.addEventListener('change', (e) => {
                    if (e.target.classList.contains('file-indexing-type-select')) {
                        const fileId = e.target.dataset.fileId;
                        const tabKey = e.target.dataset.tabKey;
                        const newType = e.target.value;
                        const files = this.uploadedFiles.get(tabKey) || [];
                        const fileToUpdate = files.find(f => f.id === fileId);
                        if (fileToUpdate) fileToUpdate.documentDesignation = newType;
                    }
                    this.checkFormCompleteness(); // Her select değiştiğinde formu kontrol et
                });

                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-uploaded-file')) {
                        const fileId = e.target.dataset.fileId;
                        const tabKey = e.target.dataset.tabKey;
                        let files = this.uploadedFiles.get(tabKey) || [];
                        this.uploadedFiles.set(tabKey, files.filter(f => f.id !== fileId));
                        this.renderUploadedFilesList(tabKey);
                    }
                });
                
                document.getElementById('specificTransactionParentId').addEventListener('focus', () => {
                    if (this.selectedRecord) {
                        this.populateParentTransactionSelect(this.selectedRecord.transactions);
                    }
                });

                // Yeni eklenen çocuk işlem inputları için listenerlar
                document.getElementById('specificChildTransactionDesignation').addEventListener('input', () => this.checkFormCompleteness());
                document.getElementById('specificChildTransactionType').addEventListener('change', () => this.checkFormCompleteness());
            }

            activateTab(tabName) {
                this.activeTab = tabName;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                this.checkFormCompleteness(); 
            }

            searchRecords(query) {
                const container = document.getElementById('searchResultsContainer');
                if (query.length < 3) {
                    container.innerHTML = '<p class="no-results-message p-2">Arama yapmak için en az 3 karakter girin.</p>';
                    container.style.display = 'block';
                    return;
                }
                container.innerHTML = '';
                const filtered = this.allRecords.filter(r => 
                    (r.title && r.title.toLowerCase().includes(query.toLowerCase())) ||
                    (r.applicationNumber && r.applicationNumber.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filtered.length === 0) {
                    container.innerHTML = '<p class="no-results-message p-2">Kayıt bulunamadı.</p>';
                } else {
                    filtered.forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'record-search-item';
                        item.innerHTML = `<div class="record-info"><div>${record.title}</div><small>${record.applicationNumber}</small></div>`;
                        item.addEventListener('click', () => this.selectRecord(record.id));
                        container.appendChild(item);
                    });
                }
                container.style.display = 'block';
            }

            selectRecord(recordId) {
                this.selectedRecord = this.allRecords.find(r => r.id === recordId);
                document.getElementById('selectedRecordDisplay').value = `${this.selectedRecord.title} (${this.selectedRecord.applicationNumber})`;
                document.getElementById('searchResultsContainer').style.display = 'none';
                document.getElementById('recordSearchInput').value = '';
                document.getElementById('documentUploadSection').style.display = 'block';
                this.renderTransactionsForSelection(); // Mevcut işlemleri listele
                this.populateParentTransactionSelect(this.selectedRecord.transactions); // Manuel işlem için parent listesini doldur
                this.checkFormCompleteness();

                // Kayıt seçildiğinde child işlem inputlarını gizle/göster (varsayılan gizli)
                const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                if (childTransactionInputsEl) {
                    childTransactionInputsEl.style.display = 'none'; // İlk başta gizle
                }
                this.selectedTransactionId = null; // Yeni kayıt seçildiğinde transaction seçimi sıfırla
            }

            renderTransactionsForSelection() {
                const container = document.getElementById('transactions-list-for-selection');
                container.innerHTML = '';
                this.selectedTransactionId = null; 
                
                const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                if (childTransactionInputsEl) {
                    childTransactionInputsEl.style.display = 'none'; // Parent seçimi değişince gizle
                    document.getElementById('specificChildTransactionDesignation').value = '';
                    document.getElementById('specificChildTransactionType').value = '';
                    document.getElementById('specificChildTransactionNotes').value = '';
                }

                const transactions = this.selectedRecord.transactions || [];

                if (transactions.length === 0) {
                    container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut işlem yok. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                    return;
                }
                
                const parentTransactions = transactions
                    .filter(tx => tx.transactionHierarchy === 'parent' || !tx.transactionHierarchy) 
                    .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                if (parentTransactions.length === 0) {
                     container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut ana işlem bulunamadı. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                     return;
                }

                parentTransactions.forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'transaction-list-item';
                    item.dataset.id = tx.transactionId;
                    item.textContent = `${tx.designation || tx.transactionType} - ${new Date(tx.timestamp).toLocaleDateString('tr-TR')}`;
                    item.addEventListener('click', (e) => {
                        // Parent işlem seçildiğinde
                        this.selectedTransactionId = e.currentTarget.dataset.id;
                        document.querySelectorAll('#transactions-list-for-selection .transaction-list-item').forEach(el => el.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        
                        // Child işlem inputlarını göster
                        if (childTransactionInputsEl) {
                            childTransactionInputsEl.style.display = 'block'; 
                        }
                        this.checkFormCompleteness();
                    });
                    container.appendChild(item);
                });
            }

            populateParentTransactionSelect(transactions) {
                const selectEl = document.getElementById('specificTransactionParentId');
                selectEl.innerHTML = '<option value="">Yok (Ana İşlem)</option>'; 

                const parentTransactions = (transactions || [])
                    .filter(tx => tx.transactionHierarchy === 'parent' || !tx.transactionHierarchy) 
                    .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                parentTransactions.forEach(tx => {
                    const option = document.createElement('option');
                    option.value = tx.transactionId;
                    option.textContent = `${tx.designation || tx.transactionType} (${new Date(tx.timestamp).toLocaleDateString('tr-TR')})`;
                    selectEl.appendChild(option);
                });
            }
            
            handleFileChange(event, tabKey) {
                const fileInput = event.target;
                const files = Array.from(fileInput.files);
                const currentFiles = this.uploadedFiles.get(tabKey) || [];
                files.forEach(file => {
                    currentFiles.push({
                        id: `temp_${Date.now()}_${generateUUID()}`, 
                        fileObject: file,
                        documentDesignation: DOCUMENT_DESIGNATION_TYPES[0] || 'Diğer Belge' 
                    });
                });
                this.uploadedFiles.set(tabKey, currentFiles);
                this.renderUploadedFilesList(tabKey);
                this.checkFormCompleteness();
            }

            renderUploadedFilesList(tabKey) {
                const containerId = tabKey === 'existing-transaction-pane' ? 'fileListExisting' : 'fileListManual';
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const files = this.uploadedFiles.get(tabKey) || [];
                if (files.length === 0) return;

                files.forEach(fileData => {
                    const selectOptions = DOCUMENT_DESIGNATION_TYPES.map(type => 
                        `<option value="${type}" ${fileData.documentDesignation === type ? 'selected' : ''}>${type}</option>`
                    ).join('');
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="d-flex justify-content-between w-100">
                            <strong>${fileData.fileObject.name}</strong>
                            <button type="button" class="remove-file remove-uploaded-file" data-file-id="${fileData.id}" data-tab-key="${tabKey}">&times;</button>
                        </div>
                        <div class="file-item-controls">
                            <label class="form-label small mb-0">Belge Tipi:</label>
                            <select class="file-item-select file-indexing-type-select" data-file-id="${fileData.id}" data-tab-key="${tabKey}">${selectOptions}</select>
                        </div>
                    `;
                    container.appendChild(fileItem);
                });
            }

            checkFormCompleteness() {
                const filesExist = (this.uploadedFiles.get(this.activeTab) || []).length > 0;
                let canSubmit = false;

                if (!this.selectedRecord) {
                    canSubmit = false;
                } else if (this.activeTab === 'existing-transaction-pane') {
                    // Bu sekmede hem parent işlem seçili olmalı hem de (eğer girilmişse) çocuk işlem başlığı/türü dolu olmalı
                    const specificChildTransactionDesignation = document.getElementById('specificChildTransactionDesignation').value.trim();
                    const specificChildTransactionType = document.getElementById('specificChildTransactionType').value;

                    // Eğer çocuk işlem tanımları boşsa, sadece parent seçimi yeterli
                    // Eğer çocuk işlem tanımları dolduruluyorsa, ikisi de dolu olmalı
                    const childTransactionFieldsFilled = specificChildTransactionDesignation !== '' && specificChildTransactionType !== '';
                    const childTransactionFieldsEmpty = specificChildTransactionDesignation === '' && specificChildTransactionType === '';

                    canSubmit = filesExist && this.selectedTransactionId !== null && (childTransactionFieldsFilled || childTransactionFieldsEmpty);

                } else { // manual-indexing-pane
                    const specificTransactionDesignation = document.getElementById('specificTransactionDesignation').value.trim();
                    const specificTransactionType = document.getElementById('specificTransactionType').value;
                    canSubmit = filesExist && specificTransactionDesignation !== '' && specificTransactionType !== '';
                }
                document.getElementById('indexDocumentsBtn').disabled = !canSubmit;
            }

            async handleSubmit() {
                const btn = document.getElementById('indexDocumentsBtn');
                btn.disabled = true;
                showNotification('İşlem kaydediliyor...', 'info');

                const filesToProcess = this.uploadedFiles.get(this.activeTab) || [];
                if (filesToProcess.length === 0) {
                    showNotification('Lütfen en az bir dosya yükleyin.', 'error');
                    btn.disabled = false; return;
                }
                if (!this.selectedRecord) {
                    showNotification('Lütfen bir kayıt seçin.', 'error');
                    btn.disabled = false; return;
                }

                let transactionIdToAssociateFiles = null; // Dosyaların bağlanacağı transaction ID'si

                try {
                    // --- Manuel İşlem Oluşturma Sekmesi ---
                    if (this.activeTab === 'manual-indexing-pane') {
                        const specificTransactionDesignation = document.getElementById('specificTransactionDesignation').value.trim();
                        const specificTransactionType = document.getElementById('specificTransactionType').value;
                        const specificTransactionNotes = document.getElementById('specificTransactionNotes').value.trim();
                        const specificTransactionParentId = document.getElementById('specificTransactionParentId').value || null; 

                        if (!specificTransactionDesignation || !specificTransactionType) {
                            showNotification('Lütfen yeni işlem için başlık ve tür seçin.', 'error');
                            btn.disabled = false; return;
                        }

                        const newTransactionData = {
                            designation: specificTransactionDesignation,
                            transactionType: specificTransactionType,
                            notes: specificTransactionNotes,
                            transactionHierarchy: specificTransactionParentId ? 'child' : 'parent', 
                            parentId: specificTransactionParentId,
                        };

                        const transactionAddResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, newTransactionData);

                        if (!transactionAddResult.success) {
                            throw new Error(transactionAddResult.error || 'Yeni işlem oluşturulurken hata oluştu.');
                        }
                        transactionIdToAssociateFiles = transactionAddResult.data.transactionId;
                        showNotification('Yeni işlem başarıyla oluşturuldu.', 'success');

                    } else { // --- Mevcut İşleme Dosya Ekle Sekmesi ---
                        if (!this.selectedTransactionId) {
                            showNotification('Lütfen dosyaları bağlamak için bir PARENT işlem seçin.', 'error');
                            btn.disabled = false; return;
                        }
                        
                        const specificChildTransactionDesignation = document.getElementById('specificChildTransactionDesignation').value.trim();
                        const specificChildTransactionType = document.getElementById('specificChildTransactionType').value;
                        const specificChildTransactionNotes = document.getElementById('specificChildTransactionNotes').value.trim();

                        // Eğer çocuk işlem bilgileri girildiyse, yeni bir çocuk işlem oluştur
                        if (specificChildTransactionDesignation && specificChildTransactionType) {
                            const newChildTransactionData = {
                                designation: specificChildTransactionDesignation,
                                transactionType: specificChildTransactionType,
                                notes: specificChildTransactionNotes,
                                transactionHierarchy: 'child',
                                parentId: this.selectedTransactionId, // Seçilen parent işlem
                            };
                            const childTransactionAddResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, newChildTransactionData);
                            if (!childTransactionAddResult.success) {
                                throw new Error(childTransactionAddResult.error || 'Yeni çocuk işlem oluşturulurken hata oluştu.');
                            }
                            transactionIdToAssociateFiles = childTransactionAddResult.data.transactionId; // Dosyaları bu yeni child'a bağla
                            showNotification('Yeni çocuk işlem başarıyla oluşturuldu.', 'success');
                        } else {
                            // Çocuk işlem bilgileri girilmediyse, dosyaları doğrudan seçilen parent'a bağla
                            transactionIdToAssociateFiles = this.selectedTransactionId;
                            showNotification('Dosyalar mevcut PARENT işleme bağlanıyor.', 'info');
                        }
                    }

                    // --- Dosyaları Yükleme ve İlişkilendirme ---
                    for (const fileData of filesToProcess) {
                        try {
                            const fileContent = await readFileAsDataURL(fileData.fileObject); 
                            
                            const fileToUpload = {
                                fileName: fileData.fileObject.name,
                                fileType: fileData.fileObject.type,
                                fileSize: fileData.fileObject.size,
                                fileUrl: fileContent, 
                                relatedTransactionId: transactionIdToAssociateFiles, // İşlem ID'si
                                documentDesignation: fileData.documentDesignation 
                            };
                            const fileAddResult = await ipRecordsService.addFileToRecord(this.selectedRecord.id, fileToUpload);
                            if (!fileAddResult.success) {
                                console.error(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`);
                                showNotification(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`, 'error');
                            }
                        } catch (fileError) {
                            console.error(`Dosya işlenirken hata (${fileData.fileObject.name}):`, fileError);
                            showNotification(`Dosya işlenirken hata (${fileData.fileObject.name}): ${fileError.message}`, 'error');
                        }
                    }
                    
                    showNotification('Tüm işlemler ve belgeler başarıyla kaydedildi!', 'success');
                    this.resetForm();
                    await this.loadRecords(); 

                } catch (error) {
                    showNotification(`Genel hata oluştu: ${error.message}`, 'error');
                } finally {
                    btn.disabled = false;
                }
            }

            resetForm() {
                this.selectedRecord = null;
                this.uploadedFiles.clear();
                this.selectedTransactionId = null;
                this.activeTab = 'existing-transaction-pane'; 
                document.getElementById('indexingForm').reset();
                document.getElementById('documentUploadSection').style.display = 'none';
                document.getElementById('fileListExisting').innerHTML = '';
                document.getElementById('fileListManual').innerHTML = '';
                document.getElementById('transactions-list-for-selection').innerHTML = '<p class="text-muted p-2">Lütfen bir kayıt seçin.</p>';
                this.activateTab('existing-transaction-pane'); 
                
                // Çocuk işlem inputlarını da sıfırla ve gizle
                const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                if (childTransactionInputsEl) {
                    childTransactionInputsEl.style.display = 'none';
                    document.getElementById('specificChildTransactionDesignation').value = '';
                    document.getElementById('specificChildTransactionType').value = '';
                    document.getElementById('specificChildTransactionNotes').value = '';
                }

                this.checkFormCompleteness();
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'indexing.html' });
            new IndexingModule();
        });
    </script>
</body>
</html>