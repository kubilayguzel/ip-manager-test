<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Marka B√ºlten ƒ∞zleme</title>
    <script src="https://cdn.jsdelivr.net/npm/algoliasearch@4/dist/algoliasearch-lite.umd.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; display: flex; }
        .page-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .main-container { width: 100%; padding: 30px; margin: 0; }
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .monitoring-container, .results-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px; }
        .monitoring-header, .results-header { padding: 20px 30px; border-bottom: 1px solid #e1e8ed; }
        .monitoring-header h3, .results-header h3 { color: #1e3c72; margin-bottom: 20px; font-size: 1.3em; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; }
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; }
        .btn { padding: 12px 24px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; font-weight: 600; }
        .btn-primary { background: #1e3c72; color: white; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .results-table th { background: #f8f9fa; font-weight: 600; }
        .result-block { margin-bottom: 20px; }
        .similarity-list { list-style-type: none; padding-left: 0; }
        .similarity-list li { border-bottom: 1px dashed #ccc; padding: 10px 0; }
    </style>
</head>
<body>
    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Marka B√ºlten ƒ∞zleme</h1>
                <p class="page-subtitle">Marka b√ºltenlerini takip edin ve yeni ba≈üvurularƒ± izleyin.</p>
            </section>
    
            <div class="monitoring-container">
                <div class="monitoring-header">
                    <h3>Arama Kriterleri</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="owner-filter" class="form-label">Sahip</label>
                            <input type="text" id="owner-filter" class="form-input" placeholder="Sahip adƒ±na g√∂re filtrele">
                        </div>
                        <div class="form-group">
                            <label for="nice-filter" class="form-label">Nice Sƒ±nƒ±fƒ±</label>
                            <input type="text" id="nice-filter" class="form-input" placeholder="Nice sƒ±nƒ±fƒ±na g√∂re filtrele (√∂rn: 35)">
                        </div>
                        <div class="form-group">
                            <label for="bulletin-select" class="form-label">B√ºlten Se√ß</label>
                            <select id="bulletin-select" class="form-select">
                                <option value="">B√ºlten se√ßiniz...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="results-container">
                <h3>ƒ∞zlenecek Markalar</h3>
                <ul id="trademark-list" style="padding: 20px;"></ul>
                <div style="text-align: right; padding: 20px;">
                    <button type="button" class="btn btn-primary" id="start-search">üîç Aramayƒ± Ba≈ülat</button>
                </div>
            </div>

            <div class="results-container" style="margin-top: 30px;">
                <h3>Arama Sonu√ßlarƒ±</h3>
                <div id="search-results" style="padding: 20px;"></div>
                <div id="paginationContainer" style="padding: 20px;"></div> 
            </div>
        </main>
    </div>

<script type="module">
    // PAGINATION SINIFINI DOƒûRU YERDEN IMPORT EDƒ∞YORUZ
    import Pagination from './js/pagination.js'; 
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { firebaseConfig } from './firebase-config.js';
    import { loadSharedLayout } from './js/layout-loader.js';

    // Mevcut JS kodunuzun tamamƒ± (deƒüi≈üiklik yok)
    const algoliaClient = algoliasearch('THCIEJJTZ9', 'b6c38850bfc00adcf0ecdd9a14638c27');
    const index = algoliaClient.initIndex('trademark_bulletin_records_live');

    initializeApp(firebaseConfig);
    const db = getFirestore();

    const startButton = document.getElementById('start-search');
    const bulletinSelect = document.getElementById('bulletin-select');
    const ownerFilterInput = document.getElementById('owner-filter');
    const niceFilterInput = document.getElementById('nice-filter');
    const trademarkListEl = document.getElementById('trademark-list');
    const resultsContainer = document.getElementById('search-results');

    // YENƒ∞ GLOBAL DEƒûƒ∞≈ûKENLER
    let pagination;
    let allCombinedResults = [];

    // Sayfa y√ºklendiƒüinde layout ve b√ºltenleri doldur
    loadSharedLayout({ activeMenuLink: 'trademark-similarity-search.html' });
    loadBulletinOptions();
    initializePagination(); // Pagination'ƒ± ba≈ülat

    async function loadBulletinOptions() {
      const snapshot = await getDocs(collection(db, 'trademarkBulletins'));
      const bulletins = [];
      snapshot.forEach(doc => bulletins.push({ id: doc.id, ...doc.data() }));
      bulletinSelect.innerHTML = bulletins
        .map(b => `<option value="${b.id}">${b.bulletinNo} - ${b.bulletinDate}</option>`)
        .join('');
    }
    
    // YENƒ∞: Pagination'ƒ± ba≈ülatan fonksiyon
    function initializePagination() {
        pagination = new Pagination({
            containerId: 'paginationContainer',
            itemsPerPage: 5, // Her bir izlenen marka bir "sayfa" gibi d√º≈ü√ºn√ºlebilir
            onPageChange: () => {
                renderCurrentPageResults();
            }
        });
    }

    startButton.addEventListener('click', async () => {
      const selectedBulletin = bulletinSelect.value;
      if (!selectedBulletin) return alert('L√ºtfen bir b√ºlten se√ßin.');

      const ownerFilter = ownerFilterInput.value.toLowerCase();
      const niceFilter = niceFilterInput.value;

      const snapshot = await getDocs(collection(db, 'monitoringTrademarks'));
      const monitored = [];
      snapshot.forEach(doc => {
        const data = doc.data();
        const owner = (data.owners?.[0]?.name || '').toLowerCase();
        const niceMatch = !niceFilter || (data.niceClass && data.niceClass.includes(niceFilter));
        if (owner.includes(ownerFilter) && niceMatch) {
          monitored.push({ id: doc.id, ...data });
        }
      });

      trademarkListEl.innerHTML = monitored.map(m => `
        <li><strong>${m.title}</strong> (${m.applicationNumber})</li>
      `).join('');

      // ARAMA SONU√áLARINI GLOBAL DEƒûƒ∞≈ûKENDE SAKLA
      allCombinedResults = [];
      resultsContainer.innerHTML = 'Arama yapƒ±lƒ±yor...'; // Y√ºkleniyor mesajƒ±

      for (const trademark of monitored) {
        try {
          const hits = await runSimilaritySearch(trademark, selectedBulletin);
          allCombinedResults.push({ trademark, hits });
        } catch (e) {
          console.error("Arama hatasƒ±:", trademark.title, e);
          allCombinedResults.push({ trademark, hits: [] });
        }
      }
      
      // ARAMA Bƒ∞TTƒ∞KTEN SONRA PAGINATION'I G√úNCELLE
      pagination.update(allCombinedResults.length, 1);
    });

    async function runSimilaritySearch(trademark, bulletinId) {
      const query = trademark.title || trademark.markName;
      const { hits } = await index.search(query, {
        filters: `bulletinId:'${bulletinId}'`,
        hitsPerPage: 1000
      });
      return hits;
    }
    
    // ESKƒ∞ RENDER FONKSƒ∞YONU YERƒ∞NE YENƒ∞Sƒ∞
    function renderCurrentPageResults() {
        resultsContainer.innerHTML = '';
        const currentPageData = pagination.getCurrentPageData(allCombinedResults);
        
        currentPageData.forEach(({ trademark, hits }) => {
            let blockHtml = `<div class="result-block">
              <h3>${trademark.title} (${trademark.applicationNumber})</h3>`;
            if (hits.length > 0) {
              blockHtml += buildList(hits);
            } else {
              blockHtml += `<p>Benzer marka bulunamadƒ±.</p>`;
            }
            blockHtml += `</div><hr/>`;
            resultsContainer.innerHTML += blockHtml;
        });
    }

    function buildList(list) {
      return `
        <ul class="similarity-list">
          ${list.map(item => `
            <li>
              <strong>${item.markName}</strong> (${item.applicationNo})<br/>
              Sƒ±nƒ±flar: ${Array.isArray(item.niceClasses) ? item.niceClasses.join(', ') : (item.niceClasses || '-')}<br/>
              Ba≈üvuru Tarihi: ${new Date(item.applicationDate).toLocaleDateString('tr-TR')}
            </li>
          `).join('')}
        </ul>
      `;
    }
</script>
</body>
</html>