<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Belge İndeksleme</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="css/shared-styles.css" rel="stylesheet">
    <style>
        /* Sayfaya özel ek stiller */
        .select2-container--bootstrap-5 .select2-selection {
            border: 2px solid #e1e8ed;
            padding: 0.5rem 1rem;
            min-height: 48px;
        }

        .transaction-list-group .list-group-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .transaction-list-group .list-group-item.selected {
            background-color: #1e3c72;
            color: white;
            border-color: #1e3c72;
        }
        .file-item-card {
            border: 1px solid #ddd;
            border-left: 4px solid #0d6efd;
        }
        .file-item-card .card-body {
            padding: 1rem;
        }
    </style>
</head>
<body>
    <div id="layout-placeholder"></div>

    <main class="container-fluid mt-4">
        <div class="card p-4 shadow-sm">
            <div class="page-header mb-4 text-center">
                <h1 class="page-title">Belge İndeksleme ve Yönetimi</h1>
                <p class="page-subtitle">Mevcut kayıtlara yeni belgeler ekleyin veya var olanları yönetin.</p>
            </div>

            <div class="row mb-4">
                <div class="col-md-12">
                    <label for="ipRecordSelect" class="form-label fs-5">1. İşlem Yapılacak Kaydı Seçin</label>
                    <select id="ipRecordSelect" class="form-control" style="width: 100%;">
                        <option></option>
                    </select>
                </div>
            </div>

            <div id="indexing-content" class="d-none">
                <div class="card bg-light p-3 mb-4">
                    <h5><i class="bi bi-file-earmark-text"></i> Seçilen Kayıt Bilgileri</h5>
                    <div id="record-details" class="p-2"></div>
                </div>

                <div class="card p-3 mb-4">
                    <h5 class="mb-3"><i class="bi bi-folder2-open"></i> Kayıtlı Dosyalar ve İşlemler</h5>
                    <div id="files-list" class="p-2">Dosyaları görmek için bir kayıt seçin.</div>
                </div>

                <div class="card p-3">
                    <h5 class="mb-3"><i class="bi bi-file-earmark-arrow-up"></i> 2. Yeni Belge Ekle</h5>
                    
                    <ul class="nav nav-tabs" id="indexingTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="existing-transaction-tab" data-bs-toggle="tab"
                                data-bs-target="#existing-transaction-pane" type="button" role="tab"
                                aria-controls="existing-transaction-pane" aria-selected="true">Mevcut İşleme Ekle</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="manual-indexing-tab" data-bs-toggle="tab"
                                data-bs-target="#manual-indexing-pane" type="button" role="tab"
                                aria-controls="manual-indexing-pane" aria-selected="false">Manuel İşlem Oluştur</button>
                        </li>
                    </ul>

                    <div class="tab-content border border-top-0 p-3" id="indexingTabContent">
                        <div class="tab-pane fade show active" id="existing-transaction-pane" role="tabpanel"
                            aria-labelledby="existing-transaction-tab" tabindex="0">
                            <form id="upload-form-existing" class="mt-3">
                                <div class="mb-3">
                                    <label class="form-label">A. Dosyanın Ekleneceği İşlemi Seçin</label>
                                    <div id="transactions-list-container">
                                        <p class="text-muted">Lütfen önce bir IP kaydı seçin.</p>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="files" class="form-label">B. Dosyaları Yükleyin</label>
                                    <input type="file" class="form-control" id="files" name="files[]" multiple>
                                </div>
                                <div id="existing-file-list" class="mb-3"></div>
                                <button type="submit" class="btn btn-primary w-100 mt-2">Seçilen İşleme Yükle</button>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="manual-indexing-pane" role="tabpanel"
                            aria-labelledby="manual-indexing-tab" tabindex="0">
                            <form id="upload-form-manual" class="mt-3">
                                 <div class="mb-3">
                                    <label class="form-label">A. Yeni İşlem Türünü Seçin</label>
                                    <select id="specificTaskType" class="form-select">
                                        <option value="" disabled selected>İşlem türü seçin...</option>
                                        <option value="application">Başvuru</option>
                                        <option value="renewal">Yenileme</option>
                                        <option value="assignment">Devir</option>
                                        <option value="merger">Birleşme</option>
                                        <option value="license">Lisans</option>
                                        <option value="appeal">Karara İtiraz</option>
                                        <option value="opposition">Yayına İtiraz</option>
                                        <option value="response_to_opposition">İtiraza Cevap</option>
                                        <option value="payment">Ödeme</option>
                                        <option value="general_document">Genel Doküman</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="manual-files" class="form-label">B. Dosyaları Yükleyin</label>
                                    <input type="file" class="form-control" id="manual-files" name="manual-files[]" multiple>
                                </div>
                                <div id="manual-file-list" class="mb-3"></div>
                                <button type="submit" class="btn btn-secondary w-100 mt-2">Yeni İşlem Olarak Yükle</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="module">
        import { ipRecordsService } from './firebase-config.js';
        import { loadLayout } from './js/layout-loader.js';
        import { readFileAsDataURL, formatFileSize } from './utils.js';

        class IndexingModule {
            constructor() {
                this.selectedRecord = null;
                this.selectedTransactionId = null;
                this.allIpRecords = [];
                this.uploadedFiles = new Map(); // Use map to handle files for both tabs separately
                this.indexingTypes = ['Kabul Kararı', 'Ret Kararı', 'Eksiklik Bildirimi', 'Genel', 'Diğer'];
                this.init();
            }

            init() {
                loadLayout().then(() => {
                    this.initSelect2();
                    this.bindEvents();
                }).catch(error => console.error("Layout yüklenirken hata:", error));
            }

            initSelect2() {
                const $select = $('#ipRecordSelect');
                $select.select2({
                    placeholder: 'Bir IP kaydı arayın veya seçin (Başlık, Başvuru No)',
                    allowClear: true,
                    theme: 'bootstrap-5'
                });

                ipRecordsService.getRecords().then(response => {
                    if (response.success) {
                        this.allIpRecords = response.data;
                        const options = this.allIpRecords.map(record => {
                            const text = `${record.title} (${record.applicationNumber || 'No App. No'})`;
                            return new Option(text, record.id, false, false);
                        });
                        $select.append(options).trigger('change');
                    }
                });
            }

            bindEvents() {
                $('#ipRecordSelect').on('change', (e) => this.handleRecordSelection(e.target.value));
                $('#upload-form-existing').on('submit', (e) => this.handleSubmit(e, 'existing'));
                $('#upload-form-manual').on('submit', (e) => this.handleSubmit(e, 'manual'));
                
                $('#files').on('change', (e) => this.handleFileChange(e, 'existing'));
                $('#manual-files').on('change', (e) => this.handleFileChange(e, 'manual'));

                $(document).on('click', '.transaction-list-group .list-group-item', (e) => {
                    this.selectedTransactionId = $(e.currentTarget).data('id');
                    $('.transaction-list-group .list-group-item').removeClass('selected active');
                    $(e.currentTarget).addClass('selected active');
                });
                
                $(document).on('change', '.file-indexing-type-select', (e) => {
                    const fileId = $(e.target).data('fileId');
                    const tabKey = $(e.target).data('tabKey');
                    const newType = $(e.target).val();
                    const files = this.uploadedFiles.get(tabKey) || [];
                    const fileToUpdate = files.find(f => f.id === fileId);
                    if(fileToUpdate) fileToUpdate.indexingType = newType;
                });
                
                $(document).on('click', '.remove-uploaded-file', (e) => {
                    const fileId = $(e.currentTarget).data('fileId');
                    const tabKey = $(e.currentTarget).data('tabKey');
                    let files = this.uploadedFiles.get(tabKey) || [];
                    this.uploadedFiles.set(tabKey, files.filter(f => f.id !== fileId));
                    this.renderUploadedFilesList(tabKey);
                });
            }

            handleRecordSelection(recordId) {
                if (!recordId) {
                    $('#indexing-content').addClass('d-none');
                    this.selectedRecord = null;
                    return;
                }
                this.selectedRecord = this.allIpRecords.find(r => r.id === recordId);
                if (this.selectedRecord) {
                    this.renderRecordDetails();
                    this.renderFilesAndTransactions();
                    this.renderTransactionsForSelection();
                    // Reset file inputs and lists
                    this.uploadedFiles.clear();
                    $('#files, #manual-files').val('');
                    $('#existing-file-list, #manual-file-list').html('');
                    $('#indexing-content').removeClass('d-none');
                }
            }

            renderRecordDetails() {
                const detailsHtml = `
                    <dl class="row">
                        <dt class="col-sm-3">Başlık</dt><dd class="col-sm-9">${this.selectedRecord.title}</dd>
                        <dt class="col-sm-3">Başvuru No</dt><dd class="col-sm-9">${this.selectedRecord.applicationNumber || 'N/A'}</dd>
                        <dt class="col-sm-3">Durum</dt><dd class="col-sm-9">${this.selectedRecord.status || 'N/A'}</dd>
                    </dl>
                `;
                $('#record-details').html(detailsHtml);
            }

            renderFilesAndTransactions() {
                const container = $('#files-list');
                container.html('');
                const transactions = this.selectedRecord.transactions || [];
                const files = this.selectedRecord.files || [];

                if (transactions.length === 0 && files.length === 0) {
                    container.html('<p class="text-muted">Bu kayıt için gösterilecek dosya veya işlem bulunmuyor.</p>');
                    return;
                }

                transactions.forEach(tx => {
                    const txDate = new Date(tx.timestamp).toLocaleDateString('tr-TR');
                    const card = $(`
                        <div class="card mb-2">
                            <div class="card-header bg-light">
                                <strong>İşlem:</strong> ${tx.description || tx.type} <span class="text-muted float-end">${txDate}</span>
                            </div>
                            <ul class="list-group list-group-flush" id="files-for-tx-${tx.transactionId}"></ul>
                        </div>`);
                    container.append(card);
                });

                files.forEach(file => {
                    const fileHtml = `<li class="list-group-item"><i class="bi bi-file-earmark"></i> ${file.name}</li>`;
                    const parentContainer = $(`#files-for-tx-${file.parentId}`);
                    if (file.parentId && parentContainer.length) {
                        parentContainer.append(fileHtml);
                    } else {
                        if ($('#files-for-unassigned').length === 0) {
                             container.prepend(`<div class="card mb-2"><div class="card-header"><strong>İlişkisiz Dosyalar</strong></div><ul class="list-group list-group-flush" id="files-for-unassigned"></ul></div>`);
                        }
                        $('#files-for-unassigned').append(fileHtml);
                    }
                });
            }

            renderTransactionsForSelection() {
                const container = $('#transactions-list-container');
                container.html('');
                this.selectedTransactionId = null;
                const transactions = this.selectedRecord.transactions || [];
                if (transactions.length === 0) {
                    container.html('<p class="text-danger">Dosya eklemek için uygun bir işlem bulunamadı. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>');
                    return;
                }
                const list = $('<div class="list-group transaction-list-group"></div>');
                transactions.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).forEach(tx => {
                    const txDate = new Date(tx.timestamp).toLocaleDateString('tr-TR');
                    const item = $(`<a href="#" class="list-group-item list-group-item-action" data-id="${tx.transactionId}">${tx.description || tx.type} - <strong>${txDate}</strong></a>`);
                    list.append(item);
                });
                container.append(list);
            }

            handleFileChange(event, tabKey) {
                const files = Array.from(event.target.files);
                const currentFiles = this.uploadedFiles.get(tabKey) || [];
                files.forEach(file => {
                    currentFiles.push({
                        id: `temp_${Date.now()}_${file.name}`,
                        fileObject: file,
                        indexingType: this.indexingTypes[0]
                    });
                });
                this.uploadedFiles.set(tabKey, currentFiles);
                this.renderUploadedFilesList(tabKey);
            }

            renderUploadedFilesList(tabKey) {
                const containerId = tabKey === 'existing' ? '#existing-file-list' : '#manual-file-list';
                const container = $(containerId);
                container.html('');
                const files = this.uploadedFiles.get(tabKey) || [];

                if(files.length > 0) {
                     container.append('<h6>Yüklenecek Dosyalar ve Tipleri</h6>');
                }
                
                files.forEach(fileData => {
                    const selectOptions = this.indexingTypes.map(type => `<option value="${type}" ${fileData.indexingType === type ? 'selected' : ''}>${type}</option>`).join('');
                    const fileCard = $(`
                        <div class="card file-item-card mb-2">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${fileData.fileObject.name}</strong>
                                    <small class="text-muted ms-2">(${formatFileSize(fileData.fileObject.size)})</small>
                                </div>
                                <div class="d-flex align-items-center gap-2" style="min-width: 250px;">
                                    <select class="form-select form-select-sm file-indexing-type-select" data-file-id="${fileData.id}" data-tab-key="${tabKey}">
                                        ${selectOptions}
                                    </select>
                                    <button type="button" class="btn btn-sm btn-outline-danger remove-uploaded-file" data-file-id="${fileData.id}" data-tab-key="${tabKey}">&times;</button>
                                </div>
                            </div>
                        </div>
                    `);
                    container.append(fileCard);
                });
            }

            async handleSubmit(event, tabKey) {
                event.preventDefault();
                const form = event.target;
                form.querySelector('button[type="submit"]').disabled = true;

                if (!this.selectedRecord) {
                    alert('Lütfen bir IP kaydı seçin.');
                    form.querySelector('button[type="submit"]').disabled = false;
                    return;
                }
                
                const filesToProcess = this.uploadedFiles.get(tabKey) || [];
                if (filesToProcess.length === 0) {
                    alert('Lütfen en az bir dosya seçin.');
                    form.querySelector('button[type="submit"]').disabled = false;
                    return;
                }

                let newTransaction = null;
                let parentIdForFiles = null;

                if(tabKey === 'existing') {
                     if (!this.selectedTransactionId) {
                        alert('Lütfen dosyayı eklemek için bir işlem seçin.');
                        form.querySelector('button[type="submit"]').disabled = false;
                        return;
                    }
                    parentIdForFiles = this.selectedTransactionId;
                } else if (tabKey === 'manual') {
                    const specificTaskType = $('#specificTaskType').val();
                    if (!specificTaskType) {
                        alert('Lütfen bir parent işlem türü seçin.');
                        form.querySelector('button[type="submit"]').disabled = false;
                        return;
                    }
                    newTransaction = {
                        transactionId: `tx_${Date.now()}`,
                        timestamp: new Date().toISOString(),
                        type: specificTaskType,
                        description: $(`#specificTaskType option[value='${specificTaskType}']`).text(),
                        parentId: null // Manual transactions are top-level
                    };
                    parentIdForFiles = newTransaction.transactionId;
                }

                try {
                    const fileUploadPromises = filesToProcess.map(async fileData => ({
                        id: `file_${Date.now()}_${fileData.fileObject.name}`,
                        name: fileData.fileObject.name,
                        type: fileData.fileObject.type,
                        size: fileData.fileObject.size,
                        lastModified: fileData.fileObject.lastModified,
                        parentId: parentIdForFiles,
                        indexingType: fileData.indexingType,
                        content: await readFileAsDataURL(fileData.fileObject)
                    }));
                    
                    const uploadedFileData = await Promise.all(fileUploadPromises);
                    
                    const currentFiles = this.selectedRecord.files || [];
                    const currentTransactions = this.selectedRecord.transactions || [];
                    
                    const updates = {
                        files: [...currentFiles, ...uploadedFileData],
                        transactions: newTransaction ? [...currentTransactions, newTransaction] : currentTransactions
                    };

                    const result = await ipRecordsService.updateRecord(this.selectedRecord.id, updates);
                    if (result.success) {
                        alert('Dosyalar başarıyla yüklendi ve indekslendi!');
                        // Refresh the page or just the data
                        this.handleRecordSelection(this.selectedRecord.id);
                        form.reset();
                        this.uploadedFiles.set(tabKey, []);
                        this.renderUploadedFilesList(tabKey);

                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('Dosya yükleme hatası:', error);
                    alert(`Bir hata oluştu: ${error.message}`);
                } finally {
                     form.querySelector('button[type="submit"]').disabled = false;
                }
            }
        }

        $(document).ready(() => { new IndexingModule(); });
    </script>
</body>
</html>