<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Müvekkil Bildirimleri</title>
<link rel="stylesheet" href="css/shared-styles.css">
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
    display: flex;
}
.page-wrapper {
    flex-grow: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow-y: auto;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
}
.main-container {
    width: 100%;
    padding: 30px;
    margin: 0;
}
.page-header {
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 20px;
    margin-bottom: 30px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}
.page-title {
    font-size: 2em;
    color: #1e3c72;
    margin-bottom: 10px;
}
.page-subtitle {
    color: #666;
    font-size: 1.1em;
}
.tasks-container {
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}
.tasks-table {
    width: 100%;
    border-collapse: collapse;
}
.tasks-table th,
.tasks-table td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #f0f0f0;
    vertical-align: top;
}
.tasks-table th {
    background: #f8f9fa;
    font-weight: 600;
}
.status-badge {
    padding: 5px 10px;
    border-radius: 12px;
    color: white;
    font-weight: 500;
    font-size: 0.9em;
}
.status-sent { background-color: #28a745; }
.status-failed { background-color: #dc3545; }
.status-pending { background-color: #6c757d; }
/* missing-info status styling kept */
.action-btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 5px;
    transition: all 0.3s ease;
}
.action-btn:hover {
    opacity: 0.9;
}
/* Modal common */
.modal {
  position: fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background: rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 9999;
}
/* Default modal content widened */
.modal-content {
  background:#fff;
  padding:20px;
  width:720px;
  max-width: 95vw;
  border-radius:12px;
  box-shadow:0 0 20px rgba(0,0,0,0.2);
}
/* Large editor modal */
.modal-content-lg {
  background:#fff;
  padding:20px;
  width:960px;
  max-width: 95vw;
  border-radius:12px;
  box-shadow:0 0 24px rgba(0,0,0,0.25);
  display:flex;
  flex-direction:column;
}
.modal-header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom: 8px;
}
.modal-title { margin:0; font-size: 1.25rem; }
.close-modal-btn, .close {
  background: transparent;
  border: 0;
  font-size: 28px;
  line-height: 1;
  cursor: pointer;
}
.modal-body {
  max-height: 70vh;
  overflow:auto;
}
.modal-footer {
  display:flex;
  gap:8px;
  justify-content:flex-end;
  margin-top: 10px;
}
.modal-content label {
  display:block;
  margin-top:10px;
}
.modal-content input, .modal-content textarea {
  width:100%;
  margin-top:5px;
}
.modal-actions {
  margin-top:15px;
  text-align:right;
}
.missing-info {
  background-color: #ffe5c0;
}
.missing-field {
  display: inline-block;
  background-color: #fd7e14;
  color: #000;
  padding: 2px 8px;
  border-radius: 8px;
  font-size: 0.85em;
}
.status-badge.missing-info {
  background-color: #fd7e14;
  color: #000;
}
.loading { text-align: center; padding: 50px; }
.no-records { text-align: center; padding: 50px; color: #666; }

/* Recipients badges */
.recipient-badges .badge {
  display:inline-block; padding:4px 8px; border-radius:12px; font-size:12px; margin:2px 4px 0 0;
}
.badge-to { background:#0d6efd; color:#fff; }
.badge-cc { background:#17a2b8; color:#fff; }
.badge-empty { background:#e9ecef; color:#555; }

/* Links */
.link { color:#0d6efd; text-decoration: underline; cursor:pointer; }
</style>
</head>
<body>
<div id="notification-container" style="position: fixed; top:20px; right:20px; z-index:9999;"></div>
<div id="layout-placeholder"></div>
<div class="page-wrapper">
<main class="main-container">
<section class="page-header">
    <h1 class="page-title">Müvekkil Bildirimleri</h1>
    <p class="page-subtitle">Müvekkillere gönderilen bildirimleri buradan takip edebilirsiniz.</p>
</section>

<div class="tasks-container">
    <div id="loader" class="loading">Yükleniyor...</div>
    <div id="error" class="no-records"></div>
    <div class="table-container">
    <table class="tasks-table">
        <thead>
          <tr>
            <th>Durum</th>
            <th>Müvekkil</th>
            <th>Konu</th>
            <th>Başvuru No</th>
            <th>Tür</th>
            <th>Evrak</th>
            <th>Gönderim Tarihi</th>
            <th>İşlem</th>
          </tr>
        </thead>
        <tbody id="notifications-table-body"></tbody>
    </table>
    </div>
</div>
<div id="notification-modal" class="modal">
  <div class="modal-content-lg">
    <div class="modal-header">
      <h2 class="modal-title">Bildirimi Düzenle</h2>
      <button id="close-modal" class="close-modal-btn" aria-label="Kapat">&times;</button>
    </div>
    <div class="modal-body">
      <label for="modal-subject" class="form-label">Konu</label>
      <input type="text" id="modal-subject" class="form-input" />

      <!-- Recipients block -->
      <div id="mailRecipientsBlock" style="margin:12px 0;">
        <div style="margin-bottom:6px; font-weight:600;">Alıcılar</div>
        <div class="d-flex" style="gap:16px; flex-wrap:wrap;">
          <div style="min-width:240px; flex:1;">
            <small class="text-muted d-block" style="margin-bottom:4px;">To</small>
            <div id="modal-to" class="recipient-badges"></div>
          </div>
          <div style="min-width:240px; flex:1;">
            <small class="text-muted d-block" style="margin-bottom:4px;">CC</small>
            <div id="modal-cc" class="recipient-badges"></div>
          </div>
        </div>
      </div>

      <label for="modal-body" class="form-label">İçerik</label>
      <textarea id="modal-body"></textarea>
    </div>
    <div class="modal-footer">
      <button id="save-draft" class="action-btn" style="background:#6c757d">Taslak Kaydet</button>
      <button id="send-notification" class="action-btn">Gönder</button>
    </div>
  </div>
</div>
<!-- Eksik Bilgiler Modal -->
<div id="missing-info-modal" class="modal">
  <div class="modal-content">
    <button id="mi-close" class="close" aria-label="Kapat">&times;</button>
    <h3>Eksik Bilgiler</h3>
    <p>Bu bildirim şu anda <b>gönderilmeye hazır değil</b>. Lütfen aşağıdaki eksikleri tamamlayın.</p>

    <div style="margin:8px 0;">
      <strong>Portföy Başvuru No:</strong>
      <span id="mi-application-no">—</span>
    </div>

    <div style="margin:8px 0;">
      <strong>Eksik Alanlar:</strong>
      <ul id="mi-missing-list" style="margin:6px 0;"></ul>
    </div>

    <div class="modal-actions">
      <button id="mi-edit" class="action-btn">Bildirimi Düzenle</button>
      <button id="mi-close-btn" class="action-btn" style="background:#6c757d">Kapat</button>
    </div>
  </div>
</div>

</main>
</div>
<script src="https://cdn.tiny.cloud/1/uecky9tx0nvoenpj0odjyue9swj52q3sz49i62c745240d99/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, onSnapshot,doc, getDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { loadSharedLayout } from './js/layout-loader.js';


const firebaseConfig = {
    apiKey: "AIzaSyDbdqfiVbobnl1BtyiWxhD4bfIcREw8ZRc",
    authDomain: "ip-manager-production-aab4b.firebaseapp.com",
    projectId: "ip-manager-production-aab4b",
    storageBucket: "ip-manager-production-aab4b.appspot.com",
    messagingSenderId: "594650169512",
    appId: "1:594650169512:web:43496005e063a40511829d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const functions = getFunctions(app, 'us-central1');
const auth = getAuth(app);

const tableBody = document.getElementById('notifications-table-body');
const loader = document.getElementById('loader');
const errorDiv = document.getElementById('error');
const sendEmail = httpsCallable(functions, 'sendEmailNotification');

onAuthStateChanged(auth, (user) => {
    if (user) {
        loadSharedLayout({ activeMenuLink: 'notifications.html' });
        startNotificationListener(user);
    } else {
        loader.textContent = "Bu sayfayı görmek için giriş yapmalısınız.";
    }
});

/** =====================
 *   HELPERLAR
 *  ===================== */
async function resolveApplicationNo(notification) {
  // ipRecordId → ipRecords.applicationNumber | details.brandInfo.applicationNo
  let ipRecordId = notification.ipRecordId;
  if (!ipRecordId && notification.sourceTaskId) {
    const t = await getDoc(doc(db, "tasks", notification.sourceTaskId));
    if (t.exists()) {
      const td = t.data() || {};
      ipRecordId = td.relatedIpRecordId || td.ipRecordId || td.relatedRecordId;
    }
  }
  if (!ipRecordId && notification.sourceDocumentId) {
    for (const col of ["unindexed_pdfs", "indexed_documents"]) {
      const d = await getDoc(doc(db, col, notification.sourceDocumentId));
      if (d.exists()) {
        const dd = d.data() || {};
        ipRecordId = dd.ipRecordId || dd.relatedIpRecordId || dd.ipRecordRefId || ipRecordId;
      }
    }
  }
  if (!ipRecordId) return '-';
  const recSnap = await getDoc(doc(db, "ipRecords", ipRecordId));
  if (!recSnap.exists()) return '-';
  const r = recSnap.data() || {};
  return r.applicationNumber || r.applicationNo || r.appNo || r.details?.brandInfo?.applicationNo || '-';
}

async function resolveApplicantName(notification) {
  // ipRecord.applicants[].name varsa onu, yoksa persons/{id}.name
  let ipRecordId = notification.ipRecordId;
  if (!ipRecordId && notification.sourceTaskId) {
    const t = await getDoc(doc(db, "tasks", notification.sourceTaskId));
    if (t.exists()) {
      const td = t.data() || {};
      ipRecordId = td.relatedIpRecordId || td.ipRecordId || td.relatedRecordId;
    }
  }
  if (!ipRecordId && notification.sourceDocumentId) {
    for (const col of ["unindexed_pdfs", "indexed_documents"]) {
      const d = await getDoc(doc(db, col, notification.sourceDocumentId));
      if (d.exists()) {
        const dd = d.data() || {};
        ipRecordId = dd.ipRecordId || dd.relatedIpRecordId || dd.ipRecordRefId || ipRecordId;
      }
    }
  }
  if (!ipRecordId) return '-';
  const recSnap = await getDoc(doc(db, "ipRecords", ipRecordId));
  if (!recSnap.exists()) return '-';
  const r = recSnap.data() || {};
  const applicants = Array.isArray(r.applicants) ? r.applicants : [];
  const names = [];
  for (const a of applicants) {
    if (a?.name) { names.push(a.name); continue; }
    if (a?.id) {
      const ps = await getDoc(doc(db, "persons", a.id));
      if (ps.exists()) {
        const pd = ps.data() || {};
        if (pd.name) names.push(pd.name);
      }
    }
  }
  return names.length ? names.join(", ") : '-';
}

async function resolveType(notification) {
  // notification.type yoksa unindexed_pdfs.associatedTransactionId → ipRecords/{id}/transactions/{id}.type
  if (notification.type !== undefined) return String(notification.type);
  if (notification.sourceDocumentId) {
    const u = await getDoc(doc(db, "unindexed_pdfs", notification.sourceDocumentId));
    if (u.exists()) {
      const ud = u.data() || {};
      const txId = ud.associatedTransactionId;
      let ipRecordId = ud.ipRecordId || ud.relatedIpRecordId || ud.ipRecordRefId || notification.ipRecordId;
      if (txId && ipRecordId) {
        const txSnap = await getDoc(doc(db, "ipRecords", ipRecordId, "transactions", txId));
        if (txSnap.exists()) {
          const t = txSnap.data() || {};
          if (t.type !== undefined) return String(t.type);
        }
      }
    }
  }
  return '-';
}

async function resolveDocumentInfo(notification) {
  // unindexed_pdfs/{sourceDocumentId} → fileName, fileUrl
  if (!notification.sourceDocumentId) return { fileName: '-', fileUrl: null };
  const d = await getDoc(doc(db, "unindexed_pdfs", notification.sourceDocumentId));
  if (!d.exists()) return { fileName: '-', fileUrl: null };
  const dd = d.data() || {};
  return { fileName: dd.fileName || '-', fileUrl: dd.fileUrl || null };
}

/** =====================
 *   LİSTELEYİCİ
 *  ===================== */
function startNotificationListener(user) {
  // Sıralama: en yeni en altta → ASC
  const q = query(collection(db, "mail_notifications"), orderBy("createdAt", "asc"));

  onSnapshot(q, async (snapshot) => {
    loader.style.display = 'none';
    tableBody.innerHTML = '';

    if (snapshot.empty) {
      tableBody.innerHTML = '<tr><td colspan="8" class="no-records">Gösterilecek bildirim bulunamadı.</td></tr>';
      return;
    }

    for (const snapDoc of snapshot.docs) {
      const notification = { id: snapDoc.id, ...snapDoc.data() };

      // Alanlar
      const [applicationNumber, applicantName, typeVal, docInfo] = await Promise.all([
        resolveApplicationNo(notification),
        resolveApplicantName(notification),
        resolveType(notification),
        resolveDocumentInfo(notification)
      ]);

      const tr = document.createElement('tr');
      const statusClass = notification.status === 'sent' ? 'status-sent'
        : notification.status === 'failed' ? 'status-failed'
        : notification.status === 'missing_info' ? 'missing-info'
        : 'status-pending';

      const sentAtText = notification.sentAt ? notification.sentAt.toDate().toLocaleString('tr-TR') : '-';

      const fileCellHtml = docInfo.fileUrl
        ? `<a class="link" href="${docInfo.fileUrl}" target="_blank" rel="noopener">${docInfo.fileName}</a>`
        : (docInfo.fileName || '-');

      tr.innerHTML = `
        <td><span class="status-badge ${statusClass}">${notification.status || '-'}</span></td>
        <td>${applicantName}</td>
        <td>${notification.subject ? notification.subject : '<span class="missing-field">Konu Eksik</span>'}</td>
        <td>${applicationNumber || '-'}</td>
        <td>${typeVal}</td>
        <td>${fileCellHtml}</td>
        <td>${sentAtText}</td>
        <td class="action-cell"></td>
      `;

      const actionCell = tr.querySelector('.action-cell');

      // Düzenle butonu her durumda olsun
      const editButton = document.createElement('button');
      editButton.className = 'action-btn';
      editButton.textContent = 'Düzenle';
      editButton.dataset.id = notification.id;
      editButton.addEventListener('click', () => openModal(notification));
      actionCell.appendChild(editButton);

      // Gönder/ Eksik Bilgi butonları (mevcut davranış korunur)
      if (notification.status === 'missing_info') {
        const missingBtn = document.createElement('button');
        missingBtn.className = 'action-btn';
        missingBtn.textContent = 'Eksik Bilgileri Göster';
        missingBtn.dataset.id = notification.id;
        missingBtn.addEventListener('click', () => showMissingInfo(notification));
        actionCell.appendChild(missingBtn);
      } else if (notification.status === 'failed' || notification.status === 'pending') {
        const sendButton = document.createElement('button');
        sendButton.className = 'action-btn';
        sendButton.textContent = notification.status === 'failed' ? 'Tekrar Gönder' : 'Gönder';
        sendButton.dataset.id = notification.id;
        sendButton.addEventListener('click', () => sendNotification(notification));
        actionCell.appendChild(sendButton);
      }

      tableBody.appendChild(tr);
    }
  }, (error) => {
    loader.style.display = 'none';
    errorDiv.textContent = 'Bildirimler yüklenirken bir hata oluştu.';
  });
}

/** =====================
 *   MODAL / DÜZENLEME
 *  ===================== */
const sendEmail = httpsCallable(functions, 'sendEmailNotification');

document.getElementById('save-draft').addEventListener('click', async () => {
  const id = document.getElementById('save-draft').dataset.id;
  const subject = document.getElementById('modal-subject').value.trim();
  const body = tinymce.get('modal-body').getContent();

  try {
    await updateDoc(doc(db, "mail_notifications", id), {
      subject: subject,
      body: body,
      isDraft: true,
      updatedAt: serverTimestamp()
    });
    alert("Taslak kaydedildi!");
    document.getElementById('notification-modal').style.display = "none";
  } catch (err) {
    console.error(err);
    alert("Taslak kaydedilemedi.");
  }
});

document.getElementById('send-notification').addEventListener('click', async () => {
  const id = document.getElementById('send-notification').dataset.id;
  const subject = document.getElementById('modal-subject').value.trim();
  const body = tinymce.get('modal-body').getContent();
  const user = auth.currentUser;
  if (!user) {
    alert("Giriş yapmalısınız.");
    return;
  }
  if (!confirm("Bu e-postayı göndermek istediğinize emin misiniz?")) return;

  try {
    await updateDoc(doc(db, "mail_notifications", id), {
      subject: subject,
      body: body,
      isDraft: false,
      status: "pending",
      missingFields: [],
      updatedAt: serverTimestamp()
    });
    await sendEmail({ notificationId: id, userEmail: user.email });
    alert("E-posta gönderim sırasına alındı!");
    document.getElementById('notification-modal').style.display = "none";
  } catch (err) {
    console.error(err);
    alert("Gönderim sırasında bir hata oluştu.");
  }
});

// Recipient helperları ve modal doldurma
function getToCcFromNotification(n) {
  const to = normalize(n?.toList) 
         || normalize(n?.toRecipients) 
         || normalize(n?.recipientTo)
         || normalize(n?.to) 
         || normalize(n?.recipientEmail);
  const cc = normalize(n?.ccList) 
         || normalize(n?.ccRecipients) 
         || normalize(n?.recipientCc)
         || normalize(n?.cc);
  return { toList: to || [], ccList: cc || [] };
}
function normalize(v) {
  if (!v) return null;
  if (Array.isArray(v)) return v.filter(Boolean).map(x => String(x).trim()).filter(Boolean);
  if (typeof v === 'string') return v.split(/[;,]\s*/).filter(Boolean);
  return null;
}

function openModal(notification) {
  const subjectInput = document.getElementById('modal-subject');
  subjectInput.value = notification.subject || "";

  if (tinymce.get('modal-body')) tinymce.get('modal-body').remove();

  tinymce.init({
    selector: '#modal-body',
    height: 400,
    menubar: false,
    plugins: 'link lists',
    toolbar: 'undo redo | bold italic underline | bullist numlist | link',
    branding: false,
    language: 'tr',
    setup: (editor) => {
      editor.on('init', () => {
        let html = notification.body || "";
        const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        if (bodyMatch) html = bodyMatch[1];
        editor.setContent(html);
        document.getElementById('notification-modal').style.display = "flex";
      });
    }
  });

  const { toList, ccList } = getToCcFromNotification(notification);
  const toEl = document.getElementById('modal-to');
  const ccEl = document.getElementById('modal-cc');

  const renderBadges = (arr, kind) => {
    if (!arr || arr.length === 0) return `<span class="badge badge-empty">—</span>`;
    const cls = kind === 'To' ? 'badge-to' : 'badge-cc';
    return arr.map(e => `<span class="badge ${cls}">${e}</span>`).join(' ');
  };

  toEl.innerHTML = renderBadges(toList, 'To');
  ccEl.innerHTML = renderBadges(ccList, 'CC');

  document.getElementById('save-draft').dataset.id = notification.id;
  document.getElementById('send-notification').dataset.id = notification.id;

  document.getElementById('close-modal').onclick = () => {
    document.getElementById('notification-modal').style.display = "none";
    document.getElementById('modal-subject').value = "";
    if (tinymce.get('modal-body')) tinymce.get('modal-body').remove();
  };
}
</script>
</body>
</html>
