<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IP Manager - Marka Ä°zleme Listesi</title>
  <link rel="stylesheet" href="css/shared-styles.css"/>
  <style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        color: #333;
        display: flex;
        min-height: 100vh;
        margin: 0;
    }
    .page-wrapper {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        box-sizing: border-box;
    }
    .main-container {
        width: 100%;
        padding: 30px;
        margin: 0;
        box-sizing: border-box;
        flex-shrink: 0;
    }
    .page-header { 
        background: rgba(255, 255, 255, 0.95); 
        padding: 30px; 
        border-radius: 20px; 
        margin-bottom: 30px; 
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); 
    }
    .page-title { 
        font-size: 2em; 
        color: #1e3c72; 
        margin-bottom: 10px; 
    }
    .page-subtitle { 
        color: #666; 
        font-size: 1.1em; 
    }

    .monitoring-controls {
        background: rgba(255, 255, 255, 0.95);
        padding: 15px 30px;
        border-radius: 20px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        margin-bottom: 20px;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
        position: relative;
        z-index: 2;
    }
    .monitoring-controls .filter-group {
        display: none;
    }
    .monitoring-controls .btn-selected-action {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .monitoring-controls .btn-selected-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 123, 255, 0.2);
    }
    .monitoring-controls .btn-selected-action:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .accruals-container {
        background: rgba(255,255,255,0.95);
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    .accruals-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }
    .accruals-table th,
    .accruals-table td {
        padding: 15px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .accruals-table th {
        background: #f8f9fa;
        font-weight: 600;
    }

    /* KOLON GENÄ°ÅžLÄ°KLERÄ° */
    .accruals-table th:first-child,
    .accruals-table td:first-child {
        width: 40px;
        text-align: center;
        padding-left: 5px;
        padding-right: 5px;
    }
    .accruals-table th:nth-child(2),
    .accruals-table td:nth-child(2) {
        width: 100px;
        text-align: center;
    }
    .accruals-table th:nth-child(3),
    .accruals-table td:nth-child(3) {
        width: 200px;
    }
    .accruals-table th:nth-child(4),
    .accruals-table td:nth-child(4) {
        width: 150px;
    }
    .accruals-table th:nth-child(5),
    .accruals-table td:nth-child(5) {
        width: 120px;
    }
    .accruals-table th:nth-child(6),
    .accruals-table td:nth-child(6) {
        width: 100px;
    }
    .accruals-table th:nth-child(7),
    .accruals-table td:nth-child(7) {
        width: 120px;
    }
    .accruals-table th:nth-child(8),
    .accruals-table td:nth-child(8) {
        width: 120px;
    }

    .trademark-image-thumbnail {
        width: 50px;
        height: 50px;
        object-fit: contain;
        border-radius: 5px;
        vertical-align: middle;
        line-height: 0;
        font-size: 0;
    }

    .status-badge {
        display: inline-block;
        padding: 5px 10px;
        border-radius: 5px;
        font-size: 0.8em;
        font-weight: 600;
        color: white;
        text-transform: uppercase;
        line-height: 1;
    }
    .status-badge.application { background-color: #007bff; }
    .status-badge.registered { background-color: #28a745; }
    .status-badge.rejected { background-color: #dc3545; }
    .status-badge.pending { background-color: #ffc107; color: #333; }
    .status-badge.objection { background-color: #6f42c1; }
    .status-badge.litigation { background-color: #fd7e14; }

    .loading, .no-records {
        text-align: center;
        padding: 30px;
        color: #666;
    }
    .error-message {
        text-align: center;
        padding: 30px;
        color: #dc3545;
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 5px;
        margin: 20px 0;
    }
</style>
</head>
<body>
<div id="notification-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>
  <div id="layout-placeholder"></div>
  <div class="page-wrapper">
    <main class="main-container">
      <section class="page-header">
        <h1 class="page-title">ðŸ“Š Marka Ä°zleme Listesi</h1>
        <p class="page-subtitle">Ä°zleme listenizdeki markalar burada listelenir.</p>
      </section>

      <div class="monitoring-controls">
        <button type="button" class="btn-selected-action" id="removeSelectedBtn" disabled>
          SeÃ§ileni KaldÄ±r (<span id="selectedCount">0</span>)
        </button>
      </div>
      <div class="accruals-container">
        <div id="monitoringTableContainer">
          <div class="loading">YÃ¼kleniyor...</div>
        </div>
      </div>
    </main>
  </div>
<script type="module">
    import { loadSharedLayout } from './js/layout-loader.js';
    import { monitoringService, personService  } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { showNotification } from './utils.js';

    const auth = getAuth();
    let selectedMonitoringItems = new Set();
    let allPersons = [];

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            console.log('Sayfa yÃ¼kleniyor...');
            
            // Ä°lk olarak layout'u yÃ¼kle
            await loadSharedLayout({ activeMenuLink: 'monitoring-trademarks.html' });
            console.log('Layout yÃ¼klendi');

            // KiÅŸileri yÃ¼kle - hata durumunda bile devam et
            try {
                const personsResult = await personService.getPersons();
                if (personsResult.success) {
                    allPersons = personsResult.data || [];
                    console.log('KiÅŸiler yÃ¼klendi:', allPersons.length);
                } else {
                    console.warn('KiÅŸiler yÃ¼klenirken hata:', personsResult.error);
                    allPersons = [];
                }
            } catch (error) {
                console.warn('KiÅŸiler yÃ¼klenirken hata:', error);
                allPersons = []; // BoÅŸ array ile devam et
            }

            const container = document.getElementById('monitoringTableContainer');
            const removeSelectedBtn = document.getElementById('removeSelectedBtn');
            const selectedCountSpan = document.getElementById('selectedCount');

            if (!container || !removeSelectedBtn || !selectedCountSpan) {
                console.error('Gerekli DOM elementleri bulunamadÄ±');
                return;
            }

            // DurumlarÄ± TÃ¼rkÃ§eye Ã§eviren fonksiyon
            const getStatusInTurkish = (status) => {
                switch (status) {
                    case 'application': return { text: 'BaÅŸvuru', class: 'application' };
                    case 'registered': return { text: 'Tescilli', class: 'registered' };
                    case 'rejected': return { text: 'Reddedildi', class: 'rejected' };
                    case 'pending': return { text: 'Beklemede', class: 'pending' };
                    case 'objection': return { text: 'Ä°tiraz', class: 'objection' };
                    case 'litigation': return { text: 'Dava', class: 'litigation' };
                    default: return { text: status || 'Bilinmiyor', class: '' };
                }
            };

            // Tarih formatlama yardÄ±mcÄ± fonksiyonu
            const formatTurkishDate = (dateString) => {
                if (!dateString) return '-';
                try {
                    const date = new Date(dateString);
                    if (isNaN(date.getTime())) {
                        return dateString;
                    }
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}.${month}.${year}`;
                } catch (e) {
                    console.error("Tarih formatlama hatasÄ±:", e);
                    return dateString;
                }
            };

            const renderMonitoringTable = (data, userUid) => {
                console.log('Tablo render ediliyor, veri sayÄ±sÄ±:', data?.length || 0);
                
                selectedMonitoringItems.clear();
                updateSelectedButtonState();

                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-records">Ä°zleme listeniz boÅŸ.</div>';
                    return;
                }

                let html = `
                    <table class="accruals-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="headerSelectAllCheckbox" /></th>
                                <th>GÃ¶rsel</th>
                                <th>Marka AdÄ±</th>
                                <th>Sahip</th>
                                <th>BaÅŸvuru No</th>
                                <th>BaÅŸvuru Tarihi</th>
                                <th>Nice SÄ±nÄ±fÄ±</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                data.forEach(r => {
                    const isSelected = selectedMonitoringItems.has(r.id) ? 'checked' : '';
                    const trademarkImageHtml = r.trademarkImage && typeof r.trademarkImage === 'string' && r.trademarkImage.startsWith('data:image')
                        ? `<img src="${r.trademarkImage}" alt="Marka GÃ¶rseli" class="trademark-image-thumbnail">`
                        : '-';
                    
                    const statusInfo = getStatusInTurkish(r.status);
                    
                    // Sahip bilgisini gÃ¼venli ÅŸekilde iÅŸle
                    let ownerNames = '-';
                    try {
                        if (r.owners && Array.isArray(r.owners)) {
                            ownerNames = r.owners.map(owner => {
                                if (typeof owner === 'object' && owner.id) {
                                    const match = allPersons.find(p => p.id === owner.id);
                                    return match ? match.name : `ID:${owner.id} (BulunamadÄ±)`;
                                } else if (typeof owner === 'string') {
                                    return owner;
                                } else if (typeof owner === 'object' && owner.name) {
                                    return owner.name;
                                }
                                return 'Bilinmeyen format';
                            }).join(', ');
                        } else if (typeof r.owners === 'string') {
                            ownerNames = r.owners;
                        }
                    } catch (error) {
                        console.warn('Sahip bilgisi iÅŸlenirken hata:', error, r.owners);
                        ownerNames = 'Hata: ' + error.message;
                    }

                    html += `
                        <tr data-id="${r.id}">
                            <td><input type="checkbox" class="row-checkbox" data-id="${r.id}" ${isSelected}></td>
                            <td>${trademarkImageHtml}</td>
                            <td>${r.title || r.markName || '-'}</td>
                            <td>${ownerNames}</td>
                            <td>${r.applicationNumber || r.applicationNo || '-'}</td>
                            <td>${formatTurkishDate(r.applicationDate)}</td>
                            <td>${r.niceClass || '-'}</td>
                            <td><span class="status-badge ${statusInfo.class}">${statusInfo.text}</span></td>
                        </tr>`;
                });
                html += '</tbody></table>';
                container.innerHTML = html;

                // Header checkbox'Ä±nÄ± baÄŸla
                const headerSelectAllCheckbox = document.getElementById('headerSelectAllCheckbox');
                if (headerSelectAllCheckbox) {
                    const allRowCheckboxes = document.querySelectorAll('.row-checkbox');
                    headerSelectAllCheckbox.checked = allRowCheckboxes.length > 0 && Array.from(allRowCheckboxes).every(cb => selectedMonitoringItems.has(cb.dataset.id));

                    headerSelectAllCheckbox.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                            checkbox.checked = isChecked;
                            if (isChecked) {
                                selectedMonitoringItems.add(checkbox.dataset.id);
                            } else {
                                selectedMonitoringItems.delete(checkbox.dataset.id);
                            }
                        });
                        updateSelectedButtonState();
                    });
                }
            };

            const updateSelectedButtonState = () => {
                selectedCountSpan.textContent = selectedMonitoringItems.size;
                removeSelectedBtn.disabled = selectedMonitoringItems.size === 0;

                const allRowCheckboxes = document.querySelectorAll('.row-checkbox');
                const headerSelectAllCheckbox = document.getElementById('headerSelectAllCheckbox');

                if (headerSelectAllCheckbox) {
                    const allChecked = allRowCheckboxes.length > 0 && Array.from(allRowCheckboxes).every(cb => selectedMonitoringItems.has(cb.dataset.id));
                    headerSelectAllCheckbox.checked = allChecked;
                }
            };

            // Auth state deÄŸiÅŸikliklerini dinle
            onAuthStateChanged(auth, async (user) => {
                console.log('Auth state deÄŸiÅŸti:', user ? 'GiriÅŸ yapÄ±ldÄ±' : 'Ã‡Ä±kÄ±ÅŸ yapÄ±ldÄ±');
                
                if (!user) {
                    container.innerHTML = '<div class="no-records">GiriÅŸ yapmalÄ±sÄ±nÄ±z.</div>';
                    return;
                }

                container.innerHTML = '<div class="loading">Ä°zleme listeniz yÃ¼kleniyor...</div>';
                
                try {
                    console.log('Monitoring verileri yÃ¼kleniyor...');
                    const { success, data, error } = await monitoringService.getMonitoringItems(user.uid);
                    
                    if (success) {
                        console.log('Monitoring verileri baÅŸarÄ±yla yÃ¼klendi:', data?.length || 0);
                        renderMonitoringTable(data, user.uid);
                    } else {
                        console.error("Marka izleme Ã¶ÄŸeleri yÃ¼klenirken hata:", error);
                        container.innerHTML = `<div class="error-message">Ä°zleme listeniz yÃ¼klenirken bir hata oluÅŸtu: ${error}</div>`;
                    }
                } catch (error) {
                    console.error("Monitoring yÃ¼kleme hatasÄ±:", error);
                    container.innerHTML = '<div class="error-message">Ä°zleme listeniz yÃ¼klenirken beklenmeyen bir hata oluÅŸtu.</div>';
                }
            });

            // Checkbox event delegation
            container.addEventListener('change', (e) => {
                if (e.target.classList.contains('row-checkbox')) {
                    const id = e.target.dataset.id;
                    if (e.target.checked) {
                        selectedMonitoringItems.add(id);
                    } else {
                        selectedMonitoringItems.delete(id);
                    }
                    updateSelectedButtonState();
                }
            });

            // SeÃ§ileni kaldÄ±r butonu
            removeSelectedBtn.addEventListener('click', async () => {
                if (selectedMonitoringItems.size === 0) {
                    showNotification('LÃ¼tfen kaldÄ±rmak istediÄŸiniz kayÄ±tlarÄ± seÃ§in.', 'info');
                    return;
                }

                if (!confirm(`SeÃ§ilen ${selectedMonitoringItems.size} adet kaydÄ± izleme listesinden kaldÄ±rmak istediÄŸinizden emin misiniz?`)) {
                    return;
                }

                const user = auth.currentUser;
                if (!user) {
                    showNotification('KayÄ±tlarÄ± kaldÄ±rmak iÃ§in giriÅŸ yapmalÄ±sÄ±nÄ±z.', 'error');
                    return;
                }

                let successfulRemovals = 0;
                let failedRemovals = 0;
                const itemsToRemove = Array.from(selectedMonitoringItems);

                container.innerHTML = '<div class="loading">SeÃ§ili kayÄ±tlar kaldÄ±rÄ±lÄ±yor...</div>';

                for (const id of itemsToRemove) {
                    try {
                        const res = await monitoringService.removeMonitoringItem(user.uid, id);
                        if (res.success) {
                            successfulRemovals++;
                        } else {
                            console.error(`KayÄ±t (${id}) kaldÄ±rÄ±lamadÄ±: ${res.error}`);
                            failedRemovals++;
                        }
                    } catch (error) {
                        console.error(`KayÄ±t (${id}) kaldÄ±rÄ±lamadÄ±:`, error);
                        failedRemovals++;
                    }
                }

                // Tabloyu yeniden yÃ¼kle
                try {
                    const { success, data } = await monitoringService.getMonitoringItems(user.uid);
                    if (success) {
                        renderMonitoringTable(data, user.uid);
                    } else {
                        container.innerHTML = '<div class="error-message">Ä°zleme listeniz gÃ¼ncellenirken bir hata oluÅŸtu.</div>';
                    }
                } catch (error) {
                    container.innerHTML = '<div class="error-message">Ä°zleme listeniz gÃ¼ncellenirken beklenmeyen bir hata oluÅŸtu.</div>';
                }

                // Bildirimleri gÃ¶ster
                if (successfulRemovals > 0) {
                    showNotification(`${successfulRemovals} kayÄ±t baÅŸarÄ±yla kaldÄ±rÄ±ldÄ±.`, 'success');
                }
                if (failedRemovals > 0) {
                    showNotification(`${failedRemovals} kayÄ±t kaldÄ±rÄ±lamadÄ±. Konsolu kontrol edin.`, 'error');
                }
            });

        } catch (error) {
            console.error('Sayfa baÅŸlatma hatasÄ±:', error);
            const container = document.getElementById('monitoringTableContainer');
            if (container) {
                container.innerHTML = '<div class="error-message">Sayfa yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.</div>';
            }
        }
    });
</script>
</body>
</html>