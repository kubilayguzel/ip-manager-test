<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Kişiler</title>
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        .page-header {
            background: rgba(255, 255, 255, 0.95); padding: 30px;
            border-radius: 20px; margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .controls { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .search-input { width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
        .table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .persons-table { width: 100%; border-collapse: collapse; }
        .persons-table th, .persons-table td {
            padding: 15px; text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }
        .persons-table th { background: #f8f9fa; }
        
        /* GÜNCELLEME: Modal genişliği artırıldı */
        #personModal .modal-content {
            max-width: 1500px;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Kişiler Yönetimi</h1>
                <p class="page-subtitle">Müşterileri, hak sahiplerini ve diğer ilgili kişileri yönetin.</p>
            </section>
            <div class="controls">
                <input type="text" id="personSearchInput" class="search-input" placeholder="Kişi Ara...">
                <button id="addPersonBtn" class="btn btn-primary">Yeni Kişi Ekle</button>
            </div>
            <div class="table-container">
                <table class="persons-table">
                    <thead>
                        <tr>
                            <th>Ad/Unvan</th>
                            <th>Tip</th>
                            <th>E-posta</th>
                            <th>Telefon</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="personsTableBody"></tbody>
                </table>
                <div id="loadingIndicator" class="loading" style="display: none;">Yükleniyor...</div>
                <div id="noPersonsMessage" class="no-records" style="display: none;">Henüz kişi kaydı bulunmamaktadır.</div>
            </div>
        </main>
    </div>

    <div id="personModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="personModalTitle">Yeni Kişi Ekle</h3>
                <button class="close-btn" id="closePersonModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="personForm">
                    <input type="hidden" id="personId">
                    <div class="form-group">
                        <label for="personType">Kişi Tipi:</label>
                        <select id="personType" name="personType" class="form-select">
                            <option value="real">Gerçek Kişi</option>
                            <option value="legal">Tüzel Kişi</option>
                        </select>
                    </div>

                    <div id="realPersonFields">
                        <div class="form-group"><label for="firstName">Ad:</label><input type="text" id="firstName" name="firstName" class="form-input"></div>
                        <div class="form-group"><label for="lastName">Soyad:</label><input type="text" id="lastName" name="lastName" class="form-input"></div>
                        <div class="form-group"><label for="tcId">T.C. Kimlik No:</label><input type="text" id="tcId" name="tcId" class="form-input" maxlength="11"></div>
                    </div>

                    <div id="legalPersonFields" style="display:none;">
                        <div class="form-group"><label for="companyName">Şirket Adı/Unvanı:</label><input type="text" id="companyName" name="companyName" class="form-input"></div>
                        <div class="form-group"><label for="taxId">Vergi Numarası:</label><input type="text" id="taxId" name="taxId" class="form-input" maxlength="10"></div>
                    </div>

                    <div class="form-group"><label for="email">E-posta:</label><input type="email" id="email" name="email" class="form-input"></div>
                    <div class="form-group"><label for="phone">Telefon:</label><input type="tel" id="phone" name="phone" class="form-input"></div>
                    <div class="form-group"><label for="address">Adres:</label><textarea id="address" name="address" class="form-textarea"></textarea></div>
                    
                    <div class="form-group">
                        <label for="country">Ülke:</label>
                        <select id="country" name="country" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="city">Şehir:</label>
                        <select id="city" name="city" class="form-select"></select>
                    </div>

                    <div class="form-group"><label for="notes">Notlar:</label><textarea id="notes" name="notes" class="form-textarea"></textarea></div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancelPersonBtn">İptal</button>
                        <button type="submit" class="btn btn-primary" id="savePersonBtn">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { authService, personService, auth } from './firebase-config.js';
        import { showNotification } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';

        // GÜNCELLEME: Ülke ve il verileri eklendi
        const CITIES_BY_COUNTRY = {
            "Türkiye": ["Adana", "Adıyaman", "Afyonkarahisar", "Ağrı", "Amasya", "Ankara", "Antalya", "Artvin", "Aydın", "Balıkesir", "Bilecik", "Bingöl", "Bitlis", "Bolu", "Burdur", "Bursa", "Çanakkale", "Çankırı", "Çorum", "Denizli", "Diyarbakır", "Düzce", "Edirne", "Elazığ", "Erzincan", "Erzurum", "Eskişehir", "Gaziantep", "Giresun", "Gümüşhane", "Hakkari", "Hatay", "Iğdır", "Isparta", "İstanbul", "İzmir", "Kahramanmaraş", "Karabük", "Karaman", "Kars", "Kastamonu", "Kayseri", "Kilis", "Kırıkkale", "Kırklareli", "Kırşehir", "Kocaeli", "Konya", "Kütahya", "Malatya", "Manisa", "Mardin", "Mersin", "Muğla", "Muş", "Nevşehir", "Niğde", "Ordu", "Osmaniye", "Rize", "Sakarya", "Samsun", "Şanlıurfa", "Siirt", "Sinop", "Sivas", "Şırnak", "Tekirdağ", "Tokat", "Trabzon", "Tunceli", "Uşak", "Van", "Yalova", "Yozgat", "Zonguldak"].sort(),
            "ABD": ["New York", "California", "Texas", "Florida"].sort(),
            "Almanya": ["Berlin", "Bavyera", "Hamburg"].sort(),
            "Diğer": []
        };
        const ALL_COUNTRIES = Object.keys(CITIES_BY_COUNTRY).sort();

        class PersonsModule {
            constructor() {
                this.allPersons = [];
                this.editingPersonId = null;
            }

            async init() {
                await this.loadPersons();
                this.setupEventListeners();
                this.populateCountries(); // Ülkeleri başlangıçta yükle
            }

            setupEventListeners() {
                document.getElementById('addPersonBtn').addEventListener('click', () => this.openPersonModal());
                document.getElementById('closePersonModal').addEventListener('click', () => this.closePersonModal());
                document.getElementById('cancelPersonBtn').addEventListener('click', () => this.closePersonModal());
                document.getElementById('personForm').addEventListener('submit', (e) => this.handlePersonFormSubmit(e));
                document.getElementById('personType').addEventListener('change', this.togglePersonTypeFields);
                document.getElementById('personSearchInput').addEventListener('input', (e) => this.filterPersons(e.target.value));
                // GÜNCELLEME: Ülke seçimi değiştiğinde illeri doldur
                document.getElementById('country').addEventListener('change', (e) => this.populateCities(e.target.value));
            }

            // GÜNCELLEME: Yeni fonksiyon
            populateCountries() {
                const countrySelect = document.getElementById('country');
                countrySelect.innerHTML = '<option value="">Ülke Seçiniz...</option>';
                ALL_COUNTRIES.forEach(countryName => {
                    countrySelect.add(new Option(countryName, countryName));
                });
            }

            // GÜNCELLEME: Yeni fonksiyon
            populateCities(selectedCountry) {
                const citySelect = document.getElementById('city');
                citySelect.innerHTML = '<option value="">İl Seçiniz...</option>';
                const cities = CITIES_BY_COUNTRY[selectedCountry] || [];
                cities.forEach(cityName => {
                    citySelect.add(new Option(cityName, cityName));
                });
            }

            async loadPersons() {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) loadingIndicator.style.display = 'block';
                const result = await personService.getPersons();
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                if (result.success) {
                    this.allPersons = result.data;
                    this.renderPersons(this.allPersons);
                } else {
                    showNotification('Kişiler yüklenirken bir hata oluştu.', 'error');
                }
            }

            renderPersons(persons) {
                const tableBody = document.getElementById('personsTableBody');
                const noPersonsMessage = document.getElementById('noPersonsMessage');
                tableBody.innerHTML = '';
                if (persons.length === 0) {
                    if(noPersonsMessage) noPersonsMessage.style.display = 'block';
                    return;
                }
                if(noPersonsMessage) noPersonsMessage.style.display = 'none';

                persons.forEach(person => {
                    const row = document.createElement('tr');
                    const personTypeDisplay = person.personType === 'real' ? 'Gerçek' : 'Tüzel';
                    row.innerHTML = `
                        <td>${person.name || '-'}</td>
                        <td>${personTypeDisplay}</td>
                        <td>${person.email || '-'}</td>
                        <td>${person.phone || '-'}</td>
                        <td>
                            <button class="action-btn btn-edit" data-id="${person.id}">Düzenle</button>
                            <button class="action-btn btn-delete" data-id="${person.id}">Sil</button>
                        </td>
                    `;
                    row.querySelector('.btn-edit').addEventListener('click', (e) => this.openPersonModal(person));
                    row.querySelector('.btn-delete').addEventListener('click', (e) => this.deletePerson(e.target.dataset.id));
                    tableBody.appendChild(row);
                });
            }

            filterPersons(searchTerm) {
                const lowerCaseSearchTerm = searchTerm.toLowerCase();
                const filtered = this.allPersons.filter(person => 
                    (person.name && person.name.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    (person.email && person.email.toLowerCase().includes(lowerCaseSearchTerm)) ||
                    (person.phone && person.phone.includes(lowerCaseSearchTerm))
                );
                this.renderPersons(filtered);
            }

            openPersonModal(person = null) {
                const modal = document.getElementById('personModal');
                const form = document.getElementById('personForm');
                const modalTitle = document.getElementById('personModalTitle');
                const saveButton = document.getElementById('savePersonBtn');
                
                form.reset();
                this.editingPersonId = null;
                this.populateCities(''); // Modal açıldığında illeri temizle

                if (person) {
                    this.editingPersonId = person.id;
                    modalTitle.textContent = 'Kişiyi Düzenle';
                    saveButton.textContent = 'Güncelle';
                    
                    document.getElementById('personType').value = person.personType || 'real';
                    this.togglePersonTypeFields();

                    Object.keys(person).forEach(key => {
                        const element = form.elements[key];
                        if (element && element.tagName !== 'SELECT') { // Select'ler ayrı yönetilecek
                            element.value = person[key] || '';
                        }
                    });

                    // GÜNCELLEME: Ülke ve il select-box'larını doldurma
                    const countrySelect = document.getElementById('country');
                    countrySelect.value = person.country || '';
                    this.populateCities(countrySelect.value); // İlgili ülkenin illerini yükle
                    document.getElementById('city').value = person.city || ''; // Kayıtlı ili seç

                } else {
                    modalTitle.textContent = 'Yeni Kişi Ekle';
                    saveButton.textContent = 'Kaydet';
                    this.togglePersonTypeFields();
                }
                modal.classList.add('show');
            }

            closePersonModal() {
                document.getElementById('personModal').classList.remove('show');
            }

            togglePersonTypeFields = () => {
                const personType = document.getElementById('personType').value;
                document.getElementById('realPersonFields').style.display = personType === 'real' ? 'block' : 'none';
                document.getElementById('legalPersonFields').style.display = personType === 'legal' ? 'block' : 'none';
            }
            
            async handlePersonFormSubmit(event) {
                event.preventDefault();
                const form = event.target;
                const personType = form.personType.value;
                
                const personData = {
                    personType: personType,
                    email: form.email.value.trim(),
                    phone: form.phone.value.trim(),
                    address: form.address.value.trim(),
                    country: form.country.value,
                    city: form.city.value,
                    notes: form.notes.value.trim()
                };

                if (personType === 'real') {
                    const firstName = form.firstName.value.trim();
                    const lastName = form.lastName.value.trim();
                    personData.firstName = firstName;
                    personData.lastName = lastName;
                    personData.tcId = form.tcId.value.trim();
                    personData.name = `${firstName} ${lastName}`.trim();
                    personData.companyName = ''; 
                } else {
                    const companyName = form.companyName.value.trim();
                    personData.companyName = companyName;
                    personData.taxId = form.taxId.value.trim();
                    personData.name = companyName;
                    personData.firstName = ''; 
                    personData.lastName = '';
                }

                let result;
                if (this.editingPersonId) {
                    result = await personService.updatePerson(this.editingPersonId, personData);
                } else {
                    result = await personService.addPerson(personData);
                }

                if (result.success) {
                    showNotification(this.editingPersonId ? 'Kişi güncellendi!' : 'Kişi eklendi!', 'success');
                    this.closePersonModal();
                    await this.loadPersons();
                } else {
                    showNotification('İşlem başarısız: ' + result.error, 'error');
                }
            }

            async deletePerson(personId) {
                if (confirm('Bu kişiyi silmek istediğinizden emin misiniz?')) {
                    const result = await personService.deletePerson(personId);
                    if (result.success) {
                        showNotification('Kişi başarıyla silindi.', 'success');
                        await this.loadPersons();
                    } else {
                        showNotification('Silme işlemi başarısız: ' + result.error, 'error');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'persons.html' });
            const personsModule = new PersonsModule();
            auth.onAuthStateChanged(user => {
                if (user || authService.getCurrentUser()) {
                    personsModule.init();
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>