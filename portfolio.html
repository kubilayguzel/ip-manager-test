<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Portf√∂y</title>
    <style>
        /* Bu sayfaya √∂zel stiller */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; display: flex; }
        .page-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .main-container { width: 100%; padding: 30px; margin: 0; }
        
        /* Portfolio specific styles */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }

        .portfolio-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .filter-row { 
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input { 
            margin-right: auto;
            flex-grow: 1; 
            min-width: 180px;
            padding: 10px 12px;
            box-sizing: border-box;
        }

        .tab-menu {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 18px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            color: #1e3c72;
        }
        .tab-button.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .filter-group { 
            display: flex; 
            gap: 8px;
            align-items: center; 
        }
        .filter-label { font-weight: 500; }
        .filter-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .btn-add-record, .btn-primary, .btn-secondary, .btn-status-toggle { 
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-add-record:hover, .btn-primary:hover, .btn-secondary:hover, .btn-status-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.2);
        }
        .btn-status-toggle.activate {
            background-color: #28a745;
        }
        .btn-status-toggle.archive {
            background-color: #dc3545;
        }
        .btn-status-toggle:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .portfolio-table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: visible;
            position: relative;
            z-index: 1;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .portfolio-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .portfolio-table tr:hover {
            background-color: #f6f8fa;
        }
        
        .portfolio-table tr.record-status-pasif {
            opacity: 0.6;
            font-style: italic;
            background-color: #f0f0f0;
        }
        .portfolio-table tr.record-status-pasif:hover {
            opacity: 0.8;
            background-color: #e0e0e0;
        }

        .application-status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        .application-status-badge.beklemede {
            background-color: #ffc107;
            color: #333;
        }
        .application-status-badge.onaylandƒ± {
            background-color: #28a745;
        }
        .application-status-badge.reddedildi {
            background-color: #dc3545;
        }

        .record-active-status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        .record-active-status-badge.aktif {
            background-color: #007bff;
        }
        .record-active-status-badge.pasif {
            background-color: #6c757d;
        }
        
        .column-filter {
            width: calc(100% - 10px);
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85em;
            box-sizing: border-box;
            margin-top: 5px;
        }
        .portfolio-table th:has(> .column-filter) {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        .sortable-header {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        .sortable-header::after {
            content: '';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
        }
        .sortable-header.asc::after {
            border-top-color: #333;
        }
        .sortable-header.desc::after {
            border-bottom-color: #333;
        }
        .sortable-header.inactive::after {
            content: '\25B2\25BC';
            font-size: 0.7em;
            color: #ccc;
            line-height: 0.8;
            top: 50%;
            transform: translateY(-50%) scaleY(0.7);
        }

        .trademark-image-wrapper {
            position: relative;
            display: inline-block;
            overflow: visible;
            height: 50px;
            width: 50px;
            z-index: 1;
        }

        .trademark-image-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
            vertical-align: middle;
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.5s ease-out, border 0.5s ease-out;
            cursor: pointer;
        }

        .trademark-image-wrapper:hover .trademark-image-thumbnail {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            border: 2px solid #1e3c72;
            background-color: white;
            padding: 2px;
            max-width: 300px;
            max-height: 300px;
            width: auto;
            height: auto;
        }

        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-right: 5px;
        }
        .action-btn:last-child { margin-right: 0; }
        .action-btn:hover { opacity: 0.9; }
        .action-btn.edit-btn { background-color: #ffc107; color: #212529; }
        .action-btn.edit-btn:hover { background-color: #e0a800; }
        .action-btn.delete-btn { background-color: #dc3545; }
        .action-btn.delete-btn:hover { background-color: #c82333; }
        .action-btn.view-btn { background-color: #17a2b8; }
        .action-btn.view-btn:hover { background-color: #138496; }

        .no-records, .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            width: 100%;
            display: block;
        }
        .loading { display: none; }

        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            overflow: auto;
            padding: 30px;
            box-sizing: border-box;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 1250px;
            border-radius: 20px;
            animation: animatetop 0.4s;
            max-height: 90vh;
            overflow-y: auto;
        }
        .transaction-history .accordion-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #eaf2f8;
            color: #1e3c72;
            border-radius: 8px;
            margin-bottom: 5px;
            border: 1px solid #d0e7f7;
            font-weight: 600;
            gap: 10px;
            cursor: default;
        }
        .transaction-history .accordion-header.has-children {
            cursor: pointer;
        }
        .transaction-history .accordion-header.has-children::before {
            content: '+';
            display: inline-block;
            margin-right: 10px;
            width: 1em;
            transition: all 0.2s;
        }
        .transaction-history .accordion-header.has-children.active::before {
            content: '‚àí';
        }
        .transaction-history .accordion-header:hover {
            background: #d8edf7;
        }
        .transaction-history .accordion-header .transaction-type {
            flex-grow: 1;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .transaction-history .accordion-header .transaction-meta-inline {
            font-size: 0.85em;
            color: #4a6fa3;
            font-weight: normal;
        }
        .transaction-history .accordion-header .user-info {
            font-style: italic;
        }
        .transaction-history .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 15px;
            border: 1px solid #e1e8ed;
            border-top: none;
            margin-bottom: 0;
            border-radius: 0 0 8px 8px;
        }
        .transaction-history .accordion-header.active + .accordion-content {
            margin-bottom: 10px;
            padding: 10px 15px;
        }
        
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .close-modal-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-title { font-size: 1.5em; color: #1e3c72; margin-bottom: 20px;}
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; }
        .modal-detail-item { margin-bottom: 10px; }
        .modal-detail-label { font-weight: 600; color: #333; margin-bottom: 5px; font-size: 0.9em; }
        .modal-detail-value { color: #555; word-break: break-word; font-size: 0.95em; }
        .modal-detail-value.long-text { white-space: pre-wrap; background-color: #f8f9fa; padding: 8px; border-radius: 6px; }
        .modal-detail-section-title { grid-column: 1 / -1; font-size: 1.1em; color: #1e3c72; margin-top: 20px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #e1e8ed; }
        .document-list { list-style: none; padding: 0; }
        .document-list li { margin-bottom: 8px; font-size: 0.95em;}
        .document-list li a { text-decoration: none; color: #1e3c72; display: flex; align-items: center; gap: 8px;}
        .document-list li a:hover { text-decoration: underline; }
        .document-list li .doc-icon { font-size: 1.2em; }
        .record-image-display { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }
    </style>
</head>
<body>
    <div id="notification-container" class="notification-container"></div>
    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Portf√∂y Y√∂netimi</h1>
                <p class="page-subtitle">T√ºm fikri m√ºlkiyet kayƒ±tlarƒ±nƒ±zƒ± burada g√∂r√ºnt√ºleyin ve y√∂netin.</p>
            </section>
            
            <div class="portfolio-controls">
                <div class="tab-menu">
                    <button type="button" class="tab-button active" data-type="all">T√ºm√º</button>
                    <button type="button" class="tab-button" data-type="patent">Patent</button>
                    <button type="button" class="tab-button" data-type="trademark">Marka</button>
                    <button type="button" class="tab-button" data-type="design">Tasarƒ±m</button>
                    <button type="button" class="tab-button" data-type="objections">ƒ∞tirazlar</button>
                    <button type="button" class="tab-button" data-type="litigation">Davalar</button>
                    <button type="button" class="tab-button" data-type="thirdParty">3. Taraf Dosyalarƒ±</button>
                </div>
                <div class="filter-row">
                    <input type="text" id="searchBar" class="search-input" placeholder="Ba≈ülƒ±k, numara, durum, hak sahibi ara...">
                    
                    <div class="filter-group">
                        <input type="checkbox" id="selectAllCheckbox">
                        <label for="selectAllCheckbox" class="filter-label">T√ºm√ºn√º Se√ß</label>
                    </div>

                    <button type="button" class="btn-status-toggle" id="toggleRecordStatusBtn" disabled>
                        Aktif/Pasif
                    </button>
                    <button type="button" class="btn-status-toggle" id="addToMonitoringBtn" disabled>
                        ƒ∞zlemeye Ekle
                    </button>
                    <button class="btn-add-record" onclick="window.location.href='data-entry.html'">
                        <span>&#x2795;</span> Yeni Kayƒ±t Ekle
                    </button>
                    <button class="btn-secondary" id="exportExcelBtn">Excel'e Aktar</button>
                    <button class="btn-secondary" id="exportPdfBtn">PDF'e Aktar</button>
                </div>
            </div>
    
            <div class="portfolio-table-container">
                <table class="portfolio-table" id="portfolio-table">
                    <thead>
                        <tr id="portfolioTableHeaderRow"></tr>
                        <tr id="portfolioTableFilterRow"></tr>
                    </thead>
                    <tbody id="portfolioTableBody"></tbody>
                </table>
                <div id="loadingIndicator" class="loading">Y√ºkleniyor...</div>
                <div id="noRecordsMessage" class="no-records">Hen√ºz kayƒ±t bulunmamaktadƒ±r.</div>
            </div>

            <div id="paginationContainer"></div>

        </main>
        <!-- üìÑ Kayƒ±t Detaylarƒ± Modalƒ± -->
        <div class="modal fade" id="portfolioDetailModal" tabindex="-1" role="dialog" aria-labelledby="portfolioDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable" role="document">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="portfolioDetailModalLabel">Kayƒ±t Detaylarƒ±</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Kapat">
                <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="portfolioDetailModalBody">
                <!-- JS ile doldurulacak -->
            </div>
            </div>
        </div>
        </div>
    </div>
    <div id="recordDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeRecordDetailModal">&times;</span>
            <h3 class="modal-title" id="modalRecordTitle">Kayƒ±t Detayƒ±</h3>
            <div id="modalBody" class="modal-body-content"></div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import Pagination from './js/pagination.js'; 
        import { ipRecordsService, personService, transactionTypeService, auth, monitoringService } from './firebase-config.js';
        import { showNotification, formatFileSize } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';

        let transactionTypesMap = new Map();
        let allPersons = []; 
        let pagination;
        let portfolioModule; 

        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'portfolio.html' });
            await loadTransactionTypes();
            await loadPersons();
            portfolioModule = new PortfolioModule();
            portfolioModule.init();
            window.portfolioModule = portfolioModule;
        });
        
        class PortfolioModule {
            constructor() {
                this.allRecords = []; 
                this.filteredAndSortedRecords = [];
                this.activeTypeFilter = 'all'; 
                this.columnFilters = {}; 
                this.sortBy = { column: 'applicationDate', direction: 'desc' };
                this.selectedRecords = new Set();
            }

            init() {
                this.currentUser = auth.currentUser;
                if (!this.currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
                this.initializePagination();
                this.setupEventListeners();
                this.loadAllData();
            }

            initializePagination() {
                pagination = new Pagination({
                    containerId: 'paginationContainer',
                    itemsPerPage: 20,
                    onPageChange: (newPage, itemsPerPage) => {
                       this.renderCurrentPage();
                    }
                });
            }

            async loadAllData() {
                document.getElementById('loadingIndicator').style.display = 'block';
                try {
                    const recordsResult = await ipRecordsService.getRecords();
                    console.log('üìä Firebase\'den gelen veri:', recordsResult); // Debug log
                    
                    this.allRecords = recordsResult.success ? recordsResult.data : [];
                    console.log('üìä ƒ∞≈ülenen kayƒ±tlar:', this.allRecords); // Debug log
                    
                    this.initialRenderTableStructure(); 
                    this.applyFiltersAndSort(); 
                } catch (error) {
                    console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
                    showNotification('Veriler y√ºklenirken bir hata olu≈ütu: ' + error.message, 'error');
                    document.getElementById('noRecordsMessage').style.display = 'block';
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }
            
            // portfolio.html i√ßindeki renderCurrentPage() fonksiyonunda d√ºzeltme
                renderCurrentPage() {
                    const tableBody = document.getElementById('portfolioTableBody');
                    tableBody.innerHTML = '';
                    if (!pagination) return;

                    const currentPageData = pagination.getCurrentPageData(this.filteredAndSortedRecords);
                    const fragment = document.createDocumentFragment();

currentPageData.forEach(record => {
        console.log('üîç ƒ∞≈ülenen kayƒ±t:', record);

        const row = document.createElement('tr');
        row.dataset.recordId = record.id;
        row.className = `record-status-${record.portfoyStatus || 'active'}`;

        const isChecked = this.selectedRecords.has(record.id) ? 'checked' : '';
        
        // 1. Kayƒ±t Durumu - portfoyStatus
        const portfoyStatusDisplay = record.portfoyStatus === 'active' ? 'Aktif' : 
                                    record.portfoyStatus === 'inactive' ? 'Pasif' : 
                                    'Aktif';

        // 2. Kayƒ±t Tipi - type alanƒ±
        const ipTypeDisplay = record.type === 'trademark' ? 'Marka' : 
                             record.type === 'patent' ? 'Patent' : 
                             record.type === 'design' ? 'Tasarƒ±m' : 
                             (record.type || '-');

        // 3. M/T/B Adƒ± - title
        const title = record.title || '-';

        // 4. Marka g√∂rseli - brandImageUrl
        const imageHtml = record.type === 'trademark' && record.brandImageUrl 
            ? `<div class="trademark-image-wrapper"><img src="${record.brandImageUrl}" alt="Marka G√∂rseli" class="trademark-image-thumbnail"></div>` 
            : '-';

        // 5. Ba≈üvuru No - applicationNumber
        const applicationNumber = record.applicationNumber || '-';

        // 6. Ba≈üvuru Tarihi - applicationDate
        const applicationDateDisplay = record.applicationDate ? 
            new Date(record.applicationDate).toLocaleDateString('tr-TR') : '-';

        // 7. Ba≈üvuru Durumu - status (T√ºrk√ße √ßeviri)
        const statusDisplay = record.status === 'ba≈üvuru' ? 'Ba≈üvuru' :
                             record.status === 'application_filed' ? 'Ba≈üvuru Yapƒ±ldƒ±' :
                             record.status === 'tescilli' ? 'Tescilli' :
                             record.status === 'registered' ? 'Tescilli' :
                             record.status === 'yenilendi' ? 'Yenilendi' :
                             record.status === 'renewed' ? 'Yenilendi' :
                             record.status === 'h√ºk√ºms√ºz' ? 'H√ºk√ºms√ºz' :
                             record.status === 'invalid' ? 'H√ºk√ºms√ºz' :
                             record.status === 'itiraz edildi' ? 'ƒ∞tiraz Edildi' :
                             record.status === 'opposed' ? 'ƒ∞tiraz Edildi' :
                             (record.status || '-');

        // 8. Ba≈üvuru Sahipleri - applicants
        const applicantsDisplay = record.applicants?.map(a => a.name).join(', ') || 'Belirtilmemi≈ü';

        row.innerHTML = `
            <td><input type="checkbox" ${isChecked} onchange="portfolioModule.handleRecordSelection('${record.id}', this.checked)"></td>
            <td><span class="record-active-status-badge ${record.portfoyStatus || 'active'}">${portfoyStatusDisplay}</span></td>
            <td>${ipTypeDisplay}</td>
            <td title="${title}">${title}</td>
            <td style="${this.activeTypeFilter === 'all' ? 'display: none;' : ''}">${imageHtml}</td>
            <td>${applicationNumber}</td>
            <td>${applicationDateDisplay}</td>
            <td>${statusDisplay}</td>
            <td title="${applicantsDisplay}">${applicantsDisplay}</td>
            <td>
                <button class="action-btn view-btn" data-id="${record.id}">Detay</button>
                <button class="action-btn edit-btn" data-id="${record.id}">D√ºzenle</button>
                <button class="action-btn delete-btn" data-id="${record.id}">Sil</button>
            </td>
        `;
        
        fragment.appendChild(row);
    });
    tableBody.appendChild(fragment);
}
            applyFiltersAndSort() {
            const globalSearchTerm = document.getElementById('searchBar').value.toLowerCase();
            
            let filtered = this.allRecords.filter(record => {
                let tabMatch = false;
                
                // Firebase yapƒ±sƒ±na uygun filtreleme - recordOwnerType kullanƒ±n
                if (this.activeTypeFilter === 'all') {
                    tabMatch = true; // T√ºm kayƒ±tlarƒ± g√∂ster
                } else if (this.activeTypeFilter === 'thirdParty') {
                    tabMatch = record.recordOwnerType === 'thirdParty'; // 3. taraf kayƒ±tlarƒ±
                } else if (this.activeTypeFilter === 'objections') {
                    tabMatch = record.transactions?.some(t => t.type?.includes('ƒ∞tiraz'));
                } else if (this.activeTypeFilter === 'litigation') {
                    tabMatch = record.transactions?.some(t => t.type?.includes('Dava'));
                } else {
                    // IP t√ºr√ºne g√∂re filtreleme (trademark, patent, design)
                    tabMatch = record.ipType === this.activeTypeFilter;
                }
                
                if (!tabMatch) return false;

                // Global arama
                if (globalSearchTerm) {
                    const searchableText = `
                        ${record.title || ''} 
                        ${record.brandText || ''} 
                        ${record.applicationNumber || ''} 
                        ${record.status || ''} 
                        ${record.ipType || ''}
                        ${record.applicants?.map(a => a.name).join(' ') || ''}
                    `.toLowerCase();
                    
                    if (!searchableText.includes(globalSearchTerm)) return false;
                }

                // Kolon filtreleri
                return Object.keys(this.columnFilters).every(key => {
                    const filterValue = this.columnFilters[key];
                    if (!filterValue) return true;
                    
                    let recordValue = '';
                    if (key === 'owners' || key === 'applicants') {
                        recordValue = record.applicants?.map(a => a.name).join(' ') || '';
                    } else if (key === 'title') {
                        recordValue = record.title || record.brandText || '';
                    } else if (key === 'type' || key === 'recordType') {
                        recordValue = record.ipType || '';
                    } else {
                        recordValue = String(record[key] || '');
                    }
                    
                    return recordValue.toLowerCase().includes(filterValue);
                });
            });

            // Sƒ±ralama
            if (this.sortBy.column) {
                const { column, direction } = this.sortBy;
                filtered.sort((a, b) => {
                    let valA, valB;
                    
                    // √ñzel alanlar i√ßin sƒ±ralama
                    if (column === 'title') {
                        valA = a.title || a.brandText || '';
                        valB = b.title || b.brandText || '';
                    } else if (column === 'type' || column === 'recordType') {
                        valA = a.ipType || '';
                        valB = b.ipType || '';
                    } else if (column === 'owners') {
                        valA = a.applicants?.map(app => app.name).join(', ') || '';
                        valB = b.applicants?.map(app => app.name).join(', ') || '';
                    } else {
                        valA = a[column] || '';
                        valB = b[column] || '';
                    }
                    
                    // Tarih alanlarƒ± i√ßin √∂zel i≈ülem
                    if (column.includes('Date')) {
                        valA = new Date(valA || 0);
                        valB = new Date(valB || 0);
                    }
                    
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            
            this.filteredAndSortedRecords = filtered;

            if (pagination) {
                pagination.update(this.filteredAndSortedRecords.length);
            }
            
            document.getElementById('portfolioTableBody').style.display = this.filteredAndSortedRecords.length > 0 ? 'table-row-group' : 'none';
            document.getElementById('noRecordsMessage').style.display = this.filteredAndSortedRecords.length === 0 ? 'block' : 'none';

            this.renderCurrentPage();
        }
            
            setupEventListeners() {
                document.querySelectorAll('.tab-menu .tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        document.querySelectorAll('.tab-menu .tab-button').forEach(btn => btn.classList.remove('active'));
                        e.target.classList.add('active');
                        this.activeTypeFilter = e.target.dataset.type;
                        this.selectedRecords.clear();
                        this.updateAddToMonitoringButtonState();
                        this.updateRecordStatusToggleButtonState();
                        document.getElementById('selectAllCheckbox').checked = false;
                        this.initialRenderTableStructure();
                        this.applyFiltersAndSort();
                    });
                });

                let searchTimeout;
                document.getElementById('searchBar').addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => this.applyFiltersAndSort(), 300);
                });

                document.getElementById('portfolioTableFilterRow').addEventListener('input', (e) => {
                    if (e.target.classList.contains('column-filter')) {
                        this.columnFilters[e.target.dataset.column] = e.target.value.toLowerCase();
                        this.applyFiltersAndSort();
                    }
                });

                document.getElementById('portfolioTableHeaderRow').addEventListener('click', (e) => {
                    const header = e.target.closest('.sortable-header');
                    if (header) this.toggleSort(header.dataset.column);
                });

                document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    const currentPageIds = pagination.getCurrentPageData(this.filteredAndSortedRecords).map(r => r.id);
                    currentPageIds.forEach(id => this.toggleRecordSelection(id, isChecked));
                    document.querySelectorAll('#portfolioTableBody .record-checkbox').forEach(cb => cb.checked = isChecked);
                });

                document.getElementById('portfolioTableBody').addEventListener('change', e => {
                    if (e.target.classList.contains('record-checkbox')) {
                        this.toggleRecordSelection(e.target.dataset.id, e.target.checked);
                    }
                });

                document.getElementById('toggleRecordStatusBtn').addEventListener('click', () => this.toggleSelectedRecordsStatus());
                document.getElementById('addToMonitoringBtn').addEventListener('click', () => this.addSelectedToMonitoring());
                document.getElementById('closeRecordDetailModal').addEventListener('click', () => this.closeModal('recordDetailModal'));

                document.getElementById('portfolioTableBody').addEventListener('click', (e) => { 
                    const button = e.target.closest('.action-btn');
                    if (button) {
                        e.preventDefault();
                        const recordId = button.dataset.id;
                        if (button.classList.contains('edit-btn')) window.location.href = `data-entry.html?id=${recordId}`;
                        else if (button.classList.contains('delete-btn')) this.deleteRecord(recordId);
                        else if (button.classList.contains('view-btn')) this.showRecordDetailModal(recordId);
                    }
                });
            }

            toggleSort(columnKey) {
                if (this.sortBy.column === columnKey) {
                    this.sortBy.direction = this.sortBy.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    this.sortBy.column = columnKey;
                    this.sortBy.direction = 'asc';
                }
                 document.querySelectorAll('.sortable-header').forEach(header => {
                    header.classList.remove('asc', 'desc');
                    if (header.dataset.column === this.sortBy.column) {
                        header.classList.add(this.sortBy.direction);
                    }
                });
                this.applyFiltersAndSort(); 
            }
            
            toggleRecordSelection(recordId, isChecked) {
                if (isChecked) this.selectedRecords.add(recordId);
                else this.selectedRecords.delete(recordId);
                this.updateRecordStatusToggleButtonState();
                this.updateAddToMonitoringButtonState();
            }

            updateRecordStatusToggleButtonState() {
                const btn = document.getElementById('toggleRecordStatusBtn');
                if (this.selectedRecords.size === 0) {
                    btn.disabled = true;
                    btn.textContent = 'Aktif/Pasif';
                    btn.className = 'btn-status-toggle';
                    return;
                }
                const firstStatus = this.allRecords.find(r => r.id === [...this.selectedRecords][0])?.recordStatus;
                const allSame = [...this.selectedRecords].every(id => this.allRecords.find(r => r.id === id)?.recordStatus === firstStatus);

                btn.disabled = false;
                if (!allSame) {
                     btn.textContent = `Aktif/Pasif (${this.selectedRecords.size})`;
                     btn.className = 'btn-status-toggle';
                } else if (firstStatus === 'aktif') {
                    btn.textContent = `Ar≈üivle (${this.selectedRecords.size})`;
                    btn.className = 'btn-status-toggle archive';
                } else {
                    btn.textContent = `Aktif Et (${this.selectedRecords.size})`;
                    btn.className = 'btn-status-toggle activate';
                }
            }
            
            updateAddToMonitoringButtonState() {
                const btn = document.getElementById('addToMonitoringBtn');
                btn.disabled = this.selectedRecords.size === 0;
                btn.textContent = this.selectedRecords.size > 0 ? `ƒ∞zlemeye Ekle (${this.selectedRecords.size})` : 'ƒ∞zlemeye Ekle';
            }

            async toggleSelectedRecordsStatus() {
                 if (this.selectedRecords.size === 0) return;
                const recordsToUpdate = [...this.selectedRecords].map(id => this.allRecords.find(r => r.id === id)).filter(Boolean);
                if (recordsToUpdate.length === 0) return;

                const firstStatus = recordsToUpdate[0].recordStatus;
                if (!recordsToUpdate.every(r => r.recordStatus === firstStatus)) {
                    showNotification('Se√ßili kayƒ±tlarƒ±n aktiflik durumlarƒ± farklƒ±. L√ºtfen aynƒ± durumda olanlarƒ± se√ßin.', 'warning');
                    return;
                }
                const targetStatus = firstStatus === 'aktif' ? 'pasif' : 'aktif';
                if (!confirm(`Se√ßilen ${recordsToUpdate.length} kaydƒ± "${targetStatus}" yapmak istediƒüinizden emin misiniz?`)) return;

                await Promise.all(recordsToUpdate.map(r => ipRecordsService.updateRecord(r.id, { recordStatus: targetStatus })));
                showNotification('Kayƒ±tlar g√ºncellendi.', 'success');
                this.selectedRecords.clear();
                this.loadAllData();
            }
            
            async addSelectedToMonitoring() {
                const selectedIds = Array.from(this.selectedRecords);
                if (selectedIds.length === 0) return;
                let successful = 0, failed = 0, skipped = 0;

                for (const id of selectedIds) {
                    const record = this.allRecords.find(r => r.id === id);
                    if (!record) { failed++; continue; }
                    if (record.type !== 'trademark') { skipped++; continue; }
                    
                    const res = await monitoringService.addMonitoringItem({ ...record });
                    if (res.success) successful++;
                    else failed++;
                }
                if (successful > 0) showNotification(`${successful} kayƒ±t ba≈üarƒ±yla izlemeye eklendi.`, 'success');
                if (failed > 0) showNotification(`${failed} kayƒ±t izlemeye eklenirken hata olu≈ütu.`, 'error');
                if (skipped > 0) showNotification(`${skipped} marka olmayan kayƒ±t atlandƒ±.`, 'info');
                
                this.selectedRecords.clear();
                this.updateAddToMonitoringButtonState();
                this.renderCurrentPage();
            }

            async deleteRecord(recordId) {
                if (confirm('Bu kaydƒ± silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
                    await ipRecordsService.deleteRecord(recordId);
                    showNotification('Kayƒ±t ba≈üarƒ±yla silindi.', 'success');
                    this.loadAllData();
                }
            }
            viewRecordDetail(recordId) {
            const record = this.allRecords.find(r => r.id === recordId);
            if (!record) {
                showNotification('Kayƒ±t bulunamadƒ±.', 'error');
                return;
            }
            this.showRecordDetailModal(recordId);
        }

        editRecord(recordId) {
            // D√ºzenleme sayfasƒ±na y√∂nlendir
            window.location.href = `data-entry.html?id=${recordId}`;
        }

        // ‚úÖ D√ºzeltilmi≈ü showRecordDetailModal fonksiyonu
        async showRecordDetailModal(recordId) {
            const modal = document.getElementById('recordDetailModal');
            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = '<p>Y√ºkleniyor...</p>';
            modal.classList.add('show');

            try {
                const recordResult = await ipRecordsService.getRecordById(recordId);
                if (!recordResult.success || !recordResult.data) {
                    throw new Error('Kayƒ±t bulunamadƒ±.');
                }
                const record = recordResult.data;

                document.getElementById('modalRecordTitle').textContent = `Kayƒ±t Detayƒ±: ${record.title || record.brandText || 'N/A'}`;
                
                // Ba≈üvuru sahiplerini Firebase'den applicants olarak al
                const getOwnerNames = (applicants) => {
                    if (!applicants || applicants.length === 0) return 'Belirtilmemi≈ü';
                    return applicants.map(a => a.name || 'Bilinmeyen').join(', ');
                };
                
                // Marka g√∂rseli - Firebase'den brandImageUrl
                let imageHtml = '';
                if (record.ipType === 'trademark' && record.brandImageUrl) {
                    imageHtml = `<h4 class="modal-detail-section-title">Marka G√∂rseli</h4>
                                <img src="${record.brandImageUrl}" alt="Marka G√∂rseli" class="record-image-display">`;
                }

                // Durum g√∂sterimi
                const statusDisplay = record.status === 'active' ? 'Aktif' : (record.status || '-');
                const ipTypeDisplay = record.ipType === 'trademark' ? 'Marka' : (record.ipType === 'patent' ? 'Patent' : (record.ipType === 'design' ? 'Tasarƒ±m' : (record.ipType || '-')));

                modalBody.innerHTML = `
                    <div class="modal-detail-grid">
                        <div class="modal-detail-item"><div class="modal-detail-label">IP T√ºr√º</div><div class="modal-detail-value">${ipTypeDisplay}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Durum</div><div class="modal-detail-value">${statusDisplay}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Kayƒ±t Sahibi T√ºr√º</div><div class="modal-detail-value">${record.recordOwnerType === 'self' ? 'Kendi Kaydƒ±' : '3. Taraf'}</div></div>
                        <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">Ba≈ülƒ±k</div><div class="modal-detail-value">${record.title || record.brandText || '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Ba≈üvuru Numarasƒ±</div><div class="modal-detail-value">${record.applicationNumber || '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Ba≈üvuru Tarihi</div><div class="modal-detail-value">${record.applicationDate || '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Tescil Numarasƒ±</div><div class="modal-detail-value">${record.registrationNumber || '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Tescil Tarihi</div><div class="modal-detail-value">${record.registrationDate || '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDate || '-'}</div></div>
                        <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">Ba≈üvuru Sahipleri</div><div class="modal-detail-value">${getOwnerNames(record.applicants)}</div></div>
                        <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">A√ßƒ±klama</div><div class="modal-detail-value long-text">${record.description || '-'}</div></div>
                    </div>
                    ${imageHtml}
                    <h4 class="modal-detail-section-title">Nice Sƒ±nƒ±flarƒ± ve Hizmetler</h4>
                    <div class="modal-detail-item" style="grid-column: 1 / -1;">
                        ${record.goodsAndServices && record.goodsAndServices.length > 0 
                            ? record.goodsAndServices.map((item, index) => 
                                `<div class="nice-class-item" style="margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px;">
                                    <strong>Sƒ±nƒ±f ${index + 1}:</strong> ${item}
                                </div>`
                            ).join('') 
                            : 'Nice sƒ±nƒ±fƒ± belirtilmemi≈ü'
                        }
                    </div>
                    <h4 class="modal-detail-section-title">R√º√ßhan Bilgileri</h4>
                    <div class="modal-detail-item" style="grid-column: 1 / -1;">
                        ${record.priorities && record.priorities.length > 0 
                            ? record.priorities.map(priority => 
                                `<div class="priority-item" style="margin-bottom: 8px; padding: 8px; background-color: #e3f2fd; border-radius: 4px;">
                                    <strong>${priority.type === 'ba≈üvuru' ? 'Ba≈üvuru' : 'Sergi'} R√º√ßhanƒ±:</strong><br>
                                    <span style="margin-left: 10px;">√úlke: ${priority.country}</span><br>
                                    <span style="margin-left: 10px;">Numara: ${priority.number}</span><br>
                                    <span style="margin-left: 10px;">Tarih: ${priority.date}</span>
                                </div>`
                            ).join('') 
                            : 'R√º√ßhan bilgisi bulunmuyor'
                        }
                    </div>
                    <h4 class="modal-detail-section-title">Sistem Bilgileri</h4>
                    <div class="modal-detail-grid">
                        <div class="modal-detail-item"><div class="modal-detail-label">Olu≈üturma Tarihi</div><div class="modal-detail-value">${record.createdAt ? new Date(record.createdAt.seconds * 1000).toLocaleString('tr-TR') : '-'}</div></div>
                        <div class="modal-detail-item"><div class="modal-detail-label">Son G√ºncelleme</div><div class="modal-detail-value">${record.updatedAt ? new Date(record.updatedAt).toLocaleString('tr-TR') : '-'}</div></div>
                    </div>
                `;
                
            } catch (error) {
                modalBody.innerHTML = `<p class="error-message">Kayƒ±t detaylarƒ± y√ºklenirken hata olu≈ütu: ${error.message}</p>`;
                console.error('Modal detay hatasƒ±:', error);
            }
        }
        closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
            }
        }

        generateRecordDetailHTML(record) {
            const details = record.details || {};
            const owners = record.owners || [];
            const transactions = record.transactions || [];
            
            // Hak sahiplerini al
            const ownerNames = owners.map(owner => 
                allPersons.find(p => p.id === owner.id)?.name || 'Bilinmiyor'
            ).join(', ') || 'Belirtilmemi≈ü';

            let html = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Kayƒ±t T√ºr√º:</div>
                        <div class="detail-value">${record.type || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ba≈üvuru Numarasƒ±:</div>
                        <div class="detail-value">${record.applicationNumber || details.applicationNumber || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Ba≈üvuru Tarihi:</div>
                        <div class="detail-value">${record.applicationDate ? new Date(record.applicationDate).toLocaleDateString('tr-TR') : '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Durum:</div>
                        <div class="detail-value">
                            <span class="application-status-badge ${record.status || 'beklemede'}">${record.status || 'Beklemede'}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Kayƒ±t Durumu:</div>
                        <div class="detail-value">
                            <span class="record-active-status-badge ${record.recordStatus || 'aktif'}">${record.recordStatus === 'aktif' ? 'Aktif' : 'Pasif'}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Hak Sahipleri:</div>
                        <div class="detail-value">${ownerNames}</div>
                    </div>
                `;

            // Marka √∂zel alanlarƒ±
            if (record.type === 'trademark') {
                html += `
                    <div class="detail-item">
                        <div class="detail-label">Marka Metni:</div>
                        <div class="detail-value">${details.brandText || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Nice Sƒ±nƒ±flarƒ±:</div>
                        <div class="detail-value">${details.niceClasses?.join(', ') || '-'}</div>
                    </div>
                `;
                
                if (details.trademarkImage) {
                    html += `
                        <div class="detail-item full-width">
                            <div class="detail-label">Marka G√∂rseli:</div>
                            <div class="detail-value">
                                <img src="${details.trademarkImage}" alt="Marka G√∂rseli" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd; border-radius: 8px;">
                            </div>
                        </div>
                    `;
                }
            }

            // Patent √∂zel alanlarƒ±
            if (record.type === 'patent') {
                html += `
                    <div class="detail-item full-width">
                        <div class="detail-label">Patent Ba≈ülƒ±ƒüƒ±:</div>
                        <div class="detail-value">${details.patentTitle || '-'}</div>
                    </div>
                    <div class="detail-item full-width">
                        <div class="detail-label">Patent √ñzeti:</div>
                        <div class="detail-value">${details.patentSummary || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Uluslararasƒ± Patent Sƒ±nƒ±fƒ±:</div>
                        <div class="detail-value">${details.ipcClass || '-'}</div>
                    </div>
                `;
            }

            // Tasarƒ±m √∂zel alanlarƒ±
            if (record.type === 'design') {
                html += `
                    <div class="detail-item full-width">
                        <div class="detail-label">Tasarƒ±m Ba≈ülƒ±ƒüƒ±:</div>
                        <div class="detail-value">${details.designTitle || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Locarno Sƒ±nƒ±fƒ±:</div>
                        <div class="detail-value">${details.locarnoClass || '-'}</div>
                    </div>
                `;
            }

            html += `</div>`;

            // ƒ∞≈ülemler tablosu
            if (transactions.length > 0) {
                html += `
                    <div class="transactions-section" style="margin-top: 30px;">
                        <h4>ƒ∞≈ülem Ge√ßmi≈üi</h4>
                        <table class="transactions-table" style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 10px; border: 1px solid #ddd;">Tarih</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">ƒ∞≈ülem T√ºr√º</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">Durum</th>
                                    <th style="padding: 10px; border: 1px solid #ddd;">A√ßƒ±klama</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                transactions.forEach(transaction => {
                    const transactionType = transactionTypesMap.get(transaction.transactionTypeId)?.name || 'Bilinmiyor';
                    html += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #eee;">${transaction.date ? new Date(transaction.date).toLocaleDateString('tr-TR') : '-'}</td>
                            <td style="padding: 8px; border: 1px solid #eee;">${transactionType}</td>
                            <td style="padding: 8px; border: 1px solid #eee;">
                                <span class="status-badge ${transaction.status || 'beklemede'}">${transaction.status || 'Beklemede'}</span>
                            </td>
                            <td style="padding: 8px; border: 1px solid #eee;">${transaction.description || '-'}</td>
                        </tr>
                    `;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            return html;
        }

        // handleRecordSelection fonksiyonu da eksikse ekleyin:
        handleRecordSelection(recordId, isChecked) {
            this.toggleRecordSelection(recordId, isChecked);
        }
            
        initialRenderTableStructure() {
            const headerRow = document.getElementById('portfolioTableHeaderRow');
            const filterRow = document.getElementById('portfolioTableFilterRow');
            headerRow.innerHTML = ''; 
            filterRow.innerHTML = '';

            const columns = [
                { key: 'selection', label: '', sortable: false, isCheckbox: true, width: '40px' },
                { key: 'status', label: 'Kayƒ±t Durumu', sortable: true, width: '110px' }, // En ba≈üa alƒ±ndƒ±
                { key: 'ipType', label: 'Kayƒ±t Tipi', sortable: true, width: '100px' },
                { key: 'title', label: 'M/T/B Adƒ±', sortable: true, width: '200px' },
                { key: 'brandImage', label: 'G√∂rsel', sortable: false, width: '80px' }, // Sadece Marka sekmesinde
                { key: 'applicationNumber', label: 'Ba≈üvuru No', sortable: true, width: '120px' },
                { key: 'applicationDate', label: 'Ba≈üvuru Tarihi', sortable: true, width: '120px' },
                { key: 'applicationStatus', label: 'Ba≈üvuru Durumu', sortable: false, width: '120px' }, // Bo≈ü kalacak
                { key: 'applicants', label: 'Ba≈ü.Sahibi', sortable: true, width: '200px' },
                { key: 'actions', label: 'ƒ∞≈ülemler', sortable: false, width: '250px' }
            ];

            columns.forEach(col => {
                const th = document.createElement('th');
                th.style.width = col.width;
                if (col.sortable) {
                    th.className = 'sortable-header inactive';
                    th.dataset.column = col.key;
                }
                th.innerHTML = col.isCheckbox ? 
                    `<input type="checkbox" id="selectAllCheckbox">` : col.label;

                const thFilter = document.createElement('th');
                if (col.sortable && !col.isCheckbox) {
                    thFilter.innerHTML = `<input type="text" class="column-filter" data-column="${col.key}" placeholder="${col.label} ara...">`;
                }
                
                // G√∂rsel kolonu sadece marka sekmesinde ve t√ºm√º tabƒ±nda g√∂ster
                if (col.key === 'brandImage' && this.activeTypeFilter !== 'trademark' && this.activeTypeFilter !== 'all') {
                    th.style.display = 'none';
                    thFilter.style.display = 'none';
                }
                
                // T√ºm√º tabƒ±nda g√∂rsel kolonunu gizle
                if (col.key === 'brandImage' && this.activeTypeFilter === 'all') {
                    th.style.display = 'none';
                    thFilter.style.display = 'none';
                }

                headerRow.appendChild(th);
                filterRow.appendChild(thFilter);
            });
        }
                    
            async showRecordDetailModal(recordId) {
                const modal = document.getElementById('recordDetailModal');
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = '<p>Y√ºkleniyor...</p>';
                modal.classList.add('show');

                try {
                    const recordResult = await ipRecordsService.getRecordById(recordId);
                    if (!recordResult.success || !recordResult.data) {
                        throw new Error('Kayƒ±t bulunamadƒ±.');
                    }
                    const record = recordResult.data;

                    document.getElementById('modalRecordTitle').textContent = `Kayƒ±t Detayƒ±: ${record.title || 'N/A'}`;
                    const getOwnerNames = (owners) => (!owners || owners.length === 0) ? '-' : owners.map(o => allPersons.find(p => p.id === o.id)?.name || 'Bilinmeyen').join(', ');
                    
                    let imageHtml = '';
                    let imageSrc = typeof record.trademarkImage === 'string' ? record.trademarkImage : record.trademarkImage?.content;
                    if (record.type === 'trademark' && imageSrc?.startsWith('data:image')) {
                        imageHtml = `<h4 class="modal-detail-section-title">Marka G√∂rseli</h4><img src="${imageSrc}" alt="Marka G√∂rseli" class="record-image-display">`;
                    }

                    let documentsHtml = '<ul class="document-list"><li>Hen√ºz belge yok.</li></ul>';
                    if (record.documents && record.documents.length > 0) {
                        documentsHtml = '<ul class="document-list">' + record.documents.map(doc => `<li><a href="${doc.content}" download="${doc.name}"><span class="doc-icon">üìÑ</span>${doc.name} (${formatFileSize(doc.size)}) - ${doc.documentDesignation || 'Belge'}</a></li>`).join('') + '</ul>';
                    }

                    let transactionsHtml = '<div class="transaction-history">';
                    const transResult = await ipRecordsService.getRecordTransactions(record.id);
                    if (transResult.success && transResult.data.length > 0) {
                        const transactions = transResult.data;
                        const transactionMap = new Map(transactions.map(tx => [tx.id, { ...tx, children: [] }]));
                        const topLevelTransactions = [];
                        transactions.forEach(tx => {
                            if (tx.transactionHierarchy === 'child' && tx.parentId && transactionMap.has(tx.parentId)) {
                                transactionMap.get(tx.parentId).children.push(transactionMap.get(tx.id));
                            } else {
                                topLevelTransactions.push(transactionMap.get(tx.id));
                            }
                        });
                        topLevelTransactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                        topLevelTransactions.forEach(parentTx => {
                            parentTx.children.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                            const hasChildrenClass = parentTx.children.length > 0 ? 'has-children' : '';
                            const typeObj = transactionTypesMap.get(parentTx.type);
                            const typeName = (typeObj ? (typeObj.alias || typeObj.name) : parentTx.type || parentTx.designation) || 'Bilinmiyor';
                            transactionsHtml += `<div class="accordion"><div class="accordion-header ${hasChildrenClass}"><span class="transaction-type">${typeName} <span class="transaction-meta-inline">${new Date(parentTx.timestamp).toLocaleString('tr-TR')}</span><span class="transaction-meta-inline user-info">(${parentTx.userName || parentTx.userEmail || 'Bilinmeyen'})</span></span></div><div class="accordion-content">${parentTx.children.map(childTx => { const cTypeObj = transactionTypesMap.get(childTx.type); const cTypeName = (cTypeObj ? (cTypeObj.alias || cTypeObj.name) : childTx.type || childTx.designation) || 'Bilinmiyor'; return `<div class="transaction-item" style="margin-left: 20px; border-left: 2px solid #ccc; padding-left: 10px;"><div class="transaction-type">Alt ƒ∞≈ülem: ${cTypeName}</div><div class="transaction-meta">A√ßƒ±klama: ${childTx.description || '-'}</div><div class="transaction-meta">Tarih: ${childTx.timestamp ? new Date(childTx.timestamp).toLocaleString('tr-TR') : '-'}</div><div class="transaction-meta">Yapan: ${childTx.userName || childTx.userEmail || 'Bilinmeyen'}</div></div>`; }).join('')}</div></div>`;
                        });

                    } else {
                        transactionsHtml += '<p>Bu kayƒ±t i√ßin i≈ülem ge√ßmi≈üi bulunmamaktadƒ±r.</p>';
                    }
                    transactionsHtml += '</div>';

                    modalBody.innerHTML = `
                        <div class="modal-detail-grid">
                            <div class="modal-detail-item"><div class="modal-detail-label">Kayƒ±t Tipi</div><div class="modal-detail-value">${record.recordType || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Kayƒ±t T√ºr√º</div><div class="modal-detail-value">${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Ba≈üvuru Durumu</div><div class="modal-detail-value">${record.status}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Kayƒ±t Durumu</div><div class="modal-detail-value">${record.recordStatus}</div></div>
                            <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">Ba≈ülƒ±k</div><div class="modal-detail-value">${record.title}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Ba≈üvuru Numarasƒ±</div><div class="modal-detail-value">${record.applicationNumber || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Ba≈üvuru Tarihi</div><div class="modal-detail-value">${record.applicationDate || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Tescil Numarasƒ±</div><div class="modal-detail-value">${record.registrationNumber || '-'}</div></div>
                            <div class="modal-detail-item"><div class="modal-detail-label">Tescil Tarihi</div><div class="modal-detail-value">${record.registrationDate || '-'}</div></div>
                            <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">Hak Sahipleri</div><div class="modal-detail-value">${getOwnerNames(record.owners)}</div></div>
                            <div class="modal-detail-item" style="grid-column: 1 / -1;"><div class="modal-detail-label">A√ßƒ±klama</div><div class="modal-detail-value long-text">${record.description || '-'}</div></div>
                        </div>
                        ${imageHtml}
                        <h4 class="modal-detail-section-title">Ekli Belgeler</h4>
                        <div class="modal-detail-item" style="grid-column: 1 / -1;">${documentsHtml}</div>
                        <h4 class="modal-detail-section-title">ƒ∞≈ülem Ge√ßmi≈üi</h4>
                        <div class="modal-detail-item" style="grid-column: 1 / -1;">${transactionsHtml}</div>
                    `;
                    
                    modalBody.querySelectorAll('.accordion-header.has-children').forEach(acc => {
                        acc.addEventListener('click', function() {
                            this.classList.toggle('active');
                            const content = this.nextElementSibling;
                            content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
                        });
                    });
                } catch (error) {
                    showNotification('Kayƒ±t detaylarƒ± y√ºklenirken hata olu≈ütu: ' + error.message, 'error');
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
            }
        }
        
        async function loadTransactionTypes() {
            const result = await transactionTypeService.getTransactionTypes();
            if (result.success) result.data.forEach(type => transactionTypesMap.set(type.id, type));
        }

        async function loadPersons() {
            const result = await personService.getPersons();
            if (result.success) allPersons = result.data;
        }
        function viewRecordDetail(id) {
            const record = allRecords.find(r => r.id === id);
            if (!record) return alert('Kayƒ±t bulunamadƒ±');

            const html = `
                <table class="table table-bordered table-sm">
                <tbody>
                    <tr><th>IP T√ºr√º</th><td>${record.ipType || '-'}</td></tr>
                    <tr><th>Marka Adƒ±</th><td>${record.brandName || '-'}</td></tr>
                    <tr><th>Sahip</th><td>${record.ownerName || '-'}</td></tr>
                    <tr><th>Ba≈üvuru No</th><td>${record.applicationNo || '-'}</td></tr>
                    <tr><th>Ba≈üvuru Tarihi</th><td>${record.applicationDate || '-'}</td></tr>
                    <tr><th>Nice Sƒ±nƒ±flarƒ±</th><td>${(record.niceClasses || []).join(', ') || '-'}</td></tr>
                    <tr><th>Notlar</th><td>${record.notes || '-'}</td></tr>
                </tbody>
                </table>
            `;
            document.getElementById('portfolioDetailModalBody').innerHTML = html;
            $('#portfolioDetailModal').modal('show');
            }
            function editRecord(id) {
            const record = allRecords.find(r => r.id === id);
            if (!record) return alert('Kayƒ±t bulunamadƒ±');
            window.open(`data-entry.html?id=${id}`, '_blank');
            }

    </script>
</body>
</html>