<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tahakkuk Y√∂netimi - IP Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .sidebar { width: 250px; background: #1e3c72; color: white; position: fixed; left: 0; top: 0; height: 100%; overflow-y: auto; z-index: 1000; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #2a4f8b; }
        .sidebar-logo { color: white; text-decoration: none; font-size: 1.3em; font-weight: bold; }
        .sidebar-nav { padding: 15px 0; }
        .sidebar-nav-item { display: flex; align-items: center; padding: 12px 20px; color: #b3c6ff; text-decoration: none; transition: all 0.3s; }
        .sidebar-nav-item:hover, .sidebar-nav-item.active { background: #2a4f8b; color: white; }
        .nav-icon { margin-right: 10px; font-size: 1.1em; }
        .nav-category-title { padding: 15px 20px 8px; font-size: 0.9em; color: #7a92d1; font-weight: 600; text-transform: uppercase; }
        .dropdown-nav { position: relative; }
        .dropdown-toggle { cursor: pointer; justify-content: space-between; }
        .dropdown-content { display: none; background: #2a4f8b; }
        .dropdown-content a { padding-left: 50px; font-size: 0.9em; }
        .dropdown-nav.open .dropdown-content { display: block; }
        .page-wrapper { margin-left: 250px; min-height: 100vh; }
        .top-header { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-info { }
        .user-name { font-weight: 600; color: #333; }
        .user-role { font-size: 0.85em; color: #666; }
        .logout-btn { background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .main-container { padding: 30px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .page-title { color: white; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .page-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1em; }
        .accruals-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .accruals-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f4; padding-bottom: 15px; }
        .filter-group { display: flex; align-items: center; gap: 15px; }
        .filter-label { font-weight: 600; color: #1e3c72; }
        .filter-select { padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 10px; background: white; font-weight: 500; }
        .filter-select:focus { outline: none; border-color: #667eea; }
        .action-btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.3s; }
        .action-btn { background: #28a745; color: white; }
        .action-btn:hover { transform: translateY(-1px); opacity: 0.9; }
        .action-btn.unpaid { background: #dc3545; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .accruals-table { width: 100%; border-collapse: collapse; }
        .accruals-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 18px 15px; text-align: left; font-weight: 600; font-size: 0.95em; }
        .accruals-table td { padding: 15px; border-bottom: 1px solid #f1f3f4; }
        .accruals-table tr:hover { background: #f8f9fa; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .status-paid { background: #28a745; color: white; }
        .status-unpaid { background: #dc3545; color: white; }
        .task-detail-link { color: #667eea; text-decoration: none; font-weight: 600; }
        .task-detail-link:hover { text-decoration: underline; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1003; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content, .modal-content-lg { background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content-lg { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px 15px; border-bottom: 2px solid #f1f3f4; }
        .modal-title { font-size: 1.4em; color: #1e3c72; font-weight: 700; }
        .close-modal-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #666; }
        .modal-body-content { padding: 25px 30px; }
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .modal-detail-item { }
        .modal-detail-item.full-width { grid-column: 1 / -1; }
        .modal-detail-label { font-weight: 600; color: #1e3c72; margin-bottom: 5px; }
        .modal-detail-value { color: #333; }
        .modal-detail-value.long-text { background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
        .task-history { }
        .task-history-item { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea; }
        .task-history-description { font-weight: 600; color: #333; margin-bottom: 5px; }
        .task-history-meta { font-size: 0.9em; color: #666; }
        .related-accrual-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9em; border-left: 3px solid #1e3c72; }
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; text-align: center; }
        .no-records-message { text-align: center; padding: 50px; color: #666; font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="loadingIndicator">
        <div style="font-size: 1.2em; color: #1e3c72; margin-bottom: 15px;">üí∞ Tahakkuklar Y√ºkleniyor...</div>
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">üî• IP Manager</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-category-title">Ana Sayfa</div>
            <a href="dashboard.html" class="sidebar-nav-item"><span class="nav-icon">üè†</span><span>Dashboard</span></a>
            <div class="nav-category-title">Portf√∂y Y√∂netimi</div>
            <a href="portfolio.html" class="sidebar-nav-item"><span class="nav-icon">üíº</span><span>Portf√∂y</span></a>
            <a href="data-entry.html" class="sidebar-nav-item"><span class="nav-icon">üìù</span><span>Yeni Kayƒ±t</span></a>
            <div class="nav-category-title">ƒ∞≈ü Y√∂netimi</div>
            <a href="task-management.html" class="sidebar-nav-item"><span class="nav-icon">üìã</span><span>ƒ∞≈ü Y√∂netimi</span></a>
            <a href="my-tasks.html" class="sidebar-nav-item"><span class="nav-icon">‚úÖ</span><span>Bana Atanan ƒ∞≈üler</span></a>
            <a href="create-task.html" class="sidebar-nav-item"><span class="nav-icon">‚ûï</span><span>Yeni ƒ∞≈ü Olu≈ütur</span></a>
            <div class="nav-category-title">Ki≈üiler</div>
            <div class="dropdown-nav" id="personsDropdown">
                <a href="#" class="sidebar-nav-item dropdown-toggle">
                    <div><span class="nav-icon">üë•</span><span>Ki≈üiler</span></div>
                    <span>‚ñº</span>
                </a>
                <div class="dropdown-content">
                    <a href="persons.html">Ki≈üiler Y√∂netimi</a>
                    <a href="user-management.html">Kullanƒ±cƒ± Y√∂netimi</a>
                </div>
            </div>
            <div class="nav-category-title">Finans</div>
            <a href="accruals.html" class="sidebar-nav-item active"><span class="nav-icon">üí∞</span><span>Tahakkuklarƒ±m</span></a>
            <div class="nav-category-title">Ara√ßlar</div>
            <a href="indexing.html" class="sidebar-nav-item"><span class="nav-icon">üìÅ</span><span>Belge ƒ∞ndeksleme</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">üìà</span><span>Raporlar</span></a>
            <a href="#" class="sidebar-nav-item" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">üîß</span><span>Ayarlar</span></a>
        </nav>
    </aside>

    <div class="page-wrapper">
        <header class="top-header">
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="user-name" id="userName">Y√ºkleniyor...</div>
                    <div class="user-role" id="userRole">Kullanƒ±cƒ±</div>
                </div>
                <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
            </div>
        </header>

        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Tahakkuk Y√∂netimi</h1>
                <p class="page-subtitle">T√ºm finansal tahakkuklarƒ± ve √∂deme durumlarƒ±nƒ± buradan takip edin.</p>
            </section>
    
            <div class="accruals-container">
                <div class="accruals-header">
                    <div class="filter-group">
                        <label class="filter-label" for="statusFilter">Duruma G√∂re Filtrele:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">T√ºm√º</option>
                            <option value="unpaid">√ñdenmedi</option>
                            <option value="paid">√ñdendi</option>
                        </select>
                    </div>
                    <div class="filter-group" id="bulkActions" style="display: none;">
                        <button id="bulkMarkPaidBtn" class="action-btn">Se√ßilenleri √ñdendi ƒ∞≈üaretle</button>
                        <button id="bulkMarkUnpaidBtn" class="action-btn unpaid">Se√ßilenleri √ñdenmedi ƒ∞≈üaretle</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="accruals-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Tahakkuk ID</th>
                                <th>Durum</th>
                                <th>ƒ∞lgili ƒ∞≈ü</th>
                                <th>Resmi √úcret</th>
                                <th>Hizmet Bedeli</th>
                                <th>Toplam Tutar</th>
                                <th>ƒ∞≈ülemler</th>
                            </tr>
                        </thead>
                        <tbody id="accrualsTableBody">
                        </tbody>
                    </table>
                </div>

                <div id="noRecordsMessage" class="no-records-message" style="display: none;">
                    üí∞ Hen√ºz tahakkuk bulunmuyor.
                </div>
            </div>
        </main>
    </div>

    <!-- ƒ∞≈ü Detaylarƒ± Modal -->
    <div class="modal" id="taskDetailModal">
        <div class="modal-content-lg">
            <div class="modal-header">
                <h3 class="modal-title" id="taskDetailModalTitle">ƒ∞≈ü Detayƒ±</h3>
                <button class="close-modal-btn" id="closeTaskDetailModal">&times;</button>
            </div>
            <div class="modal-body-content" id="taskDetailModalBody">
                <!-- ƒ∞√ßerik buraya dinamik olarak eklenecek -->
            </div>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/services/accrualService.js"></script>
    <script src="js/services/taskService.js"></script>
    <script src="js/services/ipRecordsService.js"></script>
    <script src="js/services/personsService.js"></script>
    <script>
        class AccrualsModule {
            constructor() {
                this.allAccruals = [];
                this.allTasks = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.selectedAccruals = new Set();
            }

            // Para birimi kodunu standart hale getiren fonksiyon
            normalizeCurrencyCode(currency) {
                const currencyMap = {
                    'TL': 'TRY',
                    'tl': 'TRY',
                    'try': 'TRY'
                };
                return currencyMap[currency] || currency;
            }

            // G√ºvenli para birimi formatƒ± fonksiyonu
            formatCurrencyAmount(amount, currency) {
                try {
                    const normalizedCurrency = this.normalizeCurrencyCode(currency || 'TL');
                    return new Intl.NumberFormat('tr-TR', { 
                        style: 'currency', 
                        currency: normalizedCurrency 
                    }).format(amount || 0);
                } catch (error) {
                    console.warn('Currency formatting error:', error);
                    // Fallback: Sadece sayƒ± + para birimi simgesi
                    return `${(amount || 0).toFixed(2)} ${currency || 'TL'}`;
                }
            }

            async init() {
                await this.loadInitialData();
                this.setupEventListeners();
                this.setupDropdowns();
            }

            setupDropdowns() {
                const dropdown = document.getElementById('personsDropdown');
                if (dropdown) {
                    dropdown.addEventListener('click', (e) => {
                        e.preventDefault();
                        dropdown.classList.toggle('open');
                    });
                }
            }

            setupEventListeners() {
                // Filtre
                document.getElementById('statusFilter').addEventListener('change', (e) => {
                    this.renderTable(e.target.value);
                });

                // Se√ßim
                document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                    this.toggleSelectAll(e.target.checked);
                });

                // Toplu i≈ülemler
                document.getElementById('bulkMarkPaidBtn').addEventListener('click', () => {
                    this.bulkUpdateStatus('paid');
                });
                document.getElementById('bulkMarkUnpaidBtn').addEventListener('click', () => {
                    this.bulkUpdateStatus('unpaid');
                });

                // Modal kapatma
                document.getElementById('closeTaskDetailModal').addEventListener('click', () => {
                    this.closeModal('taskDetailModal');
                });

                // Logout
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    authService.signOut();
                    window.location.href = 'index.html';
                });

                // Event delegation for dynamic content
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('action-btn')) {
                        const accrualId = e.target.dataset.id;
                        const status = e.target.dataset.status;
                        this.markAs(accrualId, status);
                    }
                    
                    if (e.target.classList.contains('task-detail-link')) {
                        e.preventDefault();
                        const taskId = e.target.dataset.taskId;
                        this.showTaskDetail(taskId);
                    }
                    
                    if (e.target.classList.contains('row-checkbox')) {
                        const accrualId = e.target.dataset.id;
                        this.toggleAccrualSelection(accrualId, e.target.checked);
                    }
                });
            }

            async loadInitialData() {
                try {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    const currentUser = authService.getCurrentUser();
                    if (currentUser) {
                        document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                        document.getElementById('userAvatar').textContent = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                    }

                    const [accrualsResult, tasksResult, ipRecordsResult, personsResult] = await Promise.all([
                        accrualService.getAllAccruals(),
                        taskService.getAllTasks(),
                        ipRecordsService.getAllRecords(),
                        personsService.getAllPersons()
                    ]);

                    this.allAccruals = accrualsResult.success ? accrualsResult.data : [];
                    this.allTasks = tasksResult.success ? tasksResult.data : [];
                    this.allIpRecords = ipRecordsResult.success ? ipRecordsResult.data : [];
                    this.allPersons = personsResult.success ? personsResult.data : [];
                    
                    this.renderTable();

                } catch (error) {
                    alert('Veriler y√ºklenirken bir hata olu≈ütu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            renderTable(filter = 'all') {
                const tableBody = document.getElementById('accrualsTableBody');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                tableBody.innerHTML = '';

                const filteredAccruals = this.allAccruals.filter(acc => filter === 'all' || acc.status === filter);

                if (filteredAccruals.length === 0) {
                    noRecordsMessage.style.display = 'block';
                    return;
                }
                noRecordsMessage.style.display = 'none';

                const formatFee = (feeData) => {
                    if (typeof feeData === 'object' && feeData !== null && feeData.currency) {
                        return { amount: feeData.amount || 0, currency: feeData.currency };
                    }
                    if (typeof feeData === 'number') {
                        return { amount: feeData, currency: 'TRY' };
                    }
                    return { amount: 0, currency: 'TRY' };
                };

                filteredAccruals.forEach(accrual => {
                    const row = document.createElement('tr');
                    const statusText = accrual.status === 'paid' ? '√ñdendi' : '√ñdenmedi';
                    const statusClass = accrual.status === 'paid' ? 'status-paid' : 'status-unpaid';
                    
                    const officialFee = formatFee(accrual.officialFee);
                    const serviceFee = formatFee(accrual.serviceFee);
                    const isSelected = this.selectedAccruals.has(accrual.id);

                    row.innerHTML = `
                        <td><input type="checkbox" class="row-checkbox" data-id="${accrual.id}" ${isSelected ? 'checked' : ''}></td>
                        <td><small>${accrual.id.substring(0, 8)}...</small></td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td><a href="#" class="task-detail-link" data-task-id="${accrual.taskId}">${accrual.taskTitle || 'ƒ∞≈ü Detayƒ±'}</a></td>
                        <td>${this.formatCurrencyAmount(officialFee.amount, officialFee.currency)}</td>
                        <td>${this.formatCurrencyAmount(serviceFee.amount, serviceFee.currency)}</td>
                        <td>${this.formatCurrencyAmount(accrual.totalAmount || 0, accrual.totalAmountCurrency)}</td>
                        <td>
                            <button class="action-btn" data-id="${accrual.id}" data-status="paid" ${accrual.status === 'paid' ? 'disabled' : ''}>√ñdendi</button>
                            <button class="action-btn unpaid" data-id="${accrual.id}" data-status="unpaid" ${accrual.status === 'unpaid' ? 'disabled' : ''}>√ñdenmedi</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            toggleAccrualSelection(accrualId, checked) {
                if (checked) {
                    this.selectedAccruals.add(accrualId);
                } else {
                    this.selectedAccruals.delete(accrualId);
                }
                this.updateBulkActions();
            }

            toggleSelectAll(checked) {
                const checkboxes = document.querySelectorAll('.row-checkbox');
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    this.toggleAccrualSelection(cb.dataset.id, checked);
                });
            }

            updateBulkActions() {
                const bulkActions = document.getElementById('bulkActions');
                if (this.selectedAccruals.size > 0) {
                    bulkActions.style.display = 'flex';
                } else {
                    bulkActions.style.display = 'none';
                }
            }

            async markAs(accrualId, newStatus) {
                const statusText = newStatus === 'paid' ? '√ñdendi' : '√ñdenmedi';
                if (confirm(`Bu tahakkuku "${statusText}" olarak i≈üaretlemek istediƒüinizden emin misiniz?`)) {
                    try {
                        const result = await accrualService.updateAccrual(accrualId, { status: newStatus });
                        if (result.success) {
                            alert('Tahakkuk durumu ba≈üarƒ±yla g√ºncellendi.');
                            await this.loadInitialData();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        console.error('Tahakkuk g√ºncelleme hatasƒ±:', error);
                        alert('Tahakkuk g√ºncellenirken bir hata olu≈ütu: ' + error.message);
                    }
                }
            }

            async bulkUpdateStatus(newStatus) {
                if (this.selectedAccruals.size === 0) {
                    alert('L√ºtfen √∂nce tahakkuk se√ßin.');
                    return;
                }

                const statusText = newStatus === 'paid' ? '√ñdendi' : '√ñdenmedi';
                if (confirm(`${this.selectedAccruals.size} tahakkuku "${statusText}" olarak i≈üaretlemek istediƒüinizden emin misiniz?`)) {
                    try {
                        const promises = Array.from(this.selectedAccruals).map(accrualId => 
                            accrualService.updateAccrual(accrualId, { status: newStatus })
                        );

                        await Promise.all(promises);
                        alert(`${this.selectedAccruals.size} tahakkuk ba≈üarƒ±yla g√ºncellendi.`);
                        
                        this.selectedAccruals.clear();
                        await this.loadInitialData();
                    } catch (error) {
                        console.error('Toplu g√ºncelleme hatasƒ±:', error);
                        alert('Tahakkuklar g√ºncellenirken bir hata olu≈ütu: ' + error.message);
                    }
                }
            }

            showTaskDetail(taskId) {
                const task = this.allTasks.find(t => t.id === taskId);
                if (!task) {
                    alert('ƒ∞≈ü detayƒ± bulunamadƒ±.');
                    return;
                }

                const modal = document.getElementById('taskDetailModal');
                const modalTitle = document.getElementById('taskDetailModalTitle');
                const modalBody = document.getElementById('taskDetailModalBody');

                modalTitle.textContent = `ƒ∞≈ü Detayƒ±: ${task.title}`;

                // ƒ∞lgili IP kaydƒ±nƒ± bul
                const ipRecord = this.allIpRecords.find(r => r.id === task.relatedIpRecordId);
                
                // ƒ∞lgili ki≈üiyi bul
                const relatedParty = this.allPersons.find(p => p.id === task.relatedPartyId);
                
                // ƒ∞≈ü t√ºr√º formatla
                const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                const mainType = taskTypeParts[0] || '';
                const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());

                // ƒ∞lgili tahakkuklarƒ± bul
                const relatedAccruals = this.allAccruals.filter(acc => acc.taskId === taskId);

                const renderField = (label, value) => 
                    value ? `<div class="modal-detail-item"><div class="modal-detail-label">${label}</div><div class="modal-detail-value">${value}</div></div>` : '';

                let accrualsHtml = '';
                if(relatedAccruals.length > 0) {
                    accrualsHtml = relatedAccruals.map(acc => {
                        const statusText = acc.status === 'paid' ? '√ñdendi' : '√ñdenmedi';
                        // D√úZELTƒ∞LMƒ∞≈û: formatCurrencyAmount kullanƒ±lƒ±yor
                        const totalAmountText = this.formatCurrencyAmount(acc.totalAmount, acc.totalAmountCurrency);
                        
                        return `<div class="related-accrual-item">
                            <b>ID:</b> ${acc.id.substring(0,8)}... | <b>Durum:</b> ${statusText} | <b>Tutar:</b> ${totalAmountText}
                        </div>`
                    }).join('');
                } else {
                    accrualsHtml = '<p>Bu i≈üe ait tahakkuk bulunmuyor.</p>';
                }

                let historyHtml = '<p>ƒ∞≈ülem ge√ßmi≈üi bulunmuyor.</p>';
                if(task.history && task.history.length > 0) {
                    historyHtml = [...task.history].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)).map(entry => 
                        `<div class="task-history-item">
                            <div class="task-history-description">${entry.action}</div>
                            <div class="task-history-meta">${new Date(entry.timestamp).toLocaleString('tr-TR')} by ${entry.userEmail}</div>
                        </div>`
                    ).join('');
                }

                modalBody.innerHTML = `
                    <div class="modal-detail-grid">
                        ${renderField('ƒ∞≈ü Ba≈ülƒ±ƒüƒ±', task.title)}
                        ${renderField('Atanan Ki≈üi', task.assignedTo_email)}
                        ${renderField('ƒ∞≈ü T√ºr√º', `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}`)}
                        ${renderField('Biti≈ü Tarihi', task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-')}
                        ${renderField('√ñncelik', task.priority)}
                        ${renderField('ƒ∞lgili Portf√∂y Kaydƒ±', ipRecord ? ipRecord.title : 'Bulunamadƒ±')}
                        ${renderField('ƒ∞lgili Taraf', relatedParty ? relatedParty.name : '')}
                        ${renderField('A√ßƒ±klama', task.description)}
                        
                        <div class="modal-detail-item full-width">
                            <div class="modal-detail-label">ƒ∞li≈ükili Tahakkuklar</div>
                            <div class="modal-detail-value">${accrualsHtml}</div>
                        </div>
                        
                        <div class="modal-detail-item full-width">
                            <div class="modal-detail-label">ƒ∞≈ülem Ge√ßmi≈üi</div>
                            <div class="modal-detail-value">${historyHtml}</div>
                        </div>
                    </div>
                `;

                modal.classList.add('show');
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
            }
        }

        // Global instance
        const accrualsModule = new AccrualsModule();

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user || authService.getCurrentUser()) {
                accrualsModule.init();
                window.accrualsModule = accrualsModule;
            } else {
                window.location.href = 'index.html';
            }
        });

        // Modal click outside to close
        window.addEventListener('click', (event) => {
            const modal = document.getElementById('taskDetailModal');
            if (event.target === modal) {
                accrualsModule.closeModal('taskDetailModal');
            }
        });
    </script>
</body>
</html>