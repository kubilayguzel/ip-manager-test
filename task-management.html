<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - İş Yönetimi</title>
    <style>
        /* Bu sayfaya özel stiller */
        /* Genel body, page-wrapper, main-container stilleri shared-styles.css'ten gelecektir. */
        /* Sadece bu sayfaya özgü ve çakışmayan stilleri burada tutun */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; display: flex; }
        .page-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .main-container { width: 100%; padding: 30px; margin: 0; }
        
        /* Task Management specific styles */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }

        .tasks-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tasks-header {
            padding: 20px 30px;
            border-bottom: 1px solid #e1e8ed;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-label {
            font-weight: 500;
        }

        .filter-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .search-input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            flex-grow: 1;
            min-width: 150px;
        }

        .btn-add-task {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-add-task:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.2);
        }

        .tasks-table {
            width: 100%;
            border-collapse: collapse;
        }

        .tasks-table th,
        .tasks-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
        }

        .tasks-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            color: white;
            text-align: center;
        }

        .status-open { background-color: #007bff; }
        .status-in-progress { background-color: #ffc107; color: #333;}
        .status-pending { background-color: #6c757d; }
        .status-completed { background-color: #28a745; }
        .status-cancelled { background-color: #dc3545; }
        .status-on-hold { background-color: #17a2b8; }
        .status-awaiting-approval { background-color: #6f42c1; }
        /* Yeni tetiklenen görev durumları */
        .status-awaiting_client_approval { background-color: #6f42c1; color: white; } /* Müvekkil Onayı Bekliyor - Mor */
        .status-client_approval_opened { background-color: #28a745; color: white; } /* Müvekkil Onayı - Açıldı - Yeşil */
        .status-client_approval_closed { background-color: #6c757d; color: white; } /* Müvekkil Onayı - Kapatıldı - Gri */
        .status-client_no_response_closed { background-color: #fd7e14; color: white; } /* Müvekkil Cevaplamadı - Kapatıldı - Turuncu */


        .priority-badge {
            padding: 4px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 500;
        }
        .priority-high { background-color: #ffe0e6; color: #dc3545; }
        .priority-medium { background-color: #fff3cd; color: #ffc107; }
        .priority-low { background-color: #e6ffed; color: #28a745; }

        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 5px;
            transition: all 0.3s ease;
        }

        .action-btn:hover {
            opacity: 0.9;
        }
        .action-btn.edit-btn { background-color: #ffc107; color: #212529; }
        .action-btn.edit-btn:hover { background-color: #e0a800; }
        .action-btn.delete-btn { background-color: #dc3545; }
        .action-btn.delete-btn:hover { background-color: #c82333; }
        .action-btn.add-accrual-btn { background-color: #008080; } /* Yeni buton rengi */
        .action-btn.add-accrual-btn:hover { background-color: #006666; }


        .loading { text-align: center; padding: 50px; }
        .no-records { text-align: center; padding: 50px; color: #666; }

        /* Modal Styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1002; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.6); /* Black w/ opacity */
            align-items: center; /* Center horizontally */
            justify-content: center; /* Vertically center */
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border: 1px solid #888;
            width: 90%; /* Could be more specific */
            max-width: 1200px; /* Max width */
            border-radius: 20px;
            animation-name: animatetop;
            animation-duration: 0.4s;
            max-height: 90vh; /* Allow scrolling within modal if content is long */
            overflow-y: auto;
        }
        /* İşi Başkasına Ata modalı için özel stil */
        #assignTaskModal .modal-content .form-actions {
            display: flex;
            justify-content: flex-end; /* Butonları sağa hizalar */
            gap: 15px; /* Butonlar arasında boşluk bırakır */
            margin-top: 30px; /* Üstten boşluk bırakır */
            padding-top: 15px; /* İsteğe bağlı: Üstten iç boşluk */
            border-top: 1px solid #e1e8ed; /* İsteğe bağlı: Üste çizgi */
            /* !important kullanmak genellikle kaçınılması gereken bir yöntemdir, ancak bu durumda
            medya sorgusundaki 100% genişliğini geçersiz kılmak için gerekli olabilir.
            Daha iyi bir yaklaşım, mobil medya sorgusunun içinde bu kuralı belirlemektir.
            Ancak, hızlı çözüm için şimdilik bu şekilde devam edelim. */
            flex-direction: row; /* Mobil modda bile yan yana kalmalarını sağlar */
            flex-wrap: nowrap; /* Yeni satıra geçmelerini engeller */
        }

        #assignTaskModal .modal-content .form-actions .btn {
            width: auto; /* Butonların otomatik genişlik almasını sağlar */
            margin-bottom: 0; /* Alt boşluğu kaldırır */
            flex-shrink: 0; /* Butonların küçülmesini engeller */
        }

        #assignTaskModal .modal-content .form-actions .btn-primary,
        #assignTaskModal .modal-content .form-actions .btn-secondary {
            min-width: unset; /* Minimum genişliği kaldır, içeriğe göre ayarlansın */
        }

        @keyframes animatetop {
            from {top: -300px; opacity: 0}
            to {top: 0; opacity: 1}
        }

        .close-modal-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-title {
            font-size: 1.5em;
            color: #1e3c72;
            margin-bottom: 20px;
        }

        .modal-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px 25px;
        }

        .modal-detail-item {
            margin-bottom: 10px;
        }

        .modal-detail-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .modal-detail-value {
            color: #555;
            word-break: break-word; /* Ensure long texts wrap */
            font-size: 0.95em;
        }

        .modal-detail-value.long-text {
            white-space: pre-wrap; /* Preserve whitespace and line breaks */
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
        }
        
        .modal-detail-section-title {
            grid-column: 1 / -1; /* Span full width */
            font-size: 1.1em;
            color: #1e3c72;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e1e8ed;
        }

        .task-history {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e1e8ed;
            max-height: none;
            overflow-y: visible;
            width: 100%;
        }

        .task-history-item {
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        .task-history-item:last-child {
            border-bottom: none;
        }

        .task-history-description {
            font-size: 0.9em;
            color: #333;
            font-weight: 600;
        }
        .task-history-meta {
            font-size: 0.8em;
            color: #666;
            margin-top: 4px;
        }

        /* Yeni Tahakkuk Modalı Stilleri (accruals.html'den kopyalandı ve adapte edildi) */
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .form-group { margin-bottom: 15px; } 
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; } 
        .input-with-currency { display: flex; gap: 10px; }
        .input-with-currency .form-input { flex-grow: 1; }
        .currency-select {
            padding: 12px 8px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-weight: 500;
        }
        .checkbox-label input {
            width: 18px;
            height: 18px;
        }
        .total-amount-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #1e3c72;
            text-align: right;
            margin-top: 10px;
            padding: 12px 15px;
            background-color: #f0f4f8;
            border-radius: 10px;
        }
        .search-results-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background-color: #f0f4f8; }
        .no-results-message { text-align: center; color: #999; padding: 15px; }
        .search-result-display { background: #e9f5ff; border: 1px solid #bde0fe; padding: 10px; border-radius: 8px; margin-top: 10px; }

    </style>
</head>
<body>
    <div id="layout-placeholder"></div>
    <div id="notification-container" style="
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000; /* Diğer her şeyin üstünde olmasını sağlar */
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-end;"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">İş Yönetimi</h1>
                <p class="page-subtitle">Sistemdeki tüm görevleri görüntüleyin ve yönetin.</p>
            </section>
    
            <div class="tasks-container">
                <div class="tasks-header">
                    <input type="text" id="taskSearchInput" class="search-input" placeholder="Başlık, numara, tip ara...">
                    <button class="btn-add-task" onclick="window.location.href='create-task.html'">
                        <span>&#x2795;</span> Yeni İş Oluştur
                    </button>
                </div>
                <div class="table-container">
                    <table class="tasks-table">
                        <thead>
                            <tr id="tasksTableHeaderRow"> <th>İş No.</th>
                                <th>İlgili Kayıt</th>
                                <th>Tip</th>
                                <th>Öncelik</th>
                                <th>Atanan</th>
                                <th>Operasyonel Son Tarih</th>
                                <th>Resmi Son Tarih</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                            <tr id="tasksTableFilterRow"> </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                            </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                <div id="noTasksMessage" class="no-records">Henüz kayıtlı görev bulunmamaktadır.</div>
            </div>
        </main>
    </div>

    <div id="taskDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeTaskDetailModal">&times;</span>
            <h3 class="modal-title" id="modalTaskTitle">İş Detayı</h3>
            <div id="modalBody" class="modal-body-content">
                </div>
        </div>
    </div>
    
    <div id="assignTaskModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeAssignTaskModal">&times;</span>
            <h3 class="modal-title">İşi Başkasına Ata</h3>
            <div class="modal-body-content">
                <p>İşi atamak istediğiniz yeni kullanıcıyı seçin:</p>
                <div class="form-group" style="margin-top: 20px;">
                    <label for="newAssignedTo" class="form-label">Yeni Atanacak Kullanıcı</label>
                    <select id="newAssignedTo" class="form-select">
                        <option value="">Seçiniz...</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="saveNewAssignmentBtn">Atamayı Kaydet</button>
                    <button type="button" class="btn btn-secondary" id="cancelAssignmentBtn">İptal</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="createTaskAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeCreateTaskAccrualModal">&times;</span>
            <h3 class="modal-title">Ek Tahakkuk Oluştur</h3>
            <form id="createTaskAccrualForm" onsubmit="return false;">
                <div class="modal-body-content">
                    <div class="form-group">
                        <label for="createTaskAccrualTaskTitleDisplay" class="form-label">İlgili İş</label>
                        <input type="text" id="createTaskAccrualTaskTitleDisplay" class="form-input" readonly>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="createTaskOfficialFee" class="form-label">Resmi Ücret</label>
                            <div class="input-with-currency">
                                <input type="number" id="createTaskOfficialFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="createTaskOfficialFeeCurrency" class="currency-select">
                                    <option value="TRY">TL</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="createTaskServiceFee" class="form-label">Hizmet Bedeli</label>
                            <div class="input-with-currency">
                                <input type="number" id="createTaskServiceFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="createTaskServiceFeeCurrency" class="currency-select">
                                    <option value="TRY">TL</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="createTaskVatRate" class="form-label">KDV Oranı (%)</label>
                        <input type="number" id="createTaskVatRate" class="form-input" value="20">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="createTaskApplyVatToOfficialFee" checked>
                            Resmi Ücrete KDV Uygula
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Toplam Tutar</label>
                        <div id="createTaskTotalAmountDisplay" class="total-amount-display">0.00 TRY</div>
                    </div>
                    <div class="form-group">
                        <label for="createTaskTpInvoicePartySearch" class="form-label">Türk Patent Faturası Tarafı</label>
                        <input type="text" id="createTaskTpInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="createTaskTpInvoicePartyResults" class="search-results-list"></div>
                        <div id="createTaskSelectedTpInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="createTaskServiceInvoicePartySearch" class="form-label">Hizmet Faturası Tarafı</label>
                        <input type="text" id="createTaskServiceInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="createTaskServiceInvoicePartyResults" class="search-results-list"></div>
                        <div id="createTaskSelectedServiceInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelCreateTaskAccrualBtn">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveNewAccrualBtn">Tahakkuku Oluştur</button>
                </div>
            </form>
        </div>
    </div>
    
<script type="module">
    import { authService, taskService, ipRecordsService, personService, accrualService, auth, generateUUID, documentDesignationTranslations, transactionTypeService } from './firebase-config.js';
    import { showNotification, formatFileSize, readFileAsDataURL, TASK_STATUSES, TURKEY_HOLIDAYS, addMonthsToDate, isWeekend, isHoliday, findNextWorkingDay } from './utils.js';
    import { loadSharedLayout } from './js/layout-loader.js';
    import { TableManager } from './js/table-manager.js';

    class TaskModalManager {
        constructor() {
            this.taskId = null;
            this.currentTask = null;
            this.currentUser = null;
            this.allIpRecords = [];
            this.allPersons = [];
            this.allUsers = [];
            this.allTransactionTypes = [];
            this.currentAccruals = [];
            this.currentTaskDocuments = [];
            this.uploadedAccrualReceipts = [];
            this.selectedRelatedIpRecord = null;
            this.selectedRelatedParty = null;
            this.selectedTpInvoiceParty = null;
            this.selectedServiceInvoiceParty = null;
            this.calculatedOfficialDueDate = null;
            this.calculatedOperationalDueDate = null;
            this.calculatedOfficialDueDateDetails = null;
            this.statusDropdownPopulated = false;
            this.isInitialized = false;
        }

        formatDateToYYYYMMDD(date) {
            if (!date) return null;
            let actualDate = date;
            if (typeof date === 'object' && date.toDate) {
                actualDate = date.toDate();
            } else if (typeof date === 'string') {
                const parts = date.split('-');
                if (parts.length === 3) {
                     actualDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
                     actualDate.setHours(0,0,0,0);
                } else {
                    actualDate = new Date(date);
                }
            }

            if (isNaN(actualDate.getTime())) {
                console.warn('Geçersiz tarih objesi formatDateToYYYYMMDD içinde:', date);
                return null;
            }

            const year = actualDate.getFullYear();
            const month = String(actualDate.getMonth() + 1).padStart(2, '0');
            const day = String(actualDate.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async init() {
            this.currentUser = authService.getCurrentUser();
            if (!this.currentUser) {
                console.log('DEBUG: Kullanıcı oturumu açık değil, index.html adresine yönlendiriliyor.');
                window.location.href = 'index.html';
                return;
            }

            if (!this.isInitialized) {
                await this.loadAllData();
                this.populateAssignedToDropdown();
                this.populateStatusDropdown();
                this.setupGeneralEventListeners();
                this.isInitialized = true;
                console.log('DEBUG: TaskModalManager temel verileri yüklendi ve event listenerlar ayarlandı.');
            }
        }

        async loadAllData() {
            try {
                const [ipRecordsResult, personsResult, usersResult, transactionTypesResult] = await Promise.all([
                    ipRecordsService.getRecords(),
                    personService.getPersons(),
                    taskService.getAllUsers(),
                    transactionTypeService.getTransactionTypes()
                ]);
                this.allIpRecords = ipRecordsResult.data || [];
                this.allPersons = personsResult.data || [];
                this.allUsers = usersResult.data || [];
                this.allTransactionTypes = transactionTypesResult.data || [];
                console.log('DEBUG: Tüm ana veriler yüklendi.');
            } catch (error) {
                console.error("Master veriler yüklenirken hata oluştu:", error);
                showNotification("Gerekli veriler yüklenemedi, lütfen sayfayı yenileyin.", "error");
            }
        }

        async openTaskDetailModal(taskId) {
            this.taskId = taskId;
            console.log('DEBUG: openTaskDetailModal çağrıldı, Task ID:', this.taskId);
            try {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }

                const taskResult = await taskService.getTaskById(this.taskId);
                
                if (!taskResult.success || !taskResult.data) {
                    throw new Error(taskResult.error || 'İş verisi bulunamadı');
                }

                this.currentTask = {
                    ...taskResult.data,
                    history: taskResult.data.history || []
                };
                this.currentTaskDocuments = this.currentTask.documents || [];
                
                await this.loadAccrualsForTask();
                this.fillTaskForm();
                this.renderDocuments();
                this.renderHistory();

                document.getElementById('taskDetailModal').classList.add('show');
                document.body.classList.add('modal-open');
                console.log('DEBUG: Görev detay modalı açıldı ve veriler yüklendi.');

            } catch (error) {
                console.error('Görev detayları yüklenirken hata:', error);
                showNotification('Görev detayları yüklenirken hata oluştu: ' + error.message, 'error');
            } finally {
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
            }
        }

        closeTaskDetailModal() {
            document.getElementById('taskDetailModal').classList.remove('show');
            document.body.classList.remove('modal-open');
            this.resetTaskModalForm();
        }

        resetTaskModalForm() {
            const form = document.getElementById('taskDetailForm');
            if (form) form.reset();
            document.getElementById('selectedIpRecordDisplay').style.display = 'none';
            document.getElementById('relatedIpRecordSearch').value = '';
            document.getElementById('selectedRelatedPartyDisplay').style.display = 'none';
            document.getElementById('relatedPartySearch').value = '';
            document.getElementById('fileListContainer').innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Bu işe ait belge bulunmamaktadır.</p>';
            document.getElementById('historyList').innerHTML = '<p>İşlem geçmişi bulunmamaktadır.</p>';
            this.currentTaskDocuments = [];
            this.currentAccruals = [];
            this.selectedRelatedIpRecord = null;
            this.selectedRelatedParty = null;
            this.calculatedOfficialDueDate = null;
            this.calculatedOperationalDueDate = null;
            this.calculatedOfficialDueDateDetails = null;
        }

        async loadAccrualsForTask() {
            const accrualsResult = await accrualService.getAccrualsByTaskId(this.taskId);
            if (accrualsResult.success) {
                this.currentAccruals = accrualsResult.data;
                console.log('DEBUG: Tahakkuklar yüklendi.');
            } else {
                showNotification('Tahakkuklar yüklenirken hata oluştu: ' + accrualsResult.error, 'error');
                console.error('DEBUG: Tahakkuklar yüklenirken hata:', accrualsResult.error);
                this.currentAccruals = [];
            }
            this.renderAccruals();
        }

        fillTaskForm() {
            const task = this.currentTask;
            const modalBody = document.getElementById('modalBody');
            if (!modalBody) {
                console.error('modalBody elementi bulunamadı!');
                return;
            }

            modalBody.innerHTML = `
                <form id="taskDetailForm" onsubmit="return false;">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="taskTitle" class="form-label">İş Başlığı</label>
                            <input type="text" id="taskTitle" class="form-input" value="${task.title || ''}">
                        </div>
                        <div class="form-group">
                            <label for="taskTypeDisplay" class="form-label">İş Tipi</label>
                            <input type="text" id="taskTypeDisplay" class="form-input" value="${task.taskType ? (task.taskType.split('_')[0].charAt(0).toUpperCase() + task.taskType.split('_')[0].slice(1) + ' - ' + task.taskType.split('_').slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase())) : ''}" readonly>
                        </div>
                        <div class="form-group">
                            <label for="taskPriority" class="form-label">Öncelik</label>
                            <select id="taskPriority" class="form-select">
                                <option value="low" ${task.priority === 'low' ? 'selected' : ''}>Düşük</option>
                                <option value="medium" ${task.priority === 'medium' ? 'selected' : ''}>Orta</option>
                                <option value="high" ${task.priority === 'high' ? 'selected' : ''}>Yüksek</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskStatus" class="form-label">Durum</label>
                            <select id="taskStatus" class="form-select">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="assignedTo" class="form-label">Atanan</label>
                            <select id="assignedTo" class="form-select">
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="deliveryDate" class="form-label">Tebliğ Tarihi</label>
                            <input type="date" id="deliveryDate" class="form-input" value="${this.formatDateToYYYYMMDD(task.deliveryDate) || ''}">
                        </div>
                        <div class="form-group">
                            <label for="taskDueDate" class="form-label">Operasyonel Son Tarih</label>
                            <input type="date" id="taskDueDate" class="form-input" value="${this.formatDateToYYYYMMDD(task.dueDate) || ''}">
                        </div>
                        <div class="form-group">
                            <label for="officialDueDate" class="form-label">Resmi Son Tarih</label>
                            <input type="date" id="officialDueDate" class="form-input" value="${this.formatDateToYYYYMMDD(task.officialDueDate) || ''}" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="taskDescription" class="form-label">Açıklama</label>
                        <textarea id="taskDescription" class="form-textarea">${task.description || ''}</textarea>
                    </div>

                    <div class="form-group">
                        <label for="relatedIpRecordSearch" class="form-label">İlgili Fikri Mülkiyet Varlığı</label>
                        <input type="text" id="relatedIpRecordSearch" class="form-input" placeholder="Varlık arayın...">
                        <div id="relatedIpRecordSearchResults" class="search-results-list"></div>
                        <div id="selectedIpRecordDisplay" class="search-result-display" style="display: ${task.relatedIpRecordId ? 'flex' : 'none'};">
                            <p><b>Seçilen Varlık:</b> ${task.relatedIpRecordTitle || ''}</p>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="relatedPartySearch" class="form-label">İlgili Taraf</label>
                        <input type="text" id="relatedPartySearch" class="form-input" placeholder="Kişi arayın...">
                        <div id="relatedPartySearchResults" class="search-results-list"></div>
                        <div id="selectedRelatedPartyDisplay" class="search-result-display" style="display: ${task.details?.relatedParty?.id ? 'flex' : 'none'};">
                            <p><b>Seçilen Taraf:</b> ${task.details?.relatedParty?.name || ''}</p>
                        </div>
                    </div>

                    <div class="modal-detail-section-title">Tahakkuklar</div>
                    <div id="accrualsContainer"></div>
                    <button type="button" class="btn action-btn add-accrual-btn" id="openCreateTaskAccrualModalBtn">Yeni Tahakkuk Ekle</button>
                    
                    <div class="modal-detail-section-title">Belgeler</div>
                    <div id="fileUploadArea" style="
                        border: 2px dashed #a8dadc;
                        border-radius: 10px;
                        padding: 30px;
                        text-align: center;
                        cursor: pointer;
                        background: #f1faee;
                        transition: all 0.3s ease;
                        margin-bottom: 20px;
                    ">
                        Belgeleri buraya sürükleyip bırakın veya tıklayın
                        <input type="file" id="fileInput" multiple style="display: none;">
                    </div>
                    <div id="fileListContainer" class="document-list"></div>

                    <div class="modal-detail-section-title">İşlem Geçmişi</div>
                    <div id="historyList"></div>

                    <div class="form-actions" style="margin-top: 30px; border-top: 1px solid #e1e8ed; padding-top: 15px; display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary" id="cancelEditBtn">İptal</button>
                        <button type="button" class="btn btn-primary" id="saveTaskChangesBtn">Değişiklikleri Kaydet</button>
                    </div>
                </form>
            `;
            this.populateStatusDropdown();
            document.getElementById('taskStatus').value = task.status || '';
            this.populateAssignedToDropdown();
            document.getElementById('assignedTo').value = task.assignedTo_uid || '';

            this.setupModalEventListeners();
        }

        populateStatusDropdown() {
            if (this.statusDropdownPopulated) return;
            const statusSelect = document.getElementById('taskStatus');
            if (statusSelect) {
                statusSelect.innerHTML = '';
                TASK_STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.value;
                    option.textContent = status.text;
                    statusSelect.appendChild(option);
                });
                this.statusDropdownPopulated = true;
            }
        }

        populateAssignedToDropdown() {
            const assignedToSelect = document.getElementById('assignedTo');
            const newAssignedToSelect = document.getElementById('newAssignedTo');
            [assignedToSelect, newAssignedToSelect].forEach(selectEl => {
                if (selectEl) {
                    selectEl.innerHTML = '<option value="">Seçiniz...</option>';
                    this.allUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = user.displayName || user.email;
                        selectEl.appendChild(option);
                    });
                }
            });
        }

        setupGeneralEventListeners() {
            document.getElementById('closeTaskDetailModal').addEventListener('click', () => this.closeTaskDetailModal());
            document.getElementById('closeAssignTaskModal').addEventListener('click', () => document.getElementById('assignTaskModal').classList.remove('show'));
            document.getElementById('cancelAssignmentBtn').addEventListener('click', () => document.getElementById('assignTaskModal').classList.remove('show'));
            document.getElementById('closeCreateTaskAccrualModal').addEventListener('click', () => this.closeAccrualModal());
            document.getElementById('cancelCreateTaskAccrualBtn').addEventListener('click', () => this.closeAccrualModal());

            document.getElementById('saveNewAssignmentBtn').addEventListener('click', () => this.handleAssignTask());

            document.getElementById('saveNewAccrualBtn').addEventListener('click', (e) => this.handleAccrualSubmit(e, 'createTaskAccrual'));
            
        }

        setupModalEventListeners() {
            console.log('DEBUG: Modal içi event listener\'lar ayarlanıyor...');
            const taskForm = document.getElementById('taskDetailForm');
            if (taskForm) {
                taskForm.removeEventListener('submit', (e) => this.handleTaskUpdate(e));
                taskForm.addEventListener('submit', (e) => this.handleTaskUpdate(e));
            }

            const saveBtn = document.getElementById('saveTaskChangesBtn');
            if (saveBtn) {
                saveBtn.removeEventListener('click', (e) => this.handleTaskUpdate(e));
                saveBtn.addEventListener('click', (e) => this.handleTaskUpdate(e));
            }

            const cancelBtn = document.getElementById('cancelEditBtn');
            if (cancelBtn) {
                cancelBtn.removeEventListener('click', () => this.closeTaskDetailModal());
                cancelBtn.addEventListener('click', () => this.closeTaskDetailModal());
            }

            const ipRecordSearch = document.getElementById('relatedIpRecordSearch');
            if (ipRecordSearch) {
                ipRecordSearch.removeEventListener('input', (e) => this.searchIpRecords(e.target.value));
                ipRecordSearch.addEventListener('input', (e) => this.searchIpRecords(e.target.value));
            }

            const ipRecordResults = document.getElementById('relatedIpRecordSearchResults');
            if (ipRecordResults) {
                ipRecordResults.removeEventListener('click', (e) => {
                    const target = e.target.closest('.search-result-item');
                    if (target) {
                        this.selectIpRecord(this.allIpRecords.find(rec => rec.id === target.dataset.id));
                    }
                });
                ipRecordResults.addEventListener('click', (e) => {
                    const target = e.target.closest('.search-result-item');
                    if (target) {
                        this.selectIpRecord(this.allIpRecords.find(rec => rec.id === target.dataset.id));
                    }
                });
            }

            const relatedPartySearch = document.getElementById('relatedPartySearch');
            if (relatedPartySearch) {
                relatedPartySearch.removeEventListener('input', (e) => this.searchPersons(e.target.value, 'relatedParty'));
                relatedPartySearch.addEventListener('input', (e) => this.searchPersons(e.target.value, 'relatedParty'));
            }

            const openCreateTaskAccrualModalBtn = document.getElementById('openCreateTaskAccrualModalBtn');
            if (openCreateTaskAccrualModalBtn) {
                openCreateTaskAccrualModalBtn.removeEventListener('click', () => this.showAccrualModal('create'));
                openCreateTaskAccrualModalBtn.addEventListener('click', () => this.showAccrualModal('create'));
            }

            const accrualsContainer = document.getElementById('accrualsContainer');
            if (accrualsContainer) {
                accrualsContainer.removeEventListener('click', (e) => this.setupAccrualContainerListeners(e));
                accrualsContainer.addEventListener('click', (e) => this.setupAccrualContainerListeners(e));
            }
            
            const deliveryDateInput = document.getElementById('deliveryDate');
            if (deliveryDateInput) {
                deliveryDateInput.removeEventListener('change', (e) => this.recalculateOfficialAndOperationalDueDates());
                deliveryDateInput.addEventListener('change', (e) => this.recalculateOfficialAndOperationalDueDates());
            }
            
            this.setupDocumentUploadListeners();
            console.log('DEBUG: Modal içi event listener\'lar başarıyla ayarlandı.');
        }

        async handleTaskUpdate(e) {
            e.preventDefault();
            const form = document.getElementById('taskDetailForm');
            const updatedTaskData = {
                title: form.taskTitle.value,
                description: form.taskDescription.value,
                priority: form.taskPriority.value,
                assignedTo_uid: form.assignedTo.value,
                assignedTo_email: this.allUsers.find(u => u.id === form.assignedTo.value)?.email || '',
                deliveryDate: form.deliveryDate.value || null,
                updatedAt: new Date().toISOString()
            };

            if (form.taskStatus.value !== this.currentTask.status) {
                updatedTaskData.status = form.taskStatus.value;
            }

            const currentTaskDeliveryDateFormatted = this.currentTask.deliveryDate ? 
                this.formatDateToYYYYMMDD(this.currentTask.deliveryDate) : null;

            const isDeliveryDateChanged = form.deliveryDate.value !== currentTaskDeliveryDateFormatted;
            const isOfficialDueDatePreviouslyEmpty = !this.currentTask.officialDueDate && form.deliveryDate.value;

            if ((isDeliveryDateChanged || isOfficialDueDatePreviouslyEmpty) && this.calculatedOfficialDueDate) {
                let confirmation = true;
                const existingOfficialDueDateFormatted = this.currentTask.officialDueDate ? 
                    this.formatDateToYYYYMMDD(this.currentTask.officialDueDate) : null;
                const existingDueDateFormatted = this.currentTask.dueDate ? 
                    this.formatDateToYYYYMMDD(this.currentTask.dueDate) : null; 

                if (this.calculatedOfficialDueDateDetails && (existingOfficialDueDateFormatted !== this.calculatedOfficialDueDateDetails.finalOfficialDueDate || 
                    existingDueDateFormatted !== this.calculatedOfficialDueDateDetails.finalOperationalDueDate)) {
                    
                    confirmation = confirm('Tebliğ tarihini değiştirdiniz veya yeni girdiniz. Resmi son tarih ve Operasyonel son tarih yeniden hesaplanacak. Onaylıyor musunuz?\n\n' +
                                           `Yeni Resmi Son Tarih: ${this.calculatedOfficialDueDateDetails.finalOfficialDueDate}\n` +
                                           `Yeni Operasyonel Son Tarih: ${this.calculatedOfficialDueDateDetails.finalOperationalDueDate}`);
                } else if (isOfficialDueDatePreviouslyEmpty) {
                     confirmation = confirm('Tebliğ tarihi girildi. Resmi son tarih ve Operasyonel son tarih hesaplanacak. Onaylıyor musunuz?\n\n' +
                                           `Hesaplanan Resmi Son Tarih: ${this.calculatedOfficialDueDateDetails.finalOfficialDueDate}\n` +
                                           `Hesaplanan Operasyonel Son Tarih: ${this.calculatedOfficialDueDateDetails.finalOperationalDueDate}`);
                }


                if (confirmation) {
                    updatedTaskData.officialDueDate = this.calculatedOfficialDueDate;
                    updatedTaskData.officialDueDateDetails = this.calculatedOfficialDueDateDetails;
                    if (!form.taskDueDate.value || (existingDueDateFormatted !== this.calculatedOfficialDueDateDetails.finalOperationalDueDate && isDeliveryDateChanged)) {
                        updatedTaskData.dueDate = this.formatDateToYYYYMMDD(this.calculatedOperationalDueDate);
                    } else {
                        updatedTaskData.dueDate = form.taskDueDate.value;
                    }
                } else {
                    showNotification('Resmi ve Operasyonel son tarih güncellemeleri iptal edildi.', 'info');
                    if(this.currentTask.officialDueDate) updatedTaskData.officialDueDate = this.currentTask.officialDueDate;
                    if(this.currentTask.officialDueDateDetails) updatedTaskData.officialDueDateDetails = this.currentTask.officialDueDateDetails;
                    if(this.currentTask.dueDate) updatedTaskData.dueDate = this.currentTask.dueDate; 
                    else updatedTaskData.dueDate = null; 
                }
            } else {
                if(this.currentTask.officialDueDate) updatedTaskData.officialDueDate = this.currentTask.officialDueDate;
                if(this.currentTask.officialDueDateDetails) updatedTaskData.officialDueDateDetails = this.currentTask.officialDueDateDetails;
                if(form.taskDueDate.value) updatedTaskData.dueDate = form.taskDueDate.value; 
                else if(this.currentTask.dueDate) updatedTaskData.dueDate = this.currentTask.dueDate; 
                else updatedTaskData.dueDate = null;
            }


            if (this.selectedRelatedIpRecord) {
                updatedTaskData.relatedIpRecordId = this.selectedRelatedIpRecord.id;
                updatedTaskData.relatedIpRecordTitle = this.selectedRelatedIpRecord.title;
            } else {
                updatedTaskData.relatedIpRecordId = null;
                updatedTaskData.relatedIpRecordTitle = null;
            }

            if (this.selectedRelatedParty) {
                updatedTaskData.details = { relatedParty: { id: this.selectedRelatedParty.id, name: this.selectedRelatedParty.name } };
            } else {
                if (updatedTaskData.details) updatedTaskData.details.relatedParty = null;
                else updatedTaskData.details = { relatedParty: null };
            }
            
            try {
                const result = await taskService.updateTask(this.taskId, updatedTaskData);
                if (result.success) {
                    showNotification('İş başarıyla güncellendi!', 'success');
                    await loadTasksIntoTable();
                    this.closeTaskDetailModal();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('İş güncellenirken hata oluştu: ' + error.message, 'error');
            }
        }

        searchIpRecords(query) {
            const searchResultsContainer = document.getElementById('relatedIpRecordSearchResults');
            searchResultsContainer.innerHTML = '';
            if (query.length < 3) { 
                searchResultsContainer.innerHTML = '<p class="no-results-message">Aramak için en az 3 karakter girin.</p>';
                searchResultsContainer.style.display = 'block';
                return; 
            }
            
            const lowerQuery = query.toLowerCase();
            const filtered = this.allIpRecords.filter(record =>
                record.title.toLowerCase().includes(lowerQuery) ||
                (record.applicationNumber && record.applicationNumber.toLowerCase().includes(lowerQuery)) ||
                (record.registrationNumber && record.registrationNumber.toLowerCase().includes(lowerQuery))
            );

            if (filtered.length === 0) {
                searchResultsContainer.innerHTML = '<p class="no-results-message">Kayıt bulunamadı.</p>';
                return;
            }

            filtered.forEach(record => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.dataset.id = record.id;
                item.textContent = `${record.title} (${record.applicationNumber || record.registrationNumber || 'N/A'})`;
                item.addEventListener('click', () => {
                    this.selectIpRecord(record);
                    searchResultsContainer.innerHTML = '';
                    searchResultsContainer.style.display = 'none';
                });
                searchResultsContainer.appendChild(item);
            });
            searchResultsContainer.style.display = 'block';
        }

        selectIpRecord(record) {
            this.selectedRelatedIpRecord = record;
            const display = document.getElementById('selectedIpRecordDisplay');
            display.innerHTML = `<p><b>Seçilen Varlık:</b> ${record.title}</p>`;
            display.style.display = 'flex';
            document.getElementById('relatedIpRecordSearch').value = '';
        }

        searchPersons(query, targetField) {
            const resultsContainerId = {
                'relatedParty': 'relatedPartySearchResults',
                'tpInvoiceParty': 'tpInvoicePartyResults',
                'serviceInvoiceParty': 'serviceInvoicePartyResults'
            }[targetField];
            const inputId = {
                'relatedParty': 'relatedPartySearch',
                'tpInvoiceParty': 'tpInvoicePartySearch',
                'serviceInvoiceParty': 'serviceInvoicePartySearch'
            }[targetField];
            const displayId = {
                'relatedParty': 'selectedRelatedPartyDisplay',
                'tpInvoiceParty': 'selectedTpInvoicePartyDisplay',
                'serviceInvoiceParty': 'selectedServiceInvoicePartyDisplay'
            }[targetField];

            const resultsContainer = document.getElementById(resultsContainerId);
            resultsContainer.innerHTML = '';
            if (query.length < 2) { 
                resultsContainer.innerHTML = '<p class="no-results-message">Aramak için en least 2 karakter girin.</p>';
                resultsContainer.style.display = 'block';
                return; 
            }
            
            const filtered = this.allPersons.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
            if (filtered.length === 0) { resultsContainer.innerHTML = '<p class="no-results-message">Kişi bulunamadı.</p>'; return; }
            resultsContainer.style.display = 'block';

            filtered.forEach(p => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                item.dataset.id = p.id;
                item.innerHTML = `<div><b>${p.name}</b><br><small>${p.email || '-'}</small></div>`;
                item.addEventListener('click', () => {
                    this.selectPerson(p, targetField);
                    resultsContainer.innerHTML = '';
                    resultsContainer.style.display = 'none';
                    document.getElementById(inputId).value = p.name;
                });
                resultsContainer.appendChild(item);
            });
        }

        selectPerson(person, targetField) {
            const displayId = {
                'relatedParty': 'selectedRelatedPartyDisplay',
                'tpInvoiceParty': 'selectedTpInvoicePartyDisplay',
                'serviceInvoiceParty': 'selectedServiceInvoicePartyDisplay'
            }[targetField];
            
            if (targetField === 'relatedParty') this.selectedRelatedParty = person;
            else if (targetField === 'tpInvoiceParty') this.selectedTpInvoiceParty = person;
            else if (targetField === 'serviceInvoiceParty') this.selectedServiceInvoiceParty = person;

            const display = document.getElementById(displayId);
            display.innerHTML = `<p><b>Seçilen:</b> ${person.name}</p>`;
            display.style.display = 'flex';
        }
        
        showAccrualModal(mode, accrualId = null) {
            if (!this.currentTask || !this.allPersons || !this.allIpRecords) {
                showNotification('Veriler henüz yüklenmedi, lütfen bekleyin.', 'warning');
                return;
            }

            console.log('DEBUG: Tahakkuk modalı açılıyor, mode:', mode, 'accrualId:', accrualId);

            const modal = document.getElementById('createTaskAccrualModal');
            const form = document.getElementById('createTaskAccrualForm');
            
            this.resetAccrualModal();

            if (mode === 'edit' && accrualId) {
                const accrual = this.currentAccruals.find(a => a.id === accrualId);
                if (!accrual) {
                    showNotification('Düzenlenecek tahakkuk bulunamadı.', 'error');
                    return;
                }
                
                console.log('DEBUG: Tahakkuk düzenleme modunda, accrual:', accrual.id);
                
                document.querySelector('#createTaskAccrualModal .modal-title').textContent = 'Tahakkuku Düzenle';
                document.getElementById('saveNewAccrualBtn').textContent = 'Değişiklikleri Kaydet';
                
                this.populateAccrualModal(accrual);
            } else {
                document.querySelector('#createTaskAccrualModal .modal-title').textContent = 'Yeni Tahakkuk Ekle';
                document.getElementById('saveNewAccrualBtn').textContent = 'Tahakkuk Ekle';
                document.getElementById('createTaskAccrualTaskTitleDisplay').value = this.currentTask.title;
            }

            modal.classList.add('show');
            document.body.classList.add('modal-open');
            
            const accrualInputs = ['createTaskOfficialFee', 'createTaskServiceFee', 'createTaskVatRate', 'createTaskApplyVatToOfficialFee', 'createTaskOfficialFeeCurrency', 'createTaskServiceFeeCurrency'];
            accrualInputs.forEach(id => {
                const el = document.getElementById(id);
                if (el) { 
                    el.removeEventListener('input', () => this.calculateAccrualTotalAmount());
                    el.removeEventListener('change', () => this.calculateAccrualTotalAmount());
                    el.addEventListener('input', () => this.calculateAccrualTotalAmount());
                    el.addEventListener('change', () => this.calculateAccrualTotalAmount());
                }
            });

            document.getElementById('createTaskTpInvoicePartySearch').removeEventListener('input', (e) => this.searchPersons(e.target.value, 'tpInvoiceParty'));
            document.getElementById('createTaskTpInvoicePartySearch').addEventListener('input', (e) => this.searchPersons(e.target.value, 'tpInvoiceParty'));
            document.getElementById('createTaskServiceInvoicePartySearch').removeEventListener('input', (e) => this.searchPersons(e.target.value, 'serviceInvoiceParty'));
            document.getElementById('createTaskServiceInvoicePartySearch').addEventListener('input', (e) => this.searchPersons(e.target.value, 'serviceInvoiceParty'));

            console.log('DEBUG: Tahakkuk modalı başarıyla açıldı');
        }

        resetAccrualModal() {
            const form = document.getElementById('createTaskAccrualForm');
            if (form) {
                form.reset();
            }
            document.getElementById('createTaskAccrualTaskTitleDisplay').value = '';
            document.getElementById('createTaskTotalAmountDisplay').textContent = '0.00 TRY';
            document.getElementById('createTaskSelectedTpInvoicePartyDisplay').style.display = 'none';
            document.getElementById('createTaskSelectedServiceInvoicePartyDisplay').style.display = 'none';
            document.getElementById('createTaskTpInvoicePartySearch').value = '';
            document.getElementById('createTaskServiceInvoicePartySearch').value = '';
            
            this.uploadedAccrualReceipts = [];
            this.selectedTpInvoiceParty = null;
            this.selectedServiceInvoiceParty = null;
        }

        populateAccrualModal(accrual) {
            document.getElementById('createTaskAccrualTaskTitleDisplay').value = accrual.taskTitle || this.currentTask.title;
            document.getElementById('createTaskOfficialFee').value = accrual.officialFee?.amount || 0;
            document.getElementById('createTaskOfficialFeeCurrency').value = accrual.officialFee?.currency || 'TRY';
            document.getElementById('createTaskServiceFee').value = accrual.serviceFee?.amount || 0;
            document.getElementById('createTaskServiceFeeCurrency').value = accrual.serviceFee?.currency || 'TRY';
            document.getElementById('createTaskVatRate').value = accrual.vatRate || 0;
            document.getElementById('createTaskApplyVatToOfficialFee').checked = accrual.applyVatToOfficialFee !== undefined ? accrual.applyVatToOfficialFee : true;

            this.selectedTpInvoiceParty = accrual.tpInvoiceParty || null;
            this.selectedServiceInvoiceParty = accrual.serviceInvoiceParty || null;
            
            if (this.selectedTpInvoiceParty) {
                document.getElementById('createTaskTpInvoicePartySearch').value = this.selectedTpInvoiceParty.name;
                document.getElementById('createTaskSelectedTpInvoicePartyDisplay').style.display = 'flex';
                document.getElementById('createTaskSelectedTpInvoicePartyDisplay').innerHTML = `<p><b>Seçilen:</b> ${this.selectedTpInvoiceParty.name}</p>`;
            }
            
            if (this.selectedServiceInvoiceParty) {
                document.getElementById('createTaskServiceInvoicePartySearch').value = this.selectedServiceInvoiceParty.name;
                document.getElementById('createTaskSelectedServiceInvoicePartyDisplay').style.display = 'flex';
                document.getElementById('createTaskSelectedServiceInvoicePartyDisplay').innerHTML = `<p><b>Seçilen:</b> ${this.selectedServiceInvoiceParty.name}</p>`;
            }

            this.calculateAccrualTotalAmount();
        }

        calculateAccrualTotalAmount() {
            const officialFee = parseFloat(document.getElementById('createTaskOfficialFee').value) || 0;
            const serviceFee = parseFloat(document.getElementById('createTaskServiceFee').value) || 0;
            const vatRate = parseFloat(document.getElementById('createTaskVatRate').value) || 0;
            const applyVatToOfficial = document.getElementById('createTaskApplyVatToOfficialFee').checked;

            let total;
            if (applyVatToOfficial) {
                total = (officialFee + serviceFee) * (1 + vatRate / 100);
            } else {
                total = officialFee + (serviceFee * (1 + vatRate / 100));
            }

            const display = document.getElementById('createTaskTotalAmountDisplay');
            if (display) {
                display.textContent = new Intl.NumberFormat('tr-TR', { 
                    style: 'currency', 
                    currency: 'TRY' 
                }).format(total);
            }
            return total;
        }

        closeAccrualModal() {
            const modal = document.getElementById('createTaskAccrualModal');
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
            this.resetAccrualModal();
            console.log('DEBUG: Tahakkuk modalı kapatıldı');
        }

        async handleAccrualSubmit(event) {
            event.preventDefault();
            const accrualId = document.getElementById('accrualId')?.value;
            const officialFee = parseFloat(document.getElementById('createTaskOfficialFee').value) || 0;
            const serviceFee = parseFloat(document.getElementById('createTaskServiceFee').value) || 0;

            if (officialFee <= 0 && serviceFee <= 0) {
                showNotification("Lütfen en az bir ücret girin.", 'error');
                return;
            }

            const vatRate = parseFloat(document.getElementById('createTaskVatRate').value) || 0;
            const applyVatToOfficial = document.getElementById('createTaskApplyVatToOfficialFee').checked;
            const totalAmount = this.calculateAccrualTotalAmount();

            const paymentDate = null;

            const accrualData = {
                taskId: this.taskId,
                taskTitle: this.currentTask.title,
                officialFee: {
                    amount: officialFee,
                    currency: document.getElementById('createTaskOfficialFeeCurrency').value
                },
                serviceFee: {
                    amount: serviceFee,
                    currency: document.getElementById('createTaskServiceFeeCurrency').value
                },
                vatRate,
                applyVatToOfficialFee: applyVatToOfficial,
                totalAmount,
                totalAmountCurrency: 'TRY',
                tpInvoiceParty: this.selectedTpInvoiceParty || null,
                serviceInvoiceParty: this.selectedServiceInvoiceParty || null,
                paymentDate: paymentDate || null,
                status: paymentDate ? 'paid' : 'unpaid'
            };
            
            try {
                let result;
                if (accrualId) {
                    result = await accrualService.updateAccrual(accrualId, accrualData);
                } else {
                    console.log("DEBUG: Yeni tahakkuk ekleniyor:", accrualData);
                    result = await accrualService.addAccrual(accrualData);
                }
                
                if (result.success) {
                    showNotification('Tahakkuk başarıyla kaydedildi!', 'success');
                    this.closeAccrualModal();
                    await this.loadAccrualsForTask();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('Tahakkuk kaydedilirken hata oluştu: ' + error.message, 'error');
                console.error('Tahakkuk kaydetme hatası:', error);
            }
        }

        setupDocumentUploadListeners() {
            const fileUploadArea = document.getElementById('fileUploadArea');
            const fileInput = document.getElementById('fileInput');
            
            if (fileUploadArea && fileInput) {
                fileUploadArea.removeEventListener('click', () => fileInput.click());
                fileUploadArea.addEventListener('click', () => fileInput.click());
                fileInput.removeEventListener('change', (e) => this.handleTaskDocumentsUpload(e.target.files));
                fileInput.addEventListener('change', (e) => this.handleTaskDocumentsUpload(e.target.files));
                
                fileUploadArea.removeEventListener('dragover', this.dragOverHandler);
                fileUploadArea.removeEventListener('dragleave', this.dragLeaveHandler);
                fileUploadArea.removeEventListener('drop', this.dropHandler);

                this.dragOverHandler = (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#457b9d';
                    fileUploadArea.style.background = '#e0f2f7';
                };
                this.dragLeaveHandler = (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#a8dadc';
                    fileUploadArea.style.background = '#f1faee';
                };
                this.dropHandler = (e) => {
                    e.preventDefault();
                    fileUploadArea.style.borderColor = '#a8dadc';
                    fileUploadArea.style.background = '#f1faee';
                    this.handleTaskDocumentsUpload(e.dataTransfer.files);
                };

                fileUploadArea.addEventListener('dragover', this.dragOverHandler);
                fileUploadArea.addEventListener('dragleave', this.dragLeaveHandler);
                fileUploadArea.addEventListener('drop', this.dropHandler);
            }
        }

        handleTaskDocumentsUpload(files) {
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    showNotification(`"${file.name}" dosyası çok büyük (Max 10MB).`, 'error');
                    continue;
                }
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'image/jpeg', 'image/png'];
                if (!allowedTypes.includes(file.type)) {
                    showNotification(`"${file.name}" desteklenmeyen bir formattadır.`, 'error');
                    continue;
                }
                
                if (this.currentTaskDocuments.some(d => d.name === file.name && d.size === file.size)) {
                    showNotification(`"${file.name}" zaten eklenmiş.`, 'info');
                    continue;
                }

                readFileAsDataURL(file).then(dataUrl => {
                    this.currentTaskDocuments.push({
                        id: generateUUID(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        content: dataUrl,
                        uploadedAt: new Date().toISOString(),
                        documentDesignation: 'Diğer'
                    });
                    this.renderDocuments();
                }).catch(error => {
                    console.error("Dosya okuma hatası:", error);
                    showNotification(`"${file.name}" okunamadı.`, 'error');
                });
            }
            this.saveDocumentsToTask();
        }

        renderDocuments() {
            const fileListContainer = document.getElementById('fileListContainer');
            fileListContainer.innerHTML = '';

            if (this.currentTaskDocuments.length === 0) {
                fileListContainer.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Bu işe ait belge bulunmamaktadır.</p>';
                return;
            }

            this.currentTaskDocuments.forEach(doc => {
                const fileItem = document.createElement('div');
                fileItem.classList.add('file-item');
                
                let optionsHtml = '';
                for (const key in documentDesignationTranslations) {
                    if (documentDesignationTranslations.hasOwnProperty(key)) {
                        const value = documentDesignationTranslations[key];
                        const selected = doc.documentDesignation === value ? 'selected' : '';
                        optionsHtml += `<option value="${value}" ${selected}>${value}</option>`;
                    }
                }

                fileItem.innerHTML = `
                    <div class="file-info">
                        <span class="file-icon">📄</span>
                        <div>
                            <div class="file-name"><a href="${doc.content}" download="${doc.name}">${doc.name}</a></div>
                            <div class="file-size">${formatFileSize(doc.size)}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <select class="file-designation-select" data-doc-id="${doc.id}">
                            ${optionsHtml}
                        </select>
                        <button class="btn-remove-file" data-doc-id="${doc.id}">&times;</button>
                    </div>
                `;
                const designationSelect = fileItem.querySelector('.file-designation-select');
                if (designationSelect) {
                    designationSelect.removeEventListener('change', this.handleDocumentDesignationChange);
                    this.handleDocumentDesignationChange = (e) => {
                        const changedDoc = this.currentTaskDocuments.find(d => d.id === e.target.dataset.docId);
                        if (changedDoc) {
                            changedDoc.documentDesignation = e.target.value;
                            this.saveDocumentsToTask();
                        }
                    };
                    designationSelect.addEventListener('change', this.handleDocumentDesignationChange);
                }

                const removeBtn = fileItem.querySelector('.btn-remove-file');
                if (removeBtn) {
                    removeBtn.removeEventListener('click', this.removeDocumentHandler);
                    this.removeDocumentHandler = (e) => this.removeDocument(e.target.dataset.docId);
                    removeBtn.addEventListener('click', this.removeDocumentHandler);
                }
                fileListContainer.appendChild(fileItem);
            });
        }

        removeDocument(docId) {
            if (confirm('Bu belgeyi kaldırmak istediğinizden emin misiniz?')) {
                this.currentTaskDocuments = this.currentTaskDocuments.filter(doc => doc.id !== docId);
                this.renderDocuments();
                this.saveDocumentsToTask();
            }
        }

        async saveDocumentsToTask() {
            try {
                const result = await taskService.updateTask(this.taskId, { documents: this.currentTaskDocuments });
                if (result.success) {
                    showNotification('Belgeler başarıyla güncellendi.', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('Belgeler güncellenirken hata oluştu: ' + error.message, 'error');
            }
        }

        cleanHistoryAction(action) {
            if (action.includes('İş güncellendi. Değişen alanlar:')) {
                return 'İş güncellendi';
            }
            if (action.includes('İş oluşturuldu')) return 'İş oluşturuldu';
            if (action.includes('İş silindi')) return 'İş silindi';
            if (action.includes('İş tamamlandı')) return 'İş tamamlandı';
            if (action.includes('İş yeniden atandı')) return 'İş yeniden atandı';
            if (action.includes('Durum değişti')) return 'Durum değiştirildi';
            
            return action.length > 50 ? action.substring(0, 50) + '...' : action;
        }

        renderHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            const history = this.currentTask.history || [];
            if (history.length === 0) {
                historyList.innerHTML = '<p>İşlem geçmişi bulunmamaktadır.</p>';
                return;
            }

            const sortedHistory = [...history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            sortedHistory.forEach(item => {
                const historyItem = document.createElement('div');
                historyItem.classList.add('history-item');
                
                const actionClass = item.action.length > 100 ? 'history-item-action long-text' : 'history-item-action';
                
                historyItem.innerHTML = `
                    <div class="${actionClass}">${this.cleanHistoryAction(item.action)}</div>
                    <div class="history-item-meta">${new Date(item.timestamp).toLocaleString('tr-TR')} by ${item.userEmail}</div>
                `;
                historyList.appendChild(historyItem);
            });
        }
        
        async recalculateOfficialAndOperationalDueDates() {
            console.log('DEBUG: recalculateOfficialAndOperationalDueDates çağrıldı.');
            const deliveryDateStr = document.getElementById('deliveryDate').value;
            
            if (!deliveryDateStr) {
                showNotification('Tebliğ Tarihi boş bırakılamaz. Resmi son tarih hesaplanamaz.', 'warning');
                this.calculatedOfficialDueDate = null;
                this.calculatedOperationalDueDate = null;
                this.calculatedOfficialDueDateDetails = null;
                document.getElementById('officialDueDate').value = '';
                document.getElementById('taskDueDate').value = '';
                console.log('DEBUG: Tebliğ Tarihi boş, hesaplama iptal edildi.');
                return;
            }
            
            const parts = deliveryDateStr.split('-');
            const deliveryDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
            deliveryDate.setHours(0, 0, 0, 0);

            console.log('DEBUG: Tebliğ Tarihi:', this.formatDateToYYYYMMDD(deliveryDate));
            console.log('DEBUG: Current Task Type ID:', this.currentTask.taskType);
            console.log('DEBUG: All Transaction Types:', this.allTransactionTypes);

            let duePeriod = null;
            let sourceOfDuePeriod = 'unknown';

            if (this.currentTask.officialDueDateDetails && 
                this.currentTask.officialDueDateDetails.periodMonths !== undefined && 
                this.currentTask.officialDueDateDetails.periodMonths !== null) {
                
                duePeriod = this.currentTask.officialDueDateDetails.periodMonths;
                sourceOfDuePeriod = 'task.officialDueDateDetails.periodMonths';
            } else {
                const taskTypeObj = this.allTransactionTypes.find(t => t.id === this.currentTask.taskType);
                if (taskTypeObj && taskTypeObj.duePeriod !== undefined && taskTypeObj.duePeriod !== null) {
                    duePeriod = taskTypeObj.duePeriod;
                    sourceOfDuePeriod = 'transactionType.duePeriod';
                }
            }
            
            console.log('DEBUG: Bulunan duePeriod:', duePeriod, 'Kaynak:', sourceOfDuePeriod);

            if (duePeriod === null) {
                showNotification('Seçilen görev tipi veya görevin detayları için duePeriod tanımlanmamış. Resmi son tarih hesaplanamaz.', 'warning');
                this.calculatedOfficialDueDate = null;
                this.calculatedOperationalDueDate = null;
                this.calculatedOfficialDueDateDetails = null;
                document.getElementById('officialDueDate').value = '';
                document.getElementById('taskDueDate').value = '';
                console.log('DEBUG: duePeriod tanımlanmamış, hesaplama iptal edildi.');
                return;
            }

            const originalCalculatedOfficialDate = addMonthsToDate(deliveryDate, duePeriod);
            console.log('DEBUG: duePeriod eklendikten sonraki orijinal tarih:', this.formatDateToYYYYMMDD(originalCalculatedOfficialDate));
            
            const finalOfficialDueDate = findNextWorkingDay(originalCalculatedOfficialDate, TURKEY_HOLIDAYS);
            console.log('DEBUG: Hafta sonu/tatil sonrası Resmi Son Tarih:', this.formatDateToYYYYMMDD(finalOfficialDueDate));

            const threeDaysBeforeOfficial = new Date(finalOfficialDueDate);
            threeDaysBeforeOfficial.setDate(finalOfficialDueDate.getDate() - 3);
            
            let tempOperationalDueDate = new Date(threeDaysBeforeOfficial);
            tempOperationalDueDate.setHours(0,0,0,0);

            while (isHoliday(tempOperationalDueDate, TURKEY_HOLIDAYS)) {
                tempOperationalDueDate.setDate(tempOperationalDueDate.getDate() - 1);
            }
            const finalOperationalDueDate = tempOperationalDueDate;
            console.log('DEBUG: Hesaplanan Operasyonel Son Tarih:', this.formatDateToYYYYMMDD(finalOperationalDueDate));

            this.calculatedOfficialDueDate = finalOfficialDueDate;
            this.calculatedOperationalDueDate = finalOperationalDueDate;
            this.calculatedOfficialDueDateDetails = {
                initialDeliveryDate: deliveryDateStr,
                periodMonths: duePeriod,
                originalCalculatedDate: this.formatDateToYYYYMMDD(originalCalculatedOfficialDate),
                finalOfficialDueDate: this.formatDateToYYYYMMDD(finalOfficialDueDate),
                finalOperationalDueDate: this.formatDateToYYYYMMDD(finalOperationalDueDate),
                adjustments: []
            };

            document.getElementById('officialDueDate').value = this.calculatedOfficialDueDateDetails.finalOfficialDueDate;
            document.getElementById('taskDueDate').value = this.calculatedOfficialDueDateDetails.finalOperationalDueDate;

            showNotification('Resmi ve Operasyonel son tarihler hesaplandı. Kaydetmek için "Değişiklikleri Kaydet" butonuna tıklayın.', 'info', 5000);
        }

        setupAccrualContainerListeners(e) {
            const target = e.target.closest('.action-btn');
            if (!target) return;
            
            e.preventDefault();
            const accrualId = target.dataset.id;
            
            console.log('DEBUG: Tahakkuk butonuna tıklandı:', target.className, 'ID:', accrualId);
            
            if (target.classList.contains('edit-accrual-btn')) {
                console.log('DEBUG: Tahakkuk düzenleme modalı açılıyor');
                this.showAccrualModal('edit', accrualId);
            } else if (target.classList.contains('delete-accrual-btn')) {
                console.log('DEBUG: Tahakkuk silme işlemi başlatılıyor');
                this.deleteAccrual(accrualId);
            }
        }

        async deleteAccrual(accrualId) {
            if (confirm('Bu tahakkuku silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                try {
                    const result = await accrualService.deleteAccrual(accrualId);
                    if (result.success) {
                        showNotification('Tahakkuk başarıyla silindi!', 'success');
                        await this.loadAccrualsForTask();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    showNotification('Tahakkuk silinirken hata oluştu: ' + error.message, 'error');
                    console.error('Tahakkuk silme hatası:', error);
                }
            }
        }

        async handleAssignTask() {
            const newAssignedToUid = document.getElementById('newAssignedTo').value;
            if (!newAssignedToUid) {
                showNotification('Lütfen yeni bir kullanıcı seçin.', 'warning');
                return;
            }

            const newAssignedToUser = this.allUsers.find(u => u.id === newAssignedToUid);
            if (!newAssignedToUser) {
                showNotification('Seçilen kullanıcı bulunamadı.', 'error');
                return;
            }

            try {
                const updatedTaskData = {
                    assignedTo_uid: newAssignedToUser.id,
                    assignedTo_email: newAssignedToUser.email,
                    updatedAt: new Date().toISOString(),
                };
                const result = await taskService.updateTask(this.taskId, updatedTaskData);
                if (result.success) {
                    showNotification('İş başarıyla yeniden atandı!', 'success');
                    document.getElementById('assignTaskModal').classList.remove('show');
                    document.body.classList.remove('modal-open');
                    await this.loadTaskData();
                    await loadTasksIntoTable();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('İş yeniden atanırken hata oluştu: ' + error.message, 'error');
                console.error('İş atama hatası:', error);
            }
        }
    }

    let tasksTableManager;
    const taskModalManager = new TaskModalManager();

    document.addEventListener('DOMContentLoaded', async () => {
        await loadSharedLayout({ activeMenuLink: 'task-management.html' });
        await taskModalManager.init();

        const currentUser = authService.getCurrentUser();
        if (!currentUser) {
            console.log('DEBUG: Kullanıcı oturumu açık değil, index.html adresine yönlendiriliyor.');
            window.location.href = 'index.html';
            return;
        }

        // TableManager'ı doğru şekilde başlatırken, veriyi constructor'da geçirin.
        tasksTableManager = new TableManager({
            tableId: 'tasks-table',
            tableBodyId: 'tasksTableBody',
            tableHeaderRowId: 'tasksTableHeaderRow',
            tableFilterRowId: 'tasksTableFilterRow',
            globalSearchInputId: 'taskSearchInput',
            noRecordsMessageId: 'noTasksMessage',
            columnDefinitions: [
                { key: 'taskNumber', label: 'İş No.', sortable: true, searchable: true },
                { key: 'relatedIpRecord', label: 'İlgili Kayıt', sortable: true, searchable: true },
                { key: 'taskType', label: 'Tip', sortable: true, searchable: true },
                { key: 'priority', label: 'Öncelik', sortable: true, searchable: true },
                { key: 'assignedTo', label: 'Atanan', sortable: true, searchable: true },
                { key: 'operationalDueDate', label: 'Operasyonel Son Tarih', sortable: true, searchable: true },
                { key: 'officialDueDate', label: 'Resmi Son Tarih', sortable: true, searchable: true },
                { key: 'status', label: 'Durum', sortable: true, searchable: true },
                { key: 'actions', label: 'İşlemler', sortable: false, searchable: false }
            ],
            allRecords: [],
            allPersons: taskModalManager.allPersons,
            allUsers: taskModalManager.allUsers,
            customRecordHtml: (task, allPersons, allUsers) => {
                const assignedUserName = allUsers.find(u => u.id === task.assignedTo_uid)?.displayName || task.assignedTo_email || 'Bilinmiyor';
                const statusClass = `status-${task.status.replace(/ /g, '_').toLowerCase()}`;
                const priorityClass = `priority-${task.priority.toLowerCase()}`;

                // task.taskType artık display name olarak geliyor
                const taskTypeDisplay = task.taskType; 

                return `
                    <td>${task.taskNumber}</td>
                    <td>${task.relatedIpRecord || 'Yok'}</td>
                    <td>${taskTypeDisplay}</td>
                    <td><span class="priority-badge ${priorityClass}">${task.priority}</span></td>
                    <td>${assignedUserName}</td>
                    <td>${task.operationalDueDate}</td>
                    <td>${task.officialDueDate}</td>
                    <td><span class="status-badge ${statusClass}">${task.status}</span></td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${task.id}">Düzenle</button>
                        <button class="action-btn assign-btn" data-id="${task.id}">Ata</button>
                    </td>
                `;
            },
            onRowClick: (recordId) => {
                 taskModalManager.openTaskDetailModal(recordId);
            }
        });

        tasksTableManager.initializeTable();
        await loadTasksIntoTable();
        setupListingPageEventListeners();
    });

    async function loadTasksIntoTable() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const noTasksMessage = document.getElementById('noTasksMessage');
        loadingIndicator.style.display = 'block';
        noTasksMessage.style.display = 'none';
        
        try {
            const result = await taskService.getAllTasks();
            if (result.success && result.data && result.data.length > 0) {
                let tasks = result.data;
                
                const usersResult = await taskService.getAllUsers();
                const allUsersMap = new Map((usersResult.data || []).map(user => [user.id, user.displayName || user.email]));

                const allTransactionTypes = taskModalManager.allTransactionTypes; 
                const transactionTypeMap = new Map((allTransactionTypes || []).map(type => [type.id, type.alias || type.name]));

                const formattedTasks = tasks.map(task => {
                    const assignedUserName = allUsersMap.get(task.assignedTo_uid) || 'Bilinmiyor';
                    
                    const taskTypeDisplayName = transactionTypeMap.get(task.taskType) || (task.taskType ? task.taskType.split('_').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join(' ') : 'N/A');
                    
                    const officialDueDate = task.officialDueDate ? 
                        (task.officialDueDate.seconds ? new Date(task.officialDueDate.seconds * 1000).toLocaleDateString('tr-TR') : new Date(task.officialDueDate).toLocaleDateString('tr-TR')) : 'Belirtilmemiş';
                    const operationalDueDate = task.dueDate ? 
                        (task.dueDate.seconds ? new Date(task.dueDate.seconds * 1000).toLocaleDateString('tr-TR') : new Date(task.dueDate).toLocaleDateString('tr-TR')) : 'Belirtilmemiş';

                    return {
                        id: task.id,
                        taskNumber: task.taskNumber || task.id.substring(0, 8),
                        relatedIpRecord: task.relatedIpRecordTitle || 'Yok',
                        taskType: taskTypeDisplayName,
                        priority: task.priority,
                        assignedTo: assignedUserName,
                        operationalDueDate: operationalDueDate,
                        officialDueDate: officialDueDate,
                        status: task.status,
                        searchableTitle: task.title,
                        searchableIpRecordTitle: task.relatedIpRecordTitle,
                        searchableTaskType: taskTypeDisplayName,
                        searchableAssignedToEmail: task.assignedTo_email,
                        searchableStatus: task.status
                    };
                });

                tasksTableManager.allRecords = formattedTasks; 
                tasksTableManager.applyFiltersAndSort(); 
                
            } else {
                noTasksMessage.style.display = 'block';
            }
        } catch (error) {
            console.error('Görevler yüklenirken hata oluştu:', error);
            showNotification('Görevler yüklenirken hata oluştu: ' + error.message, 'error');
            noTasksMessage.textContent = 'Görevler yüklenirken bir hata oluştu.';
            noTasksMessage.style.display = 'block';
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    function setupListingPageEventListeners() {
        document.querySelector('.btn-add-task').addEventListener('click', () => {
            window.location.href = 'create-task.html';
        });

        document.getElementById('taskSearchInput').addEventListener('input', (e) => {
            tasksTableManager.globalSearchInputId = 'taskSearchInput'; // TableManager'ın bunu almasını sağlamak için
            tasksTableManager.applyFiltersAndSort(); 
        });

        document.getElementById('tasksTableBody').addEventListener('click', (event) => {
            const editBtn = event.target.closest('.action-btn.edit-btn');
            if (editBtn) {
                event.preventDefault();
                const taskId = editBtn.dataset.id;
                taskModalManager.openTaskDetailModal(taskId);
            }
            const assignBtn = event.target.closest('.action-btn.assign-btn');
            if (assignBtn) {
                event.preventDefault();
                const taskId = assignBtn.dataset.id;
                taskModalManager.taskId = taskId;
                taskModalManager.populateAssignedToDropdown();
                document.getElementById('assignTaskModal').classList.add('show');
                document.body.classList.add('modal-open');
            }
        });
    }

    window.taskModalManager = taskModalManager;
    window.loadTasksIntoTable = loadTasksIntoTable;

</script>
</body>
</html>