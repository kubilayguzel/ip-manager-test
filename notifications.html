<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Müvekkil Bildirimleri</title>
<link rel="stylesheet" href="css/shared-styles.css">
<style>
/* Buraya sadece modal görünümünü etkileyen stil eklersin */
</style>
</head>
<body>
<div id="layout-placeholder"></div>
<div class="page-wrapper">
<main class="main-container">
<section class="page-header">
    <h1 class="page-title">Müvekkil Bildirimleri</h1>
    <p class="page-subtitle">Müvekkillere gönderilen bildirimleri buradan takip edebilirsiniz.</p>
</section>

<div class="tasks-container">
    <div id="loader" class="loading">Yükleniyor...</div>
    <div id="error" class="no-records"></div>
    <div class="table-container">
    <table class="tasks-table">
        <thead>
            <tr>
                <th>Durum</th>
                <th>Müvekkil E-posta</th>
                <th>Konu</th>
                <th>Oluşturulma</th>
                <th>İşlem</th>
            </tr>
        </thead>
        <tbody id="notifications-table-body"></tbody>
    </table>
    </div>
</div>

<div id="notification-modal" class="modal" style="display:none;">
  <div class="modal-content">
    <span id="close-modal" class="close-btn">&times;</span>
    <h2>Bildirimi Düzenle</h2>
    <label for="modal-subject">Konu</label>
    <input type="text" id="modal-subject" />
    <label for="modal-body">İçerik</label>
    <textarea id="modal-body" rows="10"></textarea>
    <div class="modal-actions">
      <button id="save-draft" class="action-btn" style="background:#6c757d;">Taslak Kaydet</button>
      <button id="send-notification" class="action-btn" style="background:#28a745;">Gönder</button>
    </div>
  </div>
</div>
</main>
</div>

<!-- Firebase ve TinyMCE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
import { getFirestore, collection, query, orderBy, onSnapshot, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-functions.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
import { loadSharedLayout } from './js/layout-loader.js';

const firebaseConfig = {
    apiKey: "AIzaSyDbdqfiVbobnl1BtyiWxhD4bfIcREw8ZRc",
    authDomain: "ip-manager-production-aab4b.firebaseapp.com",
    projectId: "ip-manager-production-aab4b",
    storageBucket: "ip-manager-production-aab4b.appspot.com",
    messagingSenderId: "594650169512",
    appId: "1:594650169512:web:43496005e063a40511829d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const functions = getFunctions(app, 'us-central1');
const auth = getAuth(app);

const tableBody = document.getElementById('notifications-table-body');
const loader = document.getElementById('loader');
const errorDiv = document.getElementById('error');
const sendEmail = httpsCallable(functions, 'sendEmailNotification');

onAuthStateChanged(auth, (user) => {
    if (user) {
        loadSharedLayout({ activeMenuLink: 'notifications.html' });
        startNotificationListener();
    } else {
        loader.textContent = "Bu sayfayı görmek için giriş yapmalısınız.";
    }
});

function startNotificationListener() {
    const q = query(collection(db, "mail_notifications"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        loader.style.display = 'none';
        tableBody.innerHTML = '';

        if (snapshot.empty) {
            tableBody.innerHTML = '<tr><td colspan="5" class="no-records">Gösterilecek bildirim bulunamadı.</td></tr>';
            return;
        }

        snapshot.forEach(docSnap => {
            const notification = { id: docSnap.id, ...docSnap.data() };
            const tr = document.createElement('tr');
            const statusClass = notification.status === 'sent' ? 'status-sent' :
                                notification.status === 'failed' ? 'status-failed' : 'status-pending';

            tr.innerHTML = `
                <td><span class="status-badge ${statusClass}">${notification.status}</span></td>
                <td>${notification.recipientEmail}</td>
                <td>${notification.subject}</td>
                <td>${notification.createdAt?.toDate().toLocaleString('tr-TR') || 'Bilinmiyor'}</td>
                <td class="action-cell"></td>
            `;

            if (notification.status !== 'sent') {
                const editButton = document.createElement('button');
                editButton.className = 'action-btn';
                editButton.textContent = 'Düzenle';
                editButton.addEventListener('click', () => openModal(notification));
                tr.querySelector('.action-cell').appendChild(editButton);

                const sendButton = document.createElement('button');
                sendButton.className = 'action-btn';
                sendButton.textContent = notification.status === 'failed' ? 'Tekrar Gönder' : 'Gönder';
                sendButton.addEventListener('click', () => sendNotification(notification.id));
                tr.querySelector('.action-cell').appendChild(sendButton);
            }
            tableBody.appendChild(tr);
        });
    }, (error) => {
        loader.style.display = 'none';
        errorDiv.textContent = 'Bildirimler yüklenirken bir hata oluştu.';
    });
}

function openModal(notification) {
  const subjectInput = document.getElementById('modal-subject');

  subjectInput.value = notification.subject || "";

  if (tinymce.get('modal-body')) {
    tinymce.get('modal-body').remove();
  }

  tinymce.init({
    selector: '#modal-body',
    height: 300,
    menubar: false,
    plugins: 'link lists',
    toolbar: 'undo redo | bold italic underline | bullist numlist | link',
    branding: false,
    language: 'tr',
    setup: (editor) => {
      editor.on('init', () => {
        let html = notification.body || "";
        const bodyMatch = html.match(/<body[^>]*>([\s\S]*?)<\/body>/i);
        if (bodyMatch) html = bodyMatch[1];
        editor.setContent(html);
      });
    }
  });

  document.getElementById('save-draft').dataset.id = notification.id;
  document.getElementById('send-notification').dataset.id = notification.id;
  document.getElementById('notification-modal').style.display = "flex";
}

document.getElementById('save-draft').addEventListener('click', async () => {
  const id = document.getElementById('save-draft').dataset.id;
  const subject = document.getElementById('modal-subject').value.trim();
  const body = tinymce.get('modal-body').getContent();

  try {
    await updateDoc(doc(db, "mail_notifications", id), {
      subject: subject,
      body: body,
      isDraft: true,
      updatedAt: serverTimestamp()
    });
    alert("Taslak kaydedildi!");
    document.getElementById('notification-modal').style.display = "none";
  } catch (err) {
    console.error(err);
    alert("Taslak kaydedilemedi.");
  }
});

document.getElementById('send-notification').addEventListener('click', async () => {
  const id = document.getElementById('send-notification').dataset.id;
  const subject = document.getElementById('modal-subject').value.trim();
  const body = tinymce.get('modal-body').getContent();
  const user = auth.currentUser;
  if (!user) {
    alert("Giriş yapmalısınız.");
    return;
  }
  if (!confirm("Bu e-postayı göndermek istediğinize emin misiniz?")) return;

  try {
    await updateDoc(doc(db, "mail_notifications", id), {
      subject: subject,
      body: body,
      isDraft: false,
      updatedAt: serverTimestamp()
    });
    await sendEmail({ notificationId: id, userEmail: user.email });
    alert("E-posta gönderim sırasına alındı!");
    document.getElementById('notification-modal').style.display = "none";
  } catch (err) {
    console.error(err);
    alert("Gönderim sırasında bir hata oluştu.");
  }
});

document.getElementById('close-modal').addEventListener('click', () => {
  document.getElementById('notification-modal').style.display = "none";
});
</script>

<script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
</body>
</html>
