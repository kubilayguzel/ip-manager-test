<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portföy Yönetimi - IP Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/dataTables.bootstrap5.min.css">
    <link href="css/shared-styles.css" rel="stylesheet">
</head>
<body>
    <div id="layout-placeholder"></div>

    <main class="container-fluid mt-4">
        <div class="card p-4">
            <h2 class="card-title mb-4">Portföy Yönetimi</h2>
            <table id="portfolio-table" class="table table-striped" style="width:100%">
                <thead>
                    <tr>
                        <th>Başlık</th>
                        <th>Başvuru Sahibi</th>
                        <th>Başvuru Numarası</th>
                        <th>Başvuru Tarihi</th>
                        <th>Durum</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </main>

    <div class="modal fade" id="recordDetailModal" tabindex="-1" aria-labelledby="recordDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="recordDetailModalLabel">Kayıt Detayları</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="modal-body-content">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.8/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script type="module">
        import { ipRecordsService, authService } from './firebase-config.js';
        import { loadSharedLayout } from './js/layout-loader.js';
        import { showNotification } from './utils.js';

        class PortfolioManager {
            constructor() {
                this.dataTable = null;
                this.allRecords = [];
                this.init();
            }

            async init() {
                await loadSharedLayout({ activeMenuLink: 'portfolio.html' });
                this.dataTable = this.initDataTable();
                await this.loadAndRenderData();
                this.bindEvents();
            }

            initDataTable() {
                return new DataTable('#portfolio-table', {
                    responsive: true,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/1.13.8/i18n/tr.json'
                    }
                });
            }

            async loadAndRenderData() {
                const response = await ipRecordsService.getRecords();
                if (response.success) {
                    this.allRecords = response.data;
                    this.renderDataTable(this.allRecords);
                } else {
                    showNotification('Portföy yüklenirken bir hata oluştu: ' + response.error, 'error');
                }
            }
            
            renderDataTable(records) {
                this.dataTable.clear();
                records.forEach(record => {
                    this.dataTable.row.add([
                        record.title || 'N/A',
                        record.owners?.map(o => o.name).join(', ') || 'N/A',
                        record.applicationNumber || 'N/A',
                        record.applicationDate ? new Date(record.applicationDate).toLocaleDateString('tr-TR') : 'N/A',
                        record.status || 'N/A',
                        `<button class="btn btn-sm btn-primary view-btn" data-id="${record.id}"><i class="bi bi-eye"></i></button>
                         <button class="btn btn-sm btn-danger delete-btn" data-id="${record.id}"><i class="bi bi-trash"></i></button>`
                    ]);
                });
                this.dataTable.draw();
            }

            bindEvents() {
                $('#portfolio-table tbody').on('click', '.view-btn', (e) => {
                    const recordId = $(e.currentTarget).data('id');
                    this.showRecordDetails(recordId);
                });

                $('#portfolio-table tbody').on('click', '.delete-btn', async (e) => {
                    const recordId = $(e.currentTarget).data('id');
                    if(confirm('Bu kaydı silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.')) {
                        const result = await ipRecordsService.deleteRecord(recordId);
                        if(result.success) {
                            showNotification('Kayıt başarıyla silindi.', 'success');
                            this.loadAndRenderData();
                        } else {
                            showNotification('Kayıt silinirken hata: ' + result.error, 'error');
                        }
                    }
                });
            }

            showRecordDetails(recordId) {
                const record = this.allRecords.find(r => r.id === recordId);
                if (!record) return;

                const modalContent = $('#modal-body-content');
                modalContent.html(`
                    <h4>${record.title}</h4>
                    <hr>
                    <div class="row">
                        <div class="col-md-6">
                            <h5><i class="bi bi-info-circle-fill"></i> Temel Bilgiler</h5>
                            <p><strong>Başvuru Numarası:</strong> ${record.applicationNumber || 'Belirtilmemiş'}</p>
                            <p><strong>Başvuru Tarihi:</strong> ${record.applicationDate ? new Date(record.applicationDate).toLocaleDateString('tr-TR') : 'Belirtilmemiş'}</p>
                            <p><strong>Tescil Numarası:</strong> ${record.registrationNumber || 'Belirtilmemiş'}</p>
                            <p><strong>Tescil Tarihi:</strong> ${record.registrationDate ? new Date(record.registrationDate).toLocaleDateString('tr-TR') : 'Belirtilmemiş'}</p>
                            <p><strong>Durum:</strong> ${record.status || 'Belirtilmemiş'}</p>
                        </div>
                        <div class="col-md-6">
                            <h5><i class="bi bi-people-fill"></i> Başvuru Sahipleri</h5>
                            <ul>
                                ${record.owners?.map(owner => `<li>${owner.name} (${owner.personType})</li>`).join('') || '<li>Belirtilmemiş</li>'}
                            </ul>
                        </div>
                    </div>
                    <hr>
                    <h5><i class="bi bi-journal-text"></i> İşlem Geçmişi</h5>
                    <div class="accordion" id="transactionHistoryAccordion">
                        ${this.renderTransactionHistory(record.transactions || [])}
                    </div>
                `);

                const detailModal = new bootstrap.Modal(document.getElementById('recordDetailModal'));
                detailModal.show();
            }

            // *** DÜZELTİLEN FONKSİYON ***
            renderTransactionHistory(transactions) {
                if (!transactions || transactions.length === 0) {
                    return '<p>Bu kayıt için işlem geçmişi bulunmuyor.</p>';
                }

                const container = document.createElement('div');
                
                // İşlemleri ana ve alt işlemler olarak ayır
                const parentTransactions = transactions.filter(t => !t.parentId);
                const childTransactions = transactions.filter(t => t.parentId);

                parentTransactions.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));

                parentTransactions.forEach((parentTx, index) => {
                    const accordionId = `accordion-${parentTx.transactionId || index}`;
                    const headerId = `heading-${parentTx.transactionId || index}`;
                    const collapseId = `collapse-${parentTx.transactionId || index}`;

                    // Bu ana işleme ait alt işlemleri bul
                    const relatedChildren = childTransactions
                        .filter(child => child.parentId === parentTx.transactionId)
                        .sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));

                    let childrenHtml = '';
                    if (relatedChildren.length > 0) {
                        childrenHtml = '<ul class="list-group mt-2">';
                        relatedChildren.forEach(child => {
                             const childDate = new Date(child.timestamp).toLocaleDateString('tr-TR');
                             childrenHtml += `<li class="list-group-item"><strong>${child.description || child.type}</strong> - ${childDate}</li>`;
                        });
                        childrenHtml += '</ul>';
                    }

                    const item = document.createElement('div');
                    item.className = 'accordion-item';

                    const parentDate = new Date(parentTx.timestamp).toLocaleDateString('tr-TR');
                    
                    item.innerHTML = `
                        <h2 class="accordion-header" id="${headerId}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="false" aria-controls="${collapseId}">
                                <strong>${parentTx.description || parentTx.type}</strong> - ${parentDate}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse" aria-labelledby="${headerId}" data-bs-parent="#transactionHistoryAccordion">
                            <div class="accordion-body">
                                <p><strong>İşlem Detayları:</strong></p>
                                <p><strong>İşlem ID:</strong> ${parentTx.transactionId || 'N/A'}</p>
                                <p><strong>Oluşturan:</strong> ${parentTx.userEmail || 'N/A'}</p>
                                ${childrenHtml || '<p>Bu işleme bağlı alt işlem bulunmamaktadır.</p>'}
                            </div>
                        </div>
                    `;
                    container.appendChild(item);
                });

                return container.innerHTML;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            new PortfolioManager();
        });
    </script>
</body>
</html>