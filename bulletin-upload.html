<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BÃ¼lten YÃ¼kleme</title>
  <link rel="stylesheet" href="css/shared-styles.css" />
  <style>
    .main-container {
      max-width: 100%;
      padding: 30px;
      padding-top: 100px;
    }
    .bulletin-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .bulletin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .bulletin-table th, .bulletin-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .bulletin-table th {
      background-color: #f2f2f2;
    }
    .bulletin-table .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .bulletin-table .delete-btn:hover {
        background-color: #c82333;
    }
    .record-count-cell {
        font-style: italic;
        color: #666;
    }
  </style>
</head>
<body>
<div id="layout-placeholder"></div>

<div class="page-wrapper">
    <main class="main-container">
        <h1>BÃ¼lten YÃ¼kleme</h1>
        <p>Marka, patent ve tasarÄ±m bÃ¼ltenlerini ayrÄ± ayrÄ± yÃ¼kleyebilirsiniz.</p>

        <div class="bulletin-section">
            <h2>Marka BÃ¼lteni YÃ¼kleme</h2>
            <form id="bulletinUploadFormTrademark">
                <div class="file-upload-area" id="dropAreaTrademark">
                    <div class="upload-icon">ğŸ“‚</div>
                    <p>DosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n.</p>
                    <input type="file" id="bulletinFileTrademark" accept=".zip,.rar" style="display: none;" required />
                </div>
                <div id="selectedFileNameTrademark" style="margin-top:10px;"></div>
                <button type="submit" class="btn btn-primary" style="margin-top:20px;">Marka BÃ¼lteni YÃ¼kle</button>
            </form>
            <div id="uploadStatusTrademark" style="margin-top:20px;"></div>
            <div id="progressContainer" style="display:none; margin-top:10px;">
                <div id="progressBar" style="height:20px; width:0%; background:#1e3c72;"></div>
            </div>
            
            <div class="bulletin-table-container">
                <h3 style="margin-top: 30px; color: #1e3c72;">YÃ¼klÃ¼ Marka BÃ¼ltenleri</h3>
                <table class="bulletin-table" id="trademarkBulletinTable">
                    <thead>
                        <tr>
                            <th>BÃ¼lten No</th>
                            <th>BÃ¼lten Tarihi</th>
                            <th>YÃ¼klenme Tarihi</th>
                            <th>KayÄ±t SayÄ±sÄ±</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bulletin-section">
            <h2>Patent BÃ¼lteni YÃ¼kleme</h2>
            <p>Bu alan yakÄ±nda aktif olacaktÄ±r.</p>
            <button class="btn btn-secondary" disabled>YakÄ±nda</button>
        </div>
    </main>
</div>

<script type="module">
    import { loadSharedLayout } from './js/layout-loader.js';
    loadSharedLayout({ activeMenuLink: 'bulletin-upload.html' });
</script>

<script>
// Basit ve garantili Ã§alÄ±ÅŸacak script
console.log('ğŸš€ BÃ¼lten script baÅŸladÄ±');

// Sayfa yÃ¼klendikten sonra tabloyu doldur
setTimeout(async () => {
    try {
        console.log('ğŸ”„ Tablo dolduruluyor...');
        
        // Firebase modÃ¼llerini import et
        const firebaseModule = await import('./firebase-config.js');
        const { collection, getDocs, query, where, doc, deleteDoc, writeBatch, getCountFromServer } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const { ref, deleteObject, listAll } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js');
        const { showNotification } = await import('./utils.js'); // âœ… DoÄŸru path
        
        console.log('âœ… Firebase modÃ¼lleri yÃ¼klendi');
        
        const db = firebaseModule.db;
        const storage = firebaseModule.storage;
        
        // Tabloyu doldur
        async function loadTrademarkBulletins() {
            console.log('ğŸ“‹ BÃ¼ltenler yÃ¼kleniyor...');
            
            const tableBody = document.querySelector("#trademarkBulletinTable tbody");
            if (!tableBody) {
                console.error('âŒ Tablo bulunamadÄ±');
                return;
            }
            
            tableBody.innerHTML = '<tr><td colspan="5">Veriler Ã§ekiliyor...</td></tr>';
            
            try {
                const bulletinsRef = collection(db, "trademarkBulletins");
                const snapshot = await getDocs(bulletinsRef);
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5">HiÃ§ bÃ¼lten bulunamadÄ±.</td></tr>';
                    return;
                }
                
                console.log(`ğŸ“¦ ${snapshot.size} bÃ¼lten bulundu`);
                
                tableBody.innerHTML = '';
                
                const allBulletins = [];
                snapshot.forEach(doc => {
                    allBulletins.push({ id: doc.id, ...doc.data() });
                });
                
                // Tarihe gÃ¶re sÄ±rala
                allBulletins.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                // Her bÃ¼lten iÃ§in satÄ±r ekle
                for (const bulletin of allBulletins) {
                    const uploadDate = bulletin.createdAt?.toDate ? 
                        bulletin.createdAt.toDate().toLocaleDateString('tr-TR') : 'Tarih Yok';
                    
                    // PERFORMANS: Sadece COUNT al, kayÄ±tlarÄ± Ã§ekme
                    let recordCount = 0;
                    try {
                        const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletin.id));
                        const countSnapshot = await getCountFromServer(recordsQuery);
                        recordCount = countSnapshot.data().count;
                        console.log(`ğŸ“Š ${bulletin.bulletinNo}: ${recordCount} kayÄ±t (sadece count)`);
                    } catch (countError) {
                        console.warn(`âš ï¸ ${bulletin.bulletinNo} count hatasÄ±:`, countError);
                        recordCount = '-';
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td>' + (bulletin.bulletinNo || 'No Yok') + '</td>' +
                        '<td>' + (bulletin.bulletinDate || 'Tarih Yok') + '</td>' +
                        '<td>' + uploadDate + '</td>' +
                        '<td>' + recordCount + '</td>' +
                        '<td><button class="delete-btn" onclick="deleteBulletin(\'' + bulletin.id + '\', \'' + (bulletin.bulletinNo || '') + '\')">Sil</button></td>';
                    
                    tableBody.appendChild(tr);
                }
                
                console.log('âœ… Tablo baÅŸarÄ±yla dolduruldu');
                
            } catch (error) {
                console.error('âŒ Tablo doldurma hatasÄ±:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="color:red;">Hata: ' + error.message + '</td></tr>';
                showNotification('Tablo yÃ¼kleme hatasÄ±: ' + error.message, 'error', 8000);
            }
        }
        
        // BÃ¼lten silme fonksiyonu (global) - PROGRESS NOTIFICATION Ä°LE
        window.deleteBulletin = async function(bulletinId, bulletinNo) {
            // Confirm modal yerine showNotification ile onay isteme
            const userConfirmed = confirm('BÃ¼lten No: ' + bulletinNo + ' olan bÃ¼lteni, TÃœM KAYITLARI ve GÃ–RSELLERÄ° ile birlikte silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!');
            if (!userConfirmed) {
                showNotification('âŒ Silme iÅŸlemi iptal edildi', 'info', 3000);
                return;
            }
            
            try {
                console.log('ğŸ—‘ï¸ ' + bulletinNo + ' bÃ¼lteni siliniyor...');
                
                // BaÅŸlangÄ±Ã§ bildirimi
                showNotification(`ğŸš€ BÃ¼lten ${bulletinNo} silme iÅŸlemi baÅŸlatÄ±ldÄ±...`, 'info', 3000);
                
                // 1. Ä°liÅŸkili kayÄ±tlarÄ± kontrol et
                showNotification('ğŸ” KayÄ±tlar kontrol ediliyor...', 'info', 3000);
                const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletinId));
                const recordsSnapshot = await getDocs(recordsQuery);
                const totalRecords = recordsSnapshot.size;
                console.log('ğŸ“‹ ' + totalRecords + ' adet iliÅŸkili kayÄ±t bulundu');
                
                // 2. Ana bÃ¼lteni sil
                showNotification('ğŸ—‚ï¸ Ana bÃ¼lten siliniyor...', 'info', 3000);
                const bulletinRef = doc(db, "trademarkBulletins", bulletinId);
                await deleteDoc(bulletinRef);
                console.log('âœ… Ana bÃ¼lten silindi');
                
                // 3. KayÄ±tlarÄ± batch'lerde sil
                const BATCH_SIZE = 500;
                let deletedCount = 0;
                if (totalRecords > 0) {
                    const recordBatches = Math.ceil(totalRecords / BATCH_SIZE);
                    showNotification(`ğŸ“¦ ${totalRecords} kayÄ±t ${recordBatches} batch'te silinecek...`, 'info', 4000);
                    
                    const allDocs = recordsSnapshot.docs;
                    
                    for (let i = 0; i < allDocs.length; i += BATCH_SIZE) {
                        const batchNumber = Math.ceil((i + 1) / BATCH_SIZE);
                        showNotification(`ğŸ“¦ KayÄ±t batch ${batchNumber}/${recordBatches} siliniyor...`, 'info', 2000);
                        
                        const batch = writeBatch(db);
                        const batchDocs = allDocs.slice(i, i + BATCH_SIZE);
                        
                        batchDocs.forEach(docSnapshot => {
                            batch.delete(docSnapshot.ref);
                        });
                        
                        await batch.commit();
                        deletedCount += batchDocs.length;
                        
                        // Progress notification
                        const progressPercent = Math.round((deletedCount / totalRecords) * 100);
                        showNotification(
                            `ğŸ“Š Ä°lerleme: ${deletedCount}/${totalRecords} kayÄ±t silindi (${progressPercent}%)`,
                            'info',
                            2000
                        );
                        
                        console.log('âœ… Batch ' + batchNumber + ' tamamlandÄ±. Silinen: ' + deletedCount + '/' + totalRecords);
                    }
                    
                    console.log('âœ… TÃ¼m kayÄ±tlar silindi (' + deletedCount + ' kayÄ±t)');
                } else {
                    showNotification('â„¹ï¸ Silinecek kayÄ±t bulunamadÄ±', 'info', 2000);
                }
                
                // 4. Storage'daki gÃ¶rselleri sil
                showNotification('ğŸ–¼ï¸ GÃ¶rseller kontrol ediliyor...', 'info', 3000);
                
                try {
                    const imagesFolderPath = 'bulletins/trademark_' + bulletinNo + '_images/';
                    console.log('ğŸ“ Storage path:', imagesFolderPath);
                    
                    const imagesRef = ref(storage, imagesFolderPath);
                    const imageList = await listAll(imagesRef);
                    const totalImages = imageList.items.length;
                    console.log('ğŸ“· ' + totalImages + ' adet gÃ¶rsel bulundu');
                    
                    if (totalImages > 0) {
                        showNotification(`ğŸ–¼ï¸ ${totalImages} gÃ¶rsel siliniyor...`, 'info', 3000);
                        
                        // GÃ¶rselleri tek tek sil (batch deÄŸil, _location hatasÄ± olmasÄ±n)
                        let deletedImages = 0;
                        
                        for (const imageItem of imageList.items) {
                            try {
                                await deleteObject(imageItem);
                                deletedImages++;
                                
                                // Her 10 gÃ¶rselde progress gÃ¶ster
                                if (deletedImages % 10 === 0 || deletedImages === totalImages) {
                                    const imageProgressPercent = Math.round((deletedImages / totalImages) * 100);
                                    showNotification(
                                        `ğŸ¨ GÃ¶rseller: ${deletedImages}/${totalImages} silindi (${imageProgressPercent}%)`,
                                        'info',
                                        2000
                                    );
                                }
                                
                                console.log(`ğŸ–¼ï¸ GÃ¶rsel silindi: ${deletedImages}/${totalImages}`);
                            } catch (imageError) {
                                console.error('âŒ Tek gÃ¶rsel silme hatasÄ±:', imageError);
                                // Tek gÃ¶rsel hatasÄ± tÃ¼m iÅŸlemi durdurmasÄ±n
                            }
                        }
                        
                        console.log('âœ… ' + deletedImages + ' gÃ¶rsel baÅŸarÄ±yla silindi');
                        showNotification(`âœ… ${deletedImages} gÃ¶rsel baÅŸarÄ±yla silindi`, 'success', 3000);
                    } else {
                        showNotification('â„¹ï¸ Silinecek gÃ¶rsel bulunamadÄ±', 'info', 2000);
                    }
                } catch (storageError) {
                    console.error('âŒ Storage silme hatasÄ±:', storageError);
                    showNotification('âš ï¸ GÃ¶rseller silinemedi: ' + storageError.message, 'warning', 8000);
                }
                
                // Final success mesajÄ±
                showNotification(
                    `âœ… BaÅŸarÄ±lÄ±! BÃ¼lten ${bulletinNo} tamamen silindi!\nâ€¢ Ana bÃ¼lten: âœ“\nâ€¢ ${totalRecords} kayÄ±t: âœ“\nâ€¢ GÃ¶rseller: âœ“`,
                    'success',
                    8000
                );
                      
                console.log('ğŸ”„ Tablo yenileniyor...');
                loadTrademarkBulletins(); // Tabloyu yenile
                
            } catch (error) {
                console.error('âŒ BÃ¼lten silme hatasÄ±:', error);
                showNotification('âŒ Silme hatasÄ±: ' + error.message, 'error', 10000);
            }
        };
        
        // Ä°lk yÃ¼kleme
        await loadTrademarkBulletins();
        
    } catch (error) {
        console.error('âŒ Script hatasÄ±:', error);
        
        // showNotification ile hata gÃ¶ster
        try {
            const { showNotification } = await import('./utils.js'); // âœ… DoÄŸru path
            showNotification('Script hatasÄ±: ' + error.message, 'error', 10000);
        } catch (importError) {
            // Fallback: tabloya hata yazdÄ±r
            const tableBody = document.querySelector("#trademarkBulletinTable tbody");
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" style="color:red;">Script hatasÄ±: ' + error.message + '</td></tr>';
            }
        }
    }
}, 1500); // 1.5 saniye bekle

</script>
<script type="module" src="js/bulletin-upload.js"></script>

</body>
</html>