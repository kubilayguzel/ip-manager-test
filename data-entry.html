<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Yeni Kayıt</title>
    <link rel="stylesheet" href="css/shared-styles.css">
    <style>
        /* BODY VE YENİ LAYOUT */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: #333;
            display: flex;
        }
        
        .page-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .main-container {
            width: 100%;
            padding: 30px;
            margin: 0;
        }
        
        /* ESKİ HEADER'ı GİZLE */
        body > .header { display: none; }

        /* Sayfaya özel ana konteyner stilleri */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 30px;
        }

        /* Form Stilleri */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 25px;
            display: flex;
            flex-direction: column;
        }
        
        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            background: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .dynamic-fields {
            display: none; /* Başlangıçta gizli */
            animation: fadeIn 0.3s ease forwards;
        }
        
        .dynamic-fields.show {
            display: grid; /* Gösterildiğinde grid yapısına döner */
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .owner-selection-group {
            position: relative;
        }
        
        .owner-search-input {
            width: calc(100% - 220px); /* Butonlar için yer bırak */
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            margin-right: 10px;
        }
        
        #mainOwnerSearchResults {
            position: absolute;
            top: 100%;
            left: 0;
            width: calc(100% - 220px);
            background: white;
            border: 1px solid #ddd;
            border-radius: 0 0 10px 10px;
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        
        .search-result-item {
            padding: 10px;
            cursor: pointer;
        }
        
        .search-result-item:hover {
            background-color: #f0f0f0;
        }
        
        .owner-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .owner-tag {
            background: #e9ecef;
            color: #495057;
            padding: 8px 12px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.9em;
        }
        
        .owner-tag .remove-owner {
            background: none;
            border: none;
            color: #6c757d;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2em;
            line-height: 1;
        }
        
        .form-actions {
            text-align: right;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
            margin-top: 20px;
        }
        
        /* Image Upload Area */
        .image-upload-area {
            border: 2px dashed #e1e8ed;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .image-upload-area:hover, .image-upload-area.drag-over {
            border-color: #1e3c72;
            background-color: #f8f9fa;
        }
        
        .image-upload-icon {
            font-size: 2.5em;
            color: #6c757d;
        }
        
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 15px;
            border-radius: 10px;
            border: 2px solid #e1e8ed;
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title" id="pageTitle">Yeni Kayıt Ekle</h1>
                <p class="page-subtitle" id="pageSubtitle">Yeni bir patent, marka, telif hakkı veya tasarım kaydı oluşturun.</p>
            </section>
            <div class="form-container">
                <form id="recordForm">
                    <div class="form-group full-width">
                        <label for="type" class="form-label">Kayıt Tipi:</label>
                        <select id="type" name="type" class="form-select">
                            <option value="">Kayıt Tipi Seçin</option>
                            <option value="patent">Patent</option>
                            <option value="trademark">Marka</option>
                            <option value="copyright">Telif Hakkı</option>
                            <option value="design">Tasarım</option>
                        </select>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="title" class="form-label">Başlık:</label>
                            <input type="text" id="title" name="title" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="status" class="form-label">Durum:</label>
                            <select id="status" name="status" class="form-select">
                                <option value="">Durum Seçin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="applicationNumber" class="form-label">Başvuru Numarası:</label>
                            <input type="text" id="applicationNumber" name="applicationNumber" class="form-input">
                        </div>
                        <div class="form-group date-picker-group">
                            <label for="applicationDate" class="form-label">Başvuru Tarihi:</label>
                            <input type="date" id="applicationDate" name="applicationDate" class="form-input">
                        </div>
                        <div class="form-group date-picker-group">
                            <label for="registrationDate" class="form-label">Tescil Tarihi (Varsa):</label>
                            <input type="date" id="registrationDate" name="registrationDate" class="form-input">
                        </div>
                    </div>

                    <div id="patentFields" class="dynamic-fields form-grid">
                        <div class="form-group">
                            <label for="patentClass" class="form-label">Patent Sınıfı:</label>
                            <input type="text" id="patentClass" name="patentClass" class="form-input">
                        </div>
                        <div class="form-group date-picker-group">
                            <label for="renewalDatePatent" class="form-label">Yenileme Tarihi:</label>
                            <input type="date" id="renewalDatePatent" name="renewalDatePatent" class="form-input">
                        </div>
                    </div>
                    <div id="trademarkFields" class="dynamic-fields form-grid">
                        <div class="form-group">
                            <label for="niceClass" class="form-label">Nice Sınıfı:</label>
                            <input type="text" id="niceClass" name="niceClass" class="form-input">
                        </div>
                        <div class="form-group date-picker-group">
                            <label for="renewalDateTrademark" class="form-label">Yenileme Tarihi:</label>
                            <input type="date" id="renewalDateTrademark" name="renewalDateTrademark" class="form-input">
                        </div>
                         <div class="form-group full-width">
                            <label for="trademarkImage" class="form-label">Marka Görseli (JPG, PNG):</label>
                            <input type="file" id="trademarkImage" name="trademarkImage" accept="image/jpeg,image/png" style="display: none;">
                            <div class="image-upload-area" id="trademarkImageUploadArea">
                                <span class="image-upload-icon">🖼️</span>
                                <p>Görsel Yüklemek İçin Tıklayın veya Sürükleyin</p>
                            </div>
                            <img id="trademarkImagePreview" class="image-preview" src="#" alt="Görsel Önizleme" style="display: none;">
                            <button type="button" id="removeTrademarkImage" style="display: none; margin-top: 10px;" class="btn btn-secondary btn-small">Görseli Kaldır</button>
                        </div>
                    </div>
                    <div id="copyrightFields" class="dynamic-fields form-grid">
                        <div class="form-group">
                            <label for="copyrightType" class="form-label">Telif Hakkı Tipi:</label>
                            <input type="text" id="copyrightType" name="copyrightType" class="form-input">
                        </div>
                    </div>
                    <div id="designFields" class="dynamic-fields form-grid">
                        <div class="form-group">
                            <label for="designClass" class="form-label">Tasarım Sınıfı:</label>
                            <input type="text" id="designClass" name="designClass" class="form-input">
                        </div>
                        <div class="form-group date-picker-group">
                            <label for="renewalDateDesign" class="form-label">Yenileme Tarihi:</label>
                            <input type="date" id="renewalDateDesign" name="renewalDateDesign" class="form-input">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="description" class="form-label">Açıklama:</label>
                        <textarea id="description" name="description" class="form-textarea"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Hak Sahipleri:</label>
                        <div class="owner-selection-group">
                            <input type="text" id="ownerSearchInput" class="owner-search-input" placeholder="Hak Sahibi Ara...">
                             <div id="mainOwnerSearchResults" class="main-owner-search-results"></div> 
                            <button type="button" class="btn btn-secondary btn-small" id="searchOwnerBtn">Ara</button>
                            <button type="button" class="btn btn-primary btn-small" id="addPersonToOwnerBtn">Yeni Kişi Ekle</button>
                        </div>
                        <div id="selectedOwnersGrid" class="owner-grid"></div>
                    </div>
                    
                    <div class="form-actions full-width">
                        <button type="submit" class="btn btn-primary" id="saveRecordBtn">Kaydet</button>
                        <button type="button" class="btn btn-secondary" id="cancelRecordBtn">İptal</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script type="module">
        import { authService, ipRecordsService, personsService, auth } from './firebase-config.js';
        import { showNotification, readFileAsDataURL } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';
    
        class DataEntryModule {
            constructor() {
                this.selectedType = null;
                this.recordId = null;
                this.uploadedImage = null; // Holds the File object for new uploads
                this.existingImageUrl = null; // Holds the URL for existing images
                this.selectedOwners = [];
                this.allPersons = [];
            }
    
            async init() {
                this.currentUser = authService.getCurrentUser();
                if (!this.currentUser) {
                    window.location.href = 'index.html';
                    return;
                }
    
                const urlParams = new URLSearchParams(window.location.search);
                this.recordId = urlParams.get('id');

                // DÜZENLEME MODU KONTROLÜ
                if (this.recordId) {
                    document.querySelector('.page-title').textContent = 'Portföy Kaydı Güncelleme';
                    document.querySelector('.page-subtitle').textContent = 'Mevcut bir patent, marka, telif hakkı veya tasarım kaydını düzenleyin.';
                    document.getElementById('saveRecordBtn').textContent = 'Kaydı Güncelle';
                } else {
                    document.querySelector('.page-title').textContent = 'Yeni Kayıt Ekle';
                    document.querySelector('.page-subtitle').textContent = 'Yeni bir patent, marka, telif hakkı veya tasarım kaydı oluşturun.';
                    document.getElementById('saveRecordBtn').textContent = 'Kaydet';
                }
    
                await this.loadInitialData();
                this.setupEventListeners();
                this.populateStatusOptions(); // Initialize with no type
                
                if (this.recordId) {
                    await this.loadRecordForEdit(this.recordId);
                } else {
                    this.resetForm();
                }
            }
    
            async loadInitialData() {
                const personsResult = await personsService.getPersons();
                if (personsResult.success) {
                    this.allPersons = personsResult.data;
                } else {
                    showNotification('Kişiler yüklenemedi: ' + personsResult.error, 'error');
                }
            }
    
            setupEventListeners() {
                document.getElementById('type').addEventListener('change', this.handleTypeChange);
                document.getElementById('recordForm').addEventListener('submit', this.handleFormSubmit);
                document.getElementById('cancelRecordBtn').addEventListener('click', () => window.history.back());
    
                // Owner search and selection
                const ownerSearchInput = document.getElementById('ownerSearchInput');
                ownerSearchInput.addEventListener('keyup', this.handleOwnerSearch);
                document.getElementById('addPersonToOwnerBtn').addEventListener('click', () => window.location.href = 'persons.html');
                
                // Event delegation for dynamically created search results
                document.getElementById('mainOwnerSearchResults').addEventListener('click', (event) => {
                    if (event.target.classList.contains('search-result-item')) {
                        const personId = event.target.dataset.id;
                        this.addOwner(personId);
                        ownerSearchInput.value = '';
                        document.getElementById('mainOwnerSearchResults').style.display = 'none';
                    }
                });
            }
    
            handleTypeChange = (event) => {
                this.selectedType = event.target.value;
                this.toggleDynamicFields();
                this.populateStatusOptions();
            }
    
            toggleDynamicFields() {
                ['patentFields', 'trademarkFields', 'copyrightFields', 'designFields'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) {
                        el.classList.remove('show');
                    }
                });
    
                if (this.selectedType) {
                    const fieldsToShow = document.getElementById(this.selectedType + 'Fields');
                    if (fieldsToShow) {
                        fieldsToShow.classList.add('show');
                        if(this.selectedType === 'trademark') this.setupImageUploadListeners();
                    }
                }
            }
    
            populateStatusOptions() {
                const statusSelect = document.getElementById('status');
                statusSelect.innerHTML = '<option value="">Durum Seçin</option>';
    
                const statuses = {
                    patent: ['Başvuru', 'Yayınlandı', 'Onaylandı', 'Reddedildi', 'Süresi Doldu'],
                    trademark: ['Başvuru', 'Yayınlandı', 'Tescilli', 'Reddedildi', 'Kısmi Ret', 'Yenilenmedi', 'İtiraz Geldi', 'İtiraz Edildi', 'Başvuru Geçersiz/Hükümsüz', 'Yenilememe Nedeniyle Geçersiz'],
                    copyright: ['Beklemede', 'Tescilli', 'Süresi Doldu'],
                    design: ['Başvuru', 'Yayınlandı', 'Onaylandı', 'Reddedildi', 'Süresi Doldu']
                };
    
                const options = statuses[this.selectedType] || [];
                options.forEach(option => {
                    const value = option.toLowerCase().replace(/ /g, '_').replace(/\//g, '_');
                    statusSelect.add(new Option(option, value));
                });
            }
    
            setupImageUploadListeners() {
                const uploadArea = document.getElementById('trademarkImageUploadArea');
                const fileInput = document.getElementById('trademarkImage');
                const removeButton = document.getElementById('removeTrademarkImage');

                if (!uploadArea || !fileInput) return;

                uploadArea.addEventListener('click', () => fileInput.click());
                
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, this.preventDefaults, false);
                });

                ['dragenter', 'dragover'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => uploadArea.classList.add('drag-over'), false);
                });
                ['dragleave', 'drop'].forEach(eventName => {
                    uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('drag-over'), false);
                });

                uploadArea.addEventListener('drop', this.handleImageDrop, false);
                fileInput.addEventListener('change', this.handleImageSelect, false);
                removeButton.addEventListener('click', this.removeImage, false);
            }
    
            preventDefaults = (e) => {
                e.preventDefault();
                e.stopPropagation();
            }
    
            handleImageDrop = (e) => {
                const dt = e.dataTransfer;
                const files = dt.files;
                if(files.length > 0) {
                    this.handleImageFile(files[0]);
                }
            }
            
            handleImageSelect = (e) => {
                if(e.target.files.length > 0) {
                    this.handleImageFile(e.target.files[0]);
                }
            }
            
            handleImageFile(file) {
                if(file && file.type.startsWith('image/')) {
                    this.uploadedImage = file;
                    this.displayImagePreview(file);
                } else {
                    showNotification('Lütfen geçerli bir resim dosyası seçin (JPG, PNG).', 'error');
                }
            }
            
            displayImagePreview(fileOrUrl) {
                const preview = document.getElementById('trademarkImagePreview');
                const removeButton = document.getElementById('removeTrademarkImage');
                
                if (typeof fileOrUrl === 'string') { // URL
                    preview.src = fileOrUrl;
                } else { // File object
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                    };
                    reader.readAsDataURL(fileOrUrl);
                }
                preview.style.display = 'block';
                removeButton.style.display = 'inline-block';
            }

            removeImage = () => {
                const preview = document.getElementById('trademarkImagePreview');
                const removeButton = document.getElementById('removeTrademarkImage');
                const fileInput = document.getElementById('trademarkImage');

                preview.src = '#';
                preview.style.display = 'none';
                removeButton.style.display = 'none';
                fileInput.value = ''; // Reset file input
                this.uploadedImage = null;
                this.existingImageUrl = null;
            }

            handleOwnerSearch = (event) => {
                const searchTerm = event.target.value.toLowerCase();
                const resultsContainer = document.getElementById('mainOwnerSearchResults');
                resultsContainer.innerHTML = '';
    
                if (searchTerm.length < 2) {
                    resultsContainer.style.display = 'none';
                    return;
                }
    
                const filtered = this.allPersons.filter(person =>
                    person.name.toLowerCase().includes(searchTerm)
                );
    
                if (filtered.length > 0) {
                    filtered.forEach(person => {
                        const item = document.createElement('div');
                        item.classList.add('search-result-item');
                        item.textContent = `${person.name} (${person.personType === 'real' ? 'Gerçek' : 'Tüzel'})`;
                        item.dataset.id = person.id;
                        resultsContainer.appendChild(item);
                    });
                    resultsContainer.style.display = 'block';
                } else {
                    resultsContainer.style.display = 'none';
                }
            }
    
            addOwner(personId) {
                if (this.selectedOwners.find(p => p.id === personId)) {
                    showNotification('Bu kişi zaten eklenmiş.', 'info');
                    return;
                }
                const person = this.allPersons.find(p => p.id === personId);
                if (person) {
                    this.selectedOwners.push(person);
                    this.renderSelectedOwners();
                }
            }
    
            removeOwner(personId) {
                this.selectedOwners = this.selectedOwners.filter(p => p.id !== personId);
                this.renderSelectedOwners();
            }
    
            renderSelectedOwners() {
                const grid = document.getElementById('selectedOwnersGrid');
                grid.innerHTML = '';
                this.selectedOwners.forEach(person => {
                    const tag = document.createElement('div');
                    tag.classList.add('owner-tag');
                    tag.innerHTML = `
                        <span>${person.name}</span>
                        <button type="button" class="remove-owner" data-id="${person.id}">&times;</button>
                    `;
                    grid.appendChild(tag);
                });
    
                // Add event listeners to new remove buttons
                grid.querySelectorAll('.remove-owner').forEach(btn => {
                    btn.addEventListener('click', (e) => this.removeOwner(e.target.dataset.id));
                });
            }
    
            resetForm() {
                document.getElementById('recordForm').reset();
                this.selectedOwners = [];
                this.renderSelectedOwners();
                this.removeImage();
                this.toggleDynamicFields();
                this.populateStatusOptions();
            }
    
            async loadRecordForEdit(id) {
                const result = await ipRecordsService.getRecordById(id);
                if (result.success && result.data) {
                    const record = result.data;
                    document.getElementById('type').value = record.type;
                    this.selectedType = record.type;
                    this.toggleDynamicFields();
                    this.populateStatusOptions();
    
                    // Populate all form fields
                    Object.keys(record).forEach(key => {
                        const element = document.getElementById(key);
                        if (element && element.tagName !== 'SELECT') {
                           if(element.type !== 'file') element.value = record[key];
                        }
                    });
                    
                    if(record.status) document.getElementById('status').value = record.status;

                    if (record.trademarkImage) {
                        this.existingImageUrl = record.trademarkImage.content;
                        this.displayImagePreview(this.existingImageUrl);
                    }
                    
                    if (record.owners) {
                        this.selectedOwners = record.owners;
                        this.renderSelectedOwners();
                    }
                } else {
                    showNotification("Kayıt verileri yüklenemedi.", "error");
                    console.error(result.error);
                }
            }
    
            handleFormSubmit = async (event) => {
                event.preventDefault();
                document.getElementById('saveRecordBtn').disabled = true;
    
                try {
                    const form = event.target;
                    const formData = {
                        type: form.type.value,
                        title: form.title.value,
                        status: form.status.value,
                        applicationNumber: form.applicationNumber.value,
                        applicationDate: form.applicationDate.value,
                        registrationDate: form.registrationDate.value,
                        description: form.description.value,
                        owners: this.selectedOwners.map(p => ({ id: p.id, name: p.name, personType: p.personType })),
                        updatedAt: new Date().toISOString()
                    };
    
                    if (form.type.value === 'patent') {
                        formData.patentClass = form.patentClass.value;
                        formData.renewalDatePatent = form.renewalDatePatent.value;
                    } else if (form.type.value === 'trademark') {
                        formData.niceClass = form.niceClass.value;
                        formData.renewalDateTrademark = form.renewalDateTrademark.value;
                    } else if (form.type.value === 'copyright') {
                        formData.copyrightType = form.copyrightType.value;
                    } else if (form.type.value === 'design') {
                        formData.designClass = form.designClass.value;
                        formData.renewalDateDesign = form.renewalDateDesign.value;
                    }

                    if (this.uploadedImage) {
                        formData.trademarkImage = await readFileAsDataURL(this.uploadedImage);
                    } else if (this.existingImageUrl) {
                         formData.trademarkImage = { content: this.existingImageUrl, name: 'existing_image' };
                    } else {
                        formData.trademarkImage = null;
                    }
    
                    let result;
                    if (this.recordId) {
                        result = await ipRecordsService.updateRecord(this.recordId, formData);
                        showNotification('Kayıt başarıyla güncellendi!', 'success');
                    } else {
                        result = await ipRecordsService.addRecord(formData);
                        showNotification('Kayıt başarıyla eklendi!', 'success');
                    }
    
                    if (result.success) {
                        window.location.href = 'portfolio.html';
                    } else {
                        throw new Error(result.error);
                    }
    
                } catch (error) {
                    console.error('Kayıt kaydedilirken hata:', error);
                    showNotification('Kayıt kaydedilirken bir hata oluştu: ' + error.message, 'error');
                } finally {
                    document.getElementById('saveRecordBtn').disabled = false;
                }
            }
        }
    
        let dataEntryModule;
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'data-entry.html' });
    
            auth.onAuthStateChanged(async (user) => {
                if (user || authService.getCurrentUser()) {
                    if (!dataEntryModule) {
                        dataEntryModule = new DataEntryModule();
                        await dataEntryModule.init();
                        window.dataEntryModule = dataEntryModule;
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        });
    </script>
</body>
</html>