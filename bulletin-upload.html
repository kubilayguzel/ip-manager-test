<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BÃ¼lten YÃ¼kleme</title>
  <link rel="stylesheet" href="css/shared-styles.css" />
  <style>
    /* SayfanÄ±n tamamÄ±nÄ± kaplamasÄ± iÃ§in container geniÅŸletildi */
    .main-container {
      max-width: 100%;
      padding: 30px;
    }

    .bulletin-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .bulletin-section h2 {
      margin-bottom: 10px;
      color: #1e3c72;
    }
    .bulletin-section p {
      margin-bottom: 15px;
      color: #555;
    }
    
    /* Tablo stilleri */
    .bulletin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .bulletin-table th, .bulletin-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .bulletin-table th {
      background-color: #f2f2f2;
      color: #333;
    }
    .bulletin-table tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    .bulletin-table .delete-btn {
        background-color: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
    }
    .bulletin-table .delete-btn:hover {
        background-color: #c82333;
    }
  </style>
</head>
<body>
<div id="layout-placeholder"></div>
<div class="page-wrapper">
    <div class="main-container">
        <h1>BÃ¼lten YÃ¼kleme</h1>
        <p>Marka, patent ve tasarÄ±m bÃ¼ltenlerini ayrÄ± ayrÄ± yÃ¼kleyebilirsiniz.</p>

        <div class="bulletin-section">
            <h2>Marka BÃ¼lteni YÃ¼kleme</h2>
            <p>ZIP veya RAR formatÄ±ndaki marka bÃ¼lten arÅŸivinizi yÃ¼kleyin. Sistem iÃ§eriÄŸi analiz edecek.</p>
            <form id="bulletinUploadFormTrademark">
                <div class="file-upload-area" id="dropAreaTrademark">
                    <div class="upload-icon">ğŸ“‚</div>
                    <p>DosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n.</p>
                    <input type="file" id="bulletinFileTrademark" accept=".zip,.rar" style="display: none;" required />
                </div>
                <div id="selectedFileNameTrademark" style="margin-top:10px; font-weight:500; color:#333;"></div>
                <button type="submit" class="btn btn-primary" style="margin-top:20px;">Marka BÃ¼lteni YÃ¼kle</button>
            </form>
            <div id="uploadStatusTrademark" style="margin-top:20px;"></div>
            <div id="progressContainer" style="margin-top:10px; display:none;">
                <div style="background:#eee; border-radius:8px; overflow:hidden; height:20px;">
                    <div id="progressBar" style="height:100%; width:0%; background:#1e3c72; color:white; text-align:center; line-height:20px; font-size:12px;"></div>
                </div>
            </div>
            
            <div class="bulletin-table-container">
                <h3 style="margin-top: 30px; color: #1e3c72;">YÃ¼klÃ¼ Marka BÃ¼ltenleri</h3>
                <table class="bulletin-table" id="trademarkBulletinTable">
                    <thead>
                        <tr>
                            <th>BÃ¼lten No</th>
                            <th>BÃ¼lten Tarihi</th>
                            <th>YÃ¼klenme Tarihi</th>
                            <th>KayÄ±t SayÄ±sÄ±</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bulletin-section">
            <h2>Patent BÃ¼lteni YÃ¼kleme</h2>
            <p>Bu alan yakÄ±nda aktif olacaktÄ±r.</p>
            <button class="btn btn-secondary" disabled>YakÄ±nda</button>
        </div>
        <div class="bulletin-section">
            <h2>TasarÄ±m BÃ¼lteni YÃ¼kleme</h2>
            <p>Bu alan yakÄ±nda aktif olacaktÄ±r.</p>
            <button class="btn btn-secondary" disabled>YakÄ±nda</button>
        </div>
    </div>
</div>

<script type="module">
    import { loadSharedLayout } from './js/layout-loader.js';
    import { db, storage } from './firebase-config.js';
    // *** DÃœZELTME: writeBatch import edildi ***
    import { collection, getDocs, doc, deleteDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ref, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // DOM yÃ¼klendiÄŸinde layout'u ve bÃ¼ltenleri yÃ¼kle
    document.addEventListener('DOMContentLoaded', () => {
        loadSharedLayout({ activeMenuLink: 'bulletin-upload.html' });
        loadTrademarkBulletins();
    });

    // Firestore'dan marka bÃ¼ltenlerini Ã§eker ve tabloya ekler
    async function loadTrademarkBulletins() {
        const tableBody = document.querySelector("#trademarkBulletinTable tbody");
        tableBody.innerHTML = '<tr><td colspan="5">YÃ¼kleniyor...</td></tr>';

        try {
            const bulletinsSnapshot = await getDocs(collection(db, "trademarkBulletins"));
            const bulletins = [];
            for (const docSnapshot of bulletinsSnapshot.docs) {
                const bulletinData = { id: docSnapshot.id, ...docSnapshot.data() };
                
                // BÃ¼ltene ait kayÄ±t sayÄ±sÄ±nÄ± bul
                const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", docSnapshot.id));
                const recordsSnapshot = await getDocs(recordsQuery);
                bulletinData.recordCount = recordsSnapshot.size;

                bulletins.push(bulletinData);
            }

            tableBody.innerHTML = ''; // Tabloyu temizle
            if (bulletins.length === 0) {
                 tableBody.innerHTML = '<tr><td colspan="5">HenÃ¼z yÃ¼klenmiÅŸ bir bÃ¼lten bulunmuyor.</td></tr>';
                 return;
            }

            bulletins.forEach(b => {
                const tr = document.createElement('tr');
                const uploadDate = b.createdAt && b.createdAt.toDate ? b.createdAt.toDate().toLocaleDateString('tr-TR') : 'Bilinmiyor';
                tr.innerHTML = `
                    <td>${b.bulletinNo || 'N/A'}</td>
                    <td>${b.bulletinDate || 'N/A'}</td>
                    <td>${uploadDate}</td>
                    <td>${b.recordCount}</td>
                    <td><button class="delete-btn" data-id="${b.id}" data-no="${b.bulletinNo}">Sil</button></td>
                `;
                tableBody.appendChild(tr);
            });

        } catch (error) {
            console.error("BÃ¼ltenler yÃ¼klenirken hata:", error);
            tableBody.innerHTML = '<tr><td colspan="5">BÃ¼ltenler yÃ¼klenirken bir hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.</td></tr>';
        }
    }
    
    // Tablodaki "Sil" butonlarÄ±na tÄ±klama olayÄ±nÄ± dinle
    document.querySelector("#trademarkBulletinTable").addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-btn')) {
            const bulletinId = e.target.dataset.id;
            const bulletinNo = e.target.dataset.no;
            
            if (confirm(`'${bulletinNo}' numaralÄ± bÃ¼lteni ve tÃ¼m iliÅŸkili verileri silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.`)) {
                e.target.disabled = true;
                e.target.textContent = "Siliniyor...";
                await deleteBulletin(bulletinId, bulletinNo);
            }
        }
    });

    // BÃ¼lteni, kayÄ±tlarÄ±nÄ± ve Storage'daki dosyalarÄ±nÄ± silen ana fonksiyon
    async function deleteBulletin(bulletinId, bulletinNo) {
        console.log(`Silme iÅŸlemi baÅŸlatÄ±ldÄ±: BÃ¼lten ID ${bulletinId}, No ${bulletinNo}`);
        
        // 1. Ä°lgili kayÄ±tlarÄ± Firestore'dan toplu olarak sil
        try {
            const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletinId));
            const recordsSnapshot = await getDocs(recordsQuery);
            if (recordsSnapshot.size > 0) {
                const batch = writeBatch(db);
                recordsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();
                console.log(`${recordsSnapshot.size} adet bÃ¼lten kaydÄ± silindi.`);
            } else {
                console.log("Silinecek bÃ¼lten kaydÄ± bulunamadÄ±.");
            }
        } catch (error) {
            console.error("BÃ¼lten kayÄ±tlarÄ± silinirken hata:", error);
            alert("Hata: BÃ¼lten kayÄ±tlarÄ± silinemedi.");
            return; // Hata durumunda iÅŸlemi durdur
        }

        // 2. Storage'daki ilgili bÃ¼lten klasÃ¶rÃ¼nÃ¼ ve iÃ§indeki gÃ¶rselleri sil
        try {
            const imagesFolderRef = ref(storage, `bulletins/trademark_${bulletinNo}_images`);
            const res = await listAll(imagesFolderRef);
            await Promise.all(res.items.map(itemRef => deleteObject(itemRef)));
            console.log(`Storage'dan ${res.items.length} adet gÃ¶rsel silindi.`);
        } catch (error) {
            console.error("Storage'daki gÃ¶rseller silinirken hata:", error);
            // Bu hata kritik olmayabilir, ana bÃ¼lten kaydÄ±nÄ±n silinmesine engel olmamalÄ±.
        }

        // 3. Ana bÃ¼lten dÃ¶kÃ¼manÄ±nÄ± Firestore'dan sil
        try {
            await deleteDoc(doc(db, "trademarkBulletins", bulletinId));
            console.log("Ana bÃ¼lten belgesi baÅŸarÄ±yla silindi.");
        } catch (error) {
            console.error("Ana bÃ¼lten belgesi silinirken hata:", error);
            alert("Hata: Ana bÃ¼lten belgesi silinemedi.");
            return;
        }

        alert("BÃ¼lten ve tÃ¼m verileri baÅŸarÄ±yla silindi.");
        loadTrademarkBulletins(); // Silme sonrasÄ± tabloyu yenile
    }

</script>
<script type="module" src="js/bulletin-upload.js"></script>
</body>
</html>