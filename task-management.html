<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒ∞≈ü Y√∂netimi - IP Manager</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .sidebar { width: 250px; background: #1e3c72; color: white; position: fixed; left: 0; top: 0; height: 100%; overflow-y: auto; z-index: 1000; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid #2a4f8b; }
        .sidebar-logo { color: white; text-decoration: none; font-size: 1.3em; font-weight: bold; }
        .sidebar-nav { padding: 15px 0; }
        .sidebar-nav-item { display: flex; align-items: center; padding: 12px 20px; color: #b3c6ff; text-decoration: none; transition: all 0.3s; }
        .sidebar-nav-item:hover, .sidebar-nav-item.active { background: #2a4f8b; color: white; }
        .nav-icon { margin-right: 10px; font-size: 1.1em; }
        .nav-category-title { padding: 15px 20px 8px; font-size: 0.9em; color: #7a92d1; font-weight: 600; text-transform: uppercase; }
        .accordion { margin: 5px 0; }
        .accordion-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; color: #b3c6ff; cursor: pointer; transition: all 0.3s; }
        .accordion-header:hover { background: #2a4f8b; color: white; }
        .accordion-header.active { background: #2a4f8b; color: white; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; background: #2a4f8b; }
        .accordion-content a { display: block; padding: 10px 20px 10px 50px; color: #b3c6ff; text-decoration: none; font-size: 0.9em; transition: all 0.3s; }
        .accordion-content a:hover, .accordion-content a.active { background: #3c5a8f; color: white; }
        .new-task-link { color: #ffd93d !important; font-weight: 600; }
        .page-wrapper { margin-left: 250px; min-height: 100vh; }
        .top-header { background: white; padding: 15px 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; justify-content: flex-end; align-items: center; }
        .user-section { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 40px; height: 40px; background: #667eea; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .user-info { }
        .user-name { font-weight: 600; color: #333; }
        .user-role { font-size: 0.85em; color: #666; }
        .logout-btn { background: #ff6b6b; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .main-container { padding: 30px; }
        .page-header { text-align: center; margin-bottom: 30px; }
        .page-title { color: white; font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
        .page-subtitle { color: rgba(255,255,255,0.8); font-size: 1.1em; }
        .tasks-container { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .tasks-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #f1f3f4; padding-bottom: 15px; }
        .filter-group { display: flex; align-items: center; gap: 15px; }
        .filter-label { font-weight: 600; color: #1e3c72; }
        .filter-select { padding: 10px 15px; border: 2px solid #e1e8ed; border-radius: 10px; background: white; font-weight: 500; }
        .filter-select:focus { outline: none; border-color: #667eea; }
        .btn-primary { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-primary:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-reassign { background: #28a745; }
        .btn-reassign:hover { background: #218838; }
        .table-container { background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .task-table { width: 100%; border-collapse: collapse; }
        .task-table th { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 18px 15px; text-align: left; font-weight: 600; font-size: 0.95em; }
        .task-table td { padding: 15px; border-bottom: 1px solid #f1f3f4; }
        .task-table tr:hover { background: #f8f9fa; }
        .status-badge { padding: 6px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; text-transform: uppercase; }
        .status-open { background: #ffc107; color: #856404; }
        .status-in-progress { background: #17a2b8; color: white; }
        .status-completed { background: #28a745; color: white; }
        .status-blocked { background: #dc3545; color: white; }
        .task-actions { display: flex; gap: 8px; }
        .task-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; transition: all 0.3s; }
        .btn-view { background: #17a2b8; color: white; }
        .btn-edit { background: #ffc107; color: #856404; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-accrual { background: #6f42c1; color: white; }
        .task-actions button:hover { transform: translateY(-1px); opacity: 0.9; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1003; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content, .modal-content-lg { background: white; border-radius: 20px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal-content-lg { max-width: 800px; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 25px 30px 15px; border-bottom: 2px solid #f1f3f4; }
        .modal-title { font-size: 1.4em; color: #1e3c72; font-weight: 700; }
        .close-modal-btn { background: none; border: none; font-size: 1.8em; cursor: pointer; color: #666; }
        .modal-body-content { padding: 25px 30px; }
        .modal-footer { padding: 15px 30px 25px; border-top: 2px solid #f1f3f4; display: flex; gap: 15px; justify-content: flex-end; }
        .btn { padding: 12px 25px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; transition: border-color 0.3s; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #667eea; }
        .form-textarea { resize: vertical; min-height: 100px; }
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .modal-detail-item { }
        .modal-detail-item.full-width { grid-column: 1 / -1; }
        .modal-detail-label { font-weight: 600; color: #1e3c72; margin-bottom: 5px; }
        .modal-detail-value { color: #333; }
        .modal-detail-value.long-text { background: #f8f9fa; padding: 15px; border-radius: 8px; white-space: pre-wrap; }
        .modal-detail-section-title { grid-column: 1 / -1; font-size: 1.2em; color: #1e3c72; margin: 25px 0 15px; padding-bottom: 8px; border-bottom: 2px solid #e1e8ed; }
        .task-history { }
        .task-history-item { margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 4px solid #667eea; }
        .task-history-item-content { }
        .task-history-info { }
        .task-history-description { font-weight: 600; color: #333; margin-bottom: 5px; }
        .task-history-meta { font-size: 0.9em; color: #666; }
        .related-accrual-item { background: #f8f9fa; padding: 10px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9em; border-left: 3px solid #1e3c72; }
        .status-badge.status-paid { background-color: #28a745; }
        .status-badge.status-unpaid { background-color: #dc3545; }
        .input-with-currency { display: flex; gap: 10px; }
        .input-with-currency .form-input { flex-grow: 1; }
        .currency-select { padding: 12px 8px; border: 2px solid #e1e8ed; border-radius: 10px; background-color: #f8f9fa; font-weight: bold; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 500; }
        .checkbox-label input { width: 18px; height: 18px; }
        .total-amount-display { font-size: 1.2em; font-weight: bold; color: #1e3c72; text-align: right; margin-top: 10px; padding: 12px 15px; background-color: #f0f4f8; border-radius: 10px; }
        .search-results-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background-color: #f0f4f8; }
        .search-result-display { background: #e9f5ff; border: 1px solid #bde0fe; padding: 10px; border-radius: 8px; margin-top: 10px; }
        #loadingIndicator { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 9999; text-align: center; }
        .no-records-message { text-align: center; padding: 50px; color: #666; font-size: 1.1em; }
    </style>
</head>
<body>
    <div id="loadingIndicator">
        <div style="font-size: 1.2em; color: #1e3c72; margin-bottom: 15px;">üìã Veriler Y√ºkleniyor...</div>
        <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <aside class="sidebar">
        <div class="sidebar-header">
            <a class="sidebar-logo" href="dashboard.html">üî• IP Manager</a>
        </div>
        <nav class="sidebar-nav">
            <div class="nav-category-title">Ana Men√º</div>
            <a class="sidebar-nav-item" href="dashboard.html"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
            <a class="sidebar-nav-item" href="portfolio.html"><span class="nav-icon">üìã</span><span>Portf√∂y</span></a>
            <div class="nav-category-title">Veri Giri≈üi</div>
            <a class="sidebar-nav-item" href="data-entry.html"><span class="nav-icon">‚ûï</span><span>Yeni Kayƒ±t</span></a>
            <a class="sidebar-nav-item" href="excel-upload.html"><span class="nav-icon">üìÑ</span><span>Excel ile Y√ºkle</span></a>
            <div class="nav-category-title">Y√∂netim</div>
            <div class="accordion">
                <div class="accordion-header"><span class="nav-icon">‚öôÔ∏è</span><span>Y√∂netim</span></div>
                <div class="accordion-content">
                    <a class="new-task-link" href="create-task.html">Yeni ƒ∞≈ü Olu≈ütur</a>
                    <a href="task-management.html">ƒ∞≈ü Y√∂netimi</a>
                    <a href="my-tasks.html">ƒ∞≈ülerim</a>
                    <a href="persons.html">Ki≈üiler Y√∂netimi</a>
                    <a href="user-management.html">Kullanƒ±cƒ± Y√∂netimi</a>
                </div>
            </div>
            <div class="nav-category-title">Finans</div>
            <a href="accruals.html" class="sidebar-nav-item"><span class="nav-icon">üí∞</span><span>Tahakkuklarƒ±m</span></a>
            <div class="nav-category-title">Ara√ßlar</div>
            <a class="sidebar-nav-item" href="indexing.html"><span class="nav-icon">üìÅ</span><span>Belge ƒ∞ndeksleme</span></a>
            <a class="sidebar-nav-item" href="#" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">üìà</span><span>Raporlar</span></a>
            <a class="sidebar-nav-item" href="#" style="opacity: 0.5; cursor: not-allowed;"><span class="nav-icon">üîß</span><span>Ayarlar</span></a>
        </nav>
    </aside>

    <div class="page-wrapper">
        <header class="top-header">
            <div class="user-section">
                <div class="user-avatar" id="userAvatar">?</div>
                <div class="user-info">
                    <div class="form-group">
                        <label for="serviceInvoicePartySearch" class="form-label">Hizmet Faturasƒ± Tarafƒ±</label>
                        <input type="text" id="serviceInvoicePartySearch" class="form-input" placeholder="Fatura tarafƒ± arayƒ±n...">
                        <div id="serviceInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedServiceInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="taskManagementModule.closeModal('addAccrualModal')">ƒ∞ptal</button>
                    <button type="button" class="btn btn-primary" id="saveAccrualBtn">Tahakkuk Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/services/taskService.js"></script>
    <script src="js/services/ipRecordsService.js"></script>
    <script src="js/services/personsService.js"></script>
    <script src="js/services/accrualService.js"></script>
    <script>
        class TaskManagementModule {
            constructor() {
                this.allTasks = [];
                this.allUsers = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.allAccruals = [];
                this.selectedTasks = new Set();
                this.currentEditTask = null;
                this.uploadedEditFiles = [];
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                this.isSavingAccrual = false; // Duplikasyon korumasƒ±
            }

            // Para birimi kodunu standart hale getiren fonksiyon
            normalizeCurrencyCode(currency) {
                const currencyMap = {
                    'TL': 'TRY',
                    'tl': 'TRY',
                    'try': 'TRY'
                };
                return currencyMap[currency] || currency;
            }

            // G√ºvenli para birimi formatƒ± fonksiyonu
            formatCurrencyAmount(amount, currency) {
                try {
                    const normalizedCurrency = this.normalizeCurrencyCode(currency || 'TL');
                    return new Intl.NumberFormat('tr-TR', { 
                        style: 'currency', 
                        currency: normalizedCurrency 
                    }).format(amount || 0);
                } catch (error) {
                    console.warn('Currency formatting error:', error);
                    // Fallback: Sadece sayƒ± + para birimi simgesi
                    return `${(amount || 0).toFixed(2)} ${currency || 'TL'}`;
                }
            }

            async init() {
                await this.loadInitialData();
                this.setupEventListeners();
                this.setupAccordionMenu();
            }

            setupAccordionMenu() {
                const accordions = document.querySelectorAll('.accordion-header');
                accordions.forEach(accordion => {
                    accordion.addEventListener('click', function(event) {
                        this.classList.toggle('active');
                        const content = this.nextElementSibling;
                        if (content.style.maxHeight) {
                            content.style.maxHeight = null;
                        } else {
                            content.style.maxHeight = content.scrollHeight + "px";
                        }
                    });
                });

                // Aktif men√º ayarlama
                const currentPage = window.location.pathname.split("/").pop() || 'task-management.html';
                document.querySelectorAll('.sidebar-nav-item.active, .accordion-content a.active').forEach(el => el.classList.remove('active'));
                
                const activeLink = document.querySelector(`.sidebar-nav a[href="${currentPage}"]`);
                if (activeLink) {
                    activeLink.classList.add('active');
                    const parentAccordionContent = activeLink.closest('.accordion-content');
                    if (parentAccordionContent) {
                        const parentAccordionHeader = parentAccordionContent.previousElementSibling;
                        if (parentAccordionHeader && parentAccordionHeader.classList.contains('accordion-header')) {
                            parentAccordionHeader.classList.add('active');
                            parentAccordionContent.style.maxHeight = parentAccordionContent.scrollHeight + "px";
                        }
                    }
                }
            }

            setupEventListeners() {
                // Tahakkuk kaydetme
                const saveAccrualBtn = document.getElementById('saveAccrualBtn');
                if (saveAccrualBtn) {
                    saveAccrualBtn.removeEventListener('click', this.handleSaveAccrual);
                    saveAccrualBtn.addEventListener('click', this.handleSaveAccrual.bind(this));
                }

                // Form submit olayƒ±nƒ± √∂nle
                const addAccrualForm = document.getElementById('addAccrualForm');
                if (addAccrualForm) {
                    addAccrualForm.removeEventListener('submit', this.preventFormSubmit);
                    addAccrualForm.addEventListener('submit', this.preventFormSubmit);
                }

                // Filtreler
                document.getElementById('userFilter').addEventListener('change', () => this.renderTaskTable());
                document.getElementById('statusFilter').addEventListener('change', () => this.renderTaskTable());

                // Modal kapatma
                document.getElementById('closeViewTaskDetailModal').addEventListener('click', () => this.closeModal('viewTaskDetailModal'));
                document.getElementById('closeEditTaskModal').addEventListener('click', () => this.closeModal('editTaskModal'));
                document.getElementById('closeReassignModal').addEventListener('click', () => this.closeModal('reassignTaskModal'));
                document.getElementById('closeAddAccrualModal').addEventListener('click', () => this.closeModal('addAccrualModal'));

                // Butonlar
                document.getElementById('createTaskBtn').addEventListener('click', () => window.location.href = 'create-task.html');
                document.getElementById('reassignBtn').addEventListener('click', () => this.showReassignModal());
                document.getElementById('confirmReassignBtn').addEventListener('click', () => this.confirmReassign());
                document.getElementById('cancelReassignBtn').addEventListener('click', () => this.closeModal('reassignTaskModal'));
                document.getElementById('saveEditTaskBtn').addEventListener('click', () => this.saveTaskChanges());
                document.getElementById('cancelEditTaskBtn').addEventListener('click', () => this.closeModal('editTaskModal'));

                // Se√ßim
                document.getElementById('selectAllCheckbox').addEventListener('change', (e) => this.toggleSelectAll(e.target.checked));

                // KDV hesaplama
                ['officialFee', 'serviceFee', 'vatRate', 'applyVatToOfficialFee'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', () => this.calculateTotalAmount());
                        element.addEventListener('change', () => this.calculateTotalAmount());
                    }
                });

                // Ki≈üi arama
                document.getElementById('tpInvoicePartySearch')?.addEventListener('input', (e) => {
                    this.searchPersons(e.target.value, 'tpInvoiceParty');
                });
                document.getElementById('serviceInvoicePartySearch')?.addEventListener('input', (e) => {
                    this.searchPersons(e.target.value, 'serviceInvoiceParty');
                });

                // Logout
                document.getElementById('logoutBtn')?.addEventListener('click', () => {
                    authService.signOut();
                    window.location.href = 'index.html';
                });
            }

            preventFormSubmit(event) {
                event.preventDefault();
                return false;
            }

            async loadInitialData() {
                try {
                    document.getElementById('loadingIndicator').style.display = 'block';
                    
                    const currentUser = authService.getCurrentUser();
                    if (currentUser) {
                        document.getElementById('userName').textContent = currentUser.displayName || currentUser.email;
                        document.getElementById('userAvatar').textContent = (currentUser.displayName || currentUser.email).charAt(0).toUpperCase();
                    }

                    const [tasksResult, usersResult, ipRecordsResult, personsResult, accrualsResult] = await Promise.all([
                        taskService.getAllTasks(),
                        authService.getAllUsers(),
                        ipRecordsService.getAllRecords(),
                        personsService.getAllPersons(),
                        accrualService.getAllAccruals()
                    ]);

                    this.allTasks = tasksResult.success ? tasksResult.data : [];
                    this.allUsers = usersResult.success ? usersResult.data : [];
                    this.allIpRecords = ipRecordsResult.success ? ipRecordsResult.data : [];
                    this.allPersons = personsResult.success ? personsResult.data : [];
                    this.allAccruals = accrualsResult.success ? accrualsResult.data : [];

                    this.populateFilters();
                    this.renderTaskTable();
                } catch (error) {
                    console.error('Veri y√ºkleme hatasƒ±:', error);
                    alert('Veriler y√ºklenirken bir hata olu≈ütu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            populateFilters() {
                const userFilter = document.getElementById('userFilter');
                const statusFilter = document.getElementById('statusFilter');

                // Kullanƒ±cƒ± filtresi
                userFilter.innerHTML = '<option value="all">T√ºm Kullanƒ±cƒ±lar</option>';
                this.allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.displayName || user.email;
                    userFilter.appendChild(option);
                });

                // Durum filtresi
                statusFilter.innerHTML = `
                    <option value="all">T√ºm Durumlar</option>
                    <option value="open">A√ßƒ±k</option>
                    <option value="in-progress">Devam Ediyor</option>
                    <option value="completed">Tamamlandƒ±</option>
                    <option value="blocked">Engellendi</option>
                `;
            }

            renderTaskTable() {
                const tableBody = document.getElementById('tasksTableBody');
                const noRecordsMessage = document.getElementById('noRecordsMessage');
                const userFilter = document.getElementById('userFilter').value;
                const statusFilter = document.getElementById('statusFilter').value;

                tableBody.innerHTML = '';

                let filteredTasks = this.allTasks.filter(task => {
                    const userMatch = userFilter === 'all' || task.assignedTo_uid === userFilter;
                    const statusMatch = statusFilter === 'all' || task.status === statusFilter;
                    return userMatch && statusMatch;
                });

                if (filteredTasks.length === 0) {
                    noRecordsMessage.style.display = 'block';
                    return;
                }
                noRecordsMessage.style.display = 'none';

                filteredTasks.forEach(task => {
                    const row = document.createElement('tr');
                    
                    const statusClass = `status-${task.status}`;
                    const statusText = {
                        'open': 'A√ßƒ±k',
                        'in-progress': 'Devam Ediyor',
                        'completed': 'Tamamlandƒ±',
                        'blocked': 'Engellendi'
                    }[task.status] || task.status;

                    const assignedUser = this.allUsers.find(u => u.id === task.assignedTo_uid);
                    const assignedUserText = assignedUser ? (assignedUser.displayName || assignedUser.email) : task.assignedTo_email || '-';

                    const relatedRecord = this.allIpRecords.find(r => r.id === task.relatedIpRecordId);
                    const relatedRecordText = relatedRecord ? relatedRecord.title : '-';

                    row.innerHTML = `
                        <td><input type="checkbox" value="${task.id}" onchange="taskManagementModule.toggleTaskSelection('${task.id}', this.checked)"></td>
                        <td>${task.title || '-'}</td>
                        <td>${assignedUserText}</td>
                        <td>${relatedRecordText}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <div class="task-actions">
                                <button class="btn-view" onclick="taskManagementModule.viewTaskDetailsModal('${task.id}')" title="G√∂r√ºnt√ºle">üëÅÔ∏è</button>
                                <button class="btn-edit" onclick="taskManagementModule.showEditTaskModal('${task.id}')" title="D√ºzenle">‚úèÔ∏è</button>
                                <button class="btn-delete" onclick="taskManagementModule.deleteTask('${task.id}')" title="Sil">üóëÔ∏è</button>
                                <button class="btn-accrual" onclick="taskManagementModule.showAddAccrualModal('${task.id}')" title="Ek Tahakkuk">üí∞</button>
                            </div>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            toggleTaskSelection(taskId, checked) {
                if (checked) {
                    this.selectedTasks.add(taskId);
                } else {
                    this.selectedTasks.delete(taskId);
                }
                this.updateReassignButton();
            }

            toggleSelectAll(checked) {
                const checkboxes = document.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = checked;
                    this.toggleTaskSelection(cb.value, checked);
                });
            }

            updateReassignButton() {
                const reassignBtn = document.getElementById('reassignBtn');
                if (this.selectedTasks.size > 0) {
                    reassignBtn.style.display = 'inline-block';
                    reassignBtn.textContent = `${this.selectedTasks.size} ƒ∞≈üi Yeniden Ata`;
                } else {
                    reassignBtn.style.display = 'none';
                }
            }

            async deleteTask(taskId) {
                if (confirm('Bu i≈üi silmek istediƒüinizden emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
                    try {
                        const result = await taskService.deleteTask(taskId);
                        if (result.success) {
                            alert('G√∂rev ba≈üarƒ±yla silindi.');
                            this.selectedTasks.delete(taskId);
                            await this.loadInitialData();
                        } else {
                            throw new Error(result.error);
                        }
                    } catch (error) {
                        alert('G√∂rev silinirken bir hata olu≈ütu: ' + error.message);
                    }
                }
            }
            
            viewTaskDetailsModal(taskId) {
                const task = this.allTasks.find(t => t.id === taskId);
                if (!task) return alert('G√∂rev bulunamadƒ±.');
                this.populateModalTaskDetails(task, this.allIpRecords, this.allPersons);
                document.getElementById('viewTaskDetailModal').classList.add('show');
            }

            populateModalTaskDetails(task, ipRecords, persons) {
                document.getElementById('modalViewTaskTitle').textContent = `ƒ∞≈ü Detayƒ±: ${task.title || '-'}`;
                document.getElementById('modalViewTaskTitleValue').textContent = task.title || '-';
                document.getElementById('modalViewTaskDescriptionValue').textContent = task.description || '-';
                
                const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                const mainType = taskTypeParts[0] || '';
                const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('modalViewTaskTypeValue').textContent = `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}` || '-';

                const priorityMap = { high: 'Y√ºksek', medium: 'Orta', low: 'D√º≈ü√ºk' };
                document.getElementById('modalViewTaskPriorityValue').textContent = priorityMap[task.priority] || task.priority || '-';
                
                document.getElementById('modalViewAssignedToValue').textContent = task.assignedTo_email || '-';
                document.getElementById('modalViewTaskDueDateValue').textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-';

                let relatedIpRecordText = '-';
                if (task.relatedIpRecordId) {
                    const ipRecord = ipRecords.find(r => r.id === task.relatedIpRecordId);
                    relatedIpRecordText = ipRecord ? `${ipRecord.title} (${ipRecord.applicationNumber || 'No: Yok'})` : 'Bulunamadƒ±';
                }
                document.getElementById('modalViewRelatedIpRecordValue').textContent = relatedIpRecordText;

                // ƒ∞lgili taraf bilgisi
                const relatedPartyGroup = document.getElementById('modalViewRelatedPartyGroup');
                const relatedPartyLabel = document.getElementById('modalViewRelatedPartyLabel');
                const relatedPartyValue = document.getElementById('modalViewRelatedPartyValue');
                
                if (task.relatedPartyId && persons.length > 0) {
                    const relatedParty = persons.find(p => p.id === task.relatedPartyId);
                    if (relatedParty) {
                        relatedPartyGroup.style.display = 'block';
                        relatedPartyLabel.textContent = 'ƒ∞lgili Taraf';
                        relatedPartyValue.textContent = relatedParty.name;
                    } else {
                        relatedPartyGroup.style.display = 'none';
                    }
                } else {
                    relatedPartyGroup.style.display = 'none';
                }

                // ƒ∞li≈ükili tahakkuklar - D√úZELTƒ∞LMƒ∞≈û VERSƒ∞YON
                const modalViewRelatedAccruals = document.getElementById('modalViewRelatedAccruals');
                const relatedAccruals = this.allAccruals.filter(acc => acc.taskId === task.id);
                
                if (relatedAccruals.length > 0) {
                    modalViewRelatedAccruals.innerHTML = relatedAccruals.map(acc => {
                        const statusText = acc.status === 'paid' ? '√ñdendi' : '√ñdenmedi';
                        const statusBadgeClass = acc.status === 'paid' ? 'status-completed' : 'status-open';
                        
                        // HATA D√úZELTƒ∞LDƒ∞: formatCurrencyAmount kullanƒ±lƒ±yor
                        const totalAmountText = this.formatCurrencyAmount(acc.totalAmount, acc.totalAmountCurrency);
                        
                        return `<div class="related-accrual-item">
                            <b>ID:</b> ${acc.id.substring(0,8)}... | 
                            <b>Durum:</b> <span class="status-badge ${statusBadgeClass}">${statusText}</span> | 
                            <b>Tutar:</b> ${totalAmountText}
                        </div>`;
                    }).join('');
                } else {
                    modalViewRelatedAccruals.innerHTML = '<p>Bu i≈üe ait tahakkuk bulunmuyor.</p>';
                }

                // ƒ∞≈ülem ge√ßmi≈üi
                const modalViewTaskHistory = document.getElementById('modalViewTaskHistory');
                modalViewTaskHistory.innerHTML = '';
                if (!task.history || task.history.length === 0) {
                    modalViewTaskHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ƒ∞≈ülem ge√ßmi≈üi bulunmuyor.</p>';
                } else {
                    const sortedHistory = [...task.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedHistory.forEach(entry => {
                        const item = document.createElement('div');
                        item.className = 'task-history-item';
                        item.innerHTML = `<div class="task-history-item-content"><div class="task-history-info"><div class="task-history-description">${entry.action}</div><div class="task-history-meta">${new Date(entry.timestamp).toLocaleString('tr-TR')} by ${entry.userEmail}</div></div></div>`;
                        modalViewTaskHistory.appendChild(item);
                    });
                }
            }
            
            showEditTaskModal(taskId) {
                const task = this.allTasks.find(t => t.id === taskId);
                if (!task) return alert('D√ºzenlenecek g√∂rev bulunamadƒ±.');

                this.currentEditTask = { ...task }; 
                this.uploadedEditFiles = []; 

                document.getElementById('editTaskId').value = task.id;
                document.getElementById('modalEditTaskTitle').value = task.title || '';
                document.getElementById('modalEditTaskDescription').value = task.description || '';
                document.getElementById('modalEditTaskDueDate').value = task.dueDate || '';

                const prioritySelect = document.getElementById('modalEditTaskPriority');
                prioritySelect.innerHTML = '';
                const priorities = { low: 'D√º≈ü√ºk', medium: 'Orta', high: 'Y√ºksek' };
                for (const [key, value] of Object.entries(priorities)) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = value;
                    if (key === task.priority) option.selected = true;
                    prioritySelect.appendChild(option);
                }

                const assignedToSelect = document.getElementById('modalEditAssignedTo');
                assignedToSelect.innerHTML = '';
                this.allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.displayName || user.email;
                    if (user.id === task.assignedTo_uid) option.selected = true;
                    assignedToSelect.appendChild(option);
                });

                document.getElementById('editTaskModal').classList.add('show');
            }

            async saveTaskChanges() {
                const taskId = document.getElementById('editTaskId').value;
                const newAssignedToUid = document.getElementById('modalEditAssignedTo').value;
                const newAssignedToUser = this.allUsers.find(u => u.id === newAssignedToUid);

                const updates = {
                    title: document.getElementById('modalEditTaskTitle').value.trim(),
                    description: document.getElementById('modalEditTaskDescription').value.trim(),
                    priority: document.getElementById('modalEditTaskPriority').value,
                    assignedTo_uid: newAssignedToUid,
                    assignedTo_email: newAssignedToUser.email,
                    dueDate: document.getElementById('modalEditTaskDueDate').value,
                    files: (this.currentEditTask.files || []).concat(this.uploadedEditFiles)
                };

                try {
                    const result = await taskService.updateTask(taskId, updates);
                    if (result.success) {
                        alert('ƒ∞≈ü ba≈üarƒ±yla g√ºncellendi!');
                        this.closeModal('editTaskModal');
                        await this.loadInitialData();
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('ƒ∞≈ü g√ºncelleme hatasƒ±:', error);
                    alert('ƒ∞≈ü g√ºncellenirken bir hata olu≈ütu: ' + error.message);
                }
            }

            showReassignModal() {
                if (this.selectedTasks.size === 0) {
                    alert('L√ºtfen √∂nce atanacak i≈üleri se√ßin.');
                    return;
                }

                const reassignUserSelect = document.getElementById('reassignUserSelect');
                reassignUserSelect.innerHTML = '';
                this.allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = user.displayName || user.email;
                    reassignUserSelect.appendChild(option);
                });

                document.getElementById('reassignTaskCount').textContent = this.selectedTasks.size;
                document.getElementById('reassignTaskModal').classList.add('show');
            }

            async confirmReassign() {
                const newAssignedToUid = document.getElementById('reassignUserSelect').value;
                if (!newAssignedToUid) {
                    alert('L√ºtfen yeni atanan ki≈üiyi se√ßin.');
                    return;
                }

                const newAssignedToUser = this.allUsers.find(u => u.id === newAssignedToUid);
                if (!newAssignedToUser) {
                    alert('Se√ßilen kullanƒ±cƒ± bulunamadƒ±.');
                    return;
                }

                try {
                    const promises = Array.from(this.selectedTasks).map(taskId => 
                        taskService.updateTask(taskId, {
                            assignedTo_uid: newAssignedToUid,
                            assignedTo_email: newAssignedToUser.email
                        })
                    );

                    await Promise.all(promises);
                    alert(`${this.selectedTasks.size} i≈ü ba≈üarƒ±yla ${newAssignedToUser.displayName || newAssignedToUser.email} ki≈üisine atandƒ±.`);
                    
                    this.selectedTasks.clear();
                    this.closeModal('reassignTaskModal');
                    await this.loadInitialData();
                } catch (error) {
                    console.error('Yeniden atama hatasƒ±:', error);
                    alert('ƒ∞≈üler yeniden atanƒ±rken bir hata olu≈ütu: ' + error.message);
                }
            }

            showAddAccrualModal(taskId) {
                const task = this.allTasks.find(t => t.id === taskId);
                if (!task) {
                    alert('Tahakkuk eklenecek i≈ü bulunamadƒ±.');
                    return;
                }
                
                document.getElementById('addAccrualForm').reset();
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                document.getElementById('selectedTpInvoicePartyDisplay').style.display = 'none';
                document.getElementById('selectedServiceInvoicePartyDisplay').style.display = 'none';
                document.getElementById('tpInvoicePartySearch').value = '';
                document.getElementById('serviceInvoicePartySearch').value = '';
                
                document.getElementById('accrualTaskId').value = taskId;
                document.getElementById('accrualTaskTitleDisplay').value = task.title;
                
                this.calculateTotalAmount();
                document.getElementById('addAccrualModal').classList.add('show');
            }

            // D√úZELTƒ∞LMƒ∞≈û handleSaveAccrual - Duplikasyon korumasƒ± ile
            async handleSaveAccrual() {
                // √áoklu tƒ±klama korumasƒ±
                if (this.isSavingAccrual) {
                    console.log('Tahakkuk kaydediliyor, l√ºtfen bekleyin...');
                    return;
                }
                
                this.isSavingAccrual = true;
                
                try {
                    const taskId = document.getElementById('accrualTaskId').value;
                    const task = this.allTasks.find(t => t.id === taskId);

                    const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                    const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                    
                    if (officialFee <= 0 && serviceFee <= 0) {
                        alert("L√ºtfen en az bir √ºcret girin.");
                        return;
                    }

                    // Buton deaktif et
                    const saveButton = document.getElementById('saveAccrualBtn');
                    if (saveButton) {
                        saveButton.disabled = true;
                        saveButton.textContent = 'Kaydediliyor...';
                    }

                    const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                    const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;
                    
                    let totalAmount;
                    if (applyVatToOfficial) {
                        totalAmount = (officialFee + serviceFee) * (1 + vatRate / 100);
                    } else {
                        totalAmount = officialFee + (serviceFee * (1 + vatRate / 100));
                    }

                    const accrualData = {
                        taskId: taskId,
                        taskTitle: task.title,
                        officialFee: {
                            amount: officialFee,
                            currency: this.normalizeCurrencyCode(document.getElementById('officialFeeCurrency').value)
                        },
                        serviceFee: {
                            amount: serviceFee,
                            currency: this.normalizeCurrencyCode(document.getElementById('serviceFeeCurrency').value)
                        },
                        vatRate,
                        applyVatToOfficialFee: applyVatToOfficial,
                        totalAmount,
                        totalAmountCurrency: 'TRY', // TL yerine TRY
                        tpInvoiceParty: this.selectedTpInvoiceParty ? 
                            {id: this.selectedTpInvoiceParty.id, name: this.selectedTpInvoiceParty.name} : null,
                        serviceInvoiceParty: this.selectedServiceInvoiceParty ? 
                            {id: this.selectedServiceInvoiceParty.id, name: this.selectedServiceInvoiceParty.name} : null,
                    };
                    
                    const result = await accrualService.addAccrual(accrualData);
                    if (result.success) {
                        alert('Yeni tahakkuk ba≈üarƒ±yla eklendi!');
                        
                        // Sadece ba≈üarƒ±lƒ± olursa listeye ekle (duplikasyonu √∂nler)
                        if (!this.allAccruals.find(acc => acc.id === result.data.id)) {
                            this.allAccruals.push(result.data);
                        }
                        
                        
                        // Sayfayƒ± yenile (en g√ºncel veri i√ßin)
                        await this.loadInitialData();
                    } else {
                        alert('Tahakkuk eklenirken hata olu≈ütu: ' + result.error);
                    }
                    
                } catch (error) {
                    console.error('Tahakkuk kaydetme hatasƒ±:', error);
                    alert('Beklenmeyen bir hata olu≈ütu: ' + error.message);
                } finally {
                    // Her durumda kilidi a√ß
                    this.isSavingAccrual = false;
                    
                    // Butonu tekrar aktif et
                    const saveButton = document.getElementById('saveAccrualBtn');
                    if (saveButton) {
                        saveButton.disabled = false;
                        saveButton.textContent = 'Tahakkuk Ekle';
                    }
                }
            }

            calculateTotalAmount() {
                const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;

                let total;
                if(applyVatToOfficial) {
                    total = (officialFee + serviceFee) * (1 + vatRate / 100);
                } else {
                    total = officialFee + (serviceFee * (1 + vatRate / 100));
                }
                
                // TL yerine TRY g√∂ster ama kullanƒ±cƒ± i√ßin TL yazsƒ±n
                const displayElement = document.getElementById('totalAmountDisplay');
                if (displayElement) {
                    displayElement.textContent = `${total.toFixed(2)} TL`;
                }
            }

            searchPersons(query, target) {
                const resultsContainerId = {
                    'tpInvoiceParty': 'tpInvoicePartyResults',
                    'serviceInvoiceParty': 'serviceInvoicePartyResults'
                }[target];
                const container = document.getElementById(resultsContainerId);
                if (!container) return;
                
                container.innerHTML = '';
                if (query.length < 2) { 
                    container.innerHTML = ''; 
                    return; 
                }
                
                const filtered = this.allPersons.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
                if (filtered.length === 0) { 
                    container.innerHTML = '<p class="no-results-message">Ki≈üi bulunamadƒ±.</p>'; 
                    return; 
                }

                filtered.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.textContent = p.name;
                    item.addEventListener('click', () => this.selectPerson(p, target));
                    container.appendChild(item);
                });
            }

            selectPerson(person, target) {
                if (target === 'tpInvoiceParty') {
                    this.selectedTpInvoiceParty = person;
                    document.getElementById('selectedTpInvoicePartyDisplay').innerHTML = `<strong>Se√ßilen:</strong> ${person.name}`;
                    document.getElementById('selectedTpInvoicePartyDisplay').style.display = 'block';
                    document.getElementById('tpInvoicePartyResults').innerHTML = '';
                } else if (target === 'serviceInvoiceParty') {
                    this.selectedServiceInvoiceParty = person;
                    document.getElementById('selectedServiceInvoicePartyDisplay').innerHTML = `<strong>Se√ßilen:</strong> ${person.name}`;
                    document.getElementById('selectedServiceInvoicePartyDisplay').style.display = 'block';
                    document.getElementById('serviceInvoicePartyResults').innerHTML = '';
                }
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                if (modalId === 'editTaskModal') {
                    this.currentEditTask = null;
                    this.uploadedEditFiles = [];
                }
                if (modalId === 'reassignTaskModal') {
                    document.getElementById('reassignUserSelect').value = '';
                }
                if (modalId === 'addAccrualModal') {
                    document.getElementById('addAccrualForm').reset();
                    this.selectedTpInvoiceParty = null;
                    this.selectedServiceInvoiceParty = null;
                }
            }
        }

        // Global instance
        const taskManagementModule = new TaskManagementModule();

        // Auth state listener
        auth.onAuthStateChanged(user => {
            if (user || authService.getCurrentUser()) {
                taskManagementModule.init();
                window.taskManagementModule = taskManagementModule;
            } else {
                window.location.href = 'index.html';
            }
        });

        // Modal click outside to close
        window.addEventListener('click', (event) => {
            const modals = ['viewTaskDetailModal', 'editTaskModal', 'reassignTaskModal', 'addAccrualModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    taskManagementModule.closeModal(modalId);
                }
            });
        });
    </script>
</body>
</html>="user-name" id="userName">Y√ºkleniyor...</div>
                    <div class="user-role" id="userRole">Kullanƒ±cƒ±</div>
                </div>
                <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
            </div>
        </header>

        <main class="main-container">
            <div id="viewContainer">
                <div id="taskListContainer">
                    <section class="page-header">
                        <h1 class="page-title">ƒ∞≈ü Akƒ±≈ü Y√∂netimi</h1>
                        <p class="page-subtitle">T√ºm i≈üleri g√∂r√ºnt√ºleyin, yeni i≈üler olu≈üturun ve atamalarƒ± y√∂netin.</p>
                    </section>
                    
                    <div class="tasks-container">
                        <div class="tasks-header">
                            <div class="filter-group">
                                <label class="filter-label" for="userFilter">Kullanƒ±cƒ±:</label>
                                <select class="filter-select" id="userFilter"></select>
                                <label class="filter-label" for="statusFilter">Durum:</label>
                                <select class="filter-select" id="statusFilter"></select>
                                <button class="btn-primary btn-reassign" id="reassignBtn" style="display: none;">Se√ßilenleri Ata</button>
                            </div>
                            <button class="btn-primary" id="createTaskBtn">‚ûï Yeni ƒ∞≈ü Olu≈ütur</button>
                        </div>
                        
                        <div class="table-container">
                            <table class="task-table">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllCheckbox"></th>
                                        <th>ƒ∞≈ü Ba≈ülƒ±ƒüƒ±</th>
                                        <th>Atanan Ki≈üi</th>
                                        <th>ƒ∞lgili Kayƒ±t</th>
                                        <th>Durum</th>
                                        <th>ƒ∞≈ülemler</th>
                                    </tr>
                                </thead>
                                <tbody id="tasksTableBody"></tbody>
                            </table>
                        </div>

                        <div id="noRecordsMessage" class="no-records-message" style="display: none;">
                            üìã Hen√ºz i≈ü bulunmuyor.
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ƒ∞≈ü Detaylarƒ± Modal -->
    <div class="modal" id="viewTaskDetailModal">
        <div class="modal-content-lg">
            <span class="close-modal-btn" id="closeViewTaskDetailModal">√ó</span>
            <h3 class="modal-title" id="modalViewTaskTitle">ƒ∞≈ü Detayƒ±</h3>
            <div class="modal-body-content">
                <div class="modal-detail-grid">
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">ƒ∞≈ü Ba≈ülƒ±ƒüƒ±</div><div class="modal-detail-value" id="modalViewTaskTitleValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">A√ßƒ±klama</div><div class="modal-detail-value long-text" id="modalViewTaskDescriptionValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">ƒ∞≈ü T√ºr√º</div><div class="modal-detail-value" id="modalViewTaskTypeValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">√ñncelik</div><div class="modal-detail-value" id="modalViewTaskPriorityValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Atanan Ki≈üi</div><div class="modal-detail-value" id="modalViewAssignedToValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Biti≈ü Tarihi</div><div class="modal-detail-value" id="modalViewTaskDueDateValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">ƒ∞lgili Portf√∂y Kaydƒ±</div><div class="modal-detail-value" id="modalViewRelatedIpRecordValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedPartyGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedPartyLabel"></div><div class="modal-detail-value" id="modalViewRelatedPartyValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedTransactionGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedTransactionLabel"></div><div class="modal-detail-value" id="modalViewRelatedTransactionValue"></div></div>
                    
                    <h4 class="modal-detail-section-title">ƒ∞li≈ükili Tahakkuklar</h4>
                    <div class="modal-detail-item full-width" id="modalViewRelatedAccruals">
                        <p style="text-align: center; color: #666;">Tahakkuk bilgisi bulunmuyor.</p>
                    </div>

                    <h4 class="modal-detail-section-title">ƒ∞≈ülem Ge√ßmi≈üi</h4>
                    <div class="modal-detail-item full-width task-history" id="modalViewTaskHistory">
                        <p style="text-align: center; color: #666;">ƒ∞≈ülem ge√ßmi≈üi bulunmuyor.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ƒ∞≈ü D√ºzenleme Modal -->
    <div id="editTaskModal" class="modal">
        <div class="modal-content-lg">
            <span class="close-modal-btn" id="closeEditTaskModal">&times;</span>
            <h3 class="modal-title">ƒ∞≈üi D√ºzenle</h3>
            <div class="modal-body-content">
                <input type="hidden" id="editTaskId">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="modalEditTaskTitle" class="form-label">ƒ∞≈ü Ba≈ülƒ±ƒüƒ±</label>
                        <input type="text" id="modalEditTaskTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="modalEditTaskPriority" class="form-label">√ñncelik</label>
                        <select id="modalEditTaskPriority" class="form-select"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="modalEditTaskDescription" class="form-label">A√ßƒ±klama</label>
                    <textarea id="modalEditTaskDescription" class="form-textarea"></textarea>
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="modalEditAssignedTo" class="form-label">Atanan Ki≈üi</label>
                        <select id="modalEditAssignedTo" class="form-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="modalEditTaskDueDate" class="form-label">Biti≈ü Tarihi</label>
                        <input type="date" id="modalEditTaskDueDate" class="form-input">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelEditTaskBtn">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" id="saveEditTaskBtn">Deƒüi≈üiklikleri Kaydet</button>
            </div>
        </div>
    </div>

    <!-- Yeniden Atama Modal -->
    <div class="modal" id="reassignTaskModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ƒ∞≈üleri Yeniden Ata</h3>
                <button class="close-modal-btn" id="closeReassignModal">&times;</button>
            </div>
            <div class="modal-body-content">
                <div class="form-group">
                    <label for="reassignUserSelect" class="form-label">Yeni Atanan Ki≈üi</label>
                    <select id="reassignUserSelect" class="form-select"></select>
                </div>
                <p><strong id="reassignTaskCount"></strong> adet i≈ü se√ßildi.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelReassignBtn">ƒ∞ptal</button>
                <button type="button" class="btn btn-primary" id="confirmReassignBtn">Atamayƒ± Onayla</button>
            </div>
        </div>
    </div>

    <!-- Ek Tahakkuk Modal -->
    <div class="modal" id="addAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeAddAccrualModal">&times;</span>
            <h3 class="modal-title">ƒ∞≈üe Yeni Tahakkuk Ekle</h3>
            <form id="addAccrualForm" onsubmit="return false;">
                <input type="hidden" id="accrualTaskId">
                <div class="modal-body-content">
                    <div class="form-group">
                        <label for="accrualTaskTitleDisplay" class="form-label">ƒ∞lgili ƒ∞≈ü</label>
                        <input type="text" id="accrualTaskTitleDisplay" class="form-input" readonly>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="officialFee" class="form-label">Resmi √úcret</label>
                            <div class="input-with-currency">
                                <input type="number" id="officialFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="officialFeeCurrency" class="currency-select">
                                    <option value="TRY" selected>TRY</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="serviceFee" class="form-label">Hizmet Bedeli</label>
                            <div class="input-with-currency">
                                <input type="number" id="serviceFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="serviceFeeCurrency" class="currency-select">
                                    <option value="TRY" selected>TRY</option>
                                    <option value="EUR">EUR</option>
                                    <option value="USD">USD</option>
                                    <option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vatRate" class="form-label">KDV Oranƒ± (%)</label>
                        <input type="number" id="vatRate" class="form-input" value="20">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="applyVatToOfficialFee" checked>
                            Resmi √úcrete KDV Uygula
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Toplam Tutar</label>
                        <div id="totalAmountDisplay" class="total-amount-display">0.00 TL</div>
                    </div>
                    <div class="form-group">
                        <label for="tpInvoicePartySearch" class="form-label">T√ºrk Patent Faturasƒ± Tarafƒ±</label>
                        <input type="text" id="tpInvoicePartySearch" class="form-input" placeholder="Fatura tarafƒ± arayƒ±n...">
                        <div id="tpInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedTpInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                    <div class