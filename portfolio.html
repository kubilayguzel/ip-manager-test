<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - PortfÃ¶y</title>
    <style>
        /* Bu sayfaya Ã¶zel stiller */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; color: #333; display: flex; }
        .page-wrapper { flex-grow: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); }
        .main-container { width: 100%; padding: 30px; margin: 0; }
        
        /* Portfolio specific styles */
        .page-header { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }

        .portfolio-controls {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px 30px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .filter-row { 
            display: flex;
            justify-content: flex-end;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .search-input { 
            margin-right: auto;
            flex-grow: 1; 
            min-width: 180px;
            padding: 10px 12px;
            box-sizing: border-box;
        }

        .tab-menu {
            display: flex;
            border-bottom: 2px solid #dee2e6;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .tab-button {
            padding: 10px 18px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1em;
            font-weight: 600;
            color: #6c757d;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s ease;
        }
        .tab-button:hover {
            color: #1e3c72;
        }
        .tab-button.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
        }

        .filter-group { 
            display: flex; 
            gap: 8px;
            align-items: center; 
        }
        .filter-label { font-weight: 500; }
        .filter-select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }

        .btn-add-record, .btn-primary, .btn-secondary, .btn-status-toggle { 
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-add-record:hover, .btn-primary:hover, .btn-secondary:hover, .btn-status-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.2);
        }
        .btn-status-toggle.activate {
             background-color: #28a745;
        }
        .btn-status-toggle.archive {
            background-color: #dc3545;
        }
        .btn-status-toggle:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .portfolio-table-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: visible; /* deÄŸiÅŸtirildi */
            position: relative; /* z-index iÃ§in gerekli */
            z-index: 1;
        }

        .portfolio-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Kolon geniÅŸliklerini sabitler */
        }

        .portfolio-table th,
        .portfolio-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap; /* Ä°Ã§eriÄŸin tek satÄ±rda kalmasÄ±nÄ± saÄŸlar */
            overflow: hidden;
            text-overflow: ellipsis; /* TaÅŸmayÄ± Ã¼Ã§ nokta ile gÃ¶ster */
        }

        .portfolio-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .portfolio-table tr:hover {
            background-color: #f6f8fa;
        }
        
        /* KayÄ±t durumu "pasif" olan kayÄ±tlar iÃ§in stil */
        .portfolio-table tr.record-status-pasif {
            opacity: 0.6;
            font-style: italic;
            background-color: #f0f0f0;
        }
        .portfolio-table tr.record-status-pasif:hover {
            opacity: 0.8;
            background-color: #e0e0e0;
        }

        /* BaÅŸvuru durumu etiketleri iÃ§in stil */
        .application-status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        .application-status-badge.beklemede {
            background-color: #ffc107;
            color: #333;
        }
        .application-status-badge.onaylandÄ± {
            background-color: #28a745;
        }
        .application-status-badge.reddedildi {
            background-color: #dc3545;
        }

        /* KayÄ±t durumu etiketleri iÃ§in stil */
        .record-active-status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            color: white;
            text-transform: uppercase;
        }
        .record-active-status-badge.aktif {
            background-color: #007bff;
        }
        .record-active-status-badge.pasif {
            background-color: #6c757d;
        }
        
        /* Kolon Filtre InputlarÄ± Ä°Ã§in Stil */
        .column-filter {
            width: calc(100% - 10px);
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85em;
            box-sizing: border-box;
            margin-top: 5px;
        }
        .portfolio-table th:has(> .column-filter) {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        /* Sorting icon style */
        .sortable-header {
            cursor: pointer;
            position: relative;
            padding-right: 20px;
        }
        .sortable-header::after {
            content: '';
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            border: 4px solid transparent;
        }
        .sortable-header.asc::after {
            border-top-color: #333;
        }
        .sortable-header.desc::after {
            border-bottom-color: #333;
        }
        .sortable-header.inactive::after {
            content: '\25B2\25BC';
            font-size: 0.7em;
            color: #ccc;
            line-height: 0.8;
            top: 50%;
            transform: translateY(-50%) scaleY(0.7);
        }

        /* Marka GÃ¶rseli Stilleri */
        .trademark-image-wrapper {
            position: relative;
            display: inline-block;
            overflow: visible;
            height: 50px;
            width: 50px;
            z-index: 1;
        }

        .trademark-image-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
            vertical-align: middle;
            transition: transform 0.5s cubic-bezier(0.23, 1, 0.32, 1), box-shadow 0.5s ease-out, border 0.5s ease-out;
            cursor: pointer;
            will-change: transform;
            transform-origin: center center;
            backface-visibility: hidden;
            image-rendering: -webkit-optimize-contrast;
            transform: translateZ(0) scale(1);
            filter: blur(0);
        }

        .trademark-image-wrapper:hover .trademark-image-thumbnail {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            border: 2px solid #1e3c72;
            background-color: white;
            padding: 2px;
            max-width: 300px;
            max-height: 300px;
            width: auto;
            height: auto;
        }

        .action-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            margin-right: 5px;
        }
        .action-btn:last-child { margin-right: 0; }
        .action-btn:hover { opacity: 0.9; }
        .action-btn.edit-btn { background-color: #ffc107; color: #212529; }
        .action-btn.edit-btn:hover { background-color: #e0a800; }
        .action-btn.delete-btn { background-color: #dc3545; }
        .action-btn.delete-btn:hover { background-color: #c82333; }
        .action-btn.view-btn { background-color: #17a2b8; }
        .action-btn.view-btn:hover { background-color: #138496; }

        .no-records, .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            width: 100%;
            display: block;
        }
        .loading { display: none; }

        /* Modal Styles (for record detail) */
        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1002;
            left: 0;
            top: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0, 0, 0, 0.6);
            overflow: auto;
            padding: 30px;
            box-sizing: border-box;
        }
        .modal.show { display: flex; }
        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border: 1px solid #888;
            width: 1250px;
            border-radius: 20px;
            animation-name: animatetop;
            animation-duration: 0.4s;
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .transaction-history .accordion-header {
            display: flex; /* Ä°Ã§eriÄŸi esnek kutu olarak dÃ¼zenle */
            align-items: center; /* Ã–ÄŸeleri dikeyde ortala */
            /* cursor: pointer; /* VarsayÄ±lan olarak kaldÄ±rÄ±n, sadece has-children iÃ§in JS ile eklenecek */
            padding: 12px 15px; /* Mevcut padding'i koru */
            background: #eaf2f8; /* Daha aÃ§Ä±k bir arka plan */
            color: #1e3c72;
            border-radius: 8px;
            margin-bottom: 5px;
            border: 1px solid #d0e7f7;
            font-weight: 600;
            gap: 10px; /* Ä°Ã§ Ã¶ÄŸeler arasÄ±nda boÅŸluk */
            cursor: default; /* VarsayÄ±lan imleÃ§ */
        }
        .transaction-history .accordion-header.has-children {
            cursor: pointer; /* Alt Ã¶ÄŸeleri varsa tÄ±klanabilir olsun */
        }
        .transaction-history .accordion-header::after {
            content: none !important; /* Ok iÅŸaretini kaldÄ±r */
        }
        .transaction-history .accordion-header::before {
            content: ''; /* VarsayÄ±lan olarak boÅŸ iÃ§erik (eÄŸer has-children yoksa) */
            margin-right: 0; /* VarsayÄ±lan olarak boÅŸluk yok */
            font-size: 1.2em; /* Ä°ÅŸaretin boyutu */
            color: #1e3c72; /* Ä°ÅŸaretin rengi */
            transition: content 0.3s ease, transform 0.3s ease; /* Ä°Ã§erik ve dÃ¶nÃ¼ÅŸÃ¼m iÃ§in geÃ§iÅŸ efekti */
            flex-shrink: 0; /* KÃ¼Ã§Ã¼lmesini engelle */
            width: 0; /* VarsayÄ±lan olarak geniÅŸlik yok */
            text-align: center; /* Ortala */
            transform: rotate(0deg); /* BaÅŸlangÄ±Ã§ta dÃ¶nÃ¼ÅŸ yok */
        }
        .transaction-history .accordion-header.has-children::before {
            content: '+'; /* VarsayÄ±lan olarak + iÅŸareti */
            display: inline-block;
            margin-right: 10px; /* Ä°ÅŸaret ile metin arasÄ±na boÅŸluk */
            width: 1em; /* Ä°ÅŸaret iÃ§in sabit bir geniÅŸlik ver (metin kaymasÄ±nÄ± engeller) */
        }
        .transaction-history .accordion-header.has-children.active::before {
            content: 'âˆ’'; /* Aktif olduÄŸunda - iÅŸareti */
        }
        .transaction-history .accordion-header:hover {
            background: #d8edf7;
        }
        .transaction-history .accordion-header .transaction-type {
            flex-grow: 1; /* BaÅŸlÄ±ÄŸÄ±n geniÅŸlemesini saÄŸlar */
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Gerekirse satÄ±r sonu */
            gap: 8px; /* Tarih ve yapan bilgisiyle arasÄ±nda boÅŸluk */
        }
        .transaction-history .accordion-header .transaction-meta {
            display: none; /* Mavi ÅŸeritte sadece inline olarak gÃ¶zÃ¼keceÄŸi iÃ§in bu kaldÄ±rÄ±lÄ±yor */
        }
        .transaction-history .accordion-header .transaction-meta-inline {
            font-size: 0.85em; /* Daha kÃ¼Ã§Ã¼k font */
            color: #4a6fa3; /* FarklÄ± bir renk */
            font-weight: normal;
        }
        .transaction-history .accordion-header .user-info {
            font-style: italic;
        }
        .transaction-history .accordion-content {
            max-height: 0; /* VarsayÄ±lan olarak kapalÄ± */
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out, border 0.3s ease-out, margin 0.3s ease-out;
            padding: 0 15px; /* BaÅŸlangÄ±Ã§ta padding sÄ±fÄ±r */
            border: none; /* BaÅŸlangÄ±Ã§ta kenarlÄ±k yok */
            margin-bottom: 0; /* BaÅŸlangÄ±Ã§ta alt boÅŸluk yok */
            background: #fdfefe;
            border-radius: 0 0 8px 8px;
        }.transaction-history .accordion-header.active + .accordion-content {
            max-height: 500px; /* Veya iÃ§eriÄŸe gÃ¶re daha bÃ¼yÃ¼k bir deÄŸer */
            padding: 10px 15px 5px 15px; /* AÃ§Ä±ldÄ±ÄŸÄ±nda padding */
            border: 1px solid #e1e8ed;
            border-top: none;
            margin-bottom: 10px; /* AÃ§Ä±ldÄ±ÄŸÄ±nda alt boÅŸluk */
        }
        .transaction-history .transaction-item {
            border-bottom: 1px dashed #f0f0f0;
            padding: 8px 0;
        }
        .transaction-history .transaction-item:last-child {
            border-bottom: none;
        }
        
        @keyframes animatetop { from {top: -300px; opacity: 0} to {top: 0; opacity: 1} }
        .close-modal-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .modal-title { font-size: 1.5em; color: #1e3c72; margin-bottom: 20px;}
        .modal-detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px 25px; }
        .modal-detail-item { margin-bottom: 10px; }
        .modal-detail-label { font-weight: 600; color: #333; margin-bottom: 5px; font-size: 0.9em; }
        .modal-detail-value { color: #555; word-break: break-word; font-size: 0.95em; }
        .modal-detail-value.long-text { white-space: pre-wrap; background-color: #f8f9fa; padding: 8px; border-radius: 6px; }
        .modal-detail-section-title { grid-column: 1 / -1; font-size: 1.1em; color: #1e3c72; margin-top: 20px; margin-bottom: 15px; padding-bottom: 5px; border-bottom: 1px dashed #e1e8ed; }
        .document-list { list-style: none; padding: 0; }
        .document-list li { margin-bottom: 8px; font-size: 0.95em;}
        .document-list li a { text-decoration: none; color: #1e3c72; display: flex; align-items: center; gap: 8px;}
        .document-list li a:hover { text-decoration: underline; }
        .document-list li .doc-icon { font-size: 1.2em; }
        .record-image-display { max-width: 100%; height: auto; border-radius: 8px; margin-top: 10px; border: 1px solid #eee; }
        .transaction-history { max-height: 300px; overflow-y: auto; }
        .transaction-item { padding: 8px 0; border-bottom: 1px dashed #eee; font-size: 0.9em; }
        .transaction-item:last-child { border-bottom: none; }
        .transaction-item div { margin-bottom: 3px; }
        .transaction-type { font-weight: 600; color: #333; }
        .transaction-meta { color: #666; }

    </style>
</head>
<body>
    <div id="notification-container" class="notification-container"></div>
    <div id="layout-placeholder"></div>
    <div class="page-wrapper">
        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">PortfÃ¶y YÃ¶netimi</h1>
                <p class="page-subtitle">TÃ¼m fikri mÃ¼lkiyet kayÄ±tlarÄ±nÄ±zÄ± burada gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin.</p>
            </section>
            
            <div class="portfolio-controls">
                <div class="tab-menu">
                    <button type="button" class="tab-button active" data-type="all">TÃ¼mÃ¼</button>
                    <button type="button" class="tab-button" data-type="patent">Patent</button>
                    <button type="button" class="tab-button" data-type="trademark">Marka</button>
                    <button type="button" class="tab-button" data-type="design">TasarÄ±m</button>
                    <button type="button" class="tab-button" data-type="objections">Ä°tirazlar</button>
                    <button type="button" class="tab-button" data-type="litigation">Davalar</button>
                    <button type="button" class="tab-button" data-type="thirdParty">3. Taraf DosyalarÄ±</button>
                </div>
                <div class="filter-row">
                    <input type="text" id="searchBar" class="search-input" placeholder="BaÅŸlÄ±k, numara, durum, hak sahibi ara...">
                    
                    <div class="filter-group">
                        <input type="checkbox" id="selectAllCheckbox">
                        <label for="selectAllCheckbox" class="filter-label">TÃ¼mÃ¼nÃ¼ SeÃ§</label>
                    </div>

                    <button type="button" class="btn-status-toggle" id="toggleRecordStatusBtn" disabled>
                        Aktif/Pasif
                    </button>
                    <button type="button" class="btn-status-toggle" id="addToMonitoringBtn" disabled>
                        Ä°zlemeye Ekle
                    </button>
                    <button class="btn-add-record" onclick="window.location.href='data-entry.html'">
                        <span>&#x2795;</span> Yeni KayÄ±t Ekle
                    </button>
                    <button class="btn btn-secondary" id="exportExcelBtn">Excel Olarak Aktar</button>
                    <button class="btn btn-secondary" id="exportPdfBtn">PDF Olarak Aktar</button>
                </div>
            </div>
    
            <div class="portfolio-table-container">
                <table class="portfolio-table" id="portfolio-table">
                    <thead>
                        <tr id="portfolioTableHeaderRow">
                            </tr>
                        <tr id="portfolioTableFilterRow">
                            </tr>
                    </thead>
                    <tbody id="portfolioTableBody">
                        </tbody>
                </table>
                <div id="loadingIndicator" class="loading">YÃ¼kleniyor...</div>
                <div id="noRecordsMessage" class="no-records">HenÃ¼z kayÄ±t bulunmamaktadÄ±r.</div>
            </div>
        </main>
    </div>

    <div id="recordDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeRecordDetailModal">&times;</span>
            <h3 class="modal-title" id="modalRecordTitle">KayÄ±t DetayÄ±</h3>
            <div id="modalBody" class="modal-body-content">
                </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script type="module">
        import { authService, ipRecordsService, personService, transactionTypeService } from './firebase-config.js';
        import { showNotification, formatFileSize, exportTableToExcel, exportTableToPdf } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';

        // Ä°ÅŸlem tiplerini ve kiÅŸileri saklayacak global deÄŸiÅŸkenler
        let transactionTypesMap = new Map();
        let allPersons = []; 

        // Sayfa yÃ¼klendiÄŸinde iÅŸlem tiplerini ve kiÅŸileri yÃ¼kle
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'portfolio.html' });
            // ModÃ¼l Ã¶rneÄŸi oluÅŸmadan Ã¶nce global verileri yÃ¼kleyelim
            await loadTransactionTypes();
            await loadPersons();

            class PortfolioModule {
                constructor() {
                    this.currentUser = null;
                    this.allRecords = []; 
                    // this.allPersons kaldÄ±rÄ±ldÄ±, global allPersons kullanÄ±lacak
                    this.activeTypeFilter = 'all'; 
                    this.columnFilters = {}; 
                    this.sortBy = { column: null, direction: 'asc' }; 
                    this.selectedRecords = new Set(); 
                }

                async init() {
                    this.currentUser = authService.getCurrentUser();
                    if (!this.currentUser) {
                        window.location.href = 'index.html';
                        return;
                    }
                    await this.loadAllData();
                }

                async loadAllData() {
                    const loadingIndicator = document.getElementById('loadingIndicator');
                    if (loadingIndicator) { 
                        loadingIndicator.style.display = 'block';
                    }
                    
                    try {
                        // Sadece kayÄ±tlarÄ± Ã§ekiyoruz, kiÅŸiler ve transaction tipleri zaten yÃ¼klendi.
                        const recordsResult = await ipRecordsService.getRecords();

                        this.allRecords = recordsResult.success ? recordsResult.data.map(record => ({
                            ...record,
                            recordStatus: record.recordStatus || 'aktif',
                            recordType: record.recordType || 'PortfÃ¶y' // Default value for existing records
                        })) : [];
                        
                        this.initialRenderTableStructure(); 
                        this.populateTableBody(); 
                        this.applyFiltersAndSort(); 
                        this.setupEventListeners(); 
                        this.updateRecordStatusToggleButtonState(); 
                    } catch (error) {
                        showNotification('Veriler yÃ¼klenirken bir hata oluÅŸtu: ' + error.message, 'error');
                    } finally {
                        if (loadingIndicator) { 
                            loadingIndicator.style.display = 'none';
                        }
                    }
                }

                setupEventListeners() {
                    document.querySelectorAll('.tab-menu .tab-button').forEach(button => {
                        button.addEventListener('click', (e) => {
                            document.querySelectorAll('.tab-menu .tab-button').forEach(btn => btn.classList.remove('active'));
                            e.target.classList.add('active');
                            this.activeTypeFilter = e.target.dataset.type;
                            this.selectedRecords.clear(); 
                            document.getElementById('selectAllCheckbox').checked = false; 
                            this.updateRecordStatusToggleButtonState(); 
                            this.initialRenderTableStructure(); 
                            this.applyFiltersAndSort(); 
                        });
                    });

                    let globalSearchTimeout;
                    document.getElementById('searchBar').addEventListener('input', (e) => {
                        clearTimeout(globalSearchTimeout);
                        globalSearchTimeout = setTimeout(() => {
                            this.applyFiltersAndSort();
                        }, 300); 
                    });

                    let columnFilterTimeout;
                    document.querySelector('.portfolio-table thead').addEventListener('input', (e) => {
                        if (e.target.classList.contains('column-filter')) {
                            clearTimeout(columnFilterTimeout);
                            columnFilterTimeout = setTimeout(() => {
                                const columnKey = e.target.dataset.column;
                                this.columnFilters[columnKey] = e.target.value.toLowerCase();
                                this.applyFiltersAndSort();
                            }, 300); 
                        }
                    });

                    document.getElementById('portfolioTableHeaderRow').addEventListener('click', (e) => {
                        const targetTh = e.target.closest('.sortable-header');
                        if (targetTh) {
                            const columnKey = targetTh.dataset.column;
                            this.toggleSort(columnKey);
                        }
                    });

                    document.getElementById('portfolioTableBody').addEventListener('change', (e) => {
                        if (e.target.classList.contains('record-checkbox')) {
                            const recordId = e.target.dataset.id;
                            this.toggleRecordSelection(recordId, e.target.checked);
                            this.updateAddToMonitoringButtonState();
                        }
                    });

                    document.getElementById('selectAllCheckbox').addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        document.querySelectorAll('#portfolioTableBody .record-checkbox').forEach(checkbox => {
                            if (checkbox.closest('tr').style.display !== 'none') {
                                checkbox.checked = isChecked;
                                this.toggleRecordSelection(checkbox.dataset.id, isChecked);
                            }
                        });
                        this.updateAddToMonitoringButtonState();
                    });
                    
                    document.getElementById('toggleRecordStatusBtn').addEventListener('click', () => {
                        this.toggleSelectedRecordsStatus();
                    });

                    document.getElementById('portfolioTableBody').addEventListener('click', (e) => { 
                        if (e.target.classList.contains('action-btn')) {
                            e.preventDefault();
                            const recordId = e.target.dataset.id;
                            if (e.target.classList.contains('edit-btn')) {
                                window.location.href = `data-entry.html?id=${recordId}`;
                            } else if (e.target.classList.contains('delete-btn')) {
                                this.deleteRecord(recordId);
                            } else if (e.target.classList.contains('view-btn')) {
                                // showRecordDetailModal'Ä± sÄ±nÄ±fÄ±n bir metodu olarak Ã§aÄŸÄ±rÄ±yoruz
                                this.showRecordDetailModal(recordId);
                            }
                        }
                    });

                    document.getElementById('addToMonitoringBtn').addEventListener('click', async () => {
                    console.log('âœ… Ä°zlemeye Ekle butonuna tÄ±klandÄ±.');
                    
                    const selectedIds = Array.from(this.selectedRecords);
                    console.log('âœ… SeÃ§ili kayÄ±tlar:', selectedIds);
                    
                    if (selectedIds.length === 0) {
                        alert('HiÃ§bir kayÄ±t seÃ§mediniz.');
                        return;
                    }

                    const auth = getAuth();
                    const user = auth.currentUser;

                    if (!user) {
                        alert('LÃ¼tfen Ã¶nce oturum aÃ§Ä±n.');
                        console.log('â›” KullanÄ±cÄ± oturum aÃ§mamÄ±ÅŸ.');
                        return;
                    }

                    const uid = user.uid;
                    console.log('âœ… KullanÄ±cÄ± UID:', uid);

                    for (const id of selectedIds) {
                        const record = this.allRecords.find(r => r.id === id);
                        console.log('ðŸ” Ä°ncelenen kayÄ±t:', record);

                        if (!record) {
                        console.log('â›” KayÄ±t bulunamadÄ±:', id);
                        continue;
                        }

                        if (record.type !== 'trademark') {
                        console.log('â›” KayÄ±t trademark deÄŸil:', record.type);
                        continue;
                        }

                        alert(`KayÄ±t ekleniyor: ${record.title}`);

                        const res = await monitoringService.addMonitoringItem(uid, {
                        id: record.id,
                        title: record.title,
                        applicationNumber: record.applicationNumber,
                        applicationDate: record.applicationDate,
                        status: record.status
                        });

                        console.log('âœ… Firestore cevabÄ±:', res);

                        if (!res.success) {
                        console.error('â›” KayÄ±t eklenemedi:', res.error);
                        } else {
                        console.log('âœ… Firestoreâ€™a kayÄ±t eklendi:', record.id);
                        }
                    }

                    alert('Ä°ÅŸlem tamamlandÄ±.');
                    });


                }
                toggleRecordSelection(recordId, isChecked) {
                    if (isChecked) {
                        this.selectedRecords.add(recordId);
                    } else {
                        this.selectedRecords.delete(recordId);
                    }
                    this.updateRecordStatusToggleButtonState();
                }

                updateRecordStatusToggleButtonState() {
                    const toggleButton = document.getElementById('toggleRecordStatusBtn');
                    if (this.selectedRecords.size === 0) {
                        toggleButton.disabled = true;
                        toggleButton.textContent = 'Aktif/Pasif';
                        toggleButton.classList.remove('activate', 'archive'); 
                        return;
                    }

                    let allActive = true;
                    let allPasif = true;

                    this.selectedRecords.forEach(id => {
                        const record = this.allRecords.find(r => r.id === id);
                        if (record) {
                            if (record.recordStatus === 'pasif') {
                                allActive = false;
                            } else if (record.recordStatus === 'aktif') {
                                allPasif = false;
                            }
                        }
                    });

                    toggleButton.disabled = false;
                    toggleButton.classList.remove('activate', 'archive'); 

                    if (allActive) { 
                        toggleButton.textContent = `ArÅŸivle (${this.selectedRecords.size})`;
                        toggleButton.classList.add('archive');
                    } else if (allPasif) { 
                        toggleButton.textContent = `Aktif Et (${this.selectedRecords.size})`;
                        toggleButton.classList.add('activate');
                    } else { 
                        toggleButton.textContent = `Aktif/Pasif (${this.selectedRecords.size})`;
                        toggleButton.classList.add('btn-status-toggle');
                    }
                }
                updateAddToMonitoringButtonState() {
                const btn = document.getElementById('addToMonitoringBtn');
                if (this.selectedRecords.size === 0) {
                    btn.disabled = true;
                    btn.textContent = 'Ä°zlemeye Ekle';
                } else {
                    btn.disabled = false;
                    btn.textContent = `Ä°zlemeye Ekle (${this.selectedRecords.size})`;
                }
                }
                async toggleSelectedRecordsStatus() {
                    if (this.selectedRecords.size === 0) {
                        showNotification('LÃ¼tfen iÅŸlem yapmak iÃ§in en az bir kayÄ±t seÃ§in.', 'info');
                        return;
                    }

                    const recordsToUpdate = Array.from(this.selectedRecords).map(id => 
                        this.allRecords.find(record => record.id === id)
                    ).filter(Boolean); 

                    if (recordsToUpdate.length === 0) {
                        showNotification('SeÃ§ili geÃ§erli kayÄ±t bulunamadÄ±.', 'info');
                        return;
                    }

                    let targetRecordStatus; 
                    const firstRecordActiveStatus = recordsToUpdate[0].recordStatus; 

                    const allSameRecordStatus = recordsToUpdate.every(record => record.recordStatus === firstRecordActiveStatus);

                    if (allSameRecordStatus) {
                        targetRecordStatus = (firstRecordActiveStatus === 'aktif') ? 'pasif' : 'aktif';
                    } else {
                        showNotification('SeÃ§ili kayÄ±tlarÄ±n aktiflik durumlarÄ± farklÄ±. LÃ¼tfen aynÄ± durumda olan kayÄ±tlarÄ± seÃ§in.', 'warning');
                        return;
                    }
                    
                    const confirmationMessage = `SeÃ§ilen ${recordsToUpdate.length} adet kaydÄ±n aktiflik durumunu "${targetRecordStatus.toUpperCase()}" olarak deÄŸiÅŸtirmek istediÄŸinizden emin misiniz?`;

                    if (!confirm(confirmationMessage)) {
                        return;
                    }

                    const updatePromises = recordsToUpdate.map(record => {
                        return ipRecordsService.updateRecord(record.id, { recordStatus: targetRecordStatus });
                    });

                    try {
                        const results = await Promise.all(updatePromises);
                        const successfulUpdates = results.filter(res => res.success).length;
                        const failedUpdates = results.length - successfulUpdates;

                        if (successfulUpdates > 0) {
                            showNotification(`${successfulUpdates} adet kayÄ±t baÅŸarÄ±yla gÃ¼ncellendi.`, 'success');
                            this.selectedRecords.clear(); 
                            document.getElementById('selectAllCheckbox').checked = false;
                            this.updateRecordStatusToggleButtonState(); 
                            await this.loadAllData(); // Verileri yeniden yÃ¼kle ve tabloyu gÃ¼ncelle
                        }

                        if (failedUpdates > 0) {
                            showNotification(`${failedUpdates} adet kayÄ±t gÃ¼ncellenirken hata oluÅŸtu. LÃ¼tfen konsolu kontrol edin.`, 'error');
                            results.filter(res => !res.success).forEach(res => console.error('Durum gÃ¼ncelleme hatasÄ±:', res.error));
                        }
                    } catch (error) {
                        showNotification('KayÄ±t durumu gÃ¼ncelleme iÅŸleminde beklenmeyen bir hata oluÅŸtu: ' + error.message, 'error');
                    }
                }

                toggleSort(columnKey) {
                    if (this.sortBy.column === columnKey) {
                        this.sortBy.direction = this.sortBy.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        this.sortBy.column = columnKey;
                        this.sortBy.direction = 'asc';
                    }
                    this.applyFiltersAndSort(); 
                }

                initialRenderTableStructure() {
                    const tableHeaderRow = document.getElementById('portfolioTableHeaderRow');
                    const tableFilterRow = document.getElementById('portfolioTableFilterRow'); 
                    
                    tableHeaderRow.innerHTML = ''; 
                    tableFilterRow.innerHTML = ''; 

                    const currentTypeFilter = this.activeTypeFilter; 

                    const columnDefinitions = [
                        { key: 'selection', label: '<input type="checkbox" id="headerSelectAllCheckbox" />', sortable: false, searchable: false, isCheckbox: true, fixedWidth: '40px', index: 0 },
                        { key: 'recordType', label: 'KayÄ±t Tipi', sortable: true, searchable: true, fixedWidth: '80px', index: 1 }, // Yeni KayÄ±t Tipi Kolonu
                        { key: 'type', label: 'KayÄ±t TÃ¼rÃ¼', sortable: true, searchable: true, fixedWidth: '80px', index: 2 }, // Bu kolonun adÄ± 'KayÄ±t TÃ¼rÃ¼' olarak deÄŸiÅŸti
                        { key: 'title', label: 'BaÅŸlÄ±k', sortable: true, searchable: true, fixedWidth: '150px', index: 3 }, 
                        { key: 'trademarkImage', label: 'Marka GÃ¶rseli', sortable: false, searchable: false, onlyTrademark: true, fixedWidth: '80px', index: 4 }, 
                        { key: 'applicationNumber', label: 'BaÅŸvuru NumarasÄ±', sortable: true, searchable: true, fixedWidth: '120px', index: 5 },
                        { key: 'applicationDate', label: 'BaÅŸvuru Tarihi', sortable: true, searchable: true, fixedWidth: '100px', index: 6 },
                        { key: 'status', label: 'BaÅŸvuru Durumu', sortable: true, searchable: true, fixedWidth: '110px', index: 7 },
                        { key: 'recordStatus', label: 'KayÄ±t Durumu', sortable: true, searchable: true, fixedWidth: '110px', index: 8 },
                        { key: 'owners', label: 'Hak Sahipleri', sortable: true, searchable: true, fixedWidth: '200px', index: 9 }, 
                        { key: 'actions', label: 'Ä°ÅŸlemler', sortable: false, searchable: false, fixedWidth: '250px', index: 10 } 
                    ];

                    columnDefinitions.forEach(col => {
                        const th = document.createElement('th');
                        if (col.sortable) {
                            th.classList.add('sortable-header');
                            th.dataset.column = col.key;
                        }
                        if (col.fixedWidth) {
                            th.style.width = col.fixedWidth;
                        }

                        if (col.isCheckbox) {
                            th.innerHTML = '<input type="checkbox" id="selectAllCheckbox">'; 
                        } else {
                            th.textContent = col.label; 
                        }
                        
                        tableHeaderRow.appendChild(th);
                        
                        // 'KayÄ±t Tipi' kolonu her zaman gÃ¶zÃ¼kecek
                        if (col.key === 'type' && currentTypeFilter === 'thirdParty') {
                             th.style.display = 'none'; // '3. Taraf' sekmesinde 'KayÄ±t TÃ¼rÃ¼' gizlensin
                        } else if (col.onlyTrademark && currentTypeFilter !== 'trademark') {
                            th.style.display = 'none';
                        }


                        const thFilter = document.createElement('th');
                        if (col.searchable) {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.classList.add('column-filter');
                            input.dataset.column = col.key;
                            input.placeholder = `${col.label} ara...`;
                            input.value = this.columnFilters[col.key] || ''; 
                            thFilter.appendChild(input);
                        }
                        tableFilterRow.appendChild(thFilter);

                        if (col.key === 'type' && currentTypeFilter === 'thirdParty') {
                            thFilter.style.display = 'none';
                        } else if (col.onlyTrademark && currentTypeFilter !== 'trademark') {
                            thFilter.style.display = 'none';
                        }
                        if (col.isCheckbox) {
                            thFilter.style.display = 'table-cell';
                            thFilter.innerHTML = '';
                        }
                    });
                }
                
                populateTableBody() {
                    const tableBody = document.getElementById('portfolioTableBody');
                    tableBody.innerHTML = ''; 

                    const columnDefinitions = [ 
                        { key: 'selection', label: '', isCheckbox: true },
                        { key: 'recordType', label: 'KayÄ±t Tipi' }, // Yeni
                        { key: 'type', label: 'KayÄ±t TÃ¼rÃ¼' },
                        { key: 'title', label: 'BaÅŸlÄ±k' },
                        { key: 'trademarkImage', label: 'Marka GÃ¶rseli', onlyTrademark: true }, 
                        { key: 'applicationNumber', label: 'BaÅŸvuru NumarasÄ±' },
                        { key: 'applicationDate', label: 'BaÅŸvuru Tarihi' },
                        { key: 'status', label: 'BaÅŸvuru Durumu' }, 
                        { key: 'recordStatus', label: 'KayÄ±t Durumu' },
                        { key: 'owners', label: 'Hak Sahipleri' },
                        { key: 'actions', label: 'Ä°ÅŸlemler' }
                    ];

                    this.allRecords.forEach(record => {
                        const row = document.createElement('tr');
                        row.dataset.recordId = record.id; 
                        row.classList.add(`record-status-${record.recordStatus}`); 
                        
                        const ownerNames = record.owners ? record.owners.map(owner => {
                            const person = allPersons.find(p => p.id === owner.id); // 'this.allPersons' yerine 'allPersons'
                            return person ? person.name : 'Bilinmeyen KiÅŸi';
                        }).filter(Boolean).join(', ') : 'BelirtilmemiÅŸ';

                        let rowCellsHtml = '';
                        
                        columnDefinitions.forEach(col => {
                            let cellHtmlContent = '';
                            if (col.key === 'selection') {
                                const isChecked = this.selectedRecords.has(record.id) ? 'checked' : '';
                                cellHtmlContent = `<input type="checkbox" class="record-checkbox" data-id="${record.id}" ${isChecked}>`;
                            } else if (col.key === 'recordType') { cellHtmlContent = `${record.recordType || '-'}`; } // Yeni KayÄ±t Tipi
                            else if (col.key === 'type') { cellHtmlContent = `${record.type.charAt(0).toUpperCase() + record.type.slice(1)}`; }
                            else if (col.key === 'title') { cellHtmlContent = `${record.title || 'BaÅŸlÄ±ksÄ±z KayÄ±t'}`; }
                            else if (col.key === 'trademarkImage') {
                            let imageSrc = '-';
                            if (record.type === 'trademark' && record.trademarkImage) {
                                imageSrc = typeof record.trademarkImage === 'string'
                                    ? record.trademarkImage
                                    : record.trademarkImage.content;
                            }

                            if (imageSrc && imageSrc.startsWith('data:image')) {
                                cellHtmlContent = `
                                    <div class="trademark-image-wrapper">
                                        <img src="${imageSrc}" alt="Marka GÃ¶rseli" class="trademark-image-thumbnail">
                                    </div>`;
                            } else {
                                cellHtmlContent = `-`;
                            }
                                                   }
                            else if (col.key === 'applicationNumber') { cellHtmlContent = `${record.applicationNumber || '-'}`; }
                            else if (col.key === 'applicationDate') { cellHtmlContent = `${record.applicationDate || '-'}`; }
                            else if (col.key === 'status') { 
                                const statusText = record.status ? record.status.charAt(0).toUpperCase() + record.status.slice(1) : '-';
                                cellHtmlContent = `<span class="application-status-badge ${record.status}">${statusText}</span>`;
                            }
                            else if (col.key === 'recordStatus') {
                                const recordStatusText = record.recordStatus ? record.recordStatus.charAt(0).toUpperCase() + record.recordStatus.slice(1) : '-';
                                cellHtmlContent = `<span class="record-active-status-badge ${record.recordStatus}">${recordStatusText}</span>`;
                            }
                            else if (col.key === 'owners') { cellHtmlContent = `${ownerNames || '-'}`; }
                            else if (col.key === 'actions') {
                                cellHtmlContent = `
                                    <button type="button" class="action-btn view-btn" data-id="${record.id}">GÃ¶rÃ¼ntÃ¼le</button>
                                    <button type="button" class="action-btn edit-btn" data-id="${record.id}">DÃ¼zenle</button>
                                    <button type="button" class="action-btn delete-btn" data-id="${record.id}">Sil</button>
                                `;
                            }
                            rowCellsHtml += `<td>${cellHtmlContent}</td>`;
                        });
                        row.innerHTML = rowCellsHtml; 
                        tableBody.appendChild(row);
                    });
                }
                
                applyFiltersAndSort() {
                    const tableBody = document.getElementById('portfolioTableBody');
                    const noRecordsMessage = document.getElementById('noRecordsMessage');
                    const allRows = Array.from(tableBody.children); 

                    const currentTypeFilter = this.activeTypeFilter; 
                    const globalSearchTerm = document.getElementById('searchBar').value.toLowerCase();

                    const columnDefinitions = [
                        { key: 'selection', searchable: false, index: 0 },
                        { key: 'recordType', searchable: true, index: 1 }, // Yeni
                        { key: 'type', searchable: true, index: 2 }, 
                        { key: 'title', searchable: true, index: 3 },
                        { key: 'trademarkImage', searchable: false, onlyTrademark: true, index: 4 }, 
                        { key: 'applicationNumber', searchable: true, index: 5 },
                        { key: 'applicationDate', searchable: true, index: 6 },
                        { key: 'status', searchable: true, index: 7 }, 
                        { key: 'recordStatus', searchable: true, index: 8 },
                        { key: 'owners', searchable: true, index: 9 },
                        { key: 'actions', searchable: false, index: 10 }
                    ];

                    let filteredRows = allRows.filter(row => {
                        const recordId = row.dataset.recordId;
                        const record = this.allRecords.find(r => r.id === recordId); 

                        if (!record) return false; 

                        // 1. Tab Filtrelemesi (recordType ve type'a gÃ¶re)
                        let matchesTabFilter = false;
                        if (currentTypeFilter === 'all') {
                            matchesTabFilter = record.recordType === 'PortfÃ¶y';
                        } else if (currentTypeFilter === 'thirdParty') {
                            matchesTabFilter = record.recordType === '3. Taraf';
                        } else if (currentTypeFilter === 'objections') {
                            matchesTabFilter = record.recordType === 'PortfÃ¶y' && record.transactions && record.transactions.some(t => t.type && t.type.includes('Ä°tiraz'));
                        } else if (currentTypeFilter === 'litigation') {
                            matchesTabFilter = record.recordType === 'PortfÃ¶y' && record.transactions && record.transactions.some(t => t.type && t.type.includes('Dava'));
                        } else { // patent, trademark, copyright, design
                            matchesTabFilter = record.recordType === 'PortfÃ¶y' && record.type === currentTypeFilter;
                        }
                        
                        // 2. Genel Arama Ã‡ubuÄŸu Filtrelemesi
                        const globalSearchMatch = [
                            record.type,
                            record.recordType, // Yeni eklendi
                            record.title,
                            record.applicationNumber,
                            record.status,
                            record.recordStatus,
                            record.description,
                            record.patentClass, 
                            record.niceClass, 
                            record.copyrightType, 
                            record.designClass,
                            (record.owners ? record.owners.map(owner => allPersons.find(p => p.id === owner.id)?.name || '').filter(Boolean).join(' ') : '') // 'this.allPersons' yerine 'allPersons'
                        ].filter(Boolean).join(' ').toLowerCase().includes(globalSearchTerm);

                        // 3. SÃ¼tun BazlÄ± Filtreleme
                        const columnFilterMatch = columnDefinitions.every(col => {
                            if (!col.searchable || !this.columnFilters[col.key]) {
                                return true; 
                            }
                             if (col.key === 'type' && currentTypeFilter === 'thirdParty') return true; // '3. Taraf' sekmesinde 'KayÄ±t TÃ¼rÃ¼' filtresi uygulanmasÄ±n
                            if (col.onlyTrademark && currentTypeFilter !== 'trademark') return true; 

                            let recordValue = '';
                            if (col.key === 'owners') {
                                recordValue = record.owners ? record.owners.map(owner => allPersons.find(p => p.id === owner.id)?.name || '').filter(Boolean).join(' ') : ''; // 'this.allPersons' yerine 'allPersons'
                            } else if (col.key === 'applicationDate') {
                                recordValue = record.applicationDate ? new Date(record.applicationDate).toLocaleDateString('tr-TR') : '';
                            } else {
                                recordValue = record[col.key] ? String(record[col.key]) : '';
                            }
                            return recordValue.toLowerCase().includes(this.columnFilters[col.key]);
                        });
                        
                        return matchesTabFilter && globalSearchMatch && columnFilterMatch;
                    });

                    // 4. SÄ±ralama
                    if (this.sortBy.column) {
                        const sortColumn = this.sortBy.column;
                        const sortDirection = this.sortBy.direction;
                        filteredRows.sort((rowA, rowB) => {
                            const recordA = this.allRecords.find(r => r.id === rowA.dataset.recordId);
                            const recordB = this.allRecords.find(r => r.id === rowB.dataset.recordId);

                            if (!recordA || !recordB) return 0; 

                            let valA, valB;

                            if (sortColumn === 'owners') {
                                valA = (recordA.owners ? recordA.owners.map(owner => allPersons.find(p => p.id === owner.id)?.name || '').filter(Boolean).join(' ') : ''); // 'this.allPersons' yerine 'allPersons'
                                valB = (recordB.owners ? recordB.map(owner => allPersons.find(p => p.id === owner.id)?.name || '').filter(Boolean).join(' ') : ''); // 'this.allPersons' yerine 'allPersons'
                            } else if (sortColumn === 'applicationDate') {
                                valA = new Date(recordA.applicationDate || '1970-01-01'); 
                                valB = new Date(recordB.applicationDate || '1970-01-01');
                            } else if (sortColumn === 'type' || sortColumn === 'title' || sortColumn === 'status' || sortColumn === 'applicationNumber' || sortColumn === 'recordStatus' || sortColumn === 'recordType') { // recordType eklendi
                                valA = String(recordA[sortColumn] || '');
                                valB = String(recordB[sortColumn] || '');
                            } else {
                                valA = recordA[sortColumn];
                                valB = recordB[sortColumn];
                            }

                            if (typeof valA === 'string' && typeof valB === 'string') {
                                return sortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                            } else if (typeof valA === 'number' && typeof valB === 'number') {
                                return sortDirection === 'asc' ? valA - valB : valB - valA;
                            } else if (valA instanceof Date && valB instanceof Date) {
                                return sortDirection === 'asc' ? valA.getTime() - valB.getTime() : valB.getTime() - valA.getTime();
                            }
                            return 0; 
                        });
                    }
                    
                    document.querySelectorAll('.sortable-header').forEach(header => {
                        header.classList.remove('asc', 'desc', 'inactive');
                        if (header.dataset.column === this.sortBy.column) {
                            header.classList.add(this.sortBy.direction);
                        } else {
                            header.classList.add('inactive');
                        }
                    });

                    allRows.forEach(row => {
                        const recordId = row.dataset.recordId;
                        const record = this.allRecords.find(r => r.id === recordId);
                        
                        columnDefinitions.forEach(col => {
                            const cellIndex = col.index;
                            const cell = row.children[cellIndex];
                            if (cell) { 
                                const hideColumn = (col.key === 'type' && currentTypeFilter === 'thirdParty') || // '3. Taraf' sekmesinde 'KayÄ±t TÃ¼rÃ¼' kolonu gizlensin
                                                   (col.onlyTrademark && currentTypeFilter !== 'trademark');
                                
                                cell.style.display = hideColumn ? 'none' : 'table-cell'; 
                            }
                        });

                        row.style.display = filteredRows.includes(row) ? 'table-row' : 'none';

                        const checkbox = row.querySelector('.record-checkbox');
                        if (checkbox) {
                            checkbox.checked = this.selectedRecords.has(recordId);
                        }
                        row.classList.remove('record-status-aktif', 'record-status-pasif');
                        if (record && record.recordStatus) {
                            row.classList.add(`record-status-${record.recordStatus}`);
                        }
                    });
                    
                    const fragment = document.createDocumentFragment();
                    filteredRows.forEach(row => {
                        fragment.appendChild(row);
                    });
                    tableBody.appendChild(fragment); 

                    if (filteredRows.length === 0) {
                        noRecordsMessage.style.display = 'block';
                        tableBody.style.display = 'none'; 
                    } else {
                        noRecordsMessage.style.display = 'none';
                        tableBody.style.display = 'table-row-group'; 
                    }

                    const allVisibleCheckboxes = document.querySelectorAll('#portfolioTableBody tr[style="display: table-row;"] .record-checkbox');
                    const allChecked = allVisibleCheckboxes.length > 0 && Array.from(allVisibleCheckboxes).every(cb => cb.checked);
                    document.getElementById('selectAllCheckbox').checked = allChecked;
                    this.updateRecordStatusToggleButtonState();
                }
                
                async deleteRecord(recordId) {
                    if (confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
                        const result = await ipRecordsService.deleteRecord(recordId);
                        if (result.success) {
                            showNotification('KayÄ±t baÅŸarÄ±yla silindi.', 'success');
                            this.selectedRecords.delete(recordId); 
                            this.updateRecordStatusToggleButtonState(); 
                            await this.loadAllData(); 
                        } else {
                            showNotification('KayÄ±t silinirken hata oluÅŸtu: ' + result.error, 'error');
                        }
                    }
                }
                
                // Buradaki showRecordDetailModal fonksiyonunu gÃ¼ncelliyoruz
                async showRecordDetailModal(recordId) {
                    const modal = document.getElementById('recordDetailModal');
                    const modalBody = document.getElementById('modalBody');
                    
                    // YÃ¼kleme mesajÄ± gÃ¶ster
                    modalBody.innerHTML = '<p>YÃ¼kleniyor...</p>'; 

                    try {
                        const recordResult = await ipRecordsService.getRecordById(recordId);
                        if (!recordResult.success || !recordResult.data) {
                            showNotification('KayÄ±t bulunamadÄ± veya yÃ¼klenirken hata oluÅŸtu.', 'error');
                            modalBody.innerHTML = '<p>KayÄ±t bulunamadÄ± veya yÃ¼klenirken hata oluÅŸtu.</p>';
                            return;
                        }
                        const record = recordResult.data;

                        document.getElementById('modalRecordTitle').textContent = `KayÄ±t DetayÄ±: ${record.title || 'N/A'}`;

                        // getOwnerNames fonksiyonunu global allPersons'Ä± kullanacak ÅŸekilde gÃ¼ncelledik
                        const getOwnerNames = (owners) => {
                            if (!owners || owners.length === 0) return '-';
                            return owners.map(owner => {
                                const person = allPersons.find(p => p.id === owner.id); // 'this.allPersons' yerine 'allPersons'
                                return person ? person.name : 'Bilinmeyen KiÅŸi';
                            }).join(', ');
                        };
                        
                        let imageHtml = '';
                        let imageSrc = typeof record.trademarkImage === 'string'
                            ? record.trademarkImage
                            : record.trademarkImage?.content;

                        if (record.type === 'trademark' && imageSrc?.startsWith('data:image')) {
                            imageHtml = `<h4 class="modal-detail-section-title">Marka GÃ¶rseli</h4>
                                        <img src="${imageSrc}" alt="Marka GÃ¶rseli" class="record-image-display">`;
                        }

                        let documentsHtml = '<ul class="document-list"><li>HenÃ¼z belge yok.</li></ul>';
                        if (record.documents && record.documents.length > 0) {
                            documentsHtml = '<ul class="document-list">';
                            record.documents.forEach(doc => {
                                documentsHtml += `<li><a href="${doc.content}" download="${doc.name}"><span class="doc-icon">ðŸ“„</span>${doc.name} (${formatFileSize(doc.size)}) - ${doc.documentDesignation || 'Belge'}</a></li>`;
                            });
                            documentsHtml += '</ul>';
                        }

                        // **Ä°ÅžLEM GEÃ‡MÄ°ÅžÄ°NÄ° ALT KOLEKSÄ°YONDAN Ã‡EK**
                        let transactionsHtml = '<div class="transaction-history">';
                        const transactionsResult = await ipRecordsService.getRecordTransactions(record.id);

                        if (transactionsResult.success && transactionsResult.data.length > 0) {
                            const transactions = transactionsResult.data;

                            const transactionMap = new Map(transactions.map(tx => [tx.id, { ...tx, children: [] }]));

                            const topLevelTransactions = [];

                            transactions.forEach(tx => {
                                if (tx.transactionHierarchy === 'child' && tx.parentId && transactionMap.has(tx.parentId)) {
                                    transactionMap.get(tx.parentId).children.push(transactionMap.get(tx.id));
                                } else {
                                    topLevelTransactions.push(transactionMap.get(tx.id));
                                }
                            });

                            // Top-level iÅŸlemleri zamana gÃ¶re sÄ±rala (en eski en Ã¼stte)
                            topLevelTransactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                            if (topLevelTransactions.length > 0) {
                                topLevelTransactions.forEach(parentTx => {
                                    parentTx.children.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Ã‡ocuklarÄ± en yeni en Ã¼stte sÄ±rala

                                    const hasChildrenClass = parentTx.children.length > 0 ? 'has-children' : '';
                                    
                                    // Ä°ÅŸlem tipi iÃ§in TÃ¼rkÃ§e isim al
                                    const transactionTypeObj = transactionTypesMap.get(parentTx.type);
                                    const transactionTypeName = (transactionTypeObj ? (transactionTypeObj.alias || transactionTypeObj.name) : parentTx.type || parentTx.designation) || 'Bilinmiyor';
                                    
                                transactionsHtml += `
                                                    <div class="accordion">
                                                        <div class="accordion-header ${hasChildrenClass}">
                                                            <span class="transaction-type">
                                                                ${transactionTypeName} 
                                                                <span class="transaction-meta-inline">${new Date(parentTx.timestamp).toLocaleString('tr-TR')}</span>
                                                                <span class="transaction-meta-inline user-info">(${parentTx.userName || parentTx.userEmail || 'Bilinmeyen KullanÄ±cÄ±'})</span>
                                                            </span>
                                                        </div>
                                                        <div class="accordion-content">
                                                            ${parentTx.children.map(childTx => {
                                                                const childTransactionTypeObj = transactionTypesMap.get(childTx.type);
                                                                const childTransactionTypeName = (childTransactionTypeObj ? (childTransactionTypeObj.alias || childTransactionTypeObj.name) : childTx.type || childTx.designation) || 'Bilinmiyor';
                                                                return `
                                                                <div class="transaction-item" style="margin-left: 20px; border-left: 2px solid #ccc; padding-left: 10px;">
                                                                    <div class="transaction-type">Alt Ä°ÅŸlem: ${childTransactionTypeName}</div>
                                                                    <div class="transaction-meta">AÃ§Ä±klama: ${childTx.description || '-'}</div>
                                                                    <div class="transaction-meta">Tarih: ${childTx.timestamp ? new Date(childTx.timestamp).toLocaleString('tr-TR') : '-'}</div>
                                                                    <div class="transaction-meta">Yapan: ${childTx.userName || childTx.userEmail || 'Bilinmeyen KullanÄ±cÄ±'}</div>
                                                                </div>
                                                            `;
                                                            }).join('')}
                                                        </div>
                                                    </div>
                                                `;
                                });
                            } else {
                                transactionsHtml += '<p>Bu kayÄ±t iÃ§in iÅŸlem geÃ§miÅŸi bulunmamaktadÄ±r.</p>';
                            }
                        } else {
                            transactionsHtml += '<p>Ä°ÅŸlem geÃ§miÅŸi yÃ¼klenemedi veya bulunamadÄ±.</p>';
                        }
                        transactionsHtml += '</div>';

                        // Modal iÃ§eriÄŸini oluÅŸtur
                        modalBody.innerHTML = `
                            <div class="modal-detail-grid">
                                <div class="modal-detail-item"><div class="modal-detail-label">KayÄ±t Tipi</div><div class="modal-detail-value">${record.recordType || '-'}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">KayÄ±t TÃ¼rÃ¼</div><div class="modal-detail-value">${record.type.charAt(0).toUpperCase() + record.type.slice(1)}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">BaÅŸvuru Durumu</div><div class="modal-detail-value">${record.status}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">KayÄ±t Durumu</div><div class="modal-detail-value">${record.recordStatus}</div></div>
                                <div class="modal-detail-item full-width"><div class="modal-detail-label">BaÅŸlÄ±k</div><div class="modal-detail-value">${record.title}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">BaÅŸvuru NumarasÄ±</div><div class="modal-detail-value">${record.applicationNumber || '-'}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">BaÅŸvuru Tarihi</div><div class="modal-detail-value">${record.applicationDate || '-'}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">Tescil NumarasÄ±</div><div class="modal-detail-value">${record.registrationNumber || '-'}</div></div>
                                <div class="modal-detail-item"><div class="modal-detail-label">Tescil Tarihi</div><div class="modal-detail-value">${record.registrationDate || '-'}</div></div>
                                <div class="modal-detail-item full-width"><div class="modal-detail-label">Hak Sahipleri</div><div class="modal-detail-value">${getOwnerNames(record.owners)}</div></div>
                                
                                ${record.patentClass ? `<div class="modal-detail-item"><div class="modal-detail-label">Patent SÄ±nÄ±fÄ±</div><div class="modal-detail-value">${record.patentClass}</div></div>` : ''}
                                ${record.renewalDatePatent ? `<div class="modal-detail-item"><div class="modal-detail-label">Patent Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDatePatent}</div></div>` : ''}

                                ${record.niceClass ? `<div class="modal-detail-item"><div class="modal-detail-label">Nice SÄ±nÄ±fÄ±</div><div class="modal-detail-value">${record.niceClass}</div></div>` : ''}
                                ${record.renewalDateTrademark ? `<div class="modal-detail-item"><div class="modal-detail-label">Marka Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDateTrademark}</div></div>` : ''}

                                ${record.copyrightType ? `<div class="modal-detail-item"><div class="modal-detail-label">Telif HakkÄ± Tipi</div><div class="modal-detail-value">${record.copyrightType}</div></div>` : ''}
                                
                                ${record.designClass ? `<div class="modal-detail-item"><div class="modal-detail-label">TasarÄ±m SÄ±nÄ±fÄ±</div><div class="modal-detail-value">${record.designClass}</div></div>` : ''}
                                ${record.renewalDateDesign ? `<div class="modal-detail-item"><div class="modal-detail-label">TasarÄ±m Yenileme Tarihi</div><div class="modal-detail-value">${record.renewalDateDesign}</div></div>` : ''}

                                <div class="modal-detail-item full-width"><div class="modal-detail-label">AÃ§Ä±klama</div><div class="modal-detail-value long-text">${record.description || '-'}</div></div>
                            </div>
                            ${imageHtml}
                            <h4 class="modal-detail-section-title">Ekli Belgeler</h4>
                            <div class="modal-detail-item full-width">${documentsHtml}</div>
                            <h4 class="modal-detail-section-title">Ä°ÅŸlem GeÃ§miÅŸi</h4>
                            <div class="modal-detail-item full-width">${transactionsHtml}</div>
                        `;
                        
                        // Accordion functionality (sadece has-children class'Ä± varsa etkinleÅŸtir)
                        const accordions = modalBody.querySelectorAll('.accordion-header.has-children');
                        accordions.forEach(accordion => {
                            accordion.addEventListener('click', function() {
                                this.classList.toggle('active');
                                const content = this.nextElementSibling;
                                if (content.style.maxHeight) {
                                    content.style.maxHeight = null;
                                } else {
                                    content.style.maxHeight = content.scrollHeight + "px";
                                }
                            });
                        });
                        //Accordion Ã¶zelliÄŸi olmayanlar iÃ§in accordion-content div'ini gizle
                        modalBody.querySelectorAll('.accordion-header:not(.has-children)').forEach(header => {
                            const content = header.nextElementSibling;
                            if (content) {
                                content.style.maxHeight = '0';
                                content.style.overflow = 'hidden';
                                content.style.paddingTop = '0';
                                content.style.paddingBottom = '0';
                                content.style.border = 'none';
                                content.style.marginBottom = '0';
                            }
                        });

                        modal.classList.add('show');
                    } catch (error) {
                        showNotification('KayÄ±t detaylarÄ± yÃ¼klenirken beklenmedik bir hata oluÅŸtu: ' + error.message, 'error');
                        console.error('KayÄ±t detay modalÄ± hatasÄ±:', error);
                        modalBody.innerHTML = '<p>Detaylar yÃ¼klenirken bir hata oluÅŸtu.</p>';
                    }
                }

                closeModal(modalId) {
                    document.getElementById(modalId).classList.remove('show');
                }
            }

            const portfolioModule = new PortfolioModule();
            portfolioModule.init(); 
        });

        // YENÄ° FONKSÄ°YON: Ä°ÅŸlem tiplerini Firestore'dan yÃ¼kler ve haritaya kaydeder
        async function loadTransactionTypes() {
            const result = await transactionTypeService.getTransactionTypes();
            if (result.success) {
                result.data.forEach(type => {
                    // map'e objenin tamamÄ±nÄ± kaydediyoruz
                    transactionTypesMap.set(type.id, type); 
                });
            } else {
                console.error("Ä°ÅŸlem tipleri yÃ¼klenirken hata:", result.error);
                showNotification("Ä°ÅŸlem tipleri yÃ¼klenirken hata oluÅŸtu.", "error");
            }
        }

        // YENÄ° FONKSÄ°YON: KiÅŸileri Firestore'dan yÃ¼kler
        async function loadPersons() {
            const result = await personService.getPersons();
            if (result.success) {
                allPersons = result.data;
            } else {
                console.error("KiÅŸiler yÃ¼klenirken hata:", result.error);
                showNotification("KiÅŸiler yÃ¼klenirken hata oluÅŸtu.", "error");
            }
        }

        // KiÅŸinin tam adÄ±nÄ± bulan yardÄ±mcÄ± fonksiyon (global olarak tanÄ±mlandÄ±)
        function getPersonFullName(userId) {
            const person = allPersons.find(p => p.id === userId);
            return person ? `${person.firstName || ''} ${person.lastName || ''}`.trim() : 'Bilinmeyen KullanÄ±cÄ±';
        }
    </script>
</body>
</html>