<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - Belge İndeksleme</title>
    <link rel="stylesheet" href="css/shared-styles.css"> 
    <style>
        /* Mevcut tüm CSS stilleriniz burada kalacak */
        .main-container { width: 100%; padding: 30px; margin: 0; }
        .page-header-section { background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); text-align: center; margin-bottom: 30px; }
        .page-title { font-size: 2em; color: #1e3c72; margin-bottom: 10px; }
        .page-subtitle { color: #666; font-size: 1.1em; }
        .form-container { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .form-section { border-bottom: 1px solid #e1e8ed; padding-bottom: 25px; margin-bottom: 25px; }
        .form-section:last-child { border-bottom: none; }
        .section-title { font-size: 1.3em; color: #1e3c72; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .form-label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1em; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .form-actions { display: flex; gap: 15px; margin-top: 40px; padding-top: 30px; border-top: 2px solid #e1e8ed; justify-content: flex-end; }
        .btn { padding: 15px 30px; border-radius: 10px; font-size: 1.1em; font-weight: 600; }
        
        .search-wrapper { position: relative; }
        .search-results-container {
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid #e1e8ed;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background-color: white;
            z-index: 100;
            display: none;
        }
        
        .record-search-item { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px dashed #e1e8ed; cursor: pointer; }
        .record-search-item:hover { background-color: #f0f4f8; }
        .record-search-item:last-child { border-bottom: none; }
        .record-search-item.selected { background-color: #e6f2ff; }

        .file-list { margin-top: 15px; }
        .file-item { display: flex; flex-direction: column; padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .file-item-controls { display: flex; align-items: flex-start; gap: 10px; flex-wrap: wrap; width: 100%; margin-top: 5px; }
        .file-item-select { flex-grow: 1; min-width: 150px; padding: 5px 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 0.85em; }
        .remove-file { background: #ff6b6b; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; flex-shrink: 0; align-self: center; }

        .tabs-container { display: flex; border-bottom: 2px solid #dee2e6; margin-bottom: 1rem; }
        .tab-btn { padding: 0.75rem 1.25rem; border: none; background: none; cursor: pointer; font-size: 1rem; font-weight: 500; color: #6c757d; border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .tab-btn.active { color: #1e3c72; border-color: #1e3c72; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        .transaction-list-container { max-height: 200px; overflow-y: auto; border: 1px solid #e1e8ed; border-radius: 8px; padding: 5px; }
        .transaction-list-item { padding: 10px; cursor: pointer; border-radius: 6px; }
        .transaction-list-item:hover { background-color: #f0f4f8; }
        .transaction-list-item.selected { background-color: #e6f2ff; color: #1e3c72; font-weight: bold; }

        .child-transaction-inputs {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #e1e8ed;
            display: none; 
        }
        
        .file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%; 
            cursor: pointer;
        }

        .file-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .file-upload-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e1e8ed;
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8; 
            color: #333;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-button:hover {
            background-color: #e6f2ff;
            border-color: #a3d4ff;
        }

        .file-upload-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
            padding-left: 5px;
        }

        /* Toplu indeksleme tablosu stilleri */
        .bulk-indexing-table-container {
            margin-top: 25px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        .bulk-indexing-table {
            width: 100%;
            border-collapse: collapse;
        }
        .bulk-indexing-table th, .bulk-indexing-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            white-space: nowrap;
        }
        .bulk-indexing-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #1e3c72;
        }
        .bulk-indexing-table td .form-select,
        .bulk-indexing-table td .form-input {
            padding: 8px 10px;
            font-size: 0.9em;
            border-radius: 8px;
            width: 100%; /* Tablo içinde genişliği ayarla */
        }
        .bulk-indexing-table td .search-results-container {
            max-height: 150px; /* Tablo içindeki arama sonuçları için daha küçük */
            top: 100%; /* Dropdown pozisyonu */
            left: 0;
            width: 100%;
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
        }
        .bulk-indexing-table td .search-results-container .record-search-item {
            padding: 8px 12px;
        }
        .bulk-indexing-table .status-text.success { color: #28a745; font-weight: 600; }
        .bulk-indexing-table .status-text.error { color: #dc3545; font-weight: 600; }
        .bulk-indexing-table .status-text.pending { color: #fd7e14; font-weight: 600; }
        .bulk-indexing-table .status-text.processing { color: #007bff; font-weight: 600; }

        /* Dosya seçim butonu (toplu indeksleme) */
        .bulk-file-upload-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
            cursor: pointer;
            margin-top: 15px;
        }

        .bulk-file-upload-wrapper input[type=file] {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }

        .bulk-file-upload-button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #1e3c72; /* Ana renk */
            border-radius: 10px;
            font-size: 1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1e3c72; 
            color: white;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bulk-file-upload-button:hover {
            background-color: #2a5298;
            border-color: #2a5298;
        }
        .bulk-file-info {
            font-size: 0.9em;
            color: #777;
            margin-top: 5px;
            padding-left: 5px;
        }
    </style>
</head>
<body>
    <div id="notification-container" class="notification-container"></div>

    <div id="layout-placeholder"></div>

    <div class="page-wrapper">
        <main class="main-container">
            <div class="page-header-section">
                <h1 class="page-title">Belge İndeksleme</h1>
                <p class="page-subtitle">Mevcut fikri mülkiyet kayıtlarına belge ekleyin ve indeksleyin.</p>
            </div>
    
            <div class="form-container">
                <form id="indexingForm" onsubmit="return false;">
                    <div class="form-section record-search-section">
                        <h2 class="section-title"><span>1.</span>Kayıt Seçin</h2>
                        <div class="form-group search-wrapper">
                            <label class="form-label" for="recordSearchInput">Başvuru Numarası veya Başlık ile Ara</label>
                            <input type="text" id="recordSearchInput" class="form-input" placeholder="Örn: TR2024/123, Proje X..." autocomplete="off">
                            <div class="search-results-container" id="searchResultsContainer">
                                <p class="no-results-message p-2">Arama yapmak için yukarıya yazın.</p>
                            </div>
                        </div>
                        <div class="form-group" style="margin-top: 20px;">
                            <label class="form-label">Seçili Kayıt:</label>
                            <input type="text" id="selectedRecordDisplay" class="form-input" readonly placeholder="Henüz kayıt seçilmedi.">
                        </div>
                    </div>
    
                    <div class="form-section document-upload-section" id="documentUploadSection" style="display: none;">
                        <h2 class="section-title"><span>2.</span>Belgeleri Yükleyin ve İndeksleyin</h2>
                        
                        <div class="tabs-container">
                            <button type="button" class="tab-btn active" data-tab="existing-transaction-pane">İşleme Dosya Ekle</button>
                            <button type="button" class="tab-btn" data-tab="manual-indexing-pane">Manuel İşlem Oluştur</button>
                            <button type="button" class="tab-btn" data-tab="bulk-indexing-pane">Toplu İndeksleme</button> </div>
                        
                        <div class="tab-content-container">
                            <div id="existing-transaction-pane" class="tab-pane active">
                                <div class="form-group">
                                    <label class="form-label">A- Ana İşlem Seçin <span style="color: red;">*</span></label>
                                    <div id="transactions-list-for-selection" class="transaction-list-container">
                                        <p class="text-muted p-2">Lütfen bir kayıt seçin.</p>
                                    </div>
                                </div>

                                <div id="childTransactionInputs" class="child-transaction-inputs">
                                    <h4 class="section-title" style="font-size: 1.1em;">B- Alt İşlem Seçin <span style="color: red;">*</span></h4>
                                    <div class="form-group">
                                        <label class="form-label" for="specificChildTransactionType">Alt İşlem Türü</label>
                                        <select id="specificChildTransactionType" class="form-select" name="specificChildTransactionType">
                                            <option value="" disabled selected>Alt işlem türü seçin...</option>
                                            </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="existingChildTransactionDeliveryDate">Tebliğ Tarihi</label>
                                        <input type="date" id="existingChildTransactionDeliveryDate" class="form-input" name="existingChildTransactionDeliveryDate">
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="filesExisting">C- Dosya Yükleyin <span style="color: red;">*</span></label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="filesExisting" multiple name="filesExisting">
                                        <div class="file-upload-button" id="filesExistingButton">Dosya Seç</div>
                                    </div>
                                    <div class="file-upload-info" id="filesExistingInfo">Henüz dosya seçilmedi.</div>
                                </div>
                                <div class="file-list" id="fileListExisting"></div>
                            </div>

                            <div id="manual-indexing-pane" class="tab-pane">
                                <div class="form-group">
                                    <label class="form-label" for="specificManualTransactionType">A- Ana İşlem Seçin</label>
                                    <select id="specificManualTransactionType" class="form-select" name="specificManualTransactionType">
                                        <option value="" disabled selected>İşlem türü seçin...</option>
                                        </select>
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="specificManualChildTransactionType">B- Alt İşlem Seçin (İsteğe Bağlı)</label>
                                    <select id="specificManualChildTransactionType" class="form-select" name="specificManualChildTransactionType">
                                        <option value="" disabled selected>Alt işlem türü seçin...</option>
                                        </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="manualChildTransactionDeliveryDate">Tebliğ Tarihi (Alt İşlem için)</label>
                                    <input type="date" id="manualChildTransactionDeliveryDate" class="form-input" name="manualChildTransactionDeliveryDate">
                                </div>

                                <div class="form-group">
                                    <label class="form-label" for="filesManual">C- Dosya Yükleyin (İsteğe Bağlı)</label>
                                    <div class="file-upload-wrapper">
                                        <input type="file" id="filesManual" multiple name="filesManual">
                                        <div class="file-upload-button" id="filesManualButton">Dosya Seç</div>
                                    </div>
                                    <div class="file-upload-info" id="filesManualInfo">Henüz dosya seçilmedi.</div>
                                </div>
                                <div class="file-list" id="fileListManual"></div>
                            </div>

                            <div id="bulk-indexing-pane" class="tab-pane">
                                <div class="form-group">
                                    <label class="form-label" for="bulkDeliveryDate">A- Tebliğ Tarihi (Klasör Adı Olarak Kabul Edilecek) <span style="color: red;">*</span></label>
                                    <input type="date" id="bulkDeliveryDate" class="form-input" name="bulkDeliveryDate">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="bulkChildTransactionType">B- Alt İşlem Türü (Tüm PDF'ler İçin Ortak) <span style="color: red;">*</span></label>
                                    <select id="bulkChildTransactionType" class="form-select" name="bulkChildTransactionType">
                                        <option value="" disabled selected>Alt işlem türü seçin...</option>
                                        </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="bulkFiles">C- PDF Dosyalarını Yükleyin (Tüm PDF'ler) <span style="color: red;">*</span></label>
                                    <div class="bulk-file-upload-wrapper">
                                        <input type="file" id="bulkFiles" multiple accept=".pdf" name="bulkFiles">
                                        <div class="bulk-file-upload-button" id="bulkFilesButton">PDF Dosyalarını Seç</div>
                                    </div>
                                    <div class="bulk-file-info" id="bulkFilesInfo">Henüz PDF dosyası seçilmedi.</div>
                                </div>

                                <div class="bulk-indexing-table-container" id="bulkIndexingTableContainer" style="display:none;">
                                    <table class="bulk-indexing-table" id="bulkIndexingTable">
                                        <thead>
                                            <tr>
                                                <th>PDF Dosya Adı</th>
                                                <th>Başvuru No</th>
                                                <th>İlgili Portföy Kaydı</th>
                                                <th>Durum</th>
                                                <th>Aksiyonlar</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            </tbody>
                                    </table>
                                    <p id="bulkTableNoJobs" style="text-align:center; padding: 20px; display:none;">Yüklenecek PDF bulunamadı veya işlenecek dosya yok.</p>
                                </div>
                            </div>
                            </div>
                    </div>
    
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="resetIndexingFormBtn">Temizle</button>
                        <button type="submit" class="btn btn-primary" id="indexDocumentsBtn" disabled>Değişiklikleri Kaydet</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <script type="module">
        import { authService, ipRecordsService, auth, generateUUID } from './firebase-config.js';
        import { showNotification, formatFileSize, readFileAsDataURL } from './utils.js';
        import { loadSharedLayout } from './js/layout-loader.js';
        import { documentDesignationTranslations } from './firebase-config.js'; 

        const DOCUMENT_DESIGNATION_TYPES = Object.values(documentDesignationTranslations); 

        const CHILD_TRANSACTION_TYPES = [
            'Ret Kararı',
            'Kabul Kararı',
            'Eksiklik Bildirimi',
            'Karara İtiraz', 
            'Yayına İtiraz',
            'İtiraza Cevap',
            'Genel',
            'Diğer'
        ];

        const MANUAL_PARENT_TRANSACTION_TYPES = [
            'Başvuru',
            'Yenileme',
            'Devir',
            'Lisans',
            'Genel',
            'Diğer'
        ];

        class IndexingModule {
            constructor() {
                this.currentUser = null;
                this.allRecords = []; 
                this.selectedRecord = null; // Tekil indeksleme için seçilen kayıt
                this.uploadedFiles = new Map(); // Key: tabKey (existing/manual), Value: Array of { id, fileObject, documentDesignation }
                this.selectedTransactionId = null; 
                this.activeTab = 'existing-transaction-pane';
                
                // Yeni: Toplu indeksleme için
                this.pendingBulkIndexJobs = []; // Her PDF için bir indeksleme işi
                this.bulkIndexingRecordsCache = new Map(); // Arama performansını artırmak için kayıt önbelleği
                
                this.init();
            }

            async init() {
                this.currentUser = authService.getCurrentUser();
                if(!this.currentUser) {
                    window.location.href = 'index.html';
                    return; 
                }

                await this.loadRecords();
                this.setupEventListeners();
                this.populateChildTransactionTypeSelect(); 
                this.populateManualTransactionTypeSelect(); 
                this.populateManualChildTransactionTypeSelect(); 
                this.populateBulkChildTransactionTypeSelect(); // Yeni: Toplu indeksleme alt işlem türü select box'ını doldur
                this.activateTab(this.activeTab); 
            }

            async loadRecords() {
                const result = await ipRecordsService.getRecords();
                if (result.success) this.allRecords = result.data;
                else showNotification('Kayıtlar yüklenemedi: ' + result.error, 'error');
            }

            setupEventListeners() {
                const searchInput = document.getElementById('recordSearchInput');
                searchInput.addEventListener('input', (e) => this.searchRecords(e.target.value));
                searchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('searchResultsContainer').style.display = 'none';
                    }, 200);
                });
                
                document.getElementById('filesExisting').addEventListener('change', (e) => {
                    this.handleFileChange(e, 'existing-transaction-pane');
                    document.getElementById('filesExistingInfo').textContent = e.target.files.length > 0 ? `${e.target.files.length} dosya seçildi.` : 'Henüz dosya seçilmedi.';
                });
                document.getElementById('filesManual').addEventListener('change', (e) => {
                    this.handleFileChange(e, 'manual-indexing-pane');
                    document.getElementById('filesManualInfo').textContent = e.target.files.length > 0 ? `${e.target.files.length} dosya seçildi.` : 'Henüz dosya seçilmedi.';
                });
                // Yeni: Toplu dosya yükleme inputu
                document.getElementById('bulkFiles').addEventListener('change', (e) => {
                    this.handleBulkFilesChange(e);
                    document.getElementById('bulkFilesInfo').textContent = e.target.files.length > 0 ? `${e.target.files.length} PDF dosyası seçildi.` : 'Henüz PDF dosyası seçilmedi.';
                });

                document.getElementById('filesExistingButton').addEventListener('click', () => document.getElementById('filesExisting').click());
                document.getElementById('filesManualButton').addEventListener('click', () => document.getElementById('filesManual').click());
                document.getElementById('bulkFilesButton').addEventListener('click', () => document.getElementById('bulkFiles').click()); // Yeni buton listener


                document.getElementById('indexDocumentsBtn').addEventListener('click', () => this.handleSubmit());
                document.getElementById('resetIndexingFormBtn').addEventListener('click', () => this.resetForm());
                
                document.querySelectorAll('.tabs-container .tab-btn').forEach(btn => { 
                    btn.addEventListener('click', (e) => {
                        const targetTab = e.currentTarget.dataset.tab;
                        this.activateTab(targetTab); 
                    });
                });
                
                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('remove-uploaded-file')) {
                        const fileId = e.target.dataset.fileId;
                        const tabKey = e.target.dataset.tabKey;
                        let files = this.uploadedFiles.get(tabKey) || [];
                        this.uploadedFiles.set(tabKey, files.filter(f => f.id !== fileId));
                        this.renderUploadedFilesList(tabKey);
                        this.checkFormCompleteness(); 
                    }
                });
                
                document.getElementById('specificChildTransactionType').addEventListener('change', () => this.checkFormCompleteness());
                document.getElementById('existingChildTransactionDeliveryDate').addEventListener('change', () => this.checkFormCompleteness()); // Tebliğ tarihi için listener

                document.getElementById('specificManualTransactionType').addEventListener('change', () => this.checkFormCompleteness());
                document.getElementById('specificManualChildTransactionType').addEventListener('change', () => this.checkFormCompleteness()); 
                document.getElementById('manualChildTransactionDeliveryDate').addEventListener('change', () => this.checkFormCompleteness()); // Tebliğ tarihi için listener

                // Yeni: Toplu indeksleme alanı için listener'lar
                document.getElementById('bulkDeliveryDate').addEventListener('change', (e) => this.updateBulkJobsTebligDate(e.target.value));
                document.getElementById('bulkChildTransactionType').addEventListener('change', (e) => this.updateBulkJobsChildType(e.target.value));
            }

            populateChildTransactionTypeSelect() {
                const selectEl = document.getElementById('specificChildTransactionType');
                selectEl.innerHTML = '<option value="" disabled selected>Alt işlem türü seçin...</option>';
                CHILD_TRANSACTION_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            }

            populateManualTransactionTypeSelect() {
                const selectEl = document.getElementById('specificManualTransactionType');
                selectEl.innerHTML = '<option value="" disabled selected>İşlem türü seçin...</option>';
                MANUAL_PARENT_TRANSACTION_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            }

            populateManualChildTransactionTypeSelect() {
                const selectEl = document.getElementById('specificManualChildTransactionType');
                selectEl.innerHTML = '<option value="" disabled selected>Alt işlem türü seçin...</option>';
                CHILD_TRANSACTION_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            }

            // Yeni fonksiyon: Toplu indeksleme alt işlem türü select box'ını doldur
            populateBulkChildTransactionTypeSelect() {
                const selectEl = document.getElementById('bulkChildTransactionType');
                selectEl.innerHTML = '<option value="" disabled selected>Alt işlem türü seçin...</option>';
                CHILD_TRANSACTION_TYPES.forEach(type => {
                    const option = document.createElement('option');
                    option.value = type;
                    option.textContent = type;
                    selectEl.appendChild(option);
                });
            }
            
            activateTab(tabName) {
                this.activeTab = tabName;
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelector(`.tab-btn[data-tab="${tabName}"]`).classList.add('active');
                document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
                document.getElementById(tabName).classList.add('active');
                
                this.setRequiredFieldsForActiveTab(); 
                this.checkFormCompleteness(); 
            }
            
            setRequiredFieldsForActiveTab() {
                const specificChildTransactionType = document.getElementById('specificChildTransactionType');
                const filesExisting = document.getElementById('filesExisting');
                // const existingChildTransactionDeliveryDate = document.getElementById('existingChildTransactionDeliveryDate'); // Zorunlu değil
                
                const specificManualTransactionType = document.getElementById('specificManualTransactionType');
                const specificManualChildTransactionType = document.getElementById('specificManualChildTransactionType'); 
                // const manualChildTransactionDeliveryDate = document.getElementById('manualChildTransactionDeliveryDate'); // Zorunlu değil
                const filesManual = document.getElementById('filesManual');

                const bulkDeliveryDate = document.getElementById('bulkDeliveryDate'); // Yeni
                const bulkChildTransactionType = document.getElementById('bulkChildTransactionType'); // Yeni
                const bulkFiles = document.getElementById('bulkFiles'); // Yeni

                // Tüm inputlardan 'required' özelliğini kaldır
                [
                    specificChildTransactionType, filesExisting, 
                    specificManualTransactionType, specificManualChildTransactionType, filesManual,
                    bulkDeliveryDate, bulkChildTransactionType, bulkFiles // Yeni alanlar
                ].forEach(el => {
                    if (el) {
                        el.removeAttribute('required');
                    }
                });

                // Aktif sekmeye göre 'required' ekle
                if (this.activeTab === 'existing-transaction-pane') {
                    if (specificChildTransactionType) specificChildTransactionType.setAttribute('required', 'required');
                    if (filesExisting) filesExisting.setAttribute('required', 'required');
                } else if (this.activeTab === 'bulk-indexing-pane') { // Yeni: Toplu indeksleme tabı
                    if (bulkDeliveryDate) bulkDeliveryDate.setAttribute('required', 'required');
                    if (bulkChildTransactionType) bulkChildTransactionType.setAttribute('required', 'required');
                    if (bulkFiles) bulkFiles.setAttribute('required', 'required');
                }
                // Manuel sekmede zorunluluklar checkFormCompleteness tarafından yönetiliyor
            }


            searchRecords(query) {
                const container = document.getElementById('searchResultsContainer');
                if (query.length < 3) {
                    container.innerHTML = '<p class="no-results-message p-2">Arama yapmak için en az 3 karakter girin.</p>';
                    container.style.display = 'block';
                    return;
                }
                container.innerHTML = '';
                const filtered = this.allRecords.filter(r => 
                    (r.title && r.title.toLowerCase().includes(query.toLowerCase())) ||
                    (r.applicationNumber && r.applicationNumber.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filtered.length === 0) {
                    container.innerHTML = '<p class="no-results-message p-2">Kayıt bulunamadı.</p>';
                } else {
                    filtered.forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'record-search-item';
                        item.innerHTML = `<div class="record-info"><div>${record.title}</div><small>${record.applicationNumber}</small></div>`;
                        item.addEventListener('click', () => this.selectRecord(record.id));
                        container.appendChild(item);
                    });
                }
                container.style.display = 'block';
            }

            selectRecord(recordId) {
                this.selectedRecord = this.allRecords.find(r => r.id === recordId);
                document.getElementById('selectedRecordDisplay').value = `${this.selectedRecord.title} (${this.selectedRecord.applicationNumber})`;
                document.getElementById('searchResultsContainer').style.display = 'none';
                document.getElementById('recordSearchInput').value = '';
                document.getElementById('documentUploadSection').style.display = 'block';
                
                // Seçilen kayıt değiştiğinde tüm sekmeler için formları sıfırla
                this.resetFormTabSpecifics(); // Yeni resetleme fonksiyonu
                
                this.renderTransactionsForSelection(); 
                this.checkFormCompleteness();

                // Toplu indeksleme için: eğer kayıt seçildiyse, önbelleği doldur
                if (this.selectedRecord) {
                    this.bulkIndexingRecordsCache.set(this.selectedRecord.id, this.selectedRecord);
                }
                this.renderBulkIndexingTable(); // Eğer seçilen bir kayıt varsa tabloyu yeniden render et
            }

            renderTransactionsForSelection() {
                const container = document.getElementById('transactions-list-for-selection');
                container.innerHTML = '';
                this.selectedTransactionId = null; 
                
                const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                if (childTransactionInputsEl) {
                    childTransactionInputsEl.style.display = 'none'; 
                    document.getElementById('specificChildTransactionType').value = ''; 
                    document.getElementById('existingChildTransactionDeliveryDate').value = ''; 
                }

                const transactions = this.selectedRecord.transactions || [];

                if (transactions.length === 0) {
                    container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut işlem yok. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                    return;
                }
                
                const parentTransactions = transactions
                    .filter(tx => tx.transactionHierarchy === 'parent' || !tx.transactionHierarchy) 
                    .sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                if (parentTransactions.length === 0) {
                     container.innerHTML = '<p class="text-muted p-2">Dosya eklenecek mevcut ana işlem bulunamadı. "Manuel İşlem Oluştur" sekmesini kullanabilirsiniz.</p>';
                     return;
                }

                parentTransactions.forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'transaction-list-item';
                    item.dataset.id = tx.transactionId;
                    item.textContent = `${tx.designation || tx.transactionType} - ${new Date(tx.timestamp).toLocaleDateString('tr-TR')}`;
                    item.addEventListener('click', (e) => {
                        this.selectedTransactionId = e.currentTarget.dataset.id;
                        document.querySelectorAll('#transactions-list-for-selection .transaction-list-item').forEach(el => el.classList.remove('selected'));
                        e.currentTarget.classList.add('selected');
                        
                        if (childTransactionInputsEl) {
                            childTransactionInputsEl.style.display = 'block'; 
                            document.getElementById('specificChildTransactionType').value = ''; 
                            document.getElementById('existingChildTransactionDeliveryDate').value = ''; 
                        }
                        this.checkFormCompleteness();
                    });
                    container.appendChild(item);
                });
            }
            
            handleFileChange(event, tabKey) {
                const fileInput = event.target;
                const files = Array.from(fileInput.files);
                
                this.uploadedFiles.set(tabKey, []); 
                
                files.forEach(file => {
                    this.uploadedFiles.get(tabKey).push({ 
                        id: `temp_${Date.now()}_${generateUUID()}`, 
                        fileObject: file,
                        documentDesignation: '' 
                    });
                });
                this.renderUploadedFilesList(tabKey);
                this.checkFormCompleteness();
            }

            renderUploadedFilesList(tabKey) {
                const containerId = tabKey === 'existing-transaction-pane' ? 'fileListExisting' : 'fileListManual';
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                const files = this.uploadedFiles.get(tabKey) || [];
                if (files.length === 0) return;

                files.forEach(fileData => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="d-flex justify-content-between w-100">
                            <strong>${fileData.fileObject.name}</strong>
                            <button type="button" class="remove-file remove-uploaded-file" data-file-id="${fileData.id}" data-tab-key="${tabKey}">&times;</button>
                        </div>
                    `;
                    container.appendChild(fileItem);
                });
            }

            checkFormCompleteness() {
                const filesExist = (this.uploadedFiles.get(this.activeTab) || []).length > 0;
                let canSubmit = false;

                if (!this.selectedRecord) {
                    canSubmit = false;
                } else if (this.activeTab === 'existing-transaction-pane') {
                    const specificChildTransactionType = document.getElementById('specificChildTransactionType').value;
                    canSubmit = this.selectedTransactionId !== null && specificChildTransactionType !== '' && filesExist;

                } else if (this.activeTab === 'manual-indexing-pane') {
                    const specificManualTransactionType = document.getElementById('specificManualTransactionType').value;
                    const specificManualChildTransactionType = document.getElementById('specificManualChildTransactionType').value; 
                    
                    canSubmit = (specificManualTransactionType !== '' || specificManualChildTransactionType !== '' || filesExist);
                } else if (this.activeTab === 'bulk-indexing-pane') { // Yeni: Toplu indeksleme sekmesi
                    const bulkDeliveryDate = document.getElementById('bulkDeliveryDate').value;
                    const bulkChildTransactionType = document.getElementById('bulkChildTransactionType').value;
                    
                    // Toplu indekslemede, tüm işlerin (job) ilgili kayıt ID'si ve Alt İşlem Türü seçili olmalı
                    // ve en az bir işin durumu "işlenecek" veya "beklemede" olmalı.
                    const allJobsValid = this.pendingBulkIndexJobs.every(job => 
                        job.matchedRecordId !== null && 
                        job.childTransactionType !== '' &&
                        job.status !== 'error' // Hata durumundakiler gönderilmez
                    );
                    const anyJobPendingOrReady = this.pendingBulkIndexJobs.some(job => job.status === 'pending' || job.status === 'ready');

                    canSubmit = bulkDeliveryDate !== '' && bulkChildTransactionType !== '' && allJobsValid && anyJobPendingOrReady;
                }
                document.getElementById('indexDocumentsBtn').disabled = !canSubmit;
            }

            async handleSubmit() {
                const btn = document.getElementById('indexDocumentsBtn');
                btn.disabled = true;
                showNotification('İşlem kaydediliyor...', 'info');

                if (!this.selectedRecord) {
                    showNotification('Lütfen bir kayıt seçin.', 'error');
                    btn.disabled = false; return;
                }
                
                try {
                    if (this.activeTab === 'manual-indexing-pane') {
                        const specificManualTransactionType = document.getElementById('specificManualTransactionType').value;
                        const specificManualChildTransactionType = document.getElementById('specificManualChildTransactionType').value; 
                        const manualChildTransactionDeliveryDate = document.getElementById('manualChildTransactionDeliveryDate').value; 

                        let transactionDeliveryDate = null;
                        if (manualChildTransactionDeliveryDate) {
                            transactionDeliveryDate = new Date(manualChildTransactionDeliveryDate).toISOString();
                        }
                        
                        let isTransactionCreated = false;
                        let newParentTransactionId = null; 
                        let transactionIdToAssociateFiles = null; 
                        let transactionDesignationForFiles = ''; 

                        if (specificManualTransactionType !== '' || specificManualChildTransactionType !== '') {
                            let transactionDesignation;
                            let transactionType;
                            let transactionHierarchy;
                            let parentId = null; 

                            if (specificManualTransactionType !== '' && specificManualChildTransactionType === '') { 
                                transactionDesignation = specificManualTransactionType;
                                transactionType = specificManualTransactionType;
                                transactionHierarchy = 'parent';
                                parentId = null; 
                                transactionDeliveryDate = null;

                            } else if (specificManualChildTransactionType !== '' && specificManualTransactionType === '') { 
                                const placeholderParentData = {
                                    designation: `${specificManualChildTransactionType} (Ana İşlem)`, 
                                    transactionType: 'Genel', 
                                    notes: 'Bu işlem, alt işlem belgesi için otomatik olarak oluşturulmuş bir ana işlemdir.',
                                    transactionHierarchy: 'parent',
                                    parentId: null,
                                };
                                const placeholderParentResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, placeholderParentData);
                                if (!placeholderParentResult.success) {
                                    throw new Error(placeholderParentResult.error || 'Otomatik ana işlem oluşturulurken hata oluştu.');
                                }
                                newParentTransactionId = placeholderParentResult.data.transactionId;
                                showNotification('Otomatik ana işlem başarıyla oluşturuldu.', 'success');

                                transactionDesignation = specificManualChildTransactionType;
                                transactionType = specificManualChildTransactionType;
                                transactionHierarchy = 'child';
                                parentId = newParentTransactionId; 

                            } else if (specificManualTransactionType !== '' && specificManualChildTransactionType !== '') { 
                                const mainTransactionData = {
                                    designation: specificManualTransactionType,
                                    transactionType: specificManualTransactionType,
                                    notes: '',
                                    transactionHierarchy: 'parent',
                                    parentId: null,
                                };
                                const mainTransactionResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, mainTransactionData);
                                if (!mainTransactionResult.success) {
                                    throw new Error(mainTransactionResult.error || 'Manuel ana işlem oluşturulurken hata oluştu.');
                                }
                                newParentTransactionId = mainTransactionResult.data.transactionId; 
                                showNotification('Manuel ana işlem başarıyla oluşturuldu.', 'success');

                                transactionDesignation = specificManualChildTransactionType;
                                transactionType = specificManualChildTransactionType;
                                transactionHierarchy = 'child';
                                parentId = newParentTransactionId;
                            } else { 
                                showNotification('Lütfen manuel işlem için geçerli bir kombinasyon seçin (Ana İşlem VEYA Alt İşlem).', 'error');
                                btn.disabled = false;
                                return;
                            }
                            
                            if (newParentTransactionId === null || specificManualChildTransactionType === '') { 
                                const newTransactionData = {
                                    designation: transactionDesignation,
                                    transactionType: transactionType,
                                    notes: '',
                                    transactionHierarchy: transactionHierarchy, 
                                    parentId: parentId,
                                    deliveryDate: transactionDeliveryDate 
                                };
                                const transactionAddResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, newTransactionData);

                                if (!transactionAddResult.success) {
                                    throw new Error(transactionAddResult.error || 'Yeni işlem oluşturulurken hata oluştu.');
                                }
                                transactionIdToAssociateFiles = transactionAddResult.data.transactionId;
                                transactionDesignationForFiles = transactionDesignation;
                                isTransactionCreated = true;
                                showNotification('Yeni işlem başarıyla kaydedildi.', 'success');
                            } else { 
                                transactionIdToAssociateFiles = parentId; 
                                transactionDesignationForFiles = specificManualChildTransactionType;
                                isTransactionCreated = true;
                            }

                        } else { 
                            transactionDesignationForFiles = 'Genel Belge';
                        }

                        const filesToProcess = this.uploadedFiles.get(this.activeTab) || []; 
                        if (filesToProcess.length === 0 && !isTransactionCreated) {
                            showNotification('Kaydedilecek bir işlem veya dosya bulunamadı.', 'error');
                            btn.disabled = false;
                            return;
                        }

                        // Dosya yükleme kısmı
                        for (const fileData of filesToProcess) {
                            try {
                                const fileContent = await readFileAsDataURL(fileData.fileObject); 
                                
                                const fileToUpload = {
                                    fileName: fileData.fileObject.name,
                                    fileType: fileData.fileObject.type,
                                    fileSize: fileData.fileObject.size,
                                    fileUrl: fileContent, 
                                    relatedTransactionId: transactionIdToAssociateFiles, 
                                    documentDesignation: transactionDesignationForFiles 
                                };
                                const fileAddResult = await ipRecordsService.addFileToRecord(this.selectedRecord.id, fileToUpload);
                                if (!fileAddResult.success) {
                                    console.error(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`);
                                    showNotification(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`, 'error');
                                }
                            } catch (fileError) {
                                console.error(`Dosya işlenirken hata (${fileData.fileObject.name}):`, fileError);
                                showNotification(`Dosya işlenirken hata (${fileData.fileObject.name}): ${fileError.message}`, 'error');
                            }
                        }
                        
                        showNotification('Tüm işlemler ve belgeler başarıyla kaydedildi!', 'success');
                        this.resetForm();
                        await this.loadRecords(); 

                    } else if (this.activeTab === 'existing-transaction-pane') {
                        if (!this.selectedTransactionId) {
                            showNotification('Lütfen dosyaları bağlamak için bir ANA işlem seçin.', 'error');
                            btn.disabled = false; return;
                        }
                        const filesToProcess = this.uploadedFiles.get(this.activeTab) || []; 
                        if (filesToProcess.length === 0) {
                            showNotification('Lütfen dosya yükleyin. Dosya yükleme zorunludur.', 'error');
                            btn.disabled = false; return;
                        }

                        const specificChildTransactionType = document.getElementById('specificChildTransactionType').value;
                        const existingChildTransactionDeliveryDate = document.getElementById('existingChildTransactionDeliveryDate').value; 

                        if (!specificChildTransactionType) {
                            showNotification('Lütfen alt işlem türünü seçin.', 'error');
                            btn.disabled = false; return;
                        }

                        if (existingChildTransactionDeliveryDate) {
                            transactionDeliveryDate = new Date(existingChildTransactionDeliveryDate).toISOString();
                        }

                        const newChildTransactionData = {
                            designation: specificChildTransactionType, 
                            transactionType: specificChildTransactionType,
                            notes: '', 
                            transactionHierarchy: 'child',
                            parentId: this.selectedTransactionId, 
                            deliveryDate: transactionDeliveryDate 
                        };
                        const childTransactionAddResult = await ipRecordsService.addTransactionToRecord(this.selectedRecord.id, newChildTransactionData);
                        if (!childTransactionAddResult.success) {
                            throw new Error(childTransactionAddResult.error || 'Yeni alt işlem oluşturulurken hata oluştu.');
                        }
                        transactionIdToAssociateFiles = childTransactionAddResult.data.transactionId; 
                        transactionDesignationForFiles = specificChildTransactionType; 
                        showNotification('Yeni alt işlem başarıyla oluşturuldu.', 'success');

                        for (const fileData of filesToProcess) {
                            try {
                                const fileContent = await readFileAsDataURL(fileData.fileObject); 
                                
                                const fileToUpload = {
                                    fileName: fileData.fileObject.name,
                                    fileType: fileData.fileObject.type,
                                    fileSize: fileData.fileObject.size,
                                    fileUrl: fileContent, 
                                    relatedTransactionId: transactionIdToAssociateFiles, 
                                    documentDesignation: transactionDesignationForFiles 
                                };
                                const fileAddResult = await ipRecordsService.addFileToRecord(this.selectedRecord.id, fileToUpload);
                                if (!fileAddResult.success) {
                                    console.error(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`);
                                    showNotification(`Dosya yüklenirken hata (${fileData.fileObject.name}): ${fileAddResult.error}`, 'error');
                                }
                            } catch (fileError) {
                                console.error(`Dosya işlenirken hata (${fileData.fileObject.name}):`, fileError);
                                showNotification(`Dosya işlenirken hata (${fileData.fileObject.name}): ${fileError.message}`, 'error');
                            }
                        }
                        
                        showNotification('Tüm işlemler ve belgeler başarıyla kaydedildi!', 'success');
                        this.resetForm();
                        await this.loadRecords(); 
                    } else if (this.activeTab === 'bulk-indexing-pane') { // Yeni: Toplu İndeksleme Sekmesi için handleSubmit mantığı
                        const bulkDeliveryDate = document.getElementById('bulkDeliveryDate').value;
                        const bulkChildTransactionType = document.getElementById('bulkChildTransactionType').value;
                        
                        if (!bulkDeliveryDate || !bulkChildTransactionType) {
                            showNotification('Lütfen tebliğ tarihi ve alt işlem türü seçin.', 'error');
                            btn.disabled = false; return;
                        }

                        if (this.pendingBulkIndexJobs.length === 0) {
                            showNotification('İşlenecek PDF bulunamadı.', 'error');
                            btn.disabled = false; return;
                        }
                        
                        showNotification('Toplu indeksleme başlatılıyor...', 'info');
                        let successfulJobs = 0;
                        let failedJobs = 0;

                        // Her bir işi döngüye al
                        for (const job of this.pendingBulkIndexJobs) {
                            // Sadece "pending" veya "ready" durumundaki işleri işle
                            if (job.status !== 'pending' && job.status !== 'ready') {
                                continue; 
                            }
                            
                            // İşlem durumunu güncelle
                            job.status = 'processing';
                            this.renderBulkIndexingTable(); // UI'da durumu yansıt

                            try {
                                // 1. İlgili portföy kaydını bul veya yükle
                                let recordToUpdate = this.bulkIndexingRecordsCache.get(job.matchedRecordId);
                                if (!recordToUpdate) {
                                    const recordResult = await ipRecordsService.getRecordById(job.matchedRecordId);
                                    if (recordResult.success) {
                                        recordToUpdate = recordResult.data;
                                        this.bulkIndexingRecordsCache.set(job.matchedRecordId, recordToUpdate); // Önbelleğe ekle
                                    } else {
                                        throw new Error(`Kayıt bulunamadı: ${job.matchedRecordId}`);
                                    }
                                }

                                // 2. Parent işlemi bul
                                // Bu toplu indeksleme işi, dosya adındaki başvuru numarasına ait parent işlemi bulmaya çalışacak
                                // Eğer bulunamazsa veya uygun bir parent yoksa, yeni bir parent oluşturulabilir.
                                // Şimdilik sadece var olan parent'lara veya genel bir parent'a bağlıyoruz
                                // Basitlik adına: her zaman ilgili record'un ilk parent işlemini parent olarak kabul et.
                                // Daha gelişmiş bir mantık gerekirse burası iyileştirilebilir.
                                const allParentTransactions = (recordToUpdate.transactions || []).filter(tx => 
                                    tx.transactionHierarchy === 'parent' || !tx.transactionHierarchy
                                );
                                let parentTransactionForChild = allParentTransactions.length > 0 ? allParentTransactions[0] : null;

                                // Eğer uygun bir parent bulunamazsa, yeni bir genel parent oluştur
                                if (!parentTransactionForChild) {
                                    const newParentData = {
                                        designation: `${recordToUpdate.title} - Genel İşlemler`,
                                        transactionType: 'Genel',
                                        transactionHierarchy: 'parent',
                                        notes: 'Toplu indeksleme için otomatik oluşturulmuş genel ana işlem.',
                                        parentId: null
                                    };
                                    const parentAddResult = await ipRecordsService.addTransactionToRecord(recordToUpdate.id, newParentData);
                                    if (parentAddResult.success) {
                                        parentTransactionForChild = parentAddResult.data;
                                        // Record'un transactions dizisini güncelle (önbellekteki kopya için)
                                        if (!recordToUpdate.transactions) recordToUpdate.transactions = [];
                                        recordToUpdate.transactions.push(parentTransactionForChild);
                                    } else {
                                        throw new Error('Otomatik parent oluşturulamadı.');
                                    }
                                }

                                // 3. Yeni child işlemi oluştur
                                const newChildTransactionData = {
                                    designation: bulkChildTransactionType, 
                                    transactionType: bulkChildTransactionType,
                                    notes: `Toplu indeksleme ile eklenen PDF (${job.fileName}).`, 
                                    transactionHierarchy: 'child',
                                    parentId: parentTransactionForChild.transactionId, 
                                    deliveryDate: new Date(bulkDeliveryDate).toISOString() // Tebliğ tarihi
                                };
                                const childTransactionAddResult = await ipRecordsService.addTransactionToRecord(recordToUpdate.id, newChildTransactionData);
                                
                                if (!childTransactionAddResult.success) {
                                    throw new Error(childTransactionAddResult.error || 'Alt işlem oluşturulurken hata oluştu.');
                                }
                                const newChildTransactionId = childTransactionAddResult.data.transactionId;
                                
                                // 4. Dosyayı yükle ve child işleme bağla
                                const fileContent = await readFileAsDataURL(job.fileObject); 
                                const fileToUpload = {
                                    fileName: job.fileName,
                                    fileType: job.fileObject.type,
                                    fileSize: job.fileObject.size,
                                    fileUrl: fileContent, 
                                    relatedTransactionId: newChildTransactionId, 
                                    documentDesignation: bulkChildTransactionType 
                                };
                                const fileAddResult = await ipRecordsService.addFileToRecord(recordToUpdate.id, fileToUpload);
                                
                                if (!fileAddResult.success) {
                                    throw new Error(fileAddResult.error || 'Dosya yüklenirken hata oluştu.');
                                }
                                
                                job.status = 'success';
                                successfulJobs++;
                                showNotification(`'${job.fileName}' başarıyla indekslendi.`, 'success');

                            } catch (jobError) {
                                job.status = 'error';
                                job.errorMessage = jobError.message;
                                failedJobs++;
                                console.error(`'${job.fileName}' işlenirken hata:`, jobError);
                                showNotification(`'${job.fileName}' işlenirken hata: ${jobError.message}`, 'error', 8000); // Hatalı işleri daha uzun göster
                            } finally {
                                this.renderBulkIndexingTable(); // Her işten sonra tabloyu güncelle
                            }
                        } // for loop sonu

                        showNotification(`Toplu indeksleme tamamlandı. Başarılı: ${successfulJobs}, Hata: ${failedJobs}`, 'info', 5000);
                        this.resetForm();
                        await this.loadRecords(); // UI'ı tamamen yenile
                    }
                } catch (error) {
                    showNotification(`Genel hata oluştu: ${error.message}`, 'error');
                } finally {
                    btn.disabled = false;
                }
            }

            // Yeni: Toplu indeksleme dosyası değiştiğinde
            handleBulkFilesChange(event) {
                const fileInput = event.target;
                const files = Array.from(fileInput.files);
                this.pendingBulkIndexJobs = []; // Mevcut işleri sıfırla

                if (!this.selectedRecord) {
                    showNotification('Lütfen önce bir IP kaydı seçin.', 'error');
                    fileInput.value = ''; // Dosya seçimini temizle
                    return;
                }

                files.forEach(file => {
                    if (file.type !== 'application/pdf') {
                        showNotification(`'${file.name}' bir PDF dosyası değil. Lütfen sadece PDF yükleyin.`, 'error');
                        return;
                    }

                    const appNumber = this.extractApplicationNumberFromFileName(file.name);
                    const matchedRecord = appNumber ? this.allRecords.find(r => r.applicationNumber === appNumber) : null;

                    this.pendingBulkIndexJobs.push({
                        jobId: generateUUID(),
                        fileName: file.name,
                        fileObject: file,
                        extractedAppNumber: appNumber,
                        matchedRecordId: matchedRecord ? matchedRecord.id : null,
                        matchedRecordDisplay: matchedRecord ? `${matchedRecord.title} (${matchedRecord.applicationNumber})` : 'Eşleşme Yok',
                        childTransactionType: document.getElementById('bulkChildTransactionType').value, // Varsayılanı al
                        tebligDate: document.getElementById('bulkDeliveryDate').value, // Varsayılanı al
                        status: matchedRecord ? 'ready' : 'pending', // Eşleşirse hazır, değilse beklemede
                        errorMessage: ''
                    });
                });
                this.renderBulkIndexingTable();
                this.checkFormCompleteness();
            }

            // Yeni: Dosya adından başvuru numarasını çek
            extractApplicationNumberFromFileName(fileName) {
                // Örnek: "TR2024_12345.pdf", "BaşvuruNo-TR12345.pdf"
                // Regex: TR ile başlayıp / veya _ ile ayrılmış numaraları arar.
                const regex = /(TR\d{4}[_\/]?\d+)/i; 
                const match = fileName.match(regex);
                return match ? match[1].replace('_', '/') : ''; // Slash'ı tekrar ekle
            }

            // Yeni: Toplu indeksleme tablosunu render et
            renderBulkIndexingTable() {
                const tableBody = document.getElementById('bulkIndexingTable').querySelector('tbody');
                const tableContainer = document.getElementById('bulkIndexingTableContainer');
                const noJobsMessage = document.getElementById('bulkTableNoJobs');
                tableBody.innerHTML = '';

                if (this.pendingBulkIndexJobs.length === 0) {
                    tableContainer.style.display = 'none';
                    noJobsMessage.style.display = 'block';
                    return;
                }

                tableContainer.style.display = 'block';
                noJobsMessage.style.display = 'none';

                this.pendingBulkIndexJobs.forEach(job => {
                    const row = tableBody.insertRow();
                    row.dataset.jobId = job.jobId;

                    row.innerHTML = `
                        <td>${job.fileName}</td>
                        <td>${job.extractedAppNumber || '-'}</td>
                        <td class="search-wrapper">
                            <input type="text" class="form-input bulk-record-search-input" 
                                data-job-id="${job.jobId}" 
                                value="${job.matchedRecordDisplay}" 
                                placeholder="Kayıt ara..."
                                autocomplete="off">
                            <div class="search-results-container bulk-search-results-container" data-job-id="${job.jobId}" style="display:none;"></div>
                        </td>
                        <td><span class="status-text ${job.status}">${job.status === 'pending' ? 'Beklemede' : job.status === 'ready' ? 'Hazır' : job.status === 'processing' ? 'İşleniyor' : job.status === 'success' ? 'Başarılı' : 'Hata'}</span>
                            ${job.errorMessage ? `<br><small style="color:red;">${job.errorMessage}</small>` : ''}
                        </td>
                        <td>
                            ${job.status === 'error' ? `<button class="btn btn-sm btn-info bulk-retry-btn" data-job-id="${job.jobId}">Tekrar Dene</button>` : 
                                job.status === 'success' ? '<span style="color:green;">✓ Tamamlandı</span>' :
                                '<button class="btn btn-sm btn-danger bulk-skip-btn" data-job-id="${job.jobId}">Atla</button>'}
                        </td>
                    `;
                });

                // Tablo içindeki input ve butonlara listener ekle
                tableBody.querySelectorAll('.bulk-record-search-input').forEach(input => {
                    input.addEventListener('input', (e) => this.searchRecordsForBulkJob(e.target.value, e.target.dataset.jobId));
                    input.addEventListener('blur', (e) => {
                        setTimeout(() => {
                            document.querySelector(`.bulk-search-results-container[data-job-id="${e.target.dataset.jobId}"]`).style.display = 'none';
                        }, 200);
                    });
                });
                tableBody.querySelectorAll('.bulk-skip-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.skipBulkJob(e.target.dataset.jobId));
                });
                tableBody.querySelectorAll('.bulk-retry-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.retryBulkJob(e.target.dataset.jobId));
                });

                // Arama sonuçları container'ına tıklandığında eleman seçimi
                tableBody.querySelectorAll('.bulk-search-results-container').forEach(container => {
                    container.addEventListener('mousedown', (e) => { // mousedown ile blur olayından önce tetiklenmesini sağla
                        if (e.target.classList.contains('record-search-item')) {
                            const jobId = e.currentTarget.dataset.jobId;
                            const recordId = e.target.dataset.id;
                            this.selectRecordForBulkJob(recordId, jobId);
                        }
                    });
                });
                this.checkFormCompleteness();
            }

            // Yeni: Tablo içindeki arama
            searchRecordsForBulkJob(query, jobId) {
                const container = document.querySelector(`.bulk-search-results-container[data-job-id="${jobId}"]`);
                container.innerHTML = '';
                if (query.length < 3) {
                    container.innerHTML = '<p class="no-results-message p-2">Arama yapmak için en az 3 karakter girin.</p>';
                    container.style.display = 'block';
                    return;
                }
                const filtered = this.allRecords.filter(r => 
                    (r.title && r.title.toLowerCase().includes(query.toLowerCase())) ||
                    (r.applicationNumber && r.applicationNumber.toLowerCase().includes(query.toLowerCase()))
                );
                
                if(filtered.length === 0) {
                    container.innerHTML = '<p class="no-results-message p-2">Kayıt bulunamadı.</p>';
                } else {
                    filtered.forEach(record => {
                        const item = document.createElement('div');
                        item.className = 'record-search-item';
                        item.dataset.id = record.id; // Record ID'yi kaydet
                        item.innerHTML = `<div class="record-info"><div>${record.title}</div><small>${record.applicationNumber}</small></div>`;
                        container.appendChild(item);
                    });
                }
                container.style.display = 'block';
            }

            // Yeni: Tablo içinde kayıt seçimi
            selectRecordForBulkJob(recordId, jobId) {
                const job = this.pendingBulkIndexJobs.find(j => j.jobId === jobId);
                const selectedRecord = this.allRecords.find(r => r.id === recordId);
                if (job && selectedRecord) {
                    job.matchedRecordId = selectedRecord.id;
                    job.matchedRecordDisplay = `${selectedRecord.title} (${selectedRecord.applicationNumber})`;
                    job.status = 'ready'; // Manuel olarak eşleşti, işlenmeye hazır
                    this.renderBulkIndexingTable(); // UI'ı güncelle
                }
                this.checkFormCompleteness();
            }

            // Yeni: Toplu indeksleme işini atla
            skipBulkJob(jobId) {
                const jobIndex = this.pendingBulkIndexJobs.findIndex(j => j.jobId === jobId);
                if (jobIndex > -1) {
                    this.pendingBulkIndexJobs.splice(jobIndex, 1); // İşlem dizisinden kaldır
                    showNotification(`İşlem atlandı: ${this.pendingBulkIndexJobs[jobIndex]?.fileName || 'dosya'}`, 'info');
                    this.renderBulkIndexingTable();
                    this.checkFormCompleteness();
                }
            }
            
            // Yeni: Hatalı toplu indeksleme işini tekrar dene
            retryBulkJob(jobId) {
                const job = this.pendingBulkIndexJobs.find(j => j.jobId === jobId);
                if (job) {
                    job.status = 'ready'; // Durumu tekrar 'ready' yap
                    job.errorMessage = ''; // Hata mesajını temizle
                    showNotification(`İşlem tekrar denenmek üzere işaretlendi: ${job.fileName}`, 'info');
                    this.renderBulkIndexingTable();
                    this.checkFormCompleteness();
                }
            }
            
            // Yeni: Toplu işlerdeki tebliğ tarihini güncelle
            updateBulkJobsTebligDate(newDate) {
                this.pendingBulkIndexJobs.forEach(job => {
                    job.tebligDate = newDate;
                });
                this.renderBulkIndexingTable(); // UI'ı güncelle
                this.checkFormCompleteness();
            }

            // Yeni: Toplu işlerdeki alt işlem türünü güncelle
            updateBulkJobsChildType(newType) {
                this.pendingBulkIndexJobs.forEach(job => {
                    job.childTransactionType = newType;
                });
                this.renderBulkIndexingTable(); // UI'ı güncelle
                this.checkFormCompleteness();
            }


            resetForm() {
                this.selectedRecord = null;
                document.getElementById('indexingForm').reset(); // Tüm formu sıfırla
                document.getElementById('documentUploadSection').style.display = 'none';
                document.getElementById('selectedRecordDisplay').value = '';
                document.getElementById('recordSearchInput').value = '';

                this.resetFormTabSpecifics(); // Her tabın kendi sıfırlamasını çağır
                this.activateTab('existing-transaction-pane'); // Varsayılan olarak ilk sekmeyi aktif yap
                this.checkFormCompleteness();
            }

            // Yeni: Her tab için özel sıfırlama mantığı
            resetFormTabSpecifics() {
                // Mevcut İşleme Dosya Ekle tabı sıfırlama
                this.uploadedFiles.set('existing-transaction-pane', []);
                document.getElementById('fileListExisting').innerHTML = '';
                document.getElementById('transactions-list-for-selection').innerHTML = '<p class="text-muted p-2">Lütfen bir kayıt seçin.</p>';
                document.getElementById('filesExistingInfo').textContent = 'Henüz dosya seçilmedi.';
                this.selectedTransactionId = null;
                const childTransactionInputsEl = document.getElementById('childTransactionInputs');
                if (childTransactionInputsEl) {
                    childTransactionInputsEl.style.display = 'none';
                    document.getElementById('specificChildTransactionType').value = ''; 
                    document.getElementById('existingChildTransactionDeliveryDate').value = ''; 
                }

                // Manuel İşlem Oluştur tabı sıfırlama
                this.uploadedFiles.set('manual-indexing-pane', []);
                document.getElementById('fileListManual').innerHTML = '';
                document.getElementById('filesManualInfo').textContent = 'Henüz dosya seçilmedi.';
                document.getElementById('specificManualTransactionType').value = '';
                document.getElementById('specificManualChildTransactionType').value = ''; 
                document.getElementById('manualChildTransactionDeliveryDate').value = '';

                // Toplu İndeksleme tabı sıfırlama
                this.pendingBulkIndexJobs = [];
                document.getElementById('bulkDeliveryDate').value = '';
                document.getElementById('bulkChildTransactionType').value = '';
                document.getElementById('bulkFilesInfo').textContent = 'Henüz PDF dosyası seçilmedi.';
                document.getElementById('bulkIndexingTableContainer').style.display = 'none';
                document.getElementById('bulkIndexingTable').querySelector('tbody').innerHTML = '';
                document.getElementById('bulkTableNoJobs').style.display = 'none';

                this.setRequiredFieldsForActiveTab();
            }
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            await loadSharedLayout({ activeMenuLink: 'indexing.html' });
            new IndexingModule();
        });
    </script>
</body>
</html>