<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BÃ¼lten YÃ¼kleme</title>
  <link rel="stylesheet" href="css/shared-styles.css" />
  <style>
    .main-container {
      max-width: 100%;
      padding: 30px;
      padding-top: 100px;
    }
    .bulletin-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .bulletin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .bulletin-table th, .bulletin-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .bulletin-table th {
      background-color: #f2f2f2;
    }
    .bulletin-table .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .bulletin-table .delete-btn:hover {
        background-color: #c82333;
    }
    .record-count-cell {
        font-style: italic;
        color: #666;
    }
  </style>
</head>
<body>
<div id="layout-placeholder"></div>

<div class="page-wrapper">
    <main class="main-container">
        <h1>BÃ¼lten YÃ¼kleme</h1>
        <p>Marka, patent ve tasarÄ±m bÃ¼ltenlerini ayrÄ± ayrÄ± yÃ¼kleyebilirsiniz.</p>

        <div class="bulletin-section">
            <h2>Marka BÃ¼lteni YÃ¼kleme</h2>
            <form id="bulletinUploadFormTrademark">
                <div class="file-upload-area" id="dropAreaTrademark">
                    <div class="upload-icon">ðŸ“‚</div>
                    <p>DosyanÄ±zÄ± buraya sÃ¼rÃ¼kleyin veya tÄ±klayÄ±n.</p>
                    <input type="file" id="bulletinFileTrademark" accept=".zip,.rar" style="display: none;" required />
                </div>
                <div id="selectedFileNameTrademark" style="margin-top:10px;"></div>
                <button type="submit" class="btn btn-primary" style="margin-top:20px;">Marka BÃ¼lteni YÃ¼kle</button>
            </form>
            <div id="uploadStatusTrademark" style="margin-top:20px;"></div>
            <div id="progressContainer" style="display:none; margin-top:10px;">
                <div id="progressBar" style="height:20px; width:0%; background:#1e3c72;"></div>
            </div>
            
            <div class="bulletin-table-container">
                <h3 style="margin-top: 30px; color: #1e3c72;">YÃ¼klÃ¼ Marka BÃ¼ltenleri</h3>
                <table class="bulletin-table" id="trademarkBulletinTable">
                    <thead>
                        <tr>
                            <th>BÃ¼lten No</th>
                            <th>BÃ¼lten Tarihi</th>
                            <th>YÃ¼klenme Tarihi</th>
                            <th>KayÄ±t SayÄ±sÄ±</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bulletin-section">
            <h2>Patent BÃ¼lteni YÃ¼kleme</h2>
            <p>Bu alan yakÄ±nda aktif olacaktÄ±r.</p>
            <button class="btn btn-secondary" disabled>YakÄ±nda</button>
        </div>
    </main>
</div>

<script type="module">
    import { loadSharedLayout } from './js/layout-loader.js';
    loadSharedLayout({ activeMenuLink: 'bulletin-upload.html' });
</script>

<script type="module">
    import { db, storage } from './firebase-config.js';
    import { collection, getDocs, doc, deleteDoc, query, where, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { ref, deleteObject, listAll } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

    // Hata ayÄ±klama iÃ§in global fonksiyon (Sayfada hata mesajlarÄ±nÄ± gÃ¶stermek iÃ§in)
    function logToScreen(message) {
        const tableBody = document.querySelector("#trademarkBulletinTable tbody");
        if(tableBody) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 5;
            td.textContent = message;
            td.style.color = "red";
            td.style.fontWeight = "bold";
            tableBody.prepend(tr); // MesajÄ± en Ã¼ste ekle
        }
    }

    // Marka bÃ¼ltenlerini Firebase'den Ã§ekip tabloya dolduran fonksiyon
    async function loadTrademarkBulletins() {
        const tableBody = document.querySelector("#trademarkBulletinTable tbody");
        if (!tableBody) {
            console.error("DEBUG: Tablo gÃ¶vdesi (tbody) HTML'de bulunamadÄ±!");
            return;
        }
        
        tableBody.innerHTML = '<tr><td colspan="5">DEBUG: Fonksiyon baÅŸladÄ±. Veriler Ã§ekiliyor...</td></tr>';
        console.log("DEBUG: loadTrademarkBulletins fonksiyonu Ã§alÄ±ÅŸtÄ±.");

        try {
            const bulletinsCollectionRef = collection(db, "trademarkBulletins");
            console.log("DEBUG: 'trademarkBulletins' koleksiyonu iÃ§in sorgu oluÅŸturuldu.");

            const querySnapshot = await getDocs(bulletinsCollectionRef);
            console.log("DEBUG: getDocs sorgusu tamamlandÄ±.");

            if (querySnapshot.empty) {
                console.log("DEBUG: Sorgu sonucu boÅŸ. HiÃ§ dokÃ¼man bulunamadÄ±.");
                tableBody.innerHTML = '<tr><td colspan="5">Firebase veritabanÄ±nda "trademarkBulletins" koleksiyonunda hiÃ§ bÃ¼lten bulunamadÄ±.</td></tr>';
                return;
            }

            console.log(`DEBUG: ${querySnapshot.size} adet bÃ¼lten dokÃ¼manÄ± bulundu.`);
            tableBody.innerHTML = ''; // Tabloyu temizle

            const allBulletins = [];
            querySnapshot.forEach(doc => {
                const bulletin = doc.data();
                allBulletins.push({ id: doc.id, ...bulletin });
            });

            // BÃ¼ltenleri yÃ¼klenme tarihine gÃ¶re azalan sÄ±rada sÄ±rala (en yeni en Ã¼stte)
            allBulletins.sort((a, b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0); // Tarih yoksa epoch baÅŸlangÄ±cÄ±
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0); // Tarih yoksa epoch baÅŸlangÄ±cÄ±
                return dateB - dateA; // En yeniden eskiye
            });

            for (const bulletin of allBulletins) {
                const uploadDate = bulletin.createdAt?.toDate ? bulletin.createdAt.toDate().toLocaleDateString('tr-TR') : 'Tarih Yok';
                
                // BÃ¼ltenin iliÅŸkili kayÄ±t sayÄ±sÄ±nÄ± al
                let recordCount = 0;
                try {
                    const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletin.id));
                    const recordsSnapshot = await getDocs(recordsQuery);
                    recordCount = recordsSnapshot.size;
                } catch (recordError) {
                    console.error(`DEBUG: BÃ¼lten ID ${bulletin.id} iÃ§in kayÄ±t sayÄ±sÄ± alÄ±nÄ±rken hata:`, recordError);
                    recordCount = 'Hata';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${bulletin.bulletinNo || 'No Yok'}</td>
                    <td>${bulletin.bulletinDate || 'Tarih Yok'}</td>
                    <td>${uploadDate}</td>
                    <td>${recordCount}</td>
                    <td><button class="delete-btn" data-id="${bulletin.id}" data-no="${bulletin.bulletinNo}">Sil</button></td>
                `;
                tableBody.appendChild(tr);
            }
            console.log("DEBUG: TÃ¼m bÃ¼ltenler tabloya eklendi.");

            // "Sil" butonlarÄ±na olay dinleyici ekle (event delegation kullanarak)
            tableBody.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-btn')) {
                    const bulletinId = e.target.dataset.id;
                    const bulletinNo = e.target.dataset.no; // bÃ¼lten numarasÄ±nÄ± da alÄ±yoruz
                    await deleteTrademarkBulletin(bulletinId, bulletinNo);
                }
            });

        } catch (error) {
            console.error("DEBUG: KRÄ°TÄ°K HATA!", error);
            // Hata mesajÄ±nÄ± tabloya yazdÄ±r
            tableBody.innerHTML = `
                <tr><td colspan="5" style="color:red; font-weight:bold;">
                    HATA OLUÅžTU! LÃ¼tfen GeliÅŸtirici Konsolu'nu (F12) aÃ§Ä±p Console sekmesindeki kÄ±rmÄ±zÄ± renkli hatayÄ± bizimle paylaÅŸÄ±n. Hata MesajÄ±: ${error.message}
                </td></tr>`;
        }
    }

    // Marka bÃ¼ltenini, ilgili tÃ¼m kayÄ±tlarÄ±nÄ± ve Storage'daki gÃ¶rsellerini silen fonksiyon
    async function deleteTrademarkBulletin(bulletinId, bulletinNo) {
        if (!confirm(`BÃ¼lten No: ${bulletinNo} olan bÃ¼lteni, tÃ¼m kayÄ±tlarÄ±nÄ± ve baÄŸlÄ± gÃ¶rselleri SÄ°LMEK istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`)) {
            return;
        }

        try {
            const batch = writeBatch(db);

            // 1. Ana bÃ¼lten dokÃ¼manÄ±nÄ± sil
            const bulletinRef = doc(db, "trademarkBulletins", bulletinId);
            batch.delete(bulletinRef);
            console.log(`DEBUG: BÃ¼lten dokÃ¼manÄ± silme iÃ§in eklendi: ${bulletinId}`);

            // 2. Ä°lgili tÃ¼m kayÄ±tlarÄ± (trademarkBulletinRecords koleksiyonundan) sil
            // NOT: Firestore batch iÅŸlemi 500'den fazla silme desteklemez. Ã‡ok fazla kayÄ±t varsa birden fazla batch gerekebilir.
            const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletinId));
            const recordsSnapshot = await getDocs(recordsQuery);
            recordsSnapshot.forEach((recordDoc) => {
                batch.delete(recordDoc.ref);
            });
            console.log(`DEBUG: ${recordsSnapshot.size} adet bÃ¼lten kaydÄ± silme iÃ§in eklendi.`);

            await batch.commit(); // Batch iÅŸlemlerini onayla
            console.log("DEBUG: Firestore iÅŸlemleri (bÃ¼lten ve kayÄ±tlar) baÅŸarÄ±yla tamamlandÄ±.");

            // 3. Firebase Storage'daki ilgili gÃ¶rselleri sil
            // GÃ¶rsel yolu formatÄ±: bulletins/trademark_${bulletinNo}_images/
            const imagesFolderPath = `bulletins/trademark_${bulletinNo}_images/`;
            const imagesRef = ref(storage, imagesFolderPath);
            
            // KlasÃ¶rdeki tÃ¼m gÃ¶rselleri listele
            const imageList = await listAll(imagesRef);
            
            if (imageList.items.length > 0) {
                console.log(`DEBUG: ${imageList.items.length} adet gÃ¶rsel siliniyor...`);
                // TÃ¼m gÃ¶rselleri paralel olarak sil
                await Promise.all(imageList.items.map(itemRef => deleteObject(itemRef)));
                console.log("DEBUG: TÃ¼m ilgili gÃ¶rseller Storage'dan baÅŸarÄ±yla silindi.");
            } else {
                console.log("DEBUG: Bu bÃ¼ltene ait gÃ¶rsel bulunamadÄ± veya klasÃ¶r boÅŸ.");
            }

            alert(`BÃ¼lten No: ${bulletinNo} baÅŸarÄ±yla silindi!`);
            loadTrademarkBulletins(); // Tabloyu yeniden yÃ¼kle

        } catch (error) {
            console.error("DEBUG: BÃ¼lten silinirken kritik hata oluÅŸtu:", error);
            alert(`BÃ¼lten silinirken bir hata oluÅŸtu: ${error.message}. Konsolu kontrol edin.`);
            logToScreen(`BÃ¼lten silme hatasÄ±: ${error.message}`);
        }
    }

    // Sayfa yÃ¼klendiÄŸinde bÃ¼ltenleri otomatik olarak yÃ¼kle
    document.addEventListener('DOMContentLoaded', loadTrademarkBulletins);
loadTrademarkBulletins();
</script>
<script type="module" src="js/bulletin-upload.js"></script>

</body>
</html>