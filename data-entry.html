<script type="module">
    import { authService, ipRecordsService, personsService, auth } from './firebase-config.js';
    import { showNotification, readFileAsDataURL, STATUSES } from './utils.js';
    import { loadSharedLayout } from './js/layout-loader.js';

    class DataEntryModule {
        constructor() {
            this.recordId = null;
            this.uploadedImage = null;
            this.existingImageUrl = null;
            this.selectedOwners = [];
            this.allPersons = [];
            this.currentUser = null;

            // 🔧 BIND işlemleri (this bağlamı kaybolmasın diye)
            this.performOwnerSearch = this.performOwnerSearch.bind(this);
            this.handleFormSubmit = this.handleFormSubmit.bind(this);
            this.handleTypeChange = this.handleTypeChange.bind(this);
        }

        async init() {
            this.currentUser = authService.getCurrentUser();
            if (!this.currentUser) {
                window.location.href = 'index.html';
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            this.recordId = urlParams.get('id');

            if (this.recordId) {
                document.querySelector('.page-title').textContent = 'Portföy Kaydı Güncelleme';
                document.querySelector('.page-subtitle').textContent = 'Mevcut bir kaydın detaylarını düzenleyin.';
                document.getElementById('saveRecordBtn').textContent = 'Kaydı Güncelle';
            }

            await this.loadInitialData();
            this.setupEventListeners();

            if (this.recordId) {
                await this.loadRecordForEdit(this.recordId);
            }
        }

        async loadInitialData() {
            const personsResult = await personsService.getPersons();
            if (personsResult.success) {
                this.allPersons = personsResult.data;
            } else {
                showNotification('Kişiler yüklenemedi: ' + personsResult.error, 'error');
            }
        }

        setupEventListeners() {
            document.getElementById('type').addEventListener('change', this.handleTypeChange);
            document.getElementById('recordForm').addEventListener('submit', this.handleFormSubmit);
            document.getElementById('cancelRecordBtn').addEventListener('click', () => window.history.back());

            const ownerSearchInput = document.getElementById('ownerSearchInput');
            const searchButton = document.getElementById('searchOwnerBtn');

            if (searchButton) {
                searchButton.addEventListener('click', (e) => {
                    e.preventDefault();
                    this.performOwnerSearch(ownerSearchInput.value);
                });
            }

            if (ownerSearchInput) {
                ownerSearchInput.addEventListener('input', (event) => {
                    this.performOwnerSearch(event.target.value);
                });
                ownerSearchInput.addEventListener('blur', () => {
                    setTimeout(() => {
                        document.getElementById('mainOwnerSearchResults').style.display = 'none';
                    }, 200);
                });
            }

            document.getElementById('addPersonToOwnerBtn').addEventListener('click', () => {
                window.location.href = 'persons.html';
            });

            document.getElementById('mainOwnerSearchResults').addEventListener('mousedown', (event) => {
                const target = event.target.closest('.search-result-item');
                if (target) {
                    const personId = target.dataset.id;
                    this.addOwner(personId);
                    ownerSearchInput.value = '';
                    document.getElementById('mainOwnerSearchResults').style.display = 'none';
                }
            });

            document.getElementById('selectedOwnersGrid').addEventListener('click', (event) => {
                if (event.target.classList.contains('remove-owner')) {
                    this.removeOwner(event.target.dataset.id);
                }
            });

            // Sayfa odağa geldiğinde kişileri yeniden yükle (yeni kişi eklenmişse)
            window.addEventListener('focus', () => this.loadInitialData());
        }

        performOwnerSearch(searchTerm) {
            const lowerSearchTerm = searchTerm.toLowerCase();
            const resultsContainer = document.getElementById('mainOwnerSearchResults');
            resultsContainer.innerHTML = '';

            if (lowerSearchTerm.length < 1) {
                resultsContainer.style.display = 'none';
                return;
            }

            const filtered = this.allPersons.filter(person =>
                person.name.toLowerCase().includes(lowerSearchTerm) &&
                !this.selectedOwners.some(p => p.id === person.id)
            );

            if (filtered.length > 0) {
                filtered.forEach(person => {
                    const item = document.createElement('div');
                    item.classList.add('search-result-item');
                    item.textContent = `${person.name} (${person.personType === 'real' ? 'Gerçek' : 'Tüzel'})`;
                    item.dataset.id = person.id;
                    resultsContainer.appendChild(item);
                });
                resultsContainer.style.display = 'block';
            } else {
                resultsContainer.innerHTML = '<p style="padding: 10px; text-align: center; color: #666;">Sonuç bulunamadı.</p>';
                resultsContainer.style.display = 'block';
            }
        }

        handleTypeChange(event) {
            const type = event.target ? event.target.value : event;
            this.renderTypeSpecificFields(type);
            this.populateStatusOptions(type);
        }

        renderTypeSpecificFields(type) {
            const container = document.getElementById('type-specific-fields');
            container.innerHTML = '';
            if (!type) return;

            let fieldsHtml = '';
            switch (type) {
                case 'patent':
                    fieldsHtml = `<div class="dynamic-fields show form-grid">
                        <div class="form-group"><label for="patentClass" class="form-label">Patent Sınıfı:</label><input type="text" id="patentClass" name="patentClass" class="form-input"></div>
                        <div class="form-group date-picker-group"><label for="renewalDatePatent" class="form-label">Yenileme Tarihi:</label><input type="date" id="renewalDatePatent" name="renewalDatePatent" class="form-input"></div>
                    </div>`;
                    break;
                case 'trademark':
                    fieldsHtml = `<div class="dynamic-fields show form-grid">
                        <div class="form-group"><label for="niceClass" class="form-label">Nice Sınıfı:</label><input type="text" id="niceClass" name="niceClass" class="form-input"></div>
                        <div class="form-group date-picker-group"><label for="renewalDateTrademark" class="form-label">Yenileme Tarihi:</label><input type="date" id="renewalDateTrademark" name="renewalDateTrademark" class="form-input"></div>
                        <div class="form-group full-width"><label for="trademarkImage" class="form-label">Marka Görseli (JPG, PNG):</label><input type="file" id="trademarkImage" name="trademarkImage" accept="image/jpeg,image/png" style="display: none;">
                        <div class="image-upload-area" id="trademarkImageUploadArea"><span class="image-upload-icon">🖼️</span><p>Görsel Yüklemek İçin Tıklayın veya Sürükleyin</p></div>
                        <img id="trademarkImagePreview" class="image-preview" src="#" alt="Görsel Önizleme" style="display: none;">
                        <button type="button" id="removeTrademarkImage" style="display: none; margin-top: 10px;" class="btn btn-secondary btn-small">Görseli Kaldır</button></div>
                    </div>`;
                    break;
                case 'copyright':
                    fieldsHtml = `<div class="dynamic-fields show form-grid">
                        <div class="form-group"><label for="copyrightType" class="form-label">Telif Hakkı Tipi:</label><input type="text" id="copyrightType" name="copyrightType" class="form-input"></div>
                    </div>`;
                    break;
                case 'design':
                    fieldsHtml = `<div class="dynamic-fields show form-grid">
                        <div class="form-group"><label for="designClass" class="form-label">Tasarım Sınıfı:</label><input type="text" id="designClass" name="designClass" class="form-input"></div>
                        <div class="form-group date-picker-group"><label for="renewalDateDesign" class="form-label">Yenileme Tarihi:</label><input type="date" id="renewalDateDesign" name="renewalDateDesign" class="form-input"></div>
                    </div>`;
                    break;
            }

            container.innerHTML = fieldsHtml;

            if (type === 'trademark') {
                this.setupImageUploadListeners();
            }
        }

        populateStatusOptions(type) {
            const statusSelect = document.getElementById('status');
            statusSelect.innerHTML = '<option value="">Durum Seçin</option>';
            const options = STATUSES[type] || [];
            options.forEach(status => {
                statusSelect.add(new Option(status.text, status.value));
            });
        }

        setupImageUploadListeners() {
            const uploadArea = document.getElementById('trademarkImageUploadArea');
            const fileInput = document.getElementById('trademarkImage');
            const removeButton = document.getElementById('removeTrademarkImage');

            if (uploadArea) uploadArea.onclick = () => fileInput.click();
            if (fileInput) fileInput.onchange = this.handleImageSelect;
            if (removeButton) removeButton.onclick = this.removeImage;
        }

        handleImageSelect = (e) => {
            if (e.target.files.length > 0) this.handleImageFile(e.target.files[0]);
        }

        handleImageFile(file) {
            this.uploadedImage = file;
            this.displayImagePreview(file);
        }

        displayImagePreview(fileOrUrl) {
            const preview = document.getElementById('trademarkImagePreview');
            const removeButton = document.getElementById('removeTrademarkImage');
            if (typeof fileOrUrl === 'string') {
                preview.src = fileOrUrl;
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(fileOrUrl);
            }
            preview.style.display = 'block';
            removeButton.style.display = 'inline-block';
        }

        removeImage = () => {
            const preview = document.getElementById('trademarkImagePreview');
            const removeButton = document.getElementById('removeTrademarkImage');
            const fileInput = document.getElementById('trademarkImage');
            preview.src = '#';
            preview.style.display = 'none';
            removeButton.style.display = 'none';
            if (fileInput) fileInput.value = '';
            this.uploadedImage = null;
            this.existingImageUrl = null;
        }

        addOwner(personId) {
            if (this.selectedOwners.some(p => p.id === personId)) return;
            const person = this.allPersons.find(p => p.id === personId);
            if (person) {
                this.selectedOwners.push(person);
                this.renderSelectedOwners();
            }
        }

        removeOwner(personId) {
            this.selectedOwners = this.selectedOwners.filter(p => p.id !== personId);
            this.renderSelectedOwners();
        }

        renderSelectedOwners() {
            const grid = document.getElementById('selectedOwnersGrid');
            grid.innerHTML = '';
            this.selectedOwners.forEach(person => {
                const tag = document.createElement('div');
                tag.classList.add('owner-tag');
                tag.innerHTML = `<span>${person.name}</span><button type="button" class="remove-owner" data-id="${person.id}">&times;</button>`;
                grid.appendChild(tag);
            });
        }

        async loadRecordForEdit(id) {
            const result = await ipRecordsService.getRecordById(id);
            if (result.success && result.data) {
                this.fillFormWithRecordData(result.data);
            } else {
                showNotification("Kayıt verileri yüklenemedi.", "error");
            }
        }

        fillFormWithRecordData(record) {
            document.getElementById('type').value = record.type;
            this.handleTypeChange(record.type);

            setTimeout(() => {
                document.getElementById('title').value = record.title || '';
                document.getElementById('status').value = record.status || '';
                document.getElementById('applicationNumber').value = record.applicationNumber || '';
                document.getElementById('applicationDate').value = record.applicationDate || '';
                document.getElementById('registrationDate').value = record.registrationDate || '';
                document.getElementById('description').value = record.description || '';

                if (record.type === 'patent') {
                    document.getElementById('patentClass').value = record.patentClass || '';
                    document.getElementById('renewalDatePatent').value = record.renewalDatePatent || '';
                } else if (record.type === 'trademark') {
                    document.getElementById('niceClass').value = record.niceClass || '';
                    document.getElementById('renewalDateTrademark').value = record.renewalDateTrademark || '';
                    if (record.trademarkImage?.content) {
                        this.existingImageUrl = record.trademarkImage.content;
                        this.displayImagePreview(this.existingImageUrl);
                    }
                } else if (record.type === 'copyright') {
                    document.getElementById('copyrightType').value = record.copyrightType || '';
                } else if (record.type === 'design') {
                    document.getElementById('designClass').value = record.designClass || '';
                    document.getElementById('renewalDateDesign').value = record.renewalDateDesign || '';
                }

                if (record.owners) {
                    this.selectedOwners = record.owners;
                    this.renderSelectedOwners();
                }
            }, 100);
        }

        async handleFormSubmit(event) {
            event.preventDefault();
            document.getElementById('saveRecordBtn').disabled = true;

            try {
                const form = event.target;
                const recordData = {
                    type: form.type.value,
                    title: form.title.value,
                    status: form.status.value,
                    owners: this.selectedOwners.map(p => ({ id: p.id })),
                };

                const addFieldIfValue = (key, value) => { if (value) recordData[key] = value; };
                addFieldIfValue('applicationNumber', form.applicationNumber.value);
                addFieldIfValue('applicationDate', form.applicationDate.value);
                addFieldIfValue('registrationDate', form.registrationDate.value);
                addFieldIfValue('description', form.description.value);

                if (recordData.type === 'patent') {
                    addFieldIfValue('patentClass', form.patentClass.value);
                    addFieldIfValue('renewalDatePatent', form.renewalDatePatent.value);
                } else if (recordData.type === 'trademark') {
                    addFieldIfValue('niceClass', form.niceClass.value);
                    addFieldIfValue('renewalDateTrademark', form.renewalDateTrademark.value);
                    if (this.uploadedImage) {
                        recordData.trademarkImage = await readFileAsDataURL(this.uploadedImage);
                    } else if (this.existingImageUrl) {
                        recordData.trademarkImage = { content: this.existingImageUrl, name: 'existing_image' };
                    }
                } else if (recordData.type === 'copyright') {
                    addFieldIfValue('copyrightType', form.copyrightType.value);
                } else if (recordData.type === 'design') {
                    addFieldIfValue('designClass', form.designClass.value);
                    addFieldIfValue('renewalDateDesign', form.renewalDateDesign.value);
                }

                let result;
                if (this.recordId) {
                    recordData.updatedAt = new Date().toISOString();
                    result = await ipRecordsService.updateRecord(this.recordId, recordData);
                } else {
                    recordData.createdAt = new Date().toISOString();
                    recordData.updatedAt = new Date().toISOString();
                    recordData.userEmail = this.currentUser.email;
                    recordData.userId = this.currentUser.uid;
                    result = await ipRecordsService.addRecord(recordData);
                }

                if (result.success) {
                    showNotification(this.recordId ? 'Kayıt güncellendi!' : 'Kayıt eklendi!', 'success');
                    window.location.href = 'portfolio.html';
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('İşlem sırasında bir hata oluştu: ' + error.message, 'error');
            } finally {
                document.getElementById('saveRecordBtn').disabled = false;
            }
        }
    }

    let dataEntryModule;
    document.addEventListener('DOMContentLoaded', async () => {
        await loadSharedLayout({ activeMenuLink: 'data-entry.html' });
        dataEntryModule = new DataEntryModule();
        auth.onAuthStateChanged(async (user) => {
            if (user || authService.getCurrentUser()) {
                await dataEntryModule.init();
                window.dataEntryModule = dataEntryModule;
            } else {
                window.location.href = 'index.html';
            }
        });
    });
</script>
