<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>B√ºlten Y√ºkleme</title>
  <link rel="stylesheet" href="css/shared-styles.css" />
  <style>
    .main-container {
      max-width: 100%;
      padding: 30px;
      padding-top: 100px;
    }
    .bulletin-section {
      background: white;
      padding: 25px;
      border-radius: 12px;
      margin-bottom: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .bulletin-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    .bulletin-table th, .bulletin-table td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: left;
    }
    .bulletin-table th {
      background-color: #f2f2f2;
    }
    .bulletin-table .delete-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .bulletin-table .delete-btn:hover {
        background-color: #c82333;
    }
    .record-count-cell {
        font-style: italic;
        color: #666;
    }
    
    /* Progress Bar Stilleri */
    .delete-progress-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
    }
    
    .delete-progress-container {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        min-width: 400px;
        text-align: center;
    }
    
    .delete-progress-title {
        font-size: 1.2em;
        color: #1e3c72;
        margin-bottom: 20px;
        font-weight: 600;
    }
    
    .delete-progress-bar {
        width: 100%;
        height: 20px;
        background: #e1e8ed;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 15px;
    }
    
    .delete-progress-fill {
        height: 100%;
        background: linear-gradient(45deg, #1e3c72, #2a5298);
        border-radius: 10px;
        width: 0%;
        transition: width 0.3s ease;
        position: relative;
    }
    
    .delete-progress-text {
        color: #666;
        font-size: 0.9em;
        margin-bottom: 10px;
    }
    
    .delete-progress-details {
        color: #888;
        font-size: 0.8em;
    }
  </style>
</head>
<body>
<div id="layout-placeholder"></div>

<div class="page-wrapper">
    <main class="main-container">
        <h1>B√ºlten Y√ºkleme</h1>
        <p>Marka, patent ve tasarƒ±m b√ºltenlerini ayrƒ± ayrƒ± y√ºkleyebilirsiniz.</p>

        <div class="bulletin-section">
            <h2>Marka B√ºlteni Y√ºkleme</h2>
            <form id="bulletinUploadFormTrademark">
                <div class="file-upload-area" id="dropAreaTrademark">
                    <div class="upload-icon">üìÇ</div>
                    <p>Dosyanƒ±zƒ± buraya s√ºr√ºkleyin veya tƒ±klayƒ±n.</p>
                    <input type="file" id="bulletinFileTrademark" accept=".zip,.rar" style="display: none;" required />
                </div>
                <div id="selectedFileNameTrademark" style="margin-top:10px;"></div>
                <button type="submit" class="btn btn-primary" style="margin-top:20px;">Marka B√ºlteni Y√ºkle</button>
            </form>
            <div id="uploadStatusTrademark" style="margin-top:20px;"></div>
            <div id="progressContainer" style="display:none; margin-top:10px;">
                <div id="progressBar" style="height:20px; width:0%; background:#1e3c72;"></div>
            </div>
            
            <div class="bulletin-table-container">
                <h3 style="margin-top: 30px; color: #1e3c72;">Y√ºkl√º Marka B√ºltenleri</h3>
                <table class="bulletin-table" id="trademarkBulletinTable">
                    <thead>
                        <tr>
                            <th>B√ºlten No</th>
                            <th>B√ºlten Tarihi</th>
                            <th>Y√ºklenme Tarihi</th>
                            <th>Kayƒ±t Sayƒ±sƒ±</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

        <div class="bulletin-section">
            <h2>Patent B√ºlteni Y√ºkleme</h2>
            <p>Bu alan yakƒ±nda aktif olacaktƒ±r.</p>
            <button class="btn btn-secondary" disabled>Yakƒ±nda</button>
        </div>
    </main>
</div>

<!-- Progress Bar Overlay -->
<div id="deleteProgressOverlay" class="delete-progress-overlay">
    <div class="delete-progress-container">
        <div class="delete-progress-title">B√ºlten Siliniyor...</div>
        <div class="delete-progress-bar">
            <div id="deleteProgressFill" class="delete-progress-fill"></div>
        </div>
        <div id="deleteProgressText" class="delete-progress-text">Ba≈ülatƒ±lƒ±yor...</div>
        <div id="deleteProgressDetails" class="delete-progress-details"></div>
    </div>
</div>

<script type="module">
    import { loadSharedLayout } from './js/layout-loader.js';
    loadSharedLayout({ activeMenuLink: 'bulletin-upload.html' });
</script>

<script>
// Basit ve garantili √ßalƒ±≈üacak script
console.log('üöÄ B√ºlten script ba≈üladƒ±');

// Sayfa y√ºklendikten sonra tabloyu doldur
setTimeout(async () => {
    try {
        console.log('üîÑ Tablo dolduruluyor...');
        
        // Firebase mod√ºllerini import et
        const firebaseModule = await import('./firebase-config.js');
        const { collection, getDocs, query, where, doc, deleteDoc, writeBatch, getCountFromServer } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const { getFunctions, httpsCallable } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js');
        const { showNotification } = await import('./utils.js');
        
        console.log('‚úÖ Firebase mod√ºlleri y√ºklendi');
        
        const db = firebaseModule.db;
        const app = firebaseModule.app;
        const functions = getFunctions(app, "europe-west1");
        
        // Tabloyu doldur
        async function loadTrademarkBulletins() {
            console.log('üìã B√ºltenler y√ºkleniyor...');
            
            const tableBody = document.querySelector("#trademarkBulletinTable tbody");
            if (!tableBody) {
                console.error('‚ùå Tablo bulunamadƒ±');
                return;
            }
            
            tableBody.innerHTML = '<tr><td colspan="5">Veriler √ßekiliyor...</td></tr>';
            
            try {
                const bulletinsRef = collection(db, "trademarkBulletins");
                const snapshot = await getDocs(bulletinsRef);
                
                if (snapshot.empty) {
                    tableBody.innerHTML = '<tr><td colspan="5">Hi√ß b√ºlten bulunamadƒ±.</td></tr>';
                    return;
                }
                
                console.log(`üì¶ ${snapshot.size} b√ºlten bulundu`);
                
                tableBody.innerHTML = '';
                
                const allBulletins = [];
                snapshot.forEach(doc => {
                    allBulletins.push({ id: doc.id, ...doc.data() });
                });
                
                // Tarihe g√∂re sƒ±rala
                allBulletins.sort((a, b) => {
                    const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                    const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                    return dateB - dateA;
                });
                
                // Her b√ºlten i√ßin satƒ±r ekle
                for (const bulletin of allBulletins) {
                    const uploadDate = bulletin.createdAt?.toDate ? 
                        bulletin.createdAt.toDate().toLocaleDateString('tr-TR') : 'Tarih Yok';
                    
                    // PERFORMANS: Sadece COUNT al, kayƒ±tlarƒ± √ßekme
                    let recordCount = 0;
                    try {
                        const recordsQuery = query(collection(db, "trademarkBulletinRecords"), where("bulletinId", "==", bulletin.id));
                        const countSnapshot = await getCountFromServer(recordsQuery);
                        recordCount = countSnapshot.data().count;
                        console.log(`üìä ${bulletin.bulletinNo}: ${recordCount} kayƒ±t (sadece count)`);
                    } catch (countError) {
                        console.warn(`‚ö†Ô∏è ${bulletin.bulletinNo} count hatasƒ±:`, countError);
                        recordCount = '-';
                    }
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = 
                        '<td>' + (bulletin.bulletinNo || 'No Yok') + '</td>' +
                        '<td>' + (bulletin.bulletinDate || 'Tarih Yok') + '</td>' +
                        '<td>' + uploadDate + '</td>' +
                        '<td>' + recordCount + '</td>' +
                        '<td><button class="delete-btn" onclick="deleteTrademarkBulletin(\'' + bulletin.id + '\', \'' + (bulletin.bulletinNo || '') + '\')">Hƒ±zlƒ± Sil</button></td>';
                    
                    tableBody.appendChild(tr);
                }
                
                console.log('‚úÖ Tablo ba≈üarƒ±yla dolduruldu');
                
            } catch (error) {
                console.error('‚ùå Tablo doldurma hatasƒ±:', error);
                tableBody.innerHTML = '<tr><td colspan="5" style="color:red;">Hata: ' + error.message + '</td></tr>';
                showNotification('Tablo y√ºkleme hatasƒ±: ' + error.message, 'error', 8000);
            }
        }
        
        // Progress bar fonksiyonlarƒ±
        function showDeleteProgress() {
            document.getElementById('deleteProgressOverlay').style.display = 'flex';
        }
        
        function hideDeleteProgress() {
            document.getElementById('deleteProgressOverlay').style.display = 'none';
        }
        
        function updateDeleteProgress(percent, text, details = '') {
            document.getElementById('deleteProgressFill').style.width = percent + '%';
            document.getElementById('deleteProgressText').textContent = text;
            document.getElementById('deleteProgressDetails').textContent = details;
        }

        // üî• YENƒ∞ BACKEND DELETE FONKSƒ∞YONU - REGION FIX
        window.deleteTrademarkBulletin = async function(bulletinId, bulletinNo) {
            const userConfirmed = confirm(
                `‚ö†Ô∏è "${bulletinNo}" numaralƒ± b√ºlteni silmek istediƒüinizden emin misiniz?\n\n` +
                `Bu i≈ülem geri alƒ±namaz ve ≈üunlarƒ± silecek:\n` +
                `‚Ä¢ Ana b√ºlten kaydƒ±\n` +
                `‚Ä¢ T√ºm marka kayƒ±tlarƒ±\n` +
                `‚Ä¢ T√ºm g√∂rsel dosyalar\n\n` +
                `ƒ∞≈ülem 30-90 saniye s√ºrecek (backend'de hƒ±zlƒ± silme).`
            );
            
            if (!userConfirmed) {
                return;
            }
            
            try {
                console.log(`üóëÔ∏è Backend silme fonksiyonu √ßaƒürƒ±lƒ±yor: ${bulletinNo}`);
                
                // Progress g√∂ster
                showDeleteProgress();
                updateDeleteProgress(10, 'Backend silme i≈ülemi ba≈ülatƒ±lƒ±yor...', 'Cloud Function √ßaƒürƒ±lƒ±yor');
                
                // Backend fonksiyonunu √ßaƒüƒ±r
                const deleteBulletinFunction = httpsCallable(functions, 'deleteBulletinV2');
                
                updateDeleteProgress(20, 'Cloud Function √ßalƒ±≈üƒ±yor...', 'Bu i≈ülem 30-90 saniye s√ºrebilir');
                
                console.log('üìû Function √ßaƒürƒ±lƒ±yor...');
                const startTime = performance.now();
                
                const result = await deleteBulletinFunction({ bulletinId });
                const data = result.data;
                
                const duration = Math.round((performance.now() - startTime) / 1000);
                console.log('üéâ Backend silme sonucu:', data);
                console.log(`‚è±Ô∏è ƒ∞≈ülem s√ºresi: ${duration} saniye`);
                
                if (data.success) {
                    // Ba≈üarƒ±lƒ± sonu√ß
                    updateDeleteProgress(100, 'Silme i≈ülemi tamamlandƒ±!', 
                        `‚úÖ B√ºlten ${data.bulletinNo} ba≈üarƒ±yla silindi!`);
                    
                    setTimeout(() => {
                        hideDeleteProgress();
                        
                        // Detaylƒ± sonu√ß bildirimi
                        const hasErrors = data.errors && data.errors.length > 0;
                        const successMessage = `üéâ B√ºlten ${data.bulletinNo} ba≈üarƒ±yla silindi!
‚Ä¢ Ana b√ºlten: ‚úÖ
‚Ä¢ Kayƒ±tlar: ${data.recordsDeleted}/${data.totalRecords} ‚úÖ  
‚Ä¢ G√∂rseller: ${data.imagesDeleted}/${data.totalImages} ${data.imagesDeleted === data.totalImages ? '‚úÖ' : '‚ö†Ô∏è'}
${hasErrors ? '\n‚ö†Ô∏è Uyarƒ±lar: ' + data.errors.join(', ') : ''}

‚ö° ƒ∞≈ülem s√ºresi: ${duration} saniye (backend silme)`;
                        
                        showNotification(
                            successMessage, 
                            hasErrors ? 'warning' : 'success', 
                            hasErrors ? 10000 : 8000
                        );
                        
                        // Tabloyu yenile
                        console.log('üîÑ Tablo yenileniyor...');
                        loadTrademarkBulletins();
                    }, 2000);
                    
                } else {
                    // Hata durumu
                    throw new Error(data.error || 'Bilinmeyen backend hatasƒ±');
                }
                
            } catch (error) {
                console.error('‚ùå Backend silme hatasƒ±:', error);
                console.error('‚ùå Error details:', error);
                
                hideDeleteProgress();
                
                showNotification(
                    `‚ùå Backend silme hatasƒ±: ${error.message}\n\n` +
                    `Fonksiyon deploy edildi mi?\n` +
                    `Console logs: firebase functions:log --only deleteBulletinV2`, 
                    'error', 
                    15000
                );
            }
        };
        
        // ƒ∞lk y√ºkleme
        await loadTrademarkBulletins();
        
    } catch (error) {
        console.error('‚ùå Script hatasƒ±:', error);
        
        // showNotification ile hata g√∂ster
        try {
            const { showNotification } = await import('./utils.js');
            showNotification('Script hatasƒ±: ' + error.message, 'error', 10000);
        } catch (importError) {
            // Fallback: tabloya hata yazdƒ±r
            const tableBody = document.querySelector("#trademarkBulletinTable tbody");
            if (tableBody) {
                tableBody.innerHTML = '<tr><td colspan="5" style="color:red;">Script hatasƒ±: ' + error.message + '</td></tr>';
            }
        }
    }
}, 1500); // 1.5 saniye bekle

</script>
<script type="module" src="js/bulletin-upload.js"></script>

</body>
</html>