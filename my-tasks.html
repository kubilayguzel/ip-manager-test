<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IP Manager - İşlerim</title>
    <style>
        /* ... Stillerin tamamı aynı ... */
        /* Yeni stiller eklendi */
        .action-btn.add-accrual-btn { background-color: #28a745; }
        .action-btn.add-accrual-btn:hover { background-color: #218838; }
        #addAccrualModal .modal-content { max-width: 700px; }
        .input-with-currency { display: flex; gap: 10px; }
        .input-with-currency .form-input { flex-grow: 1; }
        .currency-select { padding: 12px 8px; border: 2px solid #e1e8ed; border-radius: 10px; background-color: #f8f9fa; font-weight: bold; }
        .checkbox-label { display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: 500; }
        .checkbox-label input { width: 18px; height: 18px; }
        .total-amount-display { font-size: 1.2em; font-weight: bold; color: #1e3c72; text-align: right; margin-top: 10px; padding: 12px 15px; background-color: #f0f4f8; border-radius: 10px; }
        .search-results-list { max-height: 150px; overflow-y: auto; border: 1px solid #ccc; border-radius: 8px; margin-top: 5px; }
        .search-result-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .search-result-item:hover { background-color: #f0f4f8; }
        .search-result-display { background: #e9f5ff; border: 1px solid #bde0fe; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .related-accrual-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9em;
            border-left: 3px solid #1e3c72;
        }
        .status-badge.status-paid { background-color: #28a745; }
        .status-badge.status-unpaid { background-color: #dc3545; }
    </style>
</head>
<body>
    <aside class="sidebar">
        </aside>

    <div class="page-wrapper">
        <header class="top-header">
            </header>

        <main class="main-container">
            <section class="page-header">
                <h1 class="page-title">Bana Atanan İşler</h1>
                <p class="page-subtitle">Size atanmış olan tüm görevleri buradan takip edebilirsiniz.</p>
            </section>
    
            <div class="tasks-container">
                <div class="tasks-header">
                    <div class="filter-group">
                        <label class="filter-label" for="statusFilter">Duruma Göre Filtrele:</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">Tümü</option>
                            <option value="open">Açık</option>
                            <option value="in_progress">Devam Ediyor</option>
                            <option value="pending_review">Gözden Geçiriliyor</option>
                            <option value="completed">Tamamlandı</option>
                        </select>
                        <button class="btn-primary btn-reassign" id="reassignBtn" style="display: none;">Seçilenleri Ata</button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="task-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAllCheckbox"></th>
                                <th>Öncelik</th>
                                <th>İş Başlığı</th>
                                <th>İlgili Kayıt</th>
                                <th>Bitiş Tarihi</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody id="tasksTableBody">
                        </tbody>
                    </table>
                     <div id="loadingIndicator" class="loading">Yükleniyor...</div>
                     <div id="noTasksMessage" class="no-tasks">Size atanmış aktif bir iş bulunmamaktadır.</div>
                </div>
            </div>
        </main>
    </div>

    <div id="viewTaskDetailModal" class="modal">
        <div class="modal-content-lg">
            <span class="close-modal-btn" id="closeViewTaskDetailModal">&times;</span>
            <h3 class="modal-title" id="modalViewTaskTitle">İş Detayı</h3>
            <div class="modal-body-content">
                <div class="modal-detail-grid">
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">İş Başlığı</div><div class="modal-detail-value" id="modalViewTaskTitleValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">Açıklama</div><div class="modal-detail-value long-text" id="modalViewTaskDescriptionValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">İş Türü</div><div class="modal-detail-value" id="modalViewTaskTypeValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Öncelik</div><div class="modal-detail-value" id="modalViewTaskPriorityValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Atanan Kişi</div><div class="modal-detail-value" id="modalViewAssignedToValue"></div></div>
                    <div class="modal-detail-item"><div class="modal-detail-label">Bitiş Tarihi</div><div class="modal-detail-value" id="modalViewTaskDueDateValue"></div></div>
                    <div class="modal-detail-item full-width"><div class="modal-detail-label">İlgili Fikri Mülkiyet Kaydı</div><div class="modal-detail-value" id="modalViewRelatedIpRecordValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedPartyGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedPartyLabel"></div><div class="modal-detail-value" id="modalViewRelatedPartyValue"></div></div>
                    <div class="modal-detail-item full-width" id="modalViewRelatedTransactionGroup" style="display:none;"><div class="modal-detail-label" id="modalViewRelatedTransactionLabel"></div><div class="modal-detail-value" id="modalViewRelatedTransactionValue"></div></div>
                    
                    <h4 class="modal-detail-section-title">İlişkili Tahakkuklar</h4>
                    <div class="modal-detail-item full-width" id="modalViewRelatedAccruals">
                        <p style="text-align: center; color: #666;">Tahakkuk bilgisi bulunmuyor.</p>
                    </div>

                    <h4 class="modal-detail-section-title">İşlem Geçmişi</h4>
                    <div class="modal-detail-item full-width task-history" id="modalViewTaskHistory"><p style="text-align: center; color: #666;">İşlem geçmişi bulunmuyor.</p></div>
                </div>
            </div>
        </div>
    </div>

    <div id="editTaskModal" class="modal"> </div>
    <div id="completeTaskModal" class="modal"> </div>
    <div class="modal" id="ipRecordDetailModal"> </div>
    <div class="modal" id="reassignTaskModal"> </div>
    
    <div class="modal" id="addAccrualModal">
        <div class="modal-content">
            <span class="close-modal-btn" id="closeAddAccrualModal">&times;</span>
            <h3 class="modal-title">İşe Yeni Tahakkuk Ekle</h3>
            <form id="addAccrualForm" onsubmit="return false;">
                <input type="hidden" id="accrualTaskId">
                <div class="modal-body-content">
                    <div class="form-group">
                        <label for="accrualTaskTitleDisplay" class="form-label">İlgili İş</label>
                        <input type="text" id="accrualTaskTitleDisplay" class="form-input" readonly>
                    </div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="officialFee" class="form-label">Resmi Ücret</label>
                            <div class="input-with-currency">
                                <input type="number" id="officialFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="officialFeeCurrency" class="currency-select">
                                    <option value="TL" selected>TL</option><option value="EUR">EUR</option><option value="USD">USD</option><option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="serviceFee" class="form-label">Hizmet Bedeli</label>
                            <div class="input-with-currency">
                                <input type="number" id="serviceFee" class="form-input" placeholder="0.00" step="0.01">
                                <select id="serviceFeeCurrency" class="currency-select">
                                    <option value="TL" selected>TL</option><option value="EUR">EUR</option><option value="USD">USD</option><option value="CHF">CHF</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="vatRate" class="form-label">KDV Oranı (%)</label>
                        <input type="number" id="vatRate" class="form-input" value="20">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="applyVatToOfficialFee" checked>
                            Resmi Ücrete KDV Uygula
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Toplam Tutar</label>
                        <div id="totalAmountDisplay" class="total-amount-display">0.00 TL</div>
                    </div>
                    <div class="form-group">
                        <label for="tpInvoicePartySearch" class="form-label">Türk Patent Faturası Tarafı</label>
                        <input type="text" id="tpInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="tpInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedTpInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="serviceInvoicePartySearch" class="form-label">Hizmet Faturası Tarafı</label>
                        <input type="text" id="serviceInvoicePartySearch" class="form-input" placeholder="Fatura tarafı arayın...">
                        <div id="serviceInvoicePartyResults" class="search-results-list"></div>
                        <div id="selectedServiceInvoicePartyDisplay" class="search-result-display" style="display:none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelAddAccrualBtn">İptal</button>
                    <button type="button" class="btn btn-primary" id="saveAccrualBtn">Tahakkuku Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { authService, taskService, ipRecordsService, personsService, accrualService, auth, generateUUID } from './firebase-config.js';

        class MyTasksModule {
            constructor() {
                this.currentUser = null;
                this.tasks = [];
                this.allIpRecords = [];
                this.allPersons = [];
                this.allAccruals = [];
                this.allUsers = [];
                this.uploadedCompletionFiles = [];
                this.uploadedEditFiles = [];
                this.currentEditTask = null;
                this.selectedTasks = new Set();
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                this.init();
            }

            init() {
                authService.auth.onAuthStateChanged(async user => {
                    if (user) {
                        this.currentUser = authService.getCurrentUser();
                        this.updateUserInfo();
                        await this.loadInitialData();
                        this.setupEventListeners();
                    } else {
                        window.location.href = 'index.html';
                    }
                });
            }

            updateUserInfo() {
                if (this.currentUser) {
                    const userName = this.currentUser.displayName || this.currentUser.email.split('@')[0] || 'Kullanıcı';
                    const userRole = this.currentUser.role === 'admin' ? 'Yönetici' : this.currentUser.role === 'superadmin' ? 'Süper Yönetici' : 'Kullanıcı';
                    document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
                    document.getElementById('userName').textContent = userName;
                    document.getElementById('userRole').textContent = userRole;
                }
            }
            
            async loadInitialData() {
                document.getElementById('loadingIndicator').style.display = 'block';
                document.getElementById('noTasksMessage').style.display = 'none';
                document.getElementById('tasksTableBody').innerHTML = '';
                
                try {
                    const [tasksResult, ipRecordsResult, personsResult, usersResult, accrualsResult] = await Promise.all([
                        taskService.getTasksForUser(this.currentUser.uid),
                        ipRecordsService.getRecords(),
                        personsService.getPersons(),
                        taskService.getAllUsers(),
                        accrualService.getAccruals()
                    ]);

                    if (tasksResult.success) this.tasks = tasksResult.data; else throw new Error(tasksResult.error || 'Görevler yüklenemedi');
                    if (ipRecordsResult.success) this.allIpRecords = ipRecordsResult.data; else throw new Error(ipRecordsResult.error || 'IP Kayıtları yüklenemedi');
                    if (personsResult.success) this.allPersons = personsResult.data; else throw new Error(personsResult.error || 'Kişiler yüklenemedi');
                    if (usersResult.success) this.allUsers = usersResult.data; else throw new Error(usersResult.error || 'Kullanıcılar yüklenemedi');
                    if (accrualsResult.success) this.allAccruals = accrualsResult.data; else throw new Error(accrualsResult.error || 'Tahakkuklar yüklenemedi');
                    
                    this.renderTasks();
                    
                } catch (error) {
                    console.error('Başlangıç verileri yüklenirken hata:', error);
                    alert('Veriler yüklenirken bir hata oluştu: ' + error.message);
                } finally {
                    document.getElementById('loadingIndicator').style.display = 'none';
                }
            }

            setupEventListeners() {
                document.getElementById('logoutBtn').addEventListener('click', () => authService.signOut().then(() => window.location.href = 'index.html'));
                document.getElementById('statusFilter').addEventListener('change', (e) => this.renderTasks(e.target.value));
                
                document.getElementById('closeViewTaskDetailModal').addEventListener('click', () => this.closeModal('viewTaskDetailModal'));
                document.getElementById('closeEditTaskModal').addEventListener('click', () => this.closeModal('editTaskModal'));
                document.getElementById('cancelEditTaskBtn').addEventListener('click', () => this.closeModal('editTaskModal'));
                document.getElementById('saveTaskChangesBtn').addEventListener('click', () => this.saveTaskChanges());
                document.getElementById('modalTaskDetailFileUploadArea').addEventListener('click', () => document.getElementById('modalTaskDetailFileInput').click());
                document.getElementById('modalTaskDetailFileInput').addEventListener('change', (e) => this.handleEditDocumentUpload(e.target.files));
                
                document.getElementById('closeCompleteTaskModal').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('cancelCompleteTaskBtn').addEventListener('click', () => this.closeModal('completeTaskModal'));
                document.getElementById('submitCompleteTaskBtn').addEventListener('click', () => this.completeTask('completed_with_doc'));
                document.getElementById('clientApprovalBtn').addEventListener('click', () => this.completeTask('client_approved'));
                document.getElementById('manualCloseBtn').addEventListener('click', () => this.completeTask('manually_closed'));
                document.getElementById('completeTaskDocumentInput').addEventListener('change', (e) => this.handleDocumentUploadForTaskCompletion(e.target.files));
                document.getElementById('completeTaskFileUploadArea').addEventListener('click', () => document.getElementById('completeTaskDocumentInput').click());
                
                document.getElementById('closeIpRecordModalBtn').addEventListener('click', () => this.closeModal('ipRecordDetailModal'));
                
                document.getElementById('reassignBtn').addEventListener('click', () => this.showReassignModal());
                document.getElementById('closeReassignModal').addEventListener('click', () => this.closeModal('reassignTaskModal'));
                document.getElementById('cancelReassignBtn').addEventListener('click', () => this.closeModal('reassignTaskModal'));
                document.getElementById('confirmReassignBtn').addEventListener('click', () => this.handleReassignment());

                // Yeni Modal için Event Listener'lar
                document.getElementById('closeAddAccrualModal').addEventListener('click', () => this.closeModal('addAccrualModal'));
                document.getElementById('cancelAddAccrualBtn').addEventListener('click', () => this.closeModal('addAccrualModal'));
                document.getElementById('saveAccrualBtn').addEventListener('click', () => this.handleSaveAccrual());

                ['officialFee', 'serviceFee', 'vatRate', 'applyVatToOfficialFee'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('input', () => this.calculateTotalAmount());
                });
                document.getElementById('tpInvoicePartySearch').addEventListener('input', e => this.searchPersons(e.target.value, 'tpInvoiceParty'));
                document.getElementById('serviceInvoicePartySearch').addEventListener('input', e => this.searchPersons(e.target.value, 'serviceInvoiceParty'));

                const tableBody = document.getElementById('tasksTableBody');
                tableBody.addEventListener('change', (event) => {
                    if (event.target.matches('.task-checkbox')) {
                        this.handleTaskSelection(event.target);
                    }
                });
                
                document.getElementById('selectAllCheckbox').addEventListener('change', (event) => {
                    const isChecked = event.target.checked;
                    document.querySelectorAll('.task-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                        this.handleTaskSelection(checkbox);
                    });
                });
                
                tableBody.addEventListener('click', (event) => {
                    const target = event.target.closest('button.action-btn, a.ip-record-link');
                    if (!target) return;

                    const row = target.closest('tr');
                    const taskId = row.querySelector('.task-checkbox')?.dataset.taskId;
                    if (!taskId) return;
                    
                    if (target.classList.contains('complete-btn')) { 
                        const relatedIpRecordId = target.dataset.ipRecordId;
                        this.showCompleteTaskModal(taskId, relatedIpRecordId); 
                    }
                    else if (target.classList.contains('view-btn')) { this.viewTaskDetailsModal(taskId); }
                    else if (target.classList.contains('edit-btn')) { this.showEditTaskModal(taskId); }
                    else if (target.classList.contains('delete-btn')) { this.deleteTask(taskId); }
                    else if (target.classList.contains('add-accrual-btn')) { this.showAddAccrualModal(taskId); } // Yeni handler
                    else if (target.classList.contains('ip-record-link')) { 
                        const recordId = target.dataset.ipRecordId;
                        if (recordId) this.showIpRecordDetailModal(recordId); 
                    }
                });
            }

            renderTasks(filter = 'all') {
                const tableBody = document.getElementById('tasksTableBody');
                const noTasksMessage = document.getElementById('noTasksMessage');
                tableBody.innerHTML = '';
                const filteredTasks = this.tasks.filter(task => filter === 'all' || task.status === filter);
                
                noTasksMessage.style.display = filteredTasks.length === 0 ? 'block' : 'none';
                
                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                const statusMap = { open: 'Açık', in_progress: 'Devam Ediyor', completed: 'Tamamlandı', pending_review: 'Gözden Geçiriliyor' };
                
                filteredTasks.forEach((task) => {
                    const row = document.createElement('tr');
                    const relatedIpRecordTitle = task.relatedIpRecordTitle || '-'; 
                    const relatedIpRecordId = task.relatedIpRecordId || '';
                    const isCompleted = task.status === 'completed';
                    const isSelected = this.selectedTasks.has(task.id);
                    
                    row.innerHTML = `
                        <td><input type="checkbox" class="task-checkbox" data-task-id="${task.id}" ${isSelected ? 'checked' : ''}></td>
                        <td><span class="priority-${task.priority}">${priorityMap[task.priority] || 'Normal'}</span></td>
                        <td>${task.title}</td>
                        <td><a href="#" class="ip-record-link" data-ip-record-id="${relatedIpRecordId}">${relatedIpRecordTitle}</a></td> 
                        <td>${task.dueDate ? new Date(task.dueDate).toLocaleDateString() : '-'}</td>
                        <td><span class="status-badge status-${task.status}">${statusMap[task.status] || task.status}</span></td>
                        <td>
                            <div style="display: flex; gap: 5px;">
                                <button class="action-btn view-btn">Görüntüle</button>
                                <button class="action-btn edit-btn">Güncelle</button>
                                <button class="action-btn complete-btn" data-ip-record-id="${relatedIpRecordId}" ${isCompleted ? 'disabled' : ''}>${isCompleted ? 'Tamamlandı' : 'İşi Bitir'}</button>
                                <button class="action-btn add-accrual-btn" title="Bu İşe Tahakkuk Ekle">💰</button>
                            </div>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                this.updateReassignButtonState();
            }

            populateModalTaskDetails(task, ipRecords, persons) {
                const modal = document.getElementById('viewTaskDetailModal');
                if (!modal) return;
                document.getElementById('modalViewTaskTitle').textContent = `İş Detayı: ${task.title || '-'}`;
                document.getElementById('modalViewTaskTitleValue').textContent = task.title || '-';
                document.getElementById('modalViewTaskDescriptionValue').textContent = task.description || '-';
                const taskTypeParts = task.taskType ? task.taskType.split('_') : [];
                const mainType = taskTypeParts[0] || '';
                const specificType = taskTypeParts.slice(1).join(' ').replace(/\b\w/g, l => l.toUpperCase());
                document.getElementById('modalViewTaskTypeValue').textContent = `${mainType.charAt(0).toUpperCase() + mainType.slice(1)} - ${specificType}` || '-';
                const priorityMap = { high: 'Yüksek', medium: 'Orta', low: 'Düşük' };
                document.getElementById('modalViewTaskPriorityValue').textContent = priorityMap[task.priority] || task.priority || '-';
                document.getElementById('modalViewAssignedToValue').textContent = task.assignedTo_email || '-';
                document.getElementById('modalViewTaskDueDateValue').textContent = task.dueDate ? new Date(task.dueDate).toLocaleDateString('tr-TR') : '-';
                let relatedIpRecordText = '-';
                if (task.relatedIpRecordId) {
                    const ipRecord = ipRecords.find(r => r.id === task.relatedIpRecordId);
                    relatedIpRecordText = ipRecord ? `${ipRecord.title || ipRecord.applicationNumber || 'Kayıt'}` : (task.relatedIpRecordTitle || 'Kayıt Bulunamadı');
                }
                document.getElementById('modalViewRelatedIpRecordValue').textContent = relatedIpRecordText;
                const modalViewRelatedPartyGroup = document.getElementById('modalViewRelatedPartyGroup');
                const modalViewRelatedPartyLabel = document.getElementById('modalViewRelatedPartyLabel');
                const modalViewRelatedPartyValue = document.getElementById('modalViewRelatedPartyValue');
                if (task.details?.relatedParty?.id) {
                    const person = persons.find(p => p.id === task.details.relatedParty.id);
                    if (person) {
                        const taskType = task.taskType.split('_')[1];
                        const labelMap = { 'devir': 'Devralan Taraf', 'lisans': 'Lisans Alan Taraf', 'rehin': 'Rehin Alan Taraf', 'birleşme': 'Birleşilen Taraf', 'veraset': 'Mirasçı', 'teminat': 'Rehin Alan Taraf' };
                        modalViewRelatedPartyLabel.textContent = labelMap[taskType] || 'İlgili Taraf';
                        modalViewRelatedPartyValue.textContent = person.name;
                        modalViewRelatedPartyGroup.style.display = 'block';
                    } else { modalViewRelatedPartyGroup.style.display = 'none'; }
                } else { modalViewRelatedPartyGroup.style.display = 'none'; }
                
                const modalViewRelatedAccruals = document.getElementById('modalViewRelatedAccruals');
                const relatedAccruals = this.allAccruals.filter(acc => acc.taskId === task.id);
                
                if (relatedAccruals.length > 0) {
                    modalViewRelatedAccruals.innerHTML = relatedAccruals.map(acc => {
                        const statusText = acc.status === 'paid' ? 'Ödendi' : 'Ödenmedi';
                        const statusBadgeClass = acc.status === 'paid' ? 'status-badge status-completed' : 'status-badge status-open';
                        const totalAmountText = new Intl.NumberFormat('tr-TR', { style: 'currency', currency: acc.totalAmountCurrency || 'TRY' }).format(acc.totalAmount || 0);
                        
                        return `<div class="related-accrual-item">
                            <b>ID:</b> ${acc.id.substring(0,8)}... | 
                            <b>Durum:</b> <span class="${statusBadgeClass}">${statusText}</span> | 
                            <b>Tutar:</b> ${totalAmountText}
                        </div>`;
                    }).join('');
                } else {
                    modalViewRelatedAccruals.innerHTML = '<p>Bu işe ait tahakkuk bulunmuyor.</p>';
                }

                const modalViewTaskHistory = document.getElementById('modalViewTaskHistory');
                modalViewTaskHistory.innerHTML = '';
                if (!task.history || task.history.length === 0) {
                    modalViewTaskHistory.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">İşlem geçmişi bulunmuyor.</p>';
                } else {
                    const sortedHistory = [...task.history].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    sortedHistory.forEach(entry => {
                        const item = document.createElement('div');
                        item.className = 'task-history-item';
                        item.innerHTML = `<div class="task-history-item-content"><div class="task-history-info"><div class="task-history-description">${entry.action}</div><div class="task-history-meta">${new Date(entry.timestamp).toLocaleString('tr-TR')} by ${entry.userEmail}</div></div></div>`;
                        modalViewTaskHistory.appendChild(item);
                    });
                }
            }

            showAddAccrualModal(taskId) {
                const task = this.tasks.find(t => t.id === taskId);
                if (!task) {
                    alert('Tahakkuk eklenecek iş bulunamadı.');
                    return;
                }
                
                document.getElementById('addAccrualForm').reset();
                this.selectedTpInvoiceParty = null;
                this.selectedServiceInvoiceParty = null;
                document.getElementById('selectedTpInvoicePartyDisplay').style.display = 'none';
                document.getElementById('selectedServiceInvoicePartyDisplay').style.display = 'none';
                document.getElementById('tpInvoicePartySearch').value = '';
                document.getElementById('serviceInvoicePartySearch').value = '';
                
                document.getElementById('accrualTaskId').value = taskId;
                document.getElementById('accrualTaskTitleDisplay').value = task.title;
                
                this.calculateTotalAmount();
                
                document.getElementById('addAccrualModal').classList.add('show');
            }

            async handleSaveAccrual() {
                const taskId = document.getElementById('accrualTaskId').value;
                const task = this.tasks.find(t => t.id === taskId);

                const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                
                if (officialFee <= 0 && serviceFee <= 0) {
                    alert("Lütfen en az bir ücret girin.");
                    return;
                }

                const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;
                let totalAmount;
                if (applyVatToOfficial) {
                    totalAmount = (officialFee + serviceFee) * (1 + vatRate / 100);
                } else {
                    totalAmount = officialFee + (serviceFee * (1 + vatRate / 100));
                }

                const accrualData = {
                    taskId: taskId,
                    taskTitle: task.title,
                    officialFee: {
                        amount: officialFee,
                        currency: document.getElementById('officialFeeCurrency').value
                    },
                    serviceFee: {
                        amount: serviceFee,
                        currency: document.getElementById('serviceFeeCurrency').value
                    },
                    vatRate,
                    applyVatToOfficialFee: applyVatToOfficial,
                    totalAmount,
                    totalAmountCurrency: 'TL',
                    tpInvoiceParty: this.selectedTpInvoiceParty ? {id: this.selectedTpInvoiceParty.id, name: this.selectedTpInvoiceParty.name} : null,
                    serviceInvoiceParty: this.selectedServiceInvoiceParty ? {id: this.selectedServiceInvoiceParty.id, name: this.selectedServiceInvoiceParty.name} : null,
                };
                
                const result = await accrualService.addAccrual(accrualData);
                if (result.success) {
                    alert('Yeni tahakkuk başarıyla eklendi!');
                    this.allAccruals.push(result.data);
                    this.closeModal('addAccrualModal');
                } else {
                    alert('Tahakkuk eklenirken hata oluştu: ' + result.error);
                }
            }

            calculateTotalAmount() {
                const officialFee = parseFloat(document.getElementById('officialFee').value) || 0;
                const serviceFee = parseFloat(document.getElementById('serviceFee').value) || 0;
                const vatRate = parseFloat(document.getElementById('vatRate').value) || 0;
                const applyVatToOfficial = document.getElementById('applyVatToOfficialFee').checked;

                let total;
                if(applyVatToOfficial) {
                    total = (officialFee + serviceFee) * (1 + vatRate / 100);
                } else {
                    total = officialFee + (serviceFee * (1 + vatRate / 100));
                }
                document.getElementById('totalAmountDisplay').textContent = total.toFixed(2) + ' TL';
            }

            searchPersons(query, target) {
                const resultsContainerId = {
                    'tpInvoiceParty': 'tpInvoicePartyResults',
                    'serviceInvoiceParty': 'serviceInvoicePartyResults'
                }[target];
                const container = document.getElementById(resultsContainerId);
                if (!container) return;
                container.innerHTML = '';
                if (query.length < 2) { container.innerHTML = ''; return; }
                
                const filtered = this.allPersons.filter(p => p.name.toLowerCase().includes(query.toLowerCase()));
                if (filtered.length === 0) { container.innerHTML = '<p class="no-results-message">Kişi bulunamadı.</p>'; return; }

                filtered.forEach(p => {
                    const item = document.createElement('div');
                    item.className = 'search-result-item';
                    item.dataset.id = p.id;
                    item.innerHTML = `<div><b>${p.name}</b><br><small>${p.email || '-'}</small></div>`;
                    item.addEventListener('click', () => this.selectPerson(p, target));
                    container.appendChild(item);
                });
            }

            selectPerson(person, target) {
                const displayId = {
                    'tpInvoiceParty': 'selectedTpInvoicePartyDisplay',
                    'serviceInvoiceParty': 'selectedServiceInvoicePartyDisplay'
                }[target];
                const inputId = {
                    'tpInvoiceParty': 'tpInvoicePartySearch',
                    'serviceInvoiceParty': 'serviceInvoicePartySearch'
                }[target];
                const resultsId = {
                    'tpInvoiceParty': 'tpInvoicePartyResults',
                    'serviceInvoiceParty': 'serviceInvoicePartyResults'
                }[target];
                
                if(target === 'tpInvoiceParty') this.selectedTpInvoiceParty = person;
                else if(target === 'serviceInvoiceParty') this.selectedServiceInvoiceParty = person;

                const display = document.getElementById(displayId);
                display.innerHTML = `<p><b>Seçilen:</b> ${person.name}</p>`;
                display.style.display = 'block';

                document.getElementById(resultsId).innerHTML = '';
                document.getElementById(inputId).value = person.name;
            }

            closeModal(modalId) {
                document.getElementById(modalId).classList.remove('show');
                if (modalId === 'completeTaskModal') { this.uploadedCompletionFiles = []; document.getElementById('completeTaskFileList').innerHTML = ''; }
                if (modalId === 'editTaskModal') { this.uploadedEditFiles = []; this.currentEditTask = null; }
                if (modalId === 'reassignTaskModal') { document.getElementById('reassignUserSelect').value = ''; }
                if (modalId === 'addAccrualModal') { document.getElementById('addAccrualForm').reset(); }
            }
            
            // Diğer tüm metotlar aynı şekilde kalacak
            // ...
        }

        let myTasksModuleInstance;
        auth.onAuthStateChanged((user) => {
            if (user || authService.getCurrentUser()) {
                if (!myTasksModuleInstance) {
                    myTasksModuleInstance = new MyTasksModule();
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            // ... Akordiyon menü ve setActiveMenu scriptleri aynı ...
        });
    </script>
</body>
</html>